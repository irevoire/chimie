import{P as fe}from"./BNLYq5HQ.js";import{h as P,i as ee,g as i,j as v,p as ue,f as $,c as M,u as f,r as _,s as H,t as ge,a as pe,d as O}from"./BOqQhZBJ.js";import{M as ye,N as ve,O as be,P as Ae,Q as we,R as _e,T as Pe}from"./Jagi0WJL.js";import{B as Se,e as C}from"./ytu5q_IM.js";import{P as Ie}from"./4T_x9N89.js";import{a as Q}from"./C2I_EQjW.js";import"./DsnmJJEf.js";import{d as Me,a as De,s as Re}from"./BufZg4h2.js";import{i as Te}from"./QS5y7wlf.js";import{e as ke,t as x,h as F}from"./D4fmOnVC.js";import{f as te,c as Oe,a as B}from"./CnteGC4G.js";import{a as Ce,x as xe,s as Fe,b5 as Ve,b6 as oe,b7 as ie,b8 as ae,b9 as se,a4 as ze,ba as Ee,bb as Ze,b as Je,bc as Le,bd as Ue,be as Be,bf as Ne,ag as je,ax as $e,a9 as He,D as Qe,bg as We,as as qe}from"./LrV5ZTyj.js";import{a as Ge,s as Xe}from"./B227BkWK.js";import{a1 as Ye,a2 as Ke,f as et,a3 as d,a4 as tt,a5 as ot,a6 as it,J as W,a7 as ne,A as at}from"./DeYUhNiz.js";import{$ as st,g as V}from"./DdY9CyNE.js";import{S as nt}from"./De1sTUmb.js";import{C as rt}from"./Bz1BELIr.js";import{F as lt}from"./C0Ca_l_S.js";import{S as ct}from"./LRhZRw-S.js";import{p as re,u as q}from"./Cx5lmlld.js";import{o as dt}from"./BjCgVxgW.js";import{m as G}from"./C20f7eOz.js";const X=new Ie("asset-viewer-state",!1),Y=()=>({currentRotation:0,currentZoom:1,enable:!0,currentPositionX:0,currentPositionY:0});class mt extends Se{#e=P(ee(Y()));#t=P();get imgRef(){return i(this.#t)}set imgRef(e){v(this.#t,e,!0)}#o=P(!1);get isShowActivityPanel(){return i(this.#o)}set isShowActivityPanel(e){v(this.#o,e,!0)}#i=P(!1);get isPlayingMotionPhoto(){return i(this.#i)}set isPlayingMotionPhoto(e){v(this.#i,e,!0)}#a=P(!1);get isShowEditor(){return i(this.#a)}set isShowEditor(e){v(this.#a,e,!0)}get isShowDetailPanel(){return X.current}get zoomState(){return i(this.#e)}set zoomState(e){v(this.#e,e,!0),this.emit("ZoomChange",e)}get zoom(){return i(this.#e).currentZoom}set zoom(e){this.zoomState={...this.zoomState,currentZoom:e}}canZoomIn(){return this.hasListeners("Zoom")&&this.zoom<=1}canZoomOut(){return this.hasListeners("Zoom")&&this.zoom>1}canCopyImage(){return ye()&&!!r.imgRef}set isShowDetailPanel(e){X.current=e}onZoomChange(e){v(this.#e,e,!0)}resetZoomState(){this.zoomState=Y()}toggleActivityPanel(){this.closeDetailPanel(),this.isShowActivityPanel=!this.isShowActivityPanel}closeActivityPanel(){this.isShowActivityPanel=!1}toggleDetailPanel(){this.closeActivityPanel(),this.isShowDetailPanel=!this.isShowDetailPanel}closeDetailPanel(){this.isShowDetailPanel=!1}openEditor(){this.closeActivityPanel(),this.isShowEditor=!0}closeEditor(){this.isShowEditor=!1}}const r=new mt;var ht=te('<div class="flex group transition-all"><span class="inline-block h-min whitespace-nowrap ps-3 pe-1 group-hover:ps-3 py-1 text-center align-baseline leading-none text-gray-100 dark:text-immich-dark-gray bg-primary rounded-s-full hover:bg-immich-primary/80 dark:hover:bg-immich-dark-primary/80 transition-all"><p class="text-sm"> </p></span> <button type="button" class="text-gray-100 dark:text-immich-dark-gray bg-immich-primary/95 dark:bg-immich-dark-primary/95 rounded-e-full place-items-center place-content-center pe-2 ps-1 py-1 hover:bg-immich-primary/80 dark:hover:bg-immich-dark-primary/80 transition-all"><!></button></div>'),ft=te('<div class="my-4 flex flex-col gap-2"><!></div> <section class="flex flex-wrap pt-2 gap-1"></section>',1);function ut(t,e){ue(e,!0);const o=()=>Ge(st,"$t",c),[c,u]=Xe();let a=P(ee([])),l=f(()=>Object.fromEntries(i(a).map(n=>[n.id,n]))),s=new nt,g=f(()=>s.size===0),p=!0;De(async()=>{v(a,await Ye(),!0)});const m=async()=>{if(s.size===0)return;const n=await ve({tagIds:[...s],assetIds:e.assetIds,showNotification:!1});C.emit("AssetsTag",n),e.onClose(!0)},z=async n=>{if(n)if(n.id)s.add(n.value);else{const[b]=await Ke({tagUpsertDto:{tags:[n.label]}});i(a).push(b),s.add(b.id)}},E=n=>{s.delete(n)};{let n=f(()=>o()("tag_assets")),b=f(()=>o()("tag_assets"));lt(t,{size:"small",get title(){return i(n)},get icon(){return Ve},get onClose(){return e.onClose},onSubmit:m,get submitText(){return i(b)},onOpenAutoFocus:S=>S.preventDefault(),get disabled(){return i(g)},children:(S,N)=>{var R=ft(),I=$(R),Z=M(I);{let y=f(()=>o()("tag")),A=f(()=>i(a).map(h=>({id:h.id,label:h.value,value:h.id}))),w=f(()=>o()("search_tags"));rt(Z,{onSelect:z,get label(){return i(y)},allowCreate:p,defaultFirstOption:!0,get options(){return i(A)},get placeholder(){return i(w)},forceFocus:!0})}_(I);var T=H(I,2);ke(T,20,()=>s,y=>y,(y,A)=>{const w=f(()=>i(l)[A]);var h=Oe(),le=$(h);{var ce=J=>{var L=ht(),U=M(L),j=M(U),de=M(j,!0);_(j),_(U);var k=H(U,2);k.__click=()=>E(A);var me=M(k);Ce(me,{get icon(){return xe}}),_(k),_(L),ge(he=>{Re(de,i(w).value),Fe(k,"title",he)},[()=>o()("remove_tag")]),B(J,L)};Te(le,J=>{i(w)&&J(ce)})}B(y,h)}),_(T),B(S,R)},$$slots:{default:!0}})}pe(),u()}Me(["click"]);const Lt=(t,e)=>{const o=e.getOwnedAssets(),c=o.map(m=>m.id),u=o.every(m=>m.isVideo),a=async m=>{await D({name:m,assetIds:c}),e.clearSelect()},l={title:t("refresh_faces"),icon:se,onAction:()=>a(d.RefreshFaces)},s={title:t("refresh_metadata"),icon:ae,onAction:()=>a(d.RefreshMetadata)},g={title:t("refresh_thumbnails"),icon:ie,onAction:()=>a(d.RegenerateThumbnail)},p={title:t("refresh_encoded_videos"),icon:oe,onAction:()=>a(d.TranscodeVideo),$if:()=>u};return{RefreshFacesJob:l,RefreshMetadataJob:s,RegenerateThumbnailJob:g,TranscodeVideoJob:p}},Ut=(t,e)=>{const o=Pe(),c=O(q),u=O(re),a=!!(c&&c.id===e.ownerId),l={title:t("share"),icon:qe,type:t("assets"),$if:()=>!!(O(q)&&!e.isTrashed&&e.visibility!==at.Locked),onAction:()=>G.show(ct,{assetIds:[e.id]})},s={title:t("download"),icon:ze,shortcuts:{key:"d",shift:!0},type:t("assets"),$if:()=>!!c,onAction:()=>K(e,{edited:!0})},g={title:t("download_original"),icon:We,type:t("assets"),$if:()=>!!c&&e.isEdited,onAction:()=>K(e,{edited:!1})},p={...s,$if:()=>!c&&o&&o.allowDownload},m={title:t("play_motion_photo"),icon:Ne,type:t("assets"),$if:()=>!!e.livePhotoVideoId&&!r.isPlayingMotionPhoto,onAction:()=>{r.isPlayingMotionPhoto=!0}},z={title:t("stop_motion_photo"),icon:Be,type:t("assets"),$if:()=>!!e.livePhotoVideoId&&r.isPlayingMotionPhoto,onAction:()=>{r.isPlayingMotionPhoto=!1}},E={title:t("to_favorite"),icon:$e,type:t("assets"),$if:()=>a&&!e.isFavorite,onAction:()=>gt(e),shortcuts:[{key:"f"}]},n={title:t("unfavorite"),icon:je,type:t("assets"),$if:()=>a&&e.isFavorite,onAction:()=>pt(e),shortcuts:[{key:"f"}]},b={title:t("asset_offline"),icon:Qe,type:t("assets"),color:"danger",$if:()=>!!e.isOffline,onAction:()=>r.toggleDetailPanel()},S={title:t("zoom_image"),icon:Ue,$if:()=>r.canZoomIn(),onAction:()=>r.emit("Zoom")},N={title:t("zoom_image"),icon:Le,$if:()=>r.canZoomOut(),onAction:()=>r.emit("Zoom")},R={title:t("copy_image"),icon:Je,$if:()=>r.canCopyImage(),onAction:()=>r.emit("Copy")},I={title:t("info"),icon:He,type:t("assets"),$if:()=>e.hasMetadata,onAction:()=>r.toggleDetailPanel(),shortcuts:{key:"i"}},Z={title:t("add_tag"),icon:Ze,type:t("assets"),$if:()=>u.tags.enabled,onAction:()=>G.show(ut,{assetIds:[e.id]}),shortcuts:{key:"t"}},T={title:t("editor"),icon:Ee,$if:()=>!o&&a&&e.type===W.Image&&!e.livePhotoVideoId&&e.exifInfo?.projectionType!==fe.EQUIRECTANGULAR&&!e.originalPath.toLowerCase().endsWith(".insp")&&!e.originalPath.toLowerCase().endsWith(".gif")&&!e.originalPath.toLowerCase().endsWith(".svg"),onAction:()=>r.openEditor()},y={title:t("refresh_faces"),icon:se,onAction:()=>D({name:d.RefreshFaces,assetIds:[e.id]})},A={title:t("refresh_metadata"),icon:ae,onAction:()=>D({name:d.RefreshMetadata,assetIds:[e.id]})},w={title:t("refresh_thumbnails"),icon:ie,onAction:()=>D({name:d.RegenerateThumbnail,assetIds:[e.id]})},h={title:t("refresh_encoded_videos"),icon:oe,onAction:()=>D({name:d.TranscodeVideo,assetIds:[e.id]}),$if:()=>e.type===W.Video};return{Share:l,Download:s,DownloadOriginal:g,SharedLinkDownload:p,Offline:b,Info:I,Favorite:E,Unfavorite:n,PlayMotionPhoto:m,StopMotionPhoto:z,ZoomIn:S,ZoomOut:N,Copy:R,Tag:Z,Edit:T,RefreshFacesJob:y,RefreshMetadataJob:A,RegenerateThumbnailJob:w,TranscodeVideoJob:h}},K=async(t,{edited:e})=>{const o=await V(),c=[{filename:t.originalFileName,id:t.id,size:t.exifInfo?.fileSizeInByte||0}],u=l=>l.originalPath.includes("encoded-video");if(t.livePhotoVideoId){const l=await et({...Q.params,id:t.livePhotoVideoId});(!u(l)||O(re)?.download.includeEmbeddedVideos)&&c.push({filename:l.originalFileName,id:t.livePhotoVideoId,size:l.exifInfo?.fileSizeInByte||0})}const a=be(Q.params);for(const[l,{filename:s,id:g}]of c.entries()){l!==0&&await Ae(500);try{x.success(o("downloading_asset_filename",{values:{filename:t.originalFileName}})),we(_e()+`/assets/${g}/original`+(a?`?${a}&edited=${e}`:`?edited=${e}`),s)}catch(p){F(p,o("errors.error_downloading",{values:{filename:s}}))}}},gt=async t=>{const e=await V();try{const o=await ne({id:t.id,updateAssetDto:{isFavorite:!0}});x.success(e("added_to_favorites")),C.emit("AssetUpdate",o)}catch(o){F(o,e("errors.unable_to_add_remove_favorites",{values:{favorite:t.isFavorite}}))}},pt=async t=>{const e=await V();try{const o=await ne({id:t.id,updateAssetDto:{isFavorite:!1}});x.success(e("removed_from_favorites")),C.emit("AssetUpdate",o)}catch(o){F(o,e("errors.unable_to_add_remove_favorites",{values:{favorite:t.isFavorite}}))}},Bt=async t=>{const[e]=await dt({multiple:!1});await ot({assetCopyDto:{sourceId:t,targetId:e}}),await it({assetBulkDeleteDto:{ids:[t],force:!0}}),C.emit("AssetReplace",{oldAssetId:t,newAssetId:e})},yt=(t,e)=>({[d.RefreshFaces]:t("refreshing_faces"),[d.RefreshMetadata]:t("refreshing_metadata"),[d.RegenerateThumbnail]:t("regenerating_thumbnails"),[d.TranscodeVideo]:t("refreshing_encoded_video")})[e],D=async t=>{const e=await V();try{await tt({assetJobsDto:t}),x.success(yt(e,t.name))}catch(o){F(o,e("errors.unable_to_submit_job"))}};export{ut as A,r as a,Bt as b,Ut as c,Lt as g,K as h};
