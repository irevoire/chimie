const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["_app/immutable/chunks/DBZgVNgs.js","_app/immutable/chunks/DsnmJJEf.js","_app/immutable/chunks/DdY9CyNE.js","_app/immutable/chunks/BNLYq5HQ.js","_app/immutable/chunks/BOqQhZBJ.js","_app/immutable/chunks/DIeogL5L.js","_app/immutable/chunks/BufZg4h2.js","_app/immutable/chunks/CnteGC4G.js","_app/immutable/chunks/QS5y7wlf.js","_app/immutable/chunks/LrV5ZTyj.js","_app/immutable/chunks/B227BkWK.js","_app/immutable/chunks/C4XZXykC.js","_app/immutable/chunks/BUApaBEI.js","_app/immutable/assets/Logo.BzPWps5k.css","_app/immutable/chunks/Di6OVBka.js","_app/immutable/chunks/ytu5q_IM.js","_app/immutable/chunks/FIvvbHQR.js","_app/immutable/chunks/DeYUhNiz.js","_app/immutable/chunks/DdFokm7i.js","_app/immutable/chunks/4T_x9N89.js","_app/immutable/chunks/zKTaOrsI.js","_app/immutable/chunks/eLOR7anR.js","_app/immutable/chunks/Cx5lmlld.js","_app/immutable/chunks/BeWG-__C.js","_app/immutable/chunks/C0Ca_l_S.js","_app/immutable/chunks/C20f7eOz.js","_app/immutable/chunks/Ze2c3aZz.js","_app/immutable/chunks/Vqhp0wrh.js","_app/immutable/chunks/D4fmOnVC.js","_app/immutable/chunks/B_VXSWsl.js","_app/immutable/chunks/DzmAA-7p.js","_app/immutable/chunks/rybNiN9i.js","_app/immutable/chunks/69_IOA4Y.js","_app/immutable/chunks/CMtyP6CA.js","_app/immutable/chunks/CRYXttfP.js","_app/immutable/chunks/DU0cVi4D.js","_app/immutable/chunks/BJT5MMCK.js","_app/immutable/assets/Input.DUYXNfxO.css","_app/immutable/assets/Select.CV-KWLNP.css","_app/immutable/chunks/Jagi0WJL.js","_app/immutable/chunks/C2I_EQjW.js","_app/immutable/chunks/DbKlvrsB.js","_app/immutable/chunks/De1sTUmb.js","_app/immutable/chunks/BzKamodV.js","_app/immutable/chunks/Cqn8UuRa.js","_app/immutable/chunks/D-rYfuUG.js","_app/immutable/chunks/DHs6cPar.js","_app/immutable/chunks/gLUpBE6V.js","_app/immutable/assets/map.f_XjgDN9.css","_app/immutable/chunks/BppaSL2M.js","_app/immutable/chunks/Bc5ULZvy.js","_app/immutable/chunks/Bz1BELIr.js","_app/immutable/chunks/_U16pX41.js","_app/immutable/chunks/LRhZRw-S.js","_app/immutable/chunks/CBNU4HUx.js","_app/immutable/chunks/9i_j0jQI.js","_app/immutable/chunks/1WjNB9m1.js","_app/immutable/chunks/DHEjuV7w.js","_app/immutable/chunks/CaDSsDA9.js","_app/immutable/chunks/yWuLE-qO.js","_app/immutable/chunks/BjCgVxgW.js","_app/immutable/chunks/DnqqNi3p.js","_app/immutable/chunks/BQXmwHOz.js","_app/immutable/assets/photo-sphere-viewer-adapter.CksG-CW9.css","_app/immutable/chunks/C2CyOes3.js","_app/immutable/chunks/DpAluyhr.js","_app/immutable/chunks/ClEInM3m.js","_app/immutable/assets/index.B9wQqAaO.css"])))=>i.map(i=>d[i]);
import"./DsnmJJEf.js";import{d as Zr,a as tr,s as dt,b as qs,e as Be,r as Xc}from"./BufZg4h2.js";import{an as Nc,af as Uc,al as Gc,c as b,b as Ao,r as w,t as lt,p as At,a as Dt,$ as ze,g as h,u as y,h as st,i as ue,P as Ee,j as U,aS as qc,s as k,n as Ne,U as $c,N as Kc,Q as ls,f as Ct,W as Gn,ae as sa}from"./BOqQhZBJ.js";import{f as q,s as ul,a as I,t as pe,c as Ce}from"./CnteGC4G.js";import{i as K}from"./QS5y7wlf.js";import{t as er,h as ce,e as pr,i as dl}from"./D4fmOnVC.js";import{s as Nt,a as De,bD as gl,cL as fl,as as Zc,at as Jc,fe as Qc,au as th,av as eh,I as Jt,a3 as rh,a1 as sh,ff as ih,dq as nh,cw as oh,cF as ml,fg as ah,B as gn,aa as us,w as gr,h as pl,u as fr,G as Qe,ab as Pn,fh as lh,fi as ch,a7 as ia,a8 as na,ai as hh,af as uh,bG as dh,eD as gh,ah as fh,bA as mh,fj as ph,bP as vh,fk as _h,fl as yh,fm as xh,fn as wh,fo as bh,cm as Sh,cn as Ch,dA as oa,bs as Ys,r as vl,T as Rs,x as Ti,bC as Th,H as Ts,fp as go,v as kh,ae as _l,bV as Oh,b_ as Ah,cY as Dh,q as yl,cz as aa,a9 as Eh,bB as Ph,fq as Mh,aD as Ih,bY as Lh,bW as Fh,fr as jh,aV as Rh,aW as Bh,fs as zh,ft as Vh,fu as Wh,fv as Hh,b$ as Yh,bU as Xh,fw as Nh,bq as xl,bp as wl,c0 as Uh,f as Gh}from"./LrV5ZTyj.js";import{a as Ue}from"./4T_x9N89.js";import{s as It,a as at,p as Tt,c as Je,r as qh,d as Zt,f as la,e as Mn}from"./B227BkWK.js";import{g as fn}from"./C4XZXykC.js";import{f as $h}from"./CKQ4VlI3.js";import{$ as zt,d as Kh,g as ca}from"./DdY9CyNE.js";import{s as Ps,a as In}from"./_U16pX41.js";import{c as be,A as je,g as Zh,U as Jh,C as vs}from"./Bp2HQ4kn.js";import{A as Ls}from"./CT-ELVN-.js";import{M as Se}from"./ClWsMFS7.js";import{A as Gt,h as bl,a as mn,_ as zs,t as Qh,o as Hr,P as Sl}from"./BNLYq5HQ.js";import{A as tu,a as eu}from"./Clv0aeC8.js";import{B as ru,C as su,ar as iu,s as nu,as as ou,r as vi,t as ks,M as au,at as lu,au as cu,av as Do,h as Sr,a5 as hu,T as Cl,aw as uu,ax as Tl,ay as du,az as gu,u as fu,l as mu,q as pu,Y as vu,a3 as kl,ad as ha,ac as _u,ah as yu,ae as ua,ai as xu,n as da}from"./Jagi0WJL.js";import{t as Pe,g as Ol,c as wu,b as bu}from"./BIB7ntQe.js";import{m as Dr,H as pn,C as Su}from"./C20f7eOz.js";import{o as Cu}from"./BjCgVxgW.js";import{c4 as Tu,a6 as ku,a7 as ki,cn as Ou,a$ as Au,ay as Du,_ as Eu,z as Al,co as Pu,J as cs,B as hs,cp as Mu,cq as Iu,A as sn,j as Lu,cr as ni,cs as ga,ct as Fu,cu as ju,f as _i,cv as fa,bg as Ru,cw as Bu,cx as zu,cy as Vu,cz as Wu,c9 as Hu,X as Yu}from"./DeYUhNiz.js";import{f as Eo}from"./D5h9ps2j.js";import{A as Xu,d as Nu,g as ma,t as Uu,a as Gu}from"./CH9-R8qO.js";import{p as Po,u as Xs,D as di}from"./Cx5lmlld.js";import{b as vn}from"./9i_j0jQI.js";import{a as Rt,b as qu,c as Mo}from"./Bc5ULZvy.js";import{I as as,B as $u,i as hi}from"./izWpGtDw.js";import{a as _n}from"./ngppk3MK.js";import{i as ds}from"./BSBkdVh4.js";import{I as Ku}from"./BJT5MMCK.js";import{k as Zu,a as $s}from"./C2I_EQjW.js";import{C as Ju,I as Qu}from"./BTHsrYEL.js";import{a as oe,b as nn,c as td,s as Ln,S as Os}from"./y_IyUkeW.js";import{F as Io}from"./C0Ca_l_S.js";import{B as ed}from"./Ydc33-3A.js";import{R as $e}from"./BeWG-__C.js";import{C as Dl}from"./BCL4P6ef.js";import{O as Lo}from"./Di6OVBka.js";import{a as Br,A as rd,b as sd}from"./B6A-PVC5.js";import{e as Fo}from"./ytu5q_IM.js";import{T as id}from"./B1PyaZbq.js";import{a as yi}from"./yWuLE-qO.js";import{T as nd}from"./BXaFREg4.js";import{C as od}from"./ghntbn61.js";import{P as ad}from"./De1sTUmb.js";import{a as ld,L as cd}from"./eLOR7anR.js";import{g as hd,f as ud,C as dd}from"./Bz1BELIr.js";import{H as gd}from"./Bj7pQby1.js";import{B as fd}from"./SuizJy8Y.js";import{L as md}from"./Dj0AsE1j.js";import{D as pd}from"./zKTaOrsI.js";import{g as vd}from"./DxfhPdFw.js";import{P as _d,g as El}from"./CaTmVaxL.js";import{l as Pl,q as yd}from"./Ze2c3aZz.js";import"./69_IOA4Y.js";import{i as xd}from"./CMtyP6CA.js";import{t as wd}from"./CsIzZJ43.js";import{D as bd}from"./8PJ7VpFA.js";import{F as oi}from"./DzmAA-7p.js";import{S as Ei}from"./rybNiN9i.js";import{N as Sd}from"./D-O87UL4.js";import{H as Cd}from"./o4H9mija.js";function Td(a,t,e=t){var r=()=>{e(a.volume)};t()==null&&r(),Nc(a,["volumechange"],r,!1),Uc(()=>{var s=Number(t());s!==a.volume&&!isNaN(s)&&(a.volume=s)})}function kd(a,t,e,r,s){var i=()=>{r(e[a])};e.addEventListener(t,i),i(),(e===document.body||e===window||e===document)&&Gc(()=>{e.removeEventListener(t,i)})}var Od=q('<button type="button" class="my-auto mx-4 rounded-full p-3 text-gray-500 transition hover:bg-gray-500 hover:text-white"><!></button>');function Ml(a,t){var e=Od();e.__click=function(...s){t.onClick?.apply(this,s)};var r=b(e);ul(r,()=>t.children??Ao),w(e),lt(()=>Nt(e,"aria-label",t.label)),I(a,e)}Zr(["click"]);function Ad(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It();Ue(ze,(i,n)=>Ps?.(i,n),()=>[{shortcut:{key:"ArrowRight"},onShortcut:t.onNextAsset},{shortcut:{key:"d"},onShortcut:t.onNextAsset}]);{let i=y(()=>e()("view_next_asset"));Ml(a,{get onClick(){return t.onNextAsset},get label(){return h(i)},children:(n,o)=>{De(n,{get icon(){return gl},size:"36","aria-hidden":!0})}})}Dt(),s()}function Dd(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It();Ue(ze,(i,n)=>Ps?.(i,n),()=>[{shortcut:{key:"ArrowLeft"},onShortcut:t.onPreviousAsset},{shortcut:{key:"a"},onShortcut:t.onPreviousAsset}]);{let i=y(()=>e()("view_previous_asset"));Ml(a,{get onClick(){return t.onPreviousAsset},get label(){return h(i)},children:(n,o)=>{De(n,{get icon(){return fl},size:"36","aria-hidden":!0})}})}Dt(),s()}function pa(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It();let i=Tt(t,"shared",3,!1);const n=async()=>{const o=await Dr.show(tu,{shared:i()});if(!(!o||o.length===0))if(o.length===1){const l=o[0];await ru(l.id,[t.asset.id]),t.onAction({type:Gt.ADD_TO_ALBUM,asset:Pe(t.asset),album:l})}else await su(o.map(l=>l.id),[t.asset.id]),t.onAction({type:Gt.ADD_TO_ALBUM,asset:Pe(t.asset),album:o[0]})};Ue(ze,(o,l)=>In?.(o,l),()=>({shortcut:{key:"l",shift:i()},onShortcut:n}));{let o=y(()=>i()?Zc:Jc),l=y(()=>i()?e()("add_to_shared_album"):e()("add_to_album"));Se(a,{get icon(){return h(o)},get text(){return h(l)},onClick:n})}Dt(),s()}function Ed(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It(),i=async()=>{const n=await Cu({multiple:!0}),l=[t.stack?.primaryAssetId??t.asset.id,...n],c=await Tu({stackCreateDto:{assetIds:l}});t.onAction({type:Gt.STACK,stack:c})};{let n=y(()=>e()("add_upload_to_stack"));Se(a,{get icon(){return Qc},onClick:i,get text(){return h(n)}})}Dt(),s()}function Pd(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It(),i=async()=>{t.asset.isArchived||t.preAction({type:Gt.ARCHIVE,asset:Pe(t.asset)}),await iu(t.asset)&&t.onAction({type:t.asset.isArchived?Gt.ARCHIVE:Gt.UNARCHIVE,asset:Pe(t.asset)})};Ue(ze,(n,o)=>In?.(n,o),()=>({shortcut:{key:"a",shift:!0},onShortcut:i}));{let n=y(()=>t.asset.isArchived?th:eh),o=y(()=>t.asset.isArchived?e()("unarchive"):e()("to_archive"));Se(a,{get icon(){return h(n)},get text(){return h(o)},onClick:i})}Dt(),s()}function Md(a,t){At(t,!0);const e=()=>at(nu,"$showDeleteModal",s),r=()=>at(zt,"$t",s),[s,i]=It();let n=Tt(t,"onUndoDelete",3,void 0);const o=y(()=>t.asset.isTrashed||!Eo.value.trash),l=async c=>{const u=Pe(t.asset);if(h(o)||c){if(e()&&!await Dr.show(Xu,{size:1}))return;try{t.preAction({type:Gt.DELETE,asset:u}),await ku({assetBulkDeleteDto:{ids:[t.asset.id],force:!0}}),t.onAction({type:Gt.DELETE,asset:u}),er.success(r()("permanently_deleted_asset"))}catch(g){ce(g,r()("errors.unable_to_delete_asset"))}return}t.preAction({type:Gt.TRASH,asset:u}),await Nu(!1,()=>t.onAction({type:Gt.TRASH,asset:u}),[u],n())};Ue(ze,(c,u)=>Ps?.(c,u),()=>[{shortcut:{key:"Delete"},onShortcut:()=>l()},{shortcut:{key:"Delete",shift:!0},onShortcut:()=>l(!0)}]);{let c=y(()=>h(o)?rh:sh),u=y(()=>h(o)?r()("permanently_delete"):r()("delete"));Jt(a,{color:"secondary",shape:"round",variant:"ghost",get icon(){return h(c)},get"aria-label"(){return h(u)},onclick:()=>l()})}Dt(),i()}function Id(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It(),i=async()=>{if(!await Dr.showDialog({title:e()("keep_this_delete_others"),prompt:e()("confirm_keep_this_delete_others"),confirmText:e()("delete_others")}))return;const o=await ou(t.asset,t.stack);o&&t.onAction({type:Gt.UNSTACK,assets:[Pe(o)]})};{let n=y(()=>e()("keep_this_delete_others"));Se(a,{get icon(){return ih},onClick:i,get text(){return h(n)}})}Dt(),s()}function Ld(a,t){At(t,!0);const e=()=>at(zt,"$t",s),r=()=>at(Po,"$preferences",s),[s,i]=It();let n=Tt(t,"asset",7);const o=async l=>{try{const c=l===null?{}:{rating:l};await ki({id:n().id,updateAssetDto:c}),n({...n(),exifInfo:{...n().exifInfo,rating:l}}),t.onAction({type:Gt.RATING,asset:Pe(n()),rating:l})}catch(c){ce(c,e()("errors.unable_to_set_rating"))}};Ue(ze,(l,c)=>Ps?.(l,c),()=>r()?.ratings.enabled?[{shortcut:{key:"0"},onShortcut:()=>o(null)},...[1,2,3,4,5].map(l=>({shortcut:{key:String(l)},onShortcut:()=>o(l)}))]:[]),Dt(),i()}function Fd(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It(),i=async()=>{await Ou({id:t.stack.id,assetId:t.asset.id});const n={...t.stack,assets:t.stack.assets.filter(o=>o.id!==t.asset.id)};t.onAction({type:Gt.REMOVE_ASSET_FROM_STACK,stack:n,asset:t.asset})};{let n=y(()=>e()("viewer_remove_from_stack"));Se(a,{get icon(){return nh},onClick:i,get text(){return h(n)}})}Dt(),s()}function jd(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It();let i=Tt(t,"asset",15);const n=async()=>{try{await Au({bulkIdsDto:{ids:[i().id]}}),i(i().isTrashed=!1,!0),t.onAction({type:Gt.RESTORE,asset:Pe(i())}),er.success(e()("restored_asset"))}catch(o){ce(o,e()("errors.unable_to_restore_assets"))}};{let o=y(()=>e()("restore"));Se(a,{get icon(){return oh},onClick:n,get text(){return h(o)}})}Dt(),s()}function Rd(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It(),i=async()=>{try{await Du({id:t.album.id,updateAlbumDto:{albumThumbnailAssetId:t.asset.id}}),er.success(e()("album_cover_updated"))}catch(n){ce(n,e()("errors.unable_to_update_album_cover"))}};{let n=y(()=>e()("set_as_album_cover"));Se(a,{get text(){return h(n)},get icon(){return ml},onClick:i})}Dt(),s()}function Bd(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It();let i=Tt(t,"person",7);const n=async()=>{try{const o=await Eu({id:i().id,personUpdateDto:{featureFaceAssetId:t.asset.id}});i({...i(),...o}),t.onAction?.({type:Gt.SET_PERSON_FEATURED_PHOTO,asset:t.asset,person:i()}),er.success(e()("feature_photo_updated"))}catch(o){ce(o,e()("errors.unable_to_set_feature_photo"))}};{let o=y(()=>e()("set_as_featured_photo"));Se(a,{get text(){return h(o)},get icon(){return ah},onClick:n})}Dt(),s()}var qn={exports:{}},va;function zd(){return va||(va=1,(function(a){(function(t){var e=A(),r=O(),s=P(),i=L(),n={imagePlaceholder:void 0,cacheBust:!1},o={toSvg:l,toPng:u,toJpeg:d,toBlob:g,toPixelData:c,impl:{fontFaces:s,images:i,util:e,inliner:r,options:{}}};a.exports=o;function l(E,_){return _=_||{},f(_),Promise.resolve(E).then(function(X){return p(X,_.filter,!0)}).then(v).then(x).then(j).then(function(X){return T(X,_.width||e.width(E),_.height||e.height(E))});function j(X){return _.bgcolor&&(X.style.backgroundColor=_.bgcolor),_.width&&(X.style.width=_.width+"px"),_.height&&(X.style.height=_.height+"px"),_.style&&Object.keys(_.style).forEach(function(G){X.style[G]=_.style[G]}),X}}function c(E,_){return m(E,_||{}).then(function(j){return j.getContext("2d").getImageData(0,0,e.width(E),e.height(E)).data})}function u(E,_){return m(E,_||{}).then(function(j){return j.toDataURL()})}function d(E,_){return _=_||{},m(E,_).then(function(j){return j.toDataURL("image/jpeg",_.quality||1)})}function g(E,_){return m(E,_||{}).then(e.canvasToBlob)}function f(E){typeof E.imagePlaceholder>"u"?o.impl.options.imagePlaceholder=n.imagePlaceholder:o.impl.options.imagePlaceholder=E.imagePlaceholder,typeof E.cacheBust>"u"?o.impl.options.cacheBust=n.cacheBust:o.impl.options.cacheBust=E.cacheBust}function m(E,_){return l(E,_).then(e.makeImage).then(e.delay(100)).then(function(X){var G=j(E);return G.getContext("2d").drawImage(X,0,0),G});function j(X){var G=document.createElement("canvas");if(G.width=_.width||e.width(X),G.height=_.height||e.height(X),_.bgcolor){var R=G.getContext("2d");R.fillStyle=_.bgcolor,R.fillRect(0,0,G.width,G.height)}return G}}function p(E,_,j){if(!j&&_&&!_(E))return Promise.resolve();return Promise.resolve(E).then(X).then(function(B){return G(E,B,_)}).then(function(B){return R(E,B)});function X(B){return B instanceof HTMLCanvasElement?e.makeImage(B.toDataURL()):B.cloneNode(!1)}function G(B,V,Q){var tt=B.childNodes;if(tt.length===0)return Promise.resolve(V);return z(V,e.asArray(tt),Q).then(function(){return V});function z($,J,rt){var it=Promise.resolve();return J.forEach(function(ht){it=it.then(function(){return p(ht,rt)}).then(function(nt){nt&&$.appendChild(nt)})}),it}}function R(B,V){if(!(V instanceof Element))return V;return Promise.resolve().then(Q).then(tt).then(z).then($).then(function(){return V});function Q(){J(window.getComputedStyle(B),V.style);function J(rt,it){rt.cssText?it.cssText=rt.cssText:ht(rt,it);function ht(nt,ut){e.asArray(nt).forEach(function(D){ut.setProperty(D,nt.getPropertyValue(D),nt.getPropertyPriority(D))})}}}function tt(){[":before",":after"].forEach(function(rt){J(rt)});function J(rt){var it=window.getComputedStyle(B,rt),ht=it.getPropertyValue("content");if(ht===""||ht==="none")return;var nt=e.uid();V.className=V.className+" "+nt;var ut=document.createElement("style");ut.appendChild(D(nt,rt,it)),V.appendChild(ut);function D(W,H,Y){var M="."+W+":"+H,Z=Y.cssText?ft(Y):Lt(Y);return document.createTextNode(M+"{"+Z+"}");function ft(vt){var Pt=vt.getPropertyValue("content");return vt.cssText+" content: "+Pt+";"}function Lt(vt){return e.asArray(vt).map(Pt).join("; ")+";";function Pt(Ht){return Ht+": "+vt.getPropertyValue(Ht)+(vt.getPropertyPriority(Ht)?" !important":"")}}}}}function z(){B instanceof HTMLTextAreaElement&&(V.innerHTML=B.value),B instanceof HTMLInputElement&&V.setAttribute("value",B.value)}function $(){V instanceof SVGElement&&(V.setAttribute("xmlns","http://www.w3.org/2000/svg"),V instanceof SVGRectElement&&["width","height"].forEach(function(J){var rt=V.getAttribute(J);rt&&V.style.setProperty(J,rt)}))}}}function v(E){return s.resolveAll().then(function(_){var j=document.createElement("style");return E.appendChild(j),j.appendChild(document.createTextNode(_)),E})}function x(E){return i.inlineAll(E).then(function(){return E})}function T(E,_,j){return Promise.resolve(E).then(function(X){return X.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),new XMLSerializer().serializeToString(X)}).then(e.escapeXhtml).then(function(X){return'<foreignObject x="0" y="0" width="100%" height="100%">'+X+"</foreignObject>"}).then(function(X){return'<svg xmlns="http://www.w3.org/2000/svg" width="'+_+'" height="'+j+'">'+X+"</svg>"}).then(function(X){return"data:image/svg+xml;charset=utf-8,"+X})}function A(){return{escape:$,parseExtension:_,mimeType:j,dataAsUrl:z,isDataUrl:X,canvasToBlob:R,resolveUrl:B,getAndEncode:tt,uid:V(),delay:J,asArray:rt,escapeXhtml:it,makeImage:Q,width:ht,height:nt};function E(){var D="application/font-woff",W="image/jpeg";return{woff:D,woff2:D,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:W,jpeg:W,gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}function _(D){var W=/\.([^\.\/]*?)$/g.exec(D);return W?W[1]:""}function j(D){var W=_(D).toLowerCase();return E()[W]||""}function X(D){return D.search(/^(data:)/)!==-1}function G(D){return new Promise(function(W){for(var H=window.atob(D.toDataURL().split(",")[1]),Y=H.length,M=new Uint8Array(Y),Z=0;Z<Y;Z++)M[Z]=H.charCodeAt(Z);W(new Blob([M],{type:"image/png"}))})}function R(D){return D.toBlob?new Promise(function(W){D.toBlob(W)}):G(D)}function B(D,W){var H=document.implementation.createHTMLDocument(),Y=H.createElement("base");H.head.appendChild(Y);var M=H.createElement("a");return H.body.appendChild(M),Y.href=W,M.href=D,M.href}function V(){var D=0;return function(){return"u"+W()+D++;function W(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}}}function Q(D){return new Promise(function(W,H){var Y=new Image;Y.onload=function(){W(Y)},Y.onerror=H,Y.src=D})}function tt(D){var W=3e4;return o.impl.options.cacheBust&&(D+=(/\?/.test(D)?"&":"?")+new Date().getTime()),new Promise(function(H){var Y=new XMLHttpRequest;Y.onreadystatechange=ft,Y.ontimeout=Lt,Y.responseType="blob",Y.timeout=W,Y.open("GET",D,!0),Y.send();var M;if(o.impl.options.imagePlaceholder){var Z=o.impl.options.imagePlaceholder.split(/,/);Z&&Z[1]&&(M=Z[1])}function ft(){if(Y.readyState===4){if(Y.status!==200){M?H(M):vt("cannot fetch resource: "+D+", status: "+Y.status);return}var Pt=new FileReader;Pt.onloadend=function(){var Ht=Pt.result.split(/,/)[1];H(Ht)},Pt.readAsDataURL(Y.response)}}function Lt(){M?H(M):vt("timeout of "+W+"ms occured while fetching resource: "+D)}function vt(Pt){console.error(Pt),H("")}})}function z(D,W){return"data:"+W+";base64,"+D}function $(D){return D.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")}function J(D){return function(W){return new Promise(function(H){setTimeout(function(){H(W)},D)})}}function rt(D){for(var W=[],H=D.length,Y=0;Y<H;Y++)W.push(D[Y]);return W}function it(D){return D.replace(/#/g,"%23").replace(/\n/g,"%0A")}function ht(D){var W=ut(D,"border-left-width"),H=ut(D,"border-right-width");return D.scrollWidth+W+H}function nt(D){var W=ut(D,"border-top-width"),H=ut(D,"border-bottom-width");return D.scrollHeight+W+H}function ut(D,W){var H=window.getComputedStyle(D).getPropertyValue(W);return parseFloat(H.replace("px",""))}}function O(){var E=/url\(['"]?([^'"]+?)['"]?\)/g;return{inlineAll:G,shouldProcess:_,impl:{readUrls:j,inline:X}};function _(R){return R.search(E)!==-1}function j(R){for(var B=[],V;(V=E.exec(R))!==null;)B.push(V[1]);return B.filter(function(Q){return!e.isDataUrl(Q)})}function X(R,B,V,Q){return Promise.resolve(B).then(function(z){return V?e.resolveUrl(z,V):z}).then(Q||e.getAndEncode).then(function(z){return e.dataAsUrl(z,e.mimeType(B))}).then(function(z){return R.replace(tt(B),"$1"+z+"$3")});function tt(z){return new RegExp(`(url\\(['"]?)(`+e.escape(z)+`)(['"]?\\))`,"g")}}function G(R,B,V){if(Q())return Promise.resolve(R);return Promise.resolve(R).then(j).then(function(tt){var z=Promise.resolve(R);return tt.forEach(function($){z=z.then(function(J){return X(J,$,B,V)})}),z});function Q(){return!_(R)}}}function P(){return{resolveAll:E,impl:{readAll:_}};function E(){return _().then(function(j){return Promise.all(j.map(function(X){return X.resolve()}))}).then(function(j){return j.join(`
`)})}function _(){return Promise.resolve(e.asArray(document.styleSheets)).then(X).then(j).then(function(R){return R.map(G)});function j(R){return R.filter(function(B){return B.type===CSSRule.FONT_FACE_RULE}).filter(function(B){return r.shouldProcess(B.style.getPropertyValue("src"))})}function X(R){var B=[];return R.forEach(function(V){try{e.asArray(V.cssRules||[]).forEach(B.push.bind(B))}catch(Q){console.log("Error while reading CSS rules from "+V.href,Q.toString())}}),B}function G(R){return{resolve:function(){var V=(R.parentStyleSheet||{}).href;return r.inlineAll(R.cssText,V)},src:function(){return R.style.getPropertyValue("src")}}}}}function L(){return{inlineAll:_,impl:{newImage:E}};function E(j){return{inline:X};function X(G){return e.isDataUrl(j.src)?Promise.resolve():Promise.resolve(j.src).then(G||e.getAndEncode).then(function(R){return e.dataAsUrl(R,e.mimeType(j.src))}).then(function(R){return new Promise(function(B,V){j.onload=B,j.onerror=V,j.src=R})})}}function _(j){if(!(j instanceof Element))return Promise.resolve(j);return X(j).then(function(){return j instanceof HTMLImageElement?E(j).inline():Promise.all(e.asArray(j.childNodes).map(function(G){return _(G)}))});function X(G){var R=G.style.getPropertyValue("background");return R?r.inlineAll(R).then(function(B){G.style.setProperty("background",B,G.style.getPropertyPriority("background"))}).then(function(){return G}):Promise.resolve(G)}}}})()})(qn)),qn.exports}var Vd=zd();const Wd=Kh(Vd);function $n(a,t,e){return Math.max(t,Math.min(e,a))}function on(a){a.preventDefault()}var Hd=new Set(["ArrowUp","ArrowRight","ArrowDown","ArrowLeft"]);function Yd(a){if(Hd.has(a.key))return on(a),!1}var Il=new AbortController,Pi=Il.signal;function Xd(){window.addEventListener("DOMMouseScroll",on,{signal:Pi}),window.addEventListener("wheel",on,{passive:!1,signal:Pi}),window.addEventListener("touchmove",on,{passive:!1,signal:Pi}),window.addEventListener("keydown",Yd,{signal:Pi})}function Kn(){Il?.abort()}function _a(a,t){return{x:(a.x+t.x)/2,y:(a.y+t.y)/2}}function Nd(a,t){const e=_a(a[0],a[1]),r=_a(t[0],t[1]),s={x:r.x-e.x,y:r.y-e.y},i=Math.hypot(a[0].x-a[1].x,a[0].y-a[1].y);let o=Math.hypot(t[0].x-t[1].x,t[0].y-t[1].y)/i;const l=1e-5;return Math.abs(o-1)<l&&(o=1+l),{scale:o,center:{x:e.x+s.x/(1-o),y:e.y+s.y/(1-o)}}}function _s(a,t){return e=>{a()&&t(e)}}function Ud(a){let t=new Set,e=!1,r=a,s,i=(o={})=>{s={...s,...o},n()},n=()=>{if(e)return;let o=!1;if(s){for(let l in s)if(r[l]!==s[l]){o=!0;break}}o&&(r={...r,...s},t.forEach(l=>l({state:r,updatedProperties:s})),s=void 0)};return{subscribe:o=>(t.add(o),()=>{t.delete(o)}),cleanup:()=>t.clear(),getState:()=>r,setState:i,batch:o=>{e=!0,o(),e=!1,n()}}}var ya=.5,xa={currentZoom:1,enable:!0,currentPositionX:0,currentPositionY:0,currentRotation:0},Gd=()=>!0;function qd(a,t={}){const e={maxZoom:t.maxZoom||4,wheelZoomRatio:t.wheelZoomRatio||.1,dblTapAnimationDuration:t.dblTapAnimationDuration||300,initialState:{...xa,...t.initialState},shouldZoomOnSingleTouch:t.shouldZoomOnSingleTouch||Gd,zoomTarget:t.zoomTarget===void 0?a.querySelector("img"):t.zoomTarget},r=Ud(e.initialState),s=()=>[90,270].includes(r.getState().currentRotation%360),i=(D,W,H)=>{if(D>0)return 0;const Y=H?a.clientHeight:a.clientWidth;return D+Y*W<Y?-Y*(W-1):D},n=(D,W,H)=>{if(D>0)return 0;const Y=H?a.clientWidth:a.clientHeight;return D+Y*W<Y?-Y*(W-1):D},o=D=>{const W=a.clientWidth/2,H=a.clientHeight/2,Y=r.getState(),M=(W-Y.currentPositionX)/Y.currentZoom,Z=(H-Y.currentPositionY)/Y.currentZoom;r.setState({currentZoom:D,currentPositionX:i(-M*D+W,D,!1),currentPositionY:n(-Z*D+H,D,!1)})};let l=null,c=!0;const u=new Map;let d=0,g=0,f=0,m=0;a.style.overflow="hidden";let p=e.zoomTarget;function v(){const D=r.getState();p&&(p.style.transformOrigin="0 0",p.style.transform=`translate(${D.currentPositionX}px, ${D.currentPositionY}px) scale(${D.currentZoom})`,a.style.rotate=`${D.currentRotation}deg`)}function x(D){"zoomTarget"in D&&(p=D.zoomTarget??null),r.batch(()=>{const W=r.getState();if(!(typeof D.enable=="boolean"&&D.enable!==W.enable&&(r.setState({enable:D.enable}),!D.enable))){if(typeof D.currentRotation=="number"){const H=D.currentRotation;r.setState({currentRotation:H})}if(typeof D.currentZoom=="number"&&D.currentZoom!==W.currentZoom){const H=$n(D.currentZoom,1,e.maxZoom);if(H===W.currentZoom)return;o(H)}}}),v()}function T({delta:D,x:W,y:H}){const Y=a.getBoundingClientRect(),M=r.getState(),Z=s();let ft=-1,Lt=-1;switch(M.currentRotation%360){case 0:ft=W-Y.left,Lt=H-Y.top;break;case 90:ft=Math.abs(W-Y.right),Lt=Math.abs(H-Y.top);break;case 180:ft=Math.abs(W-Y.right),Lt=Math.abs(H-Y.bottom);break;case 270:ft=Math.abs(W-Y.left),Lt=Math.abs(H-Y.bottom);break}const vt=Z?M.currentPositionY:M.currentPositionX,Pt=Z?M.currentPositionX:M.currentPositionY,Ht=(ft-vt)/M.currentZoom,ke=(Lt-Pt)/M.currentZoom,Vt=$n(M.currentZoom+D*e.wheelZoomRatio*M.currentZoom,1,e.maxZoom),fe=i(-Ht*Vt+ft,Vt,Z),Ft=n(-ke*Vt+Lt,Vt,Z);r.setState({currentZoom:Vt,currentPositionX:Z?Ft:fe,currentPositionY:Z?fe:Ft})}function A(){if(u.size===1){const{x:W,y:H}=u.values().next().value,Y=s();f=Y?H:W,m=Y?W:H}const D=r.getState();d=D.currentPositionX,g=D.currentPositionY}function O(D){if(D.preventDefault(),r.getState().currentZoom===e.maxZoom&&D.deltaY<0)return;const W=-$n(D.deltaY,-ya,ya);T({delta:W,x:D.clientX,y:D.clientY}),v(),A()}function P(D){D.preventDefault();const{clientX:W,clientY:H,pointerId:Y}=D;for(const[ft]of u.entries())ft===Y&&u.set(ft,{x:W,y:H});const{currentZoom:M,currentRotation:Z}=r.getState();if(u.size===1&&M!==1){const ft=s(),Lt=ft?H:W,vt=ft?W:H;let Pt=-1,Ht=-1;switch(Z%360){case 0:Pt=Lt-f,Ht=vt-m;break;case 90:Pt=Lt-f,Ht=m-vt;break;case 180:Pt=f-Lt,Ht=m-vt;break;case 270:Pt=f-Lt,Ht=vt-m;break}r.setState({currentPositionX:i(d+Pt,M,!1),currentPositionY:n(g+Ht,M,!1)}),v()}}const L={startTimestamp:null,start:{x:0,y:0,zoom:0},target:{x:0,y:0,zoom:0}};function E(D){const W=r.getState();L.startTimestamp=null,L.start={x:W.currentPositionX,y:W.currentPositionY,zoom:W.currentZoom},W.currentZoom>1?L.target={x:0,y:0,zoom:1}:L.target={zoom:e.maxZoom,x:D.x*(1-e.maxZoom),y:D.y*(1-e.maxZoom)};function H(M,Z,ft){return M*(1-ft)+Z*ft}function Y(M){L.startTimestamp===null&&(L.startTimestamp=M);let Z=(M-L.startTimestamp)/e.dblTapAnimationDuration;Z>1&&(Z=1),r.setState({currentPositionX:H(L.start.x,L.target.x,Z),currentPositionY:H(L.start.y,L.target.y,Z),currentZoom:H(L.start.zoom,L.target.zoom,Z)}),v(),Z<1&&requestAnimationFrame(Y)}requestAnimationFrame(Y)}let _=null;const j=300;function X(D){if(!(D.touches.length>1))if(_===null)_=setTimeout(()=>{_=null},j);else{clearTimeout(_),_=null;const W=a.getBoundingClientRect(),H=D.touches[0];E({x:H.clientX-W.left,y:H.clientY-W.top});return}}function G(D){if(e.shouldZoomOnSingleTouch()&&D.preventDefault(),D.touches.length>1){D.preventDefault();const W=[...D.touches].map(H=>({x:H.clientX,y:H.clientY}));if(l!==null){const{scale:H,center:Y}=Nd(l,W);T({delta:Math.log(H)/e.wheelZoomRatio,...Y})}l=W,v();return}}function R(D){if(D.pointerType==="touch"&&!e.shouldZoomOnSingleTouch()||(D.preventDefault(),u.size===2))return;c&&(Xd(),c=!1);const{clientX:W,clientY:H,pointerId:Y}=D,M=r.getState();d=M.currentPositionX,g=M.currentPositionY;const Z=s();f=Z?H:W,m=Z?W:H,u.set(Y,{x:W,y:H})}function B(D){u.delete(D.pointerId),u.size<2&&(l=null),u.size===0&&!c&&(Kn(),c=!0),A()}function V(D){D.preventDefault(),u.delete(D.pointerId),l=null,c||(Kn(),c=!0)}function Q(){return r.getState().enable}const tt=_s(Q,O),z=_s(Q,R),$=_s(Q,V),J=_s(Q,P),rt=_s(Q,B),it=_s(Q,X),ht=_s(Q,G),nt=new AbortController,{signal:ut}=nt;return a.addEventListener("wheel",tt,{signal:ut}),a.addEventListener("touchstart",it,{signal:ut}),a.addEventListener("touchmove",ht,{signal:ut}),a.addEventListener("pointerdown",z,{signal:ut}),a.addEventListener("pointerleave",$,{signal:ut}),a.addEventListener("pointermove",J,{signal:ut}),a.addEventListener("pointerup",rt,{signal:ut}),a.addEventListener("touchend",()=>{c=!0,Kn()},{signal:ut}),r.getState().currentZoom!==xa.currentZoom&&(o(r.getState().currentZoom),v()),{cleanup(){nt.abort(),r.cleanup()},subscribe:r.subscribe,setState:x,getState:r.getState}}const $d=(a,t)=>{const e=qd(a,{maxZoom:10,initialState:Rt.zoomState}),r=[Rt.on({ZoomChange:i=>e.setState(i)}),e.subscribe(({state:i})=>Rt.onZoomChange(i))],s=i=>{t?.disabled&&i.stopImmediatePropagation()};return a.addEventListener("wheel",s,{capture:!0}),a.addEventListener("pointerdown",s,{capture:!0}),a.style.overflow="visible",{update(i){t=i},destroy(){for(const i of r)i();a.removeEventListener("wheel",s,{capture:!0}),a.removeEventListener("pointerdown",s,{capture:!0}),e.cleanup()}}};function S(a,t,e){return(t=(function(r){var s=(function(i,n){if(typeof i!="object"||!i)return i;var o=i[Symbol.toPrimitive];if(o!==void 0){var l=o.call(i,n);if(typeof l!="object")return l;throw new TypeError("@@toPrimitive must return a primitive value.")}return(n==="string"?String:Number)(i)})(r,"string");return typeof s=="symbol"?s:s+""})(t))in a?Object.defineProperty(a,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):a[t]=e,a}function wa(a,t){var e=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);t&&(r=r.filter((function(s){return Object.getOwnPropertyDescriptor(a,s).enumerable}))),e.push.apply(e,r)}return e}function C(a){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?wa(Object(e),!0).forEach((function(r){S(a,r,e[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(e)):wa(Object(e)).forEach((function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(e,r))}))}return a}function ie(a,t){if(a==null)return{};var e,r,s=(function(n,o){if(n==null)return{};var l={};for(var c in n)if({}.hasOwnProperty.call(n,c)){if(o.indexOf(c)>=0)continue;l[c]=n[c]}return l})(a,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(a);for(r=0;r<i.length;r++)e=i[r],t.indexOf(e)>=0||{}.propertyIsEnumerable.call(a,e)&&(s[e]=a[e])}return s}function Er(a,t){return t||(t=a.slice(0)),Object.freeze(Object.defineProperties(a,{raw:{value:Object.freeze(t)}}))}class ba{constructor(){S(this,"browserShadowBlurConstant",1),S(this,"DPI",96),S(this,"devicePixelRatio",typeof window<"u"?window.devicePixelRatio:1),S(this,"perfLimitSizeTotal",2097152),S(this,"maxCacheSideLimit",4096),S(this,"minCacheSideLimit",256),S(this,"disableStyleCopyPaste",!1),S(this,"enableGLFiltering",!0),S(this,"textureSize",4096),S(this,"forceGLPutImageData",!1),S(this,"cachesBoundsOfCurve",!1),S(this,"fontPaths",{}),S(this,"NUM_FRACTION_DIGITS",4)}}const Wt=new class extends ba{constructor(a){super(),this.configure(a)}configure(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};Object.assign(this,a)}addFonts(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.fontPaths=C(C({},this.fontPaths),a)}removeFonts(){(arguments.length>0&&arguments[0]!==void 0?arguments[0]:[]).forEach((a=>{delete this.fontPaths[a]}))}clearFonts(){this.fontPaths={}}restoreDefaults(a){const t=new ba,e=a?.reduce(((r,s)=>(r[s]=t[s],r)),{})||t;this.configure(e)}},gs=function(a){for(var t=arguments.length,e=new Array(t>1?t-1:0),r=1;r<t;r++)e[r-1]=arguments[r];return console[a]("fabric",...e)};class Tr extends Error{constructor(t,e){super("fabric: ".concat(t),e)}}class Kd extends Tr{constructor(t){super("".concat(t," 'options.signal' is in 'aborted' state"))}}class Zd{}class Jd extends Zd{testPrecision(t,e){const r="precision ".concat(e,` float;
void main(){}`),s=t.createShader(t.FRAGMENT_SHADER);return!!s&&(t.shaderSource(s,r),t.compileShader(s),!!t.getShaderParameter(s,t.COMPILE_STATUS))}queryWebGL(t){const e=t.getContext("webgl");e&&(this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.GLPrecision=["highp","mediump","lowp"].find((r=>this.testPrecision(e,r))),e.getExtension("WEBGL_lose_context").loseContext(),gs("log","WebGL: max texture size ".concat(this.maxTextureSize)))}isSupported(t){return!!this.maxTextureSize&&this.maxTextureSize>=t}}const Qd={};let Sa;const Ar=()=>Sa||(Sa={document,window,isTouchSupported:"ontouchstart"in window||"ontouchstart"in document||window&&window.navigator&&window.navigator.maxTouchPoints>0,WebGLProbe:new Jd,dispose(){},copyPasteData:Qd}),Zs=()=>Ar().document,Fn=()=>Ar().window,Ll=()=>{var a;return Math.max((a=Wt.devicePixelRatio)!==null&&a!==void 0?a:Fn().devicePixelRatio,1)},gi=new class{constructor(){S(this,"boundsOfCurveCache",{}),this.charWidthsCache=new Map}getFontCache(a){let{fontFamily:t,fontStyle:e,fontWeight:r}=a;t=t.toLowerCase();const s=this.charWidthsCache;s.has(t)||s.set(t,new Map);const i=s.get(t),n="".concat(e.toLowerCase(),"_").concat((r+"").toLowerCase());return i.has(n)||i.set(n,new Map),i.get(n)}clearFontCache(a){a?this.charWidthsCache.delete((a||"").toLowerCase()):this.charWidthsCache=new Map}limitDimsByArea(a){const{perfLimitSizeTotal:t}=Wt,e=Math.sqrt(t*a);return[Math.floor(e),Math.floor(t/e)]}},fo="6.9.1";function an(){}const Oi=Math.PI/2,yn=2*Math.PI,jo=Math.PI/180,Fe=Object.freeze([1,0,0,1,0,0]),Ro=16,ns=.4477152502,Bt="center",$t="left",Ve="top",mo="bottom",de="right",We="none",Bo=/\r?\n/,Fl="moving",jn="scaling",jl="rotating",zo="rotate",Rl="skewing",xi="resizing",tg="modifyPoly",eg="modifyPath",xn="changed",Rn="scale",Ye="scaleX",rr="scaleY",Js="skewX",Qs="skewY",_e="fill",He="stroke",wn="modified",Fs="json",Zn="svg",gt=new class{constructor(){this[Fs]=new Map,this[Zn]=new Map}has(a){return this[Fs].has(a)}getClass(a){const t=this[Fs].get(a);if(!t)throw new Tr("No class registered for ".concat(a));return t}setClass(a,t){t?this[Fs].set(t,a):(this[Fs].set(a.type,a),this[Fs].set(a.type.toLowerCase(),a))}getSVGClass(a){return this[Zn].get(a)}setSVGClass(a,t){this[Zn].set(t??a.type.toLowerCase(),a)}},bn=new class extends Array{remove(a){const t=this.indexOf(a);t>-1&&this.splice(t,1)}cancelAll(){const a=this.splice(0);return a.forEach((t=>t.abort())),a}cancelByCanvas(a){if(!a)return[];const t=this.filter((e=>{var r;return e.target===a||typeof e.target=="object"&&((r=e.target)===null||r===void 0?void 0:r.canvas)===a}));return t.forEach((e=>e.abort())),t}cancelByTarget(a){if(!a)return[];const t=this.filter((e=>e.target===a));return t.forEach((e=>e.abort())),t}};class rg{constructor(){S(this,"__eventListeners",{})}on(t,e){if(this.__eventListeners||(this.__eventListeners={}),typeof t=="object")return Object.entries(t).forEach((r=>{let[s,i]=r;this.on(s,i)})),()=>this.off(t);if(e){const r=t;return this.__eventListeners[r]||(this.__eventListeners[r]=[]),this.__eventListeners[r].push(e),()=>this.off(r,e)}return()=>!1}once(t,e){if(typeof t=="object"){const r=[];return Object.entries(t).forEach((s=>{let[i,n]=s;r.push(this.once(i,n))})),()=>r.forEach((s=>s()))}if(e){const r=this.on(t,(function(){for(var s=arguments.length,i=new Array(s),n=0;n<s;n++)i[n]=arguments[n];e.call(this,...i),r()}));return r}return()=>!1}_removeEventListener(t,e){if(this.__eventListeners[t])if(e){const r=this.__eventListeners[t],s=r.indexOf(e);s>-1&&r.splice(s,1)}else this.__eventListeners[t]=[]}off(t,e){if(this.__eventListeners)if(t===void 0)for(const r in this.__eventListeners)this._removeEventListener(r);else typeof t=="object"?Object.entries(t).forEach((r=>{let[s,i]=r;this._removeEventListener(s,i)})):this._removeEventListener(t,e)}fire(t,e){var r;if(!this.__eventListeners)return;const s=(r=this.__eventListeners[t])===null||r===void 0?void 0:r.concat();if(s)for(let i=0;i<s.length;i++)s[i].call(this,e||{})}}const Bs=(a,t)=>{const e=a.indexOf(t);return e!==-1&&a.splice(e,1),a},Gr=a=>{if(a===0)return 1;switch(Math.abs(a)/Oi){case 1:case 3:return 0;case 2:return-1}return Math.cos(a)},qr=a=>{if(a===0)return 0;const t=a/Oi,e=Math.sign(a);switch(t){case 1:return e;case 2:return 0;case 3:return-e}return Math.sin(a)};class F{constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;typeof t=="object"?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e)}add(t){return new F(this.x+t.x,this.y+t.y)}addEquals(t){return this.x+=t.x,this.y+=t.y,this}scalarAdd(t){return new F(this.x+t,this.y+t)}scalarAddEquals(t){return this.x+=t,this.y+=t,this}subtract(t){return new F(this.x-t.x,this.y-t.y)}subtractEquals(t){return this.x-=t.x,this.y-=t.y,this}scalarSubtract(t){return new F(this.x-t,this.y-t)}scalarSubtractEquals(t){return this.x-=t,this.y-=t,this}multiply(t){return new F(this.x*t.x,this.y*t.y)}scalarMultiply(t){return new F(this.x*t,this.y*t)}scalarMultiplyEquals(t){return this.x*=t,this.y*=t,this}divide(t){return new F(this.x/t.x,this.y/t.y)}scalarDivide(t){return new F(this.x/t,this.y/t)}scalarDivideEquals(t){return this.x/=t,this.y/=t,this}eq(t){return this.x===t.x&&this.y===t.y}lt(t){return this.x<t.x&&this.y<t.y}lte(t){return this.x<=t.x&&this.y<=t.y}gt(t){return this.x>t.x&&this.y>t.y}gte(t){return this.x>=t.x&&this.y>=t.y}lerp(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:.5;return e=Math.max(Math.min(1,e),0),new F(this.x+(t.x-this.x)*e,this.y+(t.y-this.y)*e)}distanceFrom(t){const e=this.x-t.x,r=this.y-t.y;return Math.sqrt(e*e+r*r)}midPointFrom(t){return this.lerp(t)}min(t){return new F(Math.min(this.x,t.x),Math.min(this.y,t.y))}max(t){return new F(Math.max(this.x,t.x),Math.max(this.y,t.y))}toString(){return"".concat(this.x,",").concat(this.y)}setXY(t,e){return this.x=t,this.y=e,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setFromPoint(t){return this.x=t.x,this.y=t.y,this}swap(t){const e=this.x,r=this.y;this.x=t.x,this.y=t.y,t.x=e,t.y=r}clone(){return new F(this.x,this.y)}rotate(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Vo;const r=qr(t),s=Gr(t),i=this.subtract(e);return new F(i.x*s-i.y*r,i.x*r+i.y*s).add(e)}transform(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new F(t[0]*this.x+t[2]*this.y+(e?0:t[4]),t[1]*this.x+t[3]*this.y+(e?0:t[5]))}}const Vo=new F(0,0),ln=a=>!!a&&Array.isArray(a._objects);function Bl(a){class t extends a{constructor(){super(...arguments),S(this,"_objects",[])}_onObjectAdded(r){}_onObjectRemoved(r){}_onStackOrderChanged(r){}add(){for(var r=arguments.length,s=new Array(r),i=0;i<r;i++)s[i]=arguments[i];const n=this._objects.push(...s);return s.forEach((o=>this._onObjectAdded(o))),n}insertAt(r){for(var s=arguments.length,i=new Array(s>1?s-1:0),n=1;n<s;n++)i[n-1]=arguments[n];return this._objects.splice(r,0,...i),i.forEach((o=>this._onObjectAdded(o))),this._objects.length}remove(){const r=this._objects,s=[];for(var i=arguments.length,n=new Array(i),o=0;o<i;o++)n[o]=arguments[o];return n.forEach((l=>{const c=r.indexOf(l);c!==-1&&(r.splice(c,1),s.push(l),this._onObjectRemoved(l))})),s}forEachObject(r){this.getObjects().forEach(((s,i,n)=>r(s,i,n)))}getObjects(){for(var r=arguments.length,s=new Array(r),i=0;i<r;i++)s[i]=arguments[i];return s.length===0?[...this._objects]:this._objects.filter((n=>n.isType(...s)))}item(r){return this._objects[r]}isEmpty(){return this._objects.length===0}size(){return this._objects.length}contains(r,s){return!!this._objects.includes(r)||!!s&&this._objects.some((i=>i instanceof t&&i.contains(r,!0)))}complexity(){return this._objects.reduce(((r,s)=>r+=s.complexity?s.complexity():0),0)}sendObjectToBack(r){return!(!r||r===this._objects[0])&&(Bs(this._objects,r),this._objects.unshift(r),this._onStackOrderChanged(r),!0)}bringObjectToFront(r){return!(!r||r===this._objects[this._objects.length-1])&&(Bs(this._objects,r),this._objects.push(r),this._onStackOrderChanged(r),!0)}sendObjectBackwards(r,s){if(!r)return!1;const i=this._objects.indexOf(r);if(i!==0){const n=this.findNewLowerIndex(r,i,s);return Bs(this._objects,r),this._objects.splice(n,0,r),this._onStackOrderChanged(r),!0}return!1}bringObjectForward(r,s){if(!r)return!1;const i=this._objects.indexOf(r);if(i!==this._objects.length-1){const n=this.findNewUpperIndex(r,i,s);return Bs(this._objects,r),this._objects.splice(n,0,r),this._onStackOrderChanged(r),!0}return!1}moveObjectTo(r,s){return r!==this._objects[s]&&(Bs(this._objects,r),this._objects.splice(s,0,r),this._onStackOrderChanged(r),!0)}findNewLowerIndex(r,s,i){let n;if(i){n=s;for(let o=s-1;o>=0;--o)if(r.isOverlapping(this._objects[o])){n=o;break}}else n=s-1;return n}findNewUpperIndex(r,s,i){let n;if(i){n=s;for(let o=s+1;o<this._objects.length;++o)if(r.isOverlapping(this._objects[o])){n=o;break}}else n=s+1;return n}collectObjects(r){let{left:s,top:i,width:n,height:o}=r,{includeIntersecting:l=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const c=[],u=new F(s,i),d=u.add(new F(n,o));for(let g=this._objects.length-1;g>=0;g--){const f=this._objects[g];f.selectable&&f.visible&&(l&&f.intersectsWithRect(u,d)||f.isContainedWithinRect(u,d)||l&&f.containsPoint(u)||l&&f.containsPoint(d))&&c.push(f)}return c}}return t}class zl extends rg{_setOptions(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};for(const e in t)this.set(e,t[e])}_setObject(t){for(const e in t)this._set(e,t[e])}set(t,e){return typeof t=="object"?this._setObject(t):this._set(t,e),this}_set(t,e){this[t]=e}toggle(t){const e=this.get(t);return typeof e=="boolean"&&this.set(t,!e),this}get(t){return this[t]}}function cn(a){return Fn().requestAnimationFrame(a)}function sg(a){return Fn().cancelAnimationFrame(a)}let ig=0;const fs=()=>ig++,$r=()=>{const a=Zs().createElement("canvas");if(!a||a.getContext===void 0)throw new Tr("Failed to create `canvas` element");return a},ng=()=>Zs().createElement("img"),sr=a=>{const t=$r();return t.width=a.width,t.height=a.height,t},Vl=(a,t,e)=>a.toDataURL("image/".concat(t),e),Wl=(a,t,e)=>new Promise(((r,s)=>{a.toBlob(r,"image/".concat(t),e)})),ge=a=>a*jo,Kr=a=>a/jo,og=a=>a.every(((t,e)=>t===Fe[e])),Re=(a,t,e)=>new F(a).transform(t,e),ur=a=>{const t=1/(a[0]*a[3]-a[1]*a[2]),e=[t*a[3],-t*a[1],-t*a[2],t*a[0],0,0],{x:r,y:s}=new F(a[4],a[5]).transform(e,!0);return e[4]=-r,e[5]=-s,e},Te=(a,t,e)=>[a[0]*t[0]+a[2]*t[1],a[1]*t[0]+a[3]*t[1],a[0]*t[2]+a[2]*t[3],a[1]*t[2]+a[3]*t[3],e?0:a[0]*t[4]+a[2]*t[5]+a[4],e?0:a[1]*t[4]+a[3]*t[5]+a[5]],Wo=(a,t)=>a.reduceRight(((e,r)=>r&&e?Te(r,e,t):r||e),void 0)||Fe.concat(),Hl=a=>{let[t,e]=a;return Math.atan2(e,t)},Sn=a=>{const t=Hl(a),e=Math.pow(a[0],2)+Math.pow(a[1],2),r=Math.sqrt(e),s=(a[0]*a[3]-a[2]*a[1])/r,i=Math.atan2(a[0]*a[2]+a[1]*a[3],e);return{angle:Kr(t),scaleX:r,scaleY:s,skewX:Kr(i),skewY:0,translateX:a[4]||0,translateY:a[5]||0}},Ai=function(a){return[1,0,0,1,a,arguments.length>1&&arguments[1]!==void 0?arguments[1]:0]};function ti(){let{angle:a=0}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{x:t=0,y:e=0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const r=ge(a),s=Gr(r),i=qr(r);return[s,i,-i,s,t?t-(s*t-i*e):0,e?e-(i*t+s*e):0]}const Ho=function(a){return[a,0,0,arguments.length>1&&arguments[1]!==void 0?arguments[1]:a,0,0]},Yl=a=>Math.tan(ge(a)),Xl=a=>[1,0,Yl(a),1,0,0],Nl=a=>[1,Yl(a),0,1,0,0],Bn=a=>{let{scaleX:t=1,scaleY:e=1,flipX:r=!1,flipY:s=!1,skewX:i=0,skewY:n=0}=a,o=Ho(r?-t:t,s?-e:e);return i&&(o=Te(o,Xl(i),!0)),n&&(o=Te(o,Nl(n),!0)),o},ag=a=>{const{translateX:t=0,translateY:e=0,angle:r=0}=a;let s=Ai(t,e);r&&(s=Te(s,ti({angle:r})));const i=Bn(a);return og(i)||(s=Te(s,i)),s},hn=function(a){let{signal:t,crossOrigin:e=null}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return new Promise((function(r,s){if(t&&t.aborted)return s(new Kd("loadImage"));const i=ng();let n;t&&(n=function(l){i.src="",s(l)},t.addEventListener("abort",n,{once:!0}));const o=function(){i.onload=i.onerror=null,n&&t?.removeEventListener("abort",n),r(i)};a?(i.onload=o,i.onerror=function(){n&&t?.removeEventListener("abort",n),s(new Tr("Error loading ".concat(i.src)))},e&&(i.crossOrigin=e),i.src=a):o()}))},wi=function(a){let{signal:t,reviver:e=an}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return new Promise(((r,s)=>{const i=[];t&&t.addEventListener("abort",s,{once:!0}),Promise.all(a.map((n=>gt.getClass(n.type).fromObject(n,{signal:t}).then((o=>(e(n,o),i.push(o),o)))))).then(r).catch((n=>{i.forEach((o=>{o.dispose&&o.dispose()})),s(n)})).finally((()=>{t&&t.removeEventListener("abort",s)}))}))},zn=function(a){let{signal:t}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return new Promise(((e,r)=>{const s=[];t&&t.addEventListener("abort",r,{once:!0});const i=Object.values(a).map((o=>o&&o.type&&gt.has(o.type)?wi([o],{signal:t}).then((l=>{let[c]=l;return s.push(c),c})):o)),n=Object.keys(a);Promise.all(i).then((o=>o.reduce(((l,c,u)=>(l[n[u]]=c,l)),{}))).then(e).catch((o=>{s.forEach((l=>{l.dispose&&l.dispose()})),r(o)})).finally((()=>{t&&t.removeEventListener("abort",r)}))}))},ei=function(a){return(arguments.length>1&&arguments[1]!==void 0?arguments[1]:[]).reduce(((t,e)=>(e in a&&(t[e]=a[e]),t)),{})},Yo=(a,t)=>Object.keys(a).reduce(((e,r)=>(t(a[r],r,a)&&(e[r]=a[r]),e)),{}),re=(a,t)=>parseFloat(Number(a).toFixed(t)),bi=a=>"matrix("+a.map((t=>re(t,Wt.NUM_FRACTION_DIGITS))).join(" ")+")",Ze=a=>!!a&&a.toLive!==void 0,Ca=a=>!!a&&typeof a.toObject=="function",Ta=a=>!!a&&a.offsetX!==void 0&&"source"in a,ys=a=>!!a&&"multiSelectionStacking"in a;function Ul(a){const t=a&&hr(a);let e=0,r=0;if(!a||!t)return{left:e,top:r};let s=a;const i=t.documentElement,n=t.body||{scrollLeft:0,scrollTop:0};for(;s&&(s.parentNode||s.host)&&(s=s.parentNode||s.host,s===t?(e=n.scrollLeft||i.scrollLeft||0,r=n.scrollTop||i.scrollTop||0):(e+=s.scrollLeft||0,r+=s.scrollTop||0),s.nodeType!==1||s.style.position!=="fixed"););return{left:e,top:r}}const hr=a=>a.ownerDocument||null,Gl=a=>{var t;return((t=a.ownerDocument)===null||t===void 0?void 0:t.defaultView)||null},ql=function(a,t,e){let{width:r,height:s}=e,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1;a.width=r,a.height=s,i>1&&(a.setAttribute("width",(r*i).toString()),a.setAttribute("height",(s*i).toString()),t.scale(i,i))},po=(a,t)=>{let{width:e,height:r}=t;e&&(a.style.width=typeof e=="number"?"".concat(e,"px"):e),r&&(a.style.height=typeof r=="number"?"".concat(r,"px"):r)};function ka(a){return a.onselectstart!==void 0&&(a.onselectstart=()=>!1),a.style.userSelect=We,a}class $l{constructor(t){S(this,"_originalCanvasStyle",void 0),S(this,"lower",void 0);const e=this.createLowerCanvas(t);this.lower={el:e,ctx:e.getContext("2d")}}createLowerCanvas(t){const e=(r=t)&&r.getContext!==void 0?t:t&&Zs().getElementById(t)||$r();var r;if(e.hasAttribute("data-fabric"))throw new Tr("Trying to initialize a canvas that has already been initialized. Did you forget to dispose the canvas?");return this._originalCanvasStyle=e.style.cssText,e.setAttribute("data-fabric","main"),e.classList.add("lower-canvas"),e}cleanupDOM(t){let{width:e,height:r}=t;const{el:s}=this.lower;s.classList.remove("lower-canvas"),s.removeAttribute("data-fabric"),s.setAttribute("width","".concat(e)),s.setAttribute("height","".concat(r)),s.style.cssText=this._originalCanvasStyle||"",this._originalCanvasStyle=void 0}setDimensions(t,e){const{el:r,ctx:s}=this.lower;ql(r,s,t,e)}setCSSDimensions(t){po(this.lower.el,t)}calcOffset(){return(function(t){var e;const r=t&&hr(t),s={left:0,top:0};if(!r)return s;const i=((e=Gl(t))===null||e===void 0?void 0:e.getComputedStyle(t,null))||{};s.left+=parseInt(i.borderLeftWidth,10)||0,s.top+=parseInt(i.borderTopWidth,10)||0,s.left+=parseInt(i.paddingLeft,10)||0,s.top+=parseInt(i.paddingTop,10)||0;let n={left:0,top:0};const o=r.documentElement;t.getBoundingClientRect!==void 0&&(n=t.getBoundingClientRect());const l=Ul(t);return{left:n.left+l.left-(o.clientLeft||0)+s.left,top:n.top+l.top-(o.clientTop||0)+s.top}})(this.lower.el)}dispose(){Ar().dispose(this.lower.el),delete this.lower}}const lg={backgroundVpt:!0,backgroundColor:"",overlayVpt:!0,overlayColor:"",includeDefaultValues:!0,svgViewportTransformation:!0,renderOnAddRemove:!0,skipOffscreen:!0,enableRetinaScaling:!0,imageSmoothingEnabled:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,viewportTransform:[...Fe]},cg=["objects"];class Di extends Bl(zl){get lowerCanvasEl(){var t;return(t=this.elements.lower)===null||t===void 0?void 0:t.el}get contextContainer(){var t;return(t=this.elements.lower)===null||t===void 0?void 0:t.ctx}static getDefaults(){return Di.ownDefaults}constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),Object.assign(this,this.constructor.getDefaults()),this.set(e),this.initElements(t),this._setDimensionsImpl({width:this.width||this.elements.lower.el.width||0,height:this.height||this.elements.lower.el.height||0}),this.skipControlsDrawing=!1,this.viewportTransform=[...this.viewportTransform],this.calcViewportBoundaries()}initElements(t){this.elements=new $l(t)}add(){const t=super.add(...arguments);return arguments.length>0&&this.renderOnAddRemove&&this.requestRenderAll(),t}insertAt(t){for(var e=arguments.length,r=new Array(e>1?e-1:0),s=1;s<e;s++)r[s-1]=arguments[s];const i=super.insertAt(t,...r);return r.length>0&&this.renderOnAddRemove&&this.requestRenderAll(),i}remove(){const t=super.remove(...arguments);return t.length>0&&this.renderOnAddRemove&&this.requestRenderAll(),t}_onObjectAdded(t){t.canvas&&t.canvas!==this&&(gs("warn",`Canvas is trying to add an object that belongs to a different canvas.
Resulting to default behavior: removing object from previous canvas and adding to new canvas`),t.canvas.remove(t)),t._set("canvas",this),t.setCoords(),this.fire("object:added",{target:t}),t.fire("added",{target:this})}_onObjectRemoved(t){t._set("canvas",void 0),this.fire("object:removed",{target:t}),t.fire("removed",{target:this})}_onStackOrderChanged(){this.renderOnAddRemove&&this.requestRenderAll()}getRetinaScaling(){return this.enableRetinaScaling?Ll():1}calcOffset(){return this._offset=this.elements.calcOffset()}getWidth(){return this.width}getHeight(){return this.height}setWidth(t,e){return this.setDimensions({width:t},e)}setHeight(t,e){return this.setDimensions({height:t},e)}_setDimensionsImpl(t){let{cssOnly:e=!1,backstoreOnly:r=!1}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!e){const s=C({width:this.width,height:this.height},t);this.elements.setDimensions(s,this.getRetinaScaling()),this.hasLostContext=!0,this.width=s.width,this.height=s.height}r||this.elements.setCSSDimensions(t),this.calcOffset()}setDimensions(t,e){this._setDimensionsImpl(t,e),e&&e.cssOnly||this.requestRenderAll()}getZoom(){return this.viewportTransform[0]}setViewportTransform(t){this.viewportTransform=t,this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll()}zoomToPoint(t,e){const r=t,s=[...this.viewportTransform],i=Re(t,ur(s));s[0]=e,s[3]=e;const n=Re(i,s);s[4]+=r.x-n.x,s[5]+=r.y-n.y,this.setViewportTransform(s)}setZoom(t){this.zoomToPoint(new F(0,0),t)}absolutePan(t){const e=[...this.viewportTransform];return e[4]=-t.x,e[5]=-t.y,this.setViewportTransform(e)}relativePan(t){return this.absolutePan(new F(-t.x-this.viewportTransform[4],-t.y-this.viewportTransform[5]))}getElement(){return this.elements.lower.el}clearContext(t){t.clearRect(0,0,this.width,this.height)}getContext(){return this.elements.lower.ctx}clear(){this.remove(...this.getObjects()),this.backgroundImage=void 0,this.overlayImage=void 0,this.backgroundColor="",this.overlayColor="",this.clearContext(this.getContext()),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll()}renderAll(){this.cancelRequestedRender(),this.destroyed||this.renderCanvas(this.getContext(),this._objects)}renderAndReset(){this.nextRenderHandle=0,this.renderAll()}requestRenderAll(){this.nextRenderHandle||this.disposed||this.destroyed||(this.nextRenderHandle=cn((()=>this.renderAndReset())))}calcViewportBoundaries(){const t=this.width,e=this.height,r=ur(this.viewportTransform),s=Re({x:0,y:0},r),i=Re({x:t,y:e},r),n=s.min(i),o=s.max(i);return this.vptCoords={tl:n,tr:new F(o.x,n.y),bl:new F(n.x,o.y),br:o}}cancelRequestedRender(){this.nextRenderHandle&&(sg(this.nextRenderHandle),this.nextRenderHandle=0)}drawControls(t){}renderCanvas(t,e){if(this.destroyed)return;const r=this.viewportTransform,s=this.clipPath;this.calcViewportBoundaries(),this.clearContext(t),t.imageSmoothingEnabled=this.imageSmoothingEnabled,t.patternQuality="best",this.fire("before:render",{ctx:t}),this._renderBackground(t),t.save(),t.transform(r[0],r[1],r[2],r[3],r[4],r[5]),this._renderObjects(t,e),t.restore(),this.controlsAboveOverlay||this.skipControlsDrawing||this.drawControls(t),s&&(s._set("canvas",this),s.shouldCache(),s._transformDone=!0,s.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(t,s)),this._renderOverlay(t),this.controlsAboveOverlay&&!this.skipControlsDrawing&&this.drawControls(t),this.fire("after:render",{ctx:t}),this.__cleanupTask&&(this.__cleanupTask(),this.__cleanupTask=void 0)}drawClipPathOnCanvas(t,e){const r=this.viewportTransform;t.save(),t.transform(...r),t.globalCompositeOperation="destination-in",e.transform(t),t.scale(1/e.zoomX,1/e.zoomY),t.drawImage(e._cacheCanvas,-e.cacheTranslationX,-e.cacheTranslationY),t.restore()}_renderObjects(t,e){for(let r=0,s=e.length;r<s;++r)e[r]&&e[r].render(t)}_renderBackgroundOrOverlay(t,e){const r=this["".concat(e,"Color")],s=this["".concat(e,"Image")],i=this.viewportTransform,n=this["".concat(e,"Vpt")];if(!r&&!s)return;const o=Ze(r);if(r){if(t.save(),t.beginPath(),t.moveTo(0,0),t.lineTo(this.width,0),t.lineTo(this.width,this.height),t.lineTo(0,this.height),t.closePath(),t.fillStyle=o?r.toLive(t):r,n&&t.transform(...i),o){t.transform(1,0,0,1,r.offsetX||0,r.offsetY||0);const l=r.gradientTransform||r.patternTransform;l&&t.transform(...l)}t.fill(),t.restore()}if(s){t.save();const{skipOffscreen:l}=this;this.skipOffscreen=n,n&&t.transform(...i),s.render(t),this.skipOffscreen=l,t.restore()}}_renderBackground(t){this._renderBackgroundOrOverlay(t,"background")}_renderOverlay(t){this._renderBackgroundOrOverlay(t,"overlay")}getCenter(){return{top:this.height/2,left:this.width/2}}getCenterPoint(){return new F(this.width/2,this.height/2)}centerObjectH(t){return this._centerObject(t,new F(this.getCenterPoint().x,t.getCenterPoint().y))}centerObjectV(t){return this._centerObject(t,new F(t.getCenterPoint().x,this.getCenterPoint().y))}centerObject(t){return this._centerObject(t,this.getCenterPoint())}viewportCenterObject(t){return this._centerObject(t,this.getVpCenter())}viewportCenterObjectH(t){return this._centerObject(t,new F(this.getVpCenter().x,t.getCenterPoint().y))}viewportCenterObjectV(t){return this._centerObject(t,new F(t.getCenterPoint().x,this.getVpCenter().y))}getVpCenter(){return Re(this.getCenterPoint(),ur(this.viewportTransform))}_centerObject(t,e){t.setXY(e,Bt,Bt),t.setCoords(),this.renderOnAddRemove&&this.requestRenderAll()}toDatalessJSON(t){return this.toDatalessObject(t)}toObject(t){return this._toObjectMethod("toObject",t)}toJSON(){return this.toObject()}toDatalessObject(t){return this._toObjectMethod("toDatalessObject",t)}_toObjectMethod(t,e){const r=this.clipPath,s=r&&!r.excludeFromExport?this._toObject(r,t,e):null;return C(C(C({version:fo},ei(this,e)),{},{objects:this._objects.filter((i=>!i.excludeFromExport)).map((i=>this._toObject(i,t,e)))},this.__serializeBgOverlay(t,e)),s?{clipPath:s}:null)}_toObject(t,e,r){let s;this.includeDefaultValues||(s=t.includeDefaultValues,t.includeDefaultValues=!1);const i=t[e](r);return this.includeDefaultValues||(t.includeDefaultValues=!!s),i}__serializeBgOverlay(t,e){const r={},s=this.backgroundImage,i=this.overlayImage,n=this.backgroundColor,o=this.overlayColor;return Ze(n)?n.excludeFromExport||(r.background=n.toObject(e)):n&&(r.background=n),Ze(o)?o.excludeFromExport||(r.overlay=o.toObject(e)):o&&(r.overlay=o),s&&!s.excludeFromExport&&(r.backgroundImage=this._toObject(s,t,e)),i&&!i.excludeFromExport&&(r.overlayImage=this._toObject(i,t,e)),r}toSVG(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1?arguments[1]:void 0;t.reviver=e;const r=[];return this._setSVGPreamble(r,t),this._setSVGHeader(r,t),this.clipPath&&r.push('<g clip-path="url(#'.concat(this.clipPath.clipPathId,`)" >
`)),this._setSVGBgOverlayColor(r,"background"),this._setSVGBgOverlayImage(r,"backgroundImage",e),this._setSVGObjects(r,e),this.clipPath&&r.push(`</g>
`),this._setSVGBgOverlayColor(r,"overlay"),this._setSVGBgOverlayImage(r,"overlayImage",e),r.push("</svg>"),r.join("")}_setSVGPreamble(t,e){e.suppressPreamble||t.push('<?xml version="1.0" encoding="',e.encoding||"UTF-8",`" standalone="no" ?>
`,'<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ',`"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
`)}_setSVGHeader(t,e){const r=e.width||"".concat(this.width),s=e.height||"".concat(this.height),i=Wt.NUM_FRACTION_DIGITS,n=e.viewBox;let o;if(n)o='viewBox="'.concat(n.x," ").concat(n.y," ").concat(n.width," ").concat(n.height,'" ');else if(this.svgViewportTransformation){const l=this.viewportTransform;o='viewBox="'.concat(re(-l[4]/l[0],i)," ").concat(re(-l[5]/l[3],i)," ").concat(re(this.width/l[0],i)," ").concat(re(this.height/l[3],i),'" ')}else o='viewBox="0 0 '.concat(this.width," ").concat(this.height,'" ');t.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',r,'" ','height="',s,'" ',o,`xml:space="preserve">
`,"<desc>Created with Fabric.js ",fo,`</desc>
`,`<defs>
`,this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(e),`</defs>
`)}createSVGClipPathMarkup(t){const e=this.clipPath;return e?(e.clipPathId="CLIPPATH_".concat(fs()),'<clipPath id="'.concat(e.clipPathId,`" >
`).concat(e.toClipPathSVG(t.reviver),`</clipPath>
`)):""}createSVGRefElementsMarkup(){return["background","overlay"].map((t=>{const e=this["".concat(t,"Color")];if(Ze(e)){const r=this["".concat(t,"Vpt")],s=this.viewportTransform,i={isType:()=>!1,width:this.width/(r?s[0]:1),height:this.height/(r?s[3]:1)};return e.toSVG(i,{additionalTransform:r?bi(s):""})}})).join("")}createSVGFontFacesMarkup(){const t=[],e={},r=Wt.fontPaths;this._objects.forEach((function i(n){t.push(n),ln(n)&&n._objects.forEach(i)})),t.forEach((i=>{if(!(n=i)||typeof n._renderText!="function")return;var n;const{styles:o,fontFamily:l}=i;!e[l]&&r[l]&&(e[l]=!0,o&&Object.values(o).forEach((c=>{Object.values(c).forEach((u=>{let{fontFamily:d=""}=u;!e[d]&&r[d]&&(e[d]=!0)}))})))}));const s=Object.keys(e).map((i=>`		@font-face {
			font-family: '`.concat(i,`';
			src: url('`).concat(r[i],`');
		}
`))).join("");return s?`	<style type="text/css"><![CDATA[
`.concat(s,`]]></style>
`):""}_setSVGObjects(t,e){this.forEachObject((r=>{r.excludeFromExport||this._setSVGObject(t,r,e)}))}_setSVGObject(t,e,r){t.push(e.toSVG(r))}_setSVGBgOverlayImage(t,e,r){const s=this[e];s&&!s.excludeFromExport&&s.toSVG&&t.push(s.toSVG(r))}_setSVGBgOverlayColor(t,e){const r=this["".concat(e,"Color")];if(r)if(Ze(r)){const s=r.repeat||"",i=this.width,n=this.height,o=this["".concat(e,"Vpt")]?bi(ur(this.viewportTransform)):"";t.push('<rect transform="'.concat(o," translate(").concat(i/2,",").concat(n/2,')" x="').concat(r.offsetX-i/2,'" y="').concat(r.offsetY-n/2,'" width="').concat(s!=="repeat-y"&&s!=="no-repeat"||!Ta(r)?i:r.source.width,'" height="').concat(s!=="repeat-x"&&s!=="no-repeat"||!Ta(r)?n:r.source.height,'" fill="url(#SVGID_').concat(r.id,`)"></rect>
`))}else t.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',r,'"',`></rect>
`)}loadFromJSON(t,e){let{signal:r}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(!t)return Promise.reject(new Tr("`json` is undefined"));const s=typeof t=="string"?JSON.parse(t):t,{objects:i=[]}=s,n=ie(s,cg),{backgroundImage:o,background:l,overlayImage:c,overlay:u,clipPath:d}=n,g=this.renderOnAddRemove;return this.renderOnAddRemove=!1,Promise.all([wi(i,{reviver:e,signal:r}),zn({backgroundImage:o,backgroundColor:l,overlayImage:c,overlayColor:u,clipPath:d},{signal:r})]).then((f=>{let[m,p]=f;return this.clear(),this.add(...m),this.set(n),this.set(p),this.renderOnAddRemove=g,this}))}clone(t){const e=this.toObject(t);return this.cloneWithoutData().loadFromJSON(e)}cloneWithoutData(){const t=sr(this);return new this.constructor(t)}toDataURL(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{format:e="png",quality:r=1,multiplier:s=1,enableRetinaScaling:i=!1}=t,n=s*(i?this.getRetinaScaling():1);return Vl(this.toCanvasElement(n,t),e,r)}toBlob(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{format:e="png",quality:r=1,multiplier:s=1,enableRetinaScaling:i=!1}=t,n=s*(i?this.getRetinaScaling():1);return Wl(this.toCanvasElement(n,t),e,r)}toCanvasElement(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1,{width:e,height:r,left:s,top:i,filter:n}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const o=(e||this.width)*t,l=(r||this.height)*t,c=this.getZoom(),u=this.width,d=this.height,g=this.skipControlsDrawing,f=c*t,m=this.viewportTransform,p=[f,0,0,f,(m[4]-(s||0))*t,(m[5]-(i||0))*t],v=this.enableRetinaScaling,x=sr({width:o,height:l}),T=n?this._objects.filter((A=>n(A))):this._objects;return this.enableRetinaScaling=!1,this.viewportTransform=p,this.width=o,this.height=l,this.skipControlsDrawing=!0,this.calcViewportBoundaries(),this.renderCanvas(x.getContext("2d"),T),this.viewportTransform=m,this.width=u,this.height=d,this.calcViewportBoundaries(),this.enableRetinaScaling=v,this.skipControlsDrawing=g,x}dispose(){return!this.disposed&&this.elements.cleanupDOM({width:this.width,height:this.height}),bn.cancelByCanvas(this),this.disposed=!0,new Promise(((t,e)=>{const r=()=>{this.destroy(),t(!0)};r.kill=e,this.__cleanupTask&&this.__cleanupTask.kill("aborted"),this.destroyed?t(!1):this.nextRenderHandle?this.__cleanupTask=r:r()}))}destroy(){this.destroyed=!0,this.cancelRequestedRender(),this.forEachObject((t=>t.dispose())),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose(),this.backgroundImage=void 0,this.overlayImage&&this.overlayImage.dispose(),this.overlayImage=void 0,this.elements.dispose()}toString(){return"#<Canvas (".concat(this.complexity(),"): { objects: ").concat(this._objects.length," }>")}}S(Di,"ownDefaults",lg);const hg=["touchstart","touchmove","touchend"],ug=a=>{const t=Ul(a.target),e=(function(r){const s=r.changedTouches;return s&&s[0]?s[0]:r})(a);return new F(e.clientX+t.left,e.clientY+t.top)},vo=a=>hg.includes(a.type)||a.pointerType==="touch",Oa=a=>{a.preventDefault(),a.stopPropagation()},Nr=a=>{let t=0,e=0,r=0,s=0;for(let i=0,n=a.length;i<n;i++){const{x:o,y:l}=a[i];(o>r||!i)&&(r=o),(o<t||!i)&&(t=o),(l>s||!i)&&(s=l),(l<e||!i)&&(e=l)}return{left:t,top:e,width:r-t,height:s-e}},dg=["translateX","translateY","scaleX","scaleY"],gg=(a,t)=>Cn(a,Te(t,a.calcOwnMatrix())),Cn=(a,t)=>{const e=Sn(t),{translateX:r,translateY:s,scaleX:i,scaleY:n}=e,o=ie(e,dg),l=new F(r,s);a.flipX=!1,a.flipY=!1,Object.assign(a,o),a.set({scaleX:i,scaleY:n}),a.setPositionByOrigin(l,Bt,Bt)},fg=a=>{a.scaleX=1,a.scaleY=1,a.skewX=0,a.skewY=0,a.flipX=!1,a.flipY=!1,a.rotate(0)},Kl=a=>({scaleX:a.scaleX,scaleY:a.scaleY,skewX:a.skewX,skewY:a.skewY,angle:a.angle,left:a.left,flipX:a.flipX,flipY:a.flipY,top:a.top}),Xo=(a,t,e)=>{const r=a/2,s=t/2,i=[new F(-r,-s),new F(r,-s),new F(-r,s),new F(r,s)].map((o=>o.transform(e))),n=Nr(i);return new F(n.width,n.height)},Vn=function(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Fe;return Te(ur(arguments.length>1&&arguments[1]!==void 0?arguments[1]:Fe),a)},Ns=function(a){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Fe,e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Fe;return a.transform(Vn(t,e))},mg=function(a){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Fe,e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Fe;return a.transform(Vn(t,e),!0)},pg=(a,t,e)=>{const r=Vn(t,e);return Cn(a,Te(r,a.calcOwnMatrix())),r},Zl=(a,t)=>{var e;const{transform:{target:r}}=t;(e=r.canvas)===null||e===void 0||e.fire("object:".concat(a),C(C({},t),{},{target:r})),r.fire(a,t)},vg={left:-.5,top:-.5,center:0,bottom:.5,right:.5},ve=a=>typeof a=="string"?vg[a]:a-.5,Tn="not-allowed";function Jl(a){return ve(a.originX)===ve(Bt)&&ve(a.originY)===ve(Bt)}function Aa(a){return .5-ve(a)}const mr=(a,t)=>a[t],Ql=(a,t,e,r)=>({e:a,transform:t,pointer:new F(e,r)});function tc(a,t){const e=a.getTotalAngle()+Kr(Math.atan2(t.y,t.x))+360;return Math.round(e%360/45)}function No(a,t,e,r,s){var i;let{target:n,corner:o}=a;const l=n.controls[o],c=((i=n.canvas)===null||i===void 0?void 0:i.getZoom())||1,u=n.padding/c,d=(function(g,f,m,p){const v=g.getRelativeCenterPoint(),x=m!==void 0&&p!==void 0?g.translateToGivenOrigin(v,Bt,Bt,m,p):new F(g.left,g.top);return(g.angle?f.rotate(-ge(g.angle),v):f).subtract(x)})(n,new F(r,s),t,e);return d.x>=u&&(d.x-=u),d.x<=-u&&(d.x+=u),d.y>=u&&(d.y-=u),d.y<=u&&(d.y+=u),d.x-=l.offsetX,d.y-=l.offsetY,d}const _g=(a,t,e,r)=>{const{target:s,offsetX:i,offsetY:n}=t,o=e-i,l=r-n,c=!mr(s,"lockMovementX")&&s.left!==o,u=!mr(s,"lockMovementY")&&s.top!==l;return c&&s.set($t,o),u&&s.set(Ve,l),(c||u)&&Zl(Fl,Ql(a,t,e,r)),c||u},kn=a=>a.replace(/\s+/g," "),Da={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#0FF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000",blanchedalmond:"#FFEBCD",blue:"#00F",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#0FF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#F0F",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#789",lightslategrey:"#789",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#0F0",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#F0F",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#639",red:"#F00",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFF",whitesmoke:"#F5F5F5",yellow:"#FF0",yellowgreen:"#9ACD32"},Jn=(a,t,e)=>(e<0&&(e+=1),e>1&&(e-=1),e<1/6?a+6*(t-a)*e:e<.5?t:e<2/3?a+(t-a)*(2/3-e)*6:a),Ea=(a,t,e,r)=>{a/=255,t/=255,e/=255;const s=Math.max(a,t,e),i=Math.min(a,t,e);let n,o;const l=(s+i)/2;if(s===i)n=o=0;else{const c=s-i;switch(o=l>.5?c/(2-s-i):c/(s+i),s){case a:n=(t-e)/c+(t<e?6:0);break;case t:n=(e-a)/c+2;break;case e:n=(a-t)/c+4}n/=6}return[Math.round(360*n),Math.round(100*o),Math.round(100*l),r]},Pa=function(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"1";return parseFloat(a)/(a.endsWith("%")?100:1)},Mi=a=>Math.min(Math.round(a),255).toString(16).toUpperCase().padStart(2,"0"),Ma=a=>{let[t,e,r,s=1]=a;const i=Math.round(.3*t+.59*e+.11*r);return[i,i,i,s]};class Kt{constructor(t){if(S(this,"isUnrecognised",!1),t)if(t instanceof Kt)this.setSource([...t._source]);else if(Array.isArray(t)){const[e,r,s,i=1]=t;this.setSource([e,r,s,i])}else this.setSource(this._tryParsingColor(t));else this.setSource([0,0,0,1])}_tryParsingColor(t){return(t=t.toLowerCase())in Da&&(t=Da[t]),t==="transparent"?[255,255,255,0]:Kt.sourceFromHex(t)||Kt.sourceFromRgb(t)||Kt.sourceFromHsl(t)||(this.isUnrecognised=!0)&&[0,0,0,1]}getSource(){return this._source}setSource(t){this._source=t}toRgb(){const[t,e,r]=this.getSource();return"rgb(".concat(t,",").concat(e,",").concat(r,")")}toRgba(){return"rgba(".concat(this.getSource().join(","),")")}toHsl(){const[t,e,r]=Ea(...this.getSource());return"hsl(".concat(t,",").concat(e,"%,").concat(r,"%)")}toHsla(){const[t,e,r,s]=Ea(...this.getSource());return"hsla(".concat(t,",").concat(e,"%,").concat(r,"%,").concat(s,")")}toHex(){return this.toHexa().slice(0,6)}toHexa(){const[t,e,r,s]=this.getSource();return"".concat(Mi(t)).concat(Mi(e)).concat(Mi(r)).concat(Mi(Math.round(255*s)))}getAlpha(){return this.getSource()[3]}setAlpha(t){return this._source[3]=t,this}toGrayscale(){return this.setSource(Ma(this.getSource())),this}toBlackWhite(t){const[e,,,r]=Ma(this.getSource()),s=e<(t||127)?0:255;return this.setSource([s,s,s,r]),this}overlayWith(t){t instanceof Kt||(t=new Kt(t));const e=this.getSource(),r=t.getSource(),[s,i,n]=e.map(((o,l)=>Math.round(.5*o+.5*r[l])));return this.setSource([s,i,n,e[3]]),this}static fromRgb(t){return Kt.fromRgba(t)}static fromRgba(t){return new Kt(Kt.sourceFromRgb(t))}static sourceFromRgb(t){const e=kn(t).match(/^rgba?\(\s?(\d{0,3}(?:\.\d+)?%?)\s?[\s|,]\s?(\d{0,3}(?:\.\d+)?%?)\s?[\s|,]\s?(\d{0,3}(?:\.\d+)?%?)\s?(?:\s?[,/]\s?(\d{0,3}(?:\.\d+)?%?)\s?)?\)$/i);if(e){const[r,s,i]=e.slice(1,4).map((n=>{const o=parseFloat(n);return n.endsWith("%")?Math.round(2.55*o):o}));return[r,s,i,Pa(e[4])]}}static fromHsl(t){return Kt.fromHsla(t)}static fromHsla(t){return new Kt(Kt.sourceFromHsl(t))}static sourceFromHsl(t){const e=kn(t).match(/^hsla?\(\s?([+-]?\d{0,3}(?:\.\d+)?(?:deg|turn|rad)?)\s?[\s|,]\s?(\d{0,3}(?:\.\d+)?%?)\s?[\s|,]\s?(\d{0,3}(?:\.\d+)?%?)\s?(?:\s?[,/]\s?(\d*(?:\.\d+)?%?)\s?)?\)$/i);if(!e)return;const r=(Kt.parseAngletoDegrees(e[1])%360+360)%360/360,s=parseFloat(e[2])/100,i=parseFloat(e[3])/100;let n,o,l;if(s===0)n=o=l=i;else{const c=i<=.5?i*(s+1):i+s-i*s,u=2*i-c;n=Jn(u,c,r+1/3),o=Jn(u,c,r),l=Jn(u,c,r-1/3)}return[Math.round(255*n),Math.round(255*o),Math.round(255*l),Pa(e[4])]}static fromHex(t){return new Kt(Kt.sourceFromHex(t))}static sourceFromHex(t){if(t.match(/^#?(([0-9a-f]){3,4}|([0-9a-f]{2}){3,4})$/i)){const e=t.slice(t.indexOf("#")+1);let r;r=e.length<=4?e.split("").map((l=>l+l)):e.match(/.{2}/g);const[s,i,n,o=255]=r.map((l=>parseInt(l,16)));return[s,i,n,o/255]}}static parseAngletoDegrees(t){const e=t.toLowerCase(),r=parseFloat(e);return e.includes("rad")?Kr(r):e.includes("turn")?360*r:r}}const Us=function(a){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ro;const e=/\D{0,2}$/.exec(a),r=parseFloat(a),s=Wt.DPI;switch(e?.[0]){case"mm":return r*s/25.4;case"cm":return r*s/2.54;case"in":return r*s;case"pt":return r*s/72;case"pc":return r*s/72*12;case"em":return r*t;default:return r}},yg=a=>{const[t,e]=a.trim().split(" "),[r,s]=(i=t)&&i!==We?[i.slice(1,4),i.slice(5,8)]:i===We?[i,i]:["Mid","Mid"];var i;return{meetOrSlice:e||"meet",alignX:r,alignY:s}},Si=function(a,t){let e,r,s=!(arguments.length>2&&arguments[2]!==void 0)||arguments[2];if(t)if(t.toLive)e="url(#SVGID_".concat(t.id,")");else{const i=new Kt(t),n=i.getAlpha();e=i.toRgb(),n!==1&&(r=n.toString())}else e="none";return s?"".concat(a,": ").concat(e,"; ").concat(r?"".concat(a,"-opacity: ").concat(r,"; "):""):"".concat(a,'="').concat(e,'" ').concat(r?"".concat(a,'-opacity="').concat(r,'" '):"")};class ec{getSvgStyles(t){const e=this.fillRule?this.fillRule:"nonzero",r=this.strokeWidth?this.strokeWidth:"0",s=this.strokeDashArray?this.strokeDashArray.join(" "):We,i=this.strokeDashOffset?this.strokeDashOffset:"0",n=this.strokeLineCap?this.strokeLineCap:"butt",o=this.strokeLineJoin?this.strokeLineJoin:"miter",l=this.strokeMiterLimit?this.strokeMiterLimit:"4",c=this.opacity!==void 0?this.opacity:"1",u=this.visible?"":" visibility: hidden;",d=t?"":this.getSvgFilter(),g=Si(_e,this.fill);return[Si(He,this.stroke),"stroke-width: ",r,"; ","stroke-dasharray: ",s,"; ","stroke-linecap: ",n,"; ","stroke-dashoffset: ",i,"; ","stroke-linejoin: ",o,"; ","stroke-miterlimit: ",l,"; ",g,"fill-rule: ",e,"; ","opacity: ",c,";",d,u].join("")}getSvgFilter(){return this.shadow?"filter: url(#SVGID_".concat(this.shadow.id,");"):""}getSvgCommons(){return[this.id?'id="'.concat(this.id,'" '):"",this.clipPath?'clip-path="url(#'.concat(this.clipPath.clipPathId,')" '):""].join("")}getSvgTransform(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"";const r=t?this.calcTransformMatrix():this.calcOwnMatrix(),s='transform="'.concat(bi(r));return"".concat(s).concat(e,'" ')}_toSVG(t){return[""]}toSVG(t){return this._createBaseSVGMarkup(this._toSVG(t),{reviver:t})}toClipPathSVG(t){return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(t),{reviver:t})}_createBaseClipPathSVGMarkup(t){let{reviver:e,additionalTransform:r=""}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const s=[this.getSvgTransform(!0,r),this.getSvgCommons()].join(""),i=t.indexOf("COMMON_PARTS");return t[i]=s,e?e(t.join("")):t.join("")}_createBaseSVGMarkup(t){let{noStyle:e,reviver:r,withShadow:s,additionalTransform:i}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const n=e?"":'style="'.concat(this.getSvgStyles(),'" '),o=s?'style="'.concat(this.getSvgFilter(),'" '):"",l=this.clipPath,c=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",u=l&&l.absolutePositioned,d=this.stroke,g=this.fill,f=this.shadow,m=[],p=t.indexOf("COMMON_PARTS");let v;l&&(l.clipPathId="CLIPPATH_".concat(fs()),v='<clipPath id="'.concat(l.clipPathId,`" >
`).concat(l.toClipPathSVG(r),`</clipPath>
`)),u&&m.push("<g ",o,this.getSvgCommons(),` >
`),m.push("<g ",this.getSvgTransform(!1),u?"":o+this.getSvgCommons(),` >
`);const x=[n,c,e?"":this.addPaintOrder()," ",i?'transform="'.concat(i,'" '):""].join("");return t[p]=x,Ze(g)&&m.push(g.toSVG(this)),Ze(d)&&m.push(d.toSVG(this)),f&&m.push(f.toSVG(this)),l&&m.push(v),m.push(t.join("")),m.push(`</g>
`),u&&m.push(`</g>
`),r?r(m.join("")):m.join("")}addPaintOrder(){return this.paintFirst!==_e?' paint-order="'.concat(this.paintFirst,'" '):""}}function Wn(a){return new RegExp("^("+a.join("|")+")\\b","i")}const Ds="textDecorationThickness",rc=["fontSize","fontWeight","fontFamily","fontStyle"],sc=["underline","overline","linethrough"],ic=[...rc,"lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide","pathAlign"],nc=[...ic,...sc,"textBackgroundColor","direction",Ds],xg=[...rc,...sc,He,"strokeWidth",_e,"deltaY","textBackgroundColor",Ds],wg={_reNewline:Bo,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:$t,fontStyle:"normal",lineHeight:1.16,textBackgroundColor:"",stroke:null,shadow:null,path:void 0,pathStartOffset:0,pathSide:$t,pathAlign:"baseline",charSpacing:0,deltaY:0,direction:"ltr",CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.28167,overline:-.81333},_fontSizeMult:1.13,[Ds]:66.667},Cr="justify",On="justify-left",fi="justify-right",mi="justify-center";var Ia,La,Fa;const dr=String.raw(Ia||(Ia=Er(["[-+]?(?:d*.d+|d+.?)(?:[eE][-+]?d+)?"],["[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?"]))),Qn=String.raw(La||(La=Er(["(?:s*,?s+|s*,s*)"],["(?:\\s*,?\\s+|\\s*,\\s*)"]))),bg=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+dr+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+dr+"))?\\s+(.*)"),Sg={cx:$t,x:$t,r:"radius",cy:Ve,y:Ve,display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing","text-decoration-thickness":Ds},to="font-size",eo="clip-path";Wn(["path","circle","polygon","polyline","ellipse","rect","line","image","text"]);Wn(["symbol","image","marker","pattern","view","svg"]);const ja=Wn(["symbol","g","a","svg","clipPath","defs"]);new RegExp(String.raw(Fa||(Fa=Er(["^s*(",")","(",")","(",")","(",")s*$"],["^\\s*(",")","(",")","(",")","(",")\\s*$"])),dr,Qn,dr,Qn,dr,Qn,dr));const Cg=new F(1,0),oc=new F,ac=(a,t)=>a.rotate(t),_o=(a,t)=>new F(t).subtract(a),yo=a=>a.distanceFrom(oc),xo=(a,t)=>Math.atan2(pi(a,t),kg(a,t)),Tg=a=>xo(Cg,a),Uo=a=>a.eq(oc)?a:a.scalarDivide(yo(a)),lc=function(a){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return Uo(new F(-a.y,a.x).scalarMultiply(t?1:-1))},pi=(a,t)=>a.x*t.y-a.y*t.x,kg=(a,t)=>a.x*t.x+a.y*t.y,Ra=(a,t,e)=>{if(a.eq(t)||a.eq(e))return!0;const r=pi(t,e),s=pi(t,a),i=pi(e,a);return r>=0?s>=0&&i<=0:!(s<=0&&i>=0)},Ba="(-?\\d+(?:\\.\\d*)?(?:px)?(?:\\s?|$))?",za=new RegExp("(?:\\s|^)"+Ba+Ba+"("+dr+"?(?:px)?)?(?:\\s?|$)(?:$|\\s)");class Ur{constructor(t){const e=typeof t=="string"?Ur.parseShadow(t):t;Object.assign(this,Ur.ownDefaults,e),this.id=fs()}static parseShadow(t){const e=t.trim(),[,r=0,s=0,i=0]=(za.exec(e)||[]).map((n=>parseFloat(n)||0));return{color:(e.replace(za,"")||"rgb(0,0,0)").trim(),offsetX:r,offsetY:s,blur:i}}toString(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")}toSVG(t){const e=ac(new F(this.offsetX,this.offsetY),ge(-t.angle)),r=new Kt(this.color);let s=40,i=40;return t.width&&t.height&&(s=100*re((Math.abs(e.x)+this.blur)/t.width,Wt.NUM_FRACTION_DIGITS)+20,i=100*re((Math.abs(e.y)+this.blur)/t.height,Wt.NUM_FRACTION_DIGITS)+20),t.flipX&&(e.x*=-1),t.flipY&&(e.y*=-1),'<filter id="SVGID_'.concat(this.id,'" y="-').concat(i,'%" height="').concat(100+2*i,'%" x="-').concat(s,'%" width="').concat(100+2*s,`%" >
	<feGaussianBlur in="SourceAlpha" stdDeviation="`).concat(re(this.blur?this.blur/2:0,Wt.NUM_FRACTION_DIGITS),`"></feGaussianBlur>
	<feOffset dx="`).concat(re(e.x,Wt.NUM_FRACTION_DIGITS),'" dy="').concat(re(e.y,Wt.NUM_FRACTION_DIGITS),`" result="oBlur" ></feOffset>
	<feFlood flood-color="`).concat(r.toRgb(),'" flood-opacity="').concat(r.getAlpha(),`"/>
	<feComposite in2="oBlur" operator="in" />
	<feMerge>
		<feMergeNode></feMergeNode>
		<feMergeNode in="SourceGraphic"></feMergeNode>
	</feMerge>
</filter>
`)}toObject(){const t={color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling,type:this.constructor.type},e=Ur.ownDefaults;return this.includeDefaultValues?t:Yo(t,((r,s)=>r!==e[s]))}static async fromObject(t){return new this(t)}}S(Ur,"ownDefaults",{color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1}),S(Ur,"type","shadow"),gt.setClass(Ur,"shadow");const Ks=(a,t,e)=>Math.max(a,Math.min(t,e)),Og=[Ve,$t,Ye,rr,"flipX","flipY","originX","originY","angle","opacity","globalCompositeOperation","shadow","visible",Js,Qs],Jr=[_e,He,"strokeWidth","strokeDashArray","width","height","paintFirst","strokeUniform","strokeLineCap","strokeDashOffset","strokeLineJoin","strokeMiterLimit","backgroundColor","clipPath"],Ag={top:0,left:0,width:0,height:0,angle:0,flipX:!1,flipY:!1,scaleX:1,scaleY:1,minScaleLimit:0,skewX:0,skewY:0,originX:$t,originY:Ve,strokeWidth:1,strokeUniform:!1,padding:0,opacity:1,paintFirst:_e,fill:"rgb(0,0,0)",fillRule:"nonzero",stroke:null,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,globalCompositeOperation:"source-over",backgroundColor:"",shadow:null,visible:!0,includeDefaultValues:!0,excludeFromExport:!1,objectCaching:!0,clipPath:void 0,inverted:!1,absolutePositioned:!1,centeredRotation:!0,centeredScaling:!1,dirty:!0},Dg=(a,t,e,r)=>-e*Math.cos(a/r*Oi)+e+t,Eg=()=>!1;class Go{constructor(t){let{startValue:e,byValue:r,duration:s=500,delay:i=0,easing:n=Dg,onStart:o=an,onChange:l=an,onComplete:c=an,abort:u=Eg,target:d}=t;S(this,"_state","pending"),S(this,"durationProgress",0),S(this,"valueProgress",0),this.tick=this.tick.bind(this),this.duration=s,this.delay=i,this.easing=n,this._onStart=o,this._onChange=l,this._onComplete=c,this._abort=u,this.target=d,this.startValue=e,this.byValue=r,this.value=this.startValue,this.endValue=Object.freeze(this.calculate(this.duration).value)}get state(){return this._state}isDone(){return this._state==="aborted"||this._state==="completed"}start(){const t=e=>{this._state==="pending"&&(this.startTime=e||+new Date,this._state="running",this._onStart(),this.tick(this.startTime))};this.register(),this.delay>0?setTimeout((()=>cn(t)),this.delay):cn(t)}tick(t){const e=(t||+new Date)-this.startTime,r=Math.min(e,this.duration);this.durationProgress=r/this.duration;const{value:s,valueProgress:i}=this.calculate(r);this.value=Object.freeze(s),this.valueProgress=i,this._state!=="aborted"&&(this._abort(this.value,this.valueProgress,this.durationProgress)?(this._state="aborted",this.unregister()):e>=this.duration?(this.durationProgress=this.valueProgress=1,this._onChange(this.endValue,this.valueProgress,this.durationProgress),this._state="completed",this._onComplete(this.endValue,this.valueProgress,this.durationProgress),this.unregister()):(this._onChange(this.value,this.valueProgress,this.durationProgress),cn(this.tick)))}register(){bn.push(this)}unregister(){bn.remove(this)}abort(){this._state="aborted",this.unregister()}}const Pg=["startValue","endValue"];class Mg extends Go{constructor(t){let{startValue:e=0,endValue:r=100}=t;super(C(C({},ie(t,Pg)),{},{startValue:e,byValue:r-e}))}calculate(t){const e=this.easing(t,this.startValue,this.byValue,this.duration);return{value:e,valueProgress:Math.abs((e-this.startValue)/this.byValue)}}}const Ig=["startValue","endValue"];class Lg extends Go{constructor(t){let{startValue:e=[0],endValue:r=[100]}=t;super(C(C({},ie(t,Ig)),{},{startValue:e,byValue:r.map(((s,i)=>s-e[i]))}))}calculate(t){const e=this.startValue.map(((r,s)=>this.easing(t,r,this.byValue[s],this.duration,s)));return{value:e,valueProgress:Math.abs((e[0]-this.startValue[0])/this.byValue[0])}}}const Fg=["startValue","endValue","easing","onChange","onComplete","abort"],jg=(a,t,e,r)=>t+e*(1-Math.cos(a/r*Oi)),ro=a=>a&&((t,e,r)=>a(new Kt(t).toRgba(),e,r));class Rg extends Go{constructor(t){let{startValue:e,endValue:r,easing:s=jg,onChange:i,onComplete:n,abort:o}=t,l=ie(t,Fg);const c=new Kt(e).getSource(),u=new Kt(r).getSource();super(C(C({},l),{},{startValue:c,byValue:u.map(((d,g)=>d-c[g])),easing:s,onChange:ro(i),onComplete:ro(n),abort:ro(o)}))}calculate(t){const[e,r,s,i]=this.startValue.map(((o,l)=>this.easing(t,o,this.byValue[l],this.duration,l))),n=[...[e,r,s].map(Math.round),Ks(0,i,1)];return{value:n,valueProgress:n.map(((o,l)=>this.byValue[l]!==0?Math.abs((o-this.startValue[l])/this.byValue[l]):0)).find((o=>o!==0))||0}}}function cc(a){const t=(e=>Array.isArray(e.startValue)||Array.isArray(e.endValue))(a)?new Lg(a):new Mg(a);return t.start(),t}function Bg(a){const t=new Rg(a);return t.start(),t}class le{constructor(t){this.status=t,this.points=[]}includes(t){return this.points.some((e=>e.eq(t)))}append(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return this.points=this.points.concat(e.filter((s=>!this.includes(s)))),this}static isPointContained(t,e,r){let s=arguments.length>3&&arguments[3]!==void 0&&arguments[3];if(e.eq(r))return t.eq(e);if(e.x===r.x)return t.x===e.x&&(s||t.y>=Math.min(e.y,r.y)&&t.y<=Math.max(e.y,r.y));if(e.y===r.y)return t.y===e.y&&(s||t.x>=Math.min(e.x,r.x)&&t.x<=Math.max(e.x,r.x));{const i=_o(e,r),n=_o(e,t).divide(i);return s?Math.abs(n.x)===Math.abs(n.y):n.x===n.y&&n.x>=0&&n.x<=1}}static isPointInPolygon(t,e){const r=new F(t).setX(Math.min(t.x-1,...e.map((i=>i.x))));let s=0;for(let i=0;i<e.length;i++){const n=this.intersectSegmentSegment(e[i],e[(i+1)%e.length],t,r);if(n.includes(t))return!0;s+=+(n.status==="Intersection")}return s%2==1}static intersectLineLine(t,e,r,s){let i=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4],n=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5];const o=e.x-t.x,l=e.y-t.y,c=s.x-r.x,u=s.y-r.y,d=t.x-r.x,g=t.y-r.y,f=c*g-u*d,m=o*g-l*d,p=u*o-c*l;if(p!==0){const v=f/p,x=m/p;return(i||0<=v&&v<=1)&&(n||0<=x&&x<=1)?new le("Intersection").append(new F(t.x+v*o,t.y+v*l)):new le}if(f===0||m===0){const v=i||n||le.isPointContained(t,r,s)||le.isPointContained(e,r,s)||le.isPointContained(r,t,e)||le.isPointContained(s,t,e);return new le(v?"Coincident":void 0)}return new le("Parallel")}static intersectSegmentLine(t,e,r,s){return le.intersectLineLine(t,e,r,s,!1,!0)}static intersectSegmentSegment(t,e,r,s){return le.intersectLineLine(t,e,r,s,!1,!1)}static intersectLinePolygon(t,e,r){let s=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];const i=new le,n=r.length;for(let o,l,c,u=0;u<n;u++){if(o=r[u],l=r[(u+1)%n],c=le.intersectLineLine(t,e,o,l,s,!1),c.status==="Coincident")return c;i.append(...c.points)}return i.points.length>0&&(i.status="Intersection"),i}static intersectSegmentPolygon(t,e,r){return le.intersectLinePolygon(t,e,r,!1)}static intersectPolygonPolygon(t,e){const r=new le,s=t.length,i=[];for(let n=0;n<s;n++){const o=t[n],l=t[(n+1)%s],c=le.intersectSegmentPolygon(o,l,e);c.status==="Coincident"?(i.push(c),r.append(o,l)):r.append(...c.points)}return i.length>0&&i.length===t.length?new le("Coincident"):(r.points.length>0&&(r.status="Intersection"),r)}static intersectPolygonRectangle(t,e,r){const s=e.min(r),i=e.max(r),n=new F(i.x,s.y),o=new F(s.x,i.y);return le.intersectPolygonPolygon(t,[s,n,i,o])}}class zg extends zl{getX(){return this.getXY().x}setX(t){this.setXY(this.getXY().setX(t))}getY(){return this.getXY().y}setY(t){this.setXY(this.getXY().setY(t))}getRelativeX(){return this.left}setRelativeX(t){this.left=t}getRelativeY(){return this.top}setRelativeY(t){this.top=t}getXY(){const t=this.getRelativeXY();return this.group?Re(t,this.group.calcTransformMatrix()):t}setXY(t,e,r){this.group&&(t=Re(t,ur(this.group.calcTransformMatrix()))),this.setRelativeXY(t,e,r)}getRelativeXY(){return new F(this.left,this.top)}setRelativeXY(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.originX,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.originY;this.setPositionByOrigin(t,e,r)}isStrokeAccountedForInDimensions(){return!1}getCoords(){const{tl:t,tr:e,br:r,bl:s}=this.aCoords||(this.aCoords=this.calcACoords()),i=[t,e,r,s];if(this.group){const n=this.group.calcTransformMatrix();return i.map((o=>Re(o,n)))}return i}intersectsWithRect(t,e){return le.intersectPolygonRectangle(this.getCoords(),t,e).status==="Intersection"}intersectsWithObject(t){const e=le.intersectPolygonPolygon(this.getCoords(),t.getCoords());return e.status==="Intersection"||e.status==="Coincident"||t.isContainedWithinObject(this)||this.isContainedWithinObject(t)}isContainedWithinObject(t){return this.getCoords().every((e=>t.containsPoint(e)))}isContainedWithinRect(t,e){const{left:r,top:s,width:i,height:n}=this.getBoundingRect();return r>=t.x&&r+i<=e.x&&s>=t.y&&s+n<=e.y}isOverlapping(t){return this.intersectsWithObject(t)||this.isContainedWithinObject(t)||t.isContainedWithinObject(this)}containsPoint(t){return le.isPointInPolygon(t,this.getCoords())}isOnScreen(){if(!this.canvas)return!1;const{tl:t,br:e}=this.canvas.vptCoords;return!!this.getCoords().some((r=>r.x<=e.x&&r.x>=t.x&&r.y<=e.y&&r.y>=t.y))||!!this.intersectsWithRect(t,e)||this.containsPoint(t.midPointFrom(e))}isPartiallyOnScreen(){if(!this.canvas)return!1;const{tl:t,br:e}=this.canvas.vptCoords;return this.intersectsWithRect(t,e)?!0:this.getCoords().every((r=>(r.x>=e.x||r.x<=t.x)&&(r.y>=e.y||r.y<=t.y)))&&this.containsPoint(t.midPointFrom(e))}getBoundingRect(){return Nr(this.getCoords())}getScaledWidth(){return this._getTransformedDimensions().x}getScaledHeight(){return this._getTransformedDimensions().y}scale(t){this._set(Ye,t),this._set(rr,t),this.setCoords()}scaleToWidth(t){const e=this.getBoundingRect().width/this.getScaledWidth();return this.scale(t/this.width/e)}scaleToHeight(t){const e=this.getBoundingRect().height/this.getScaledHeight();return this.scale(t/this.height/e)}getCanvasRetinaScaling(){var t;return((t=this.canvas)===null||t===void 0?void 0:t.getRetinaScaling())||1}getTotalAngle(){return this.group?Kr(Hl(this.calcTransformMatrix())):this.angle}getViewportTransform(){var t;return((t=this.canvas)===null||t===void 0?void 0:t.viewportTransform)||Fe.concat()}calcACoords(){const t=ti({angle:this.angle}),{x:e,y:r}=this.getRelativeCenterPoint(),s=Ai(e,r),i=Te(s,t),n=this._getTransformedDimensions(),o=n.x/2,l=n.y/2;return{tl:Re({x:-o,y:-l},i),tr:Re({x:o,y:-l},i),bl:Re({x:-o,y:l},i),br:Re({x:o,y:l},i)}}setCoords(){this.aCoords=this.calcACoords()}transformMatrixKey(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0],e=[];return!t&&this.group&&(e=this.group.transformMatrixKey(t)),e.push(this.top,this.left,this.width,this.height,this.scaleX,this.scaleY,this.angle,this.strokeWidth,this.skewX,this.skewY,+this.flipX,+this.flipY,ve(this.originX),ve(this.originY)),e}calcTransformMatrix(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0],e=this.calcOwnMatrix();if(t||!this.group)return e;const r=this.transformMatrixKey(t),s=this.matrixCache;return s&&s.key.every(((i,n)=>i===r[n]))?s.value:(this.group&&(e=Te(this.group.calcTransformMatrix(!1),e)),this.matrixCache={key:r,value:e},e)}calcOwnMatrix(){const t=this.transformMatrixKey(!0),e=this.ownMatrixCache;if(e&&e.key===t)return e.value;const r=this.getRelativeCenterPoint(),s={angle:this.angle,translateX:r.x,translateY:r.y,scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY},i=ag(s);return this.ownMatrixCache={key:t,value:i},i}_getNonTransformedDimensions(){return new F(this.width,this.height).scalarAdd(this.strokeWidth)}_calculateCurrentDimensions(t){return this._getTransformedDimensions(t).transform(this.getViewportTransform(),!0).scalarAdd(2*this.padding)}_getTransformedDimensions(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=C({scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,width:this.width,height:this.height,strokeWidth:this.strokeWidth},t),r=e.strokeWidth;let s=r,i=0;this.strokeUniform&&(s=0,i=r);const n=e.width+s,o=e.height+s;let l;return l=e.skewX===0&&e.skewY===0?new F(n*e.scaleX,o*e.scaleY):Xo(n,o,Bn(e)),l.scalarAdd(i)}translateToGivenOrigin(t,e,r,s,i){let n=t.x,o=t.y;const l=ve(s)-ve(e),c=ve(i)-ve(r);if(l||c){const u=this._getTransformedDimensions();n+=l*u.x,o+=c*u.y}return new F(n,o)}translateToCenterPoint(t,e,r){if(e===Bt&&r===Bt)return t;const s=this.translateToGivenOrigin(t,e,r,Bt,Bt);return this.angle?s.rotate(ge(this.angle),t):s}translateToOriginPoint(t,e,r){const s=this.translateToGivenOrigin(t,Bt,Bt,e,r);return this.angle?s.rotate(ge(this.angle),t):s}getCenterPoint(){const t=this.getRelativeCenterPoint();return this.group?Re(t,this.group.calcTransformMatrix()):t}getRelativeCenterPoint(){return this.translateToCenterPoint(new F(this.left,this.top),this.originX,this.originY)}getPointByOrigin(t,e){return this.translateToOriginPoint(this.getRelativeCenterPoint(),t,e)}setPositionByOrigin(t,e,r){const s=this.translateToCenterPoint(t,e,r),i=this.translateToOriginPoint(s,this.originX,this.originY);this.set({left:i.x,top:i.y})}_getLeftTopCoords(){return this.translateToOriginPoint(this.getRelativeCenterPoint(),$t,Ve)}}const Vg=["type"],Wg=["extraParam"];let zr=class un extends zg{static getDefaults(){return un.ownDefaults}get type(){const t=this.constructor.type;return t==="FabricObject"?"object":t.toLowerCase()}set type(t){gs("warn","Setting type has no effect",t)}constructor(t){super(),S(this,"_cacheContext",null),Object.assign(this,un.ownDefaults),this.setOptions(t)}_createCacheCanvas(){this._cacheCanvas=$r(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0}_limitCacheSize(t){const e=t.width,r=t.height,s=Wt.maxCacheSideLimit,i=Wt.minCacheSideLimit;if(e<=s&&r<=s&&e*r<=Wt.perfLimitSizeTotal)return e<i&&(t.width=i),r<i&&(t.height=i),t;const n=e/r,[o,l]=gi.limitDimsByArea(n),c=Ks(i,o,s),u=Ks(i,l,s);return e>c&&(t.zoomX/=e/c,t.width=c,t.capped=!0),r>u&&(t.zoomY/=r/u,t.height=u,t.capped=!0),t}_getCacheCanvasDimensions(){const t=this.getTotalObjectScaling(),e=this._getTransformedDimensions({skewX:0,skewY:0}),r=e.x*t.x/this.scaleX,s=e.y*t.y/this.scaleY;return{width:Math.ceil(r+2),height:Math.ceil(s+2),zoomX:t.x,zoomY:t.y,x:r,y:s}}_updateCacheCanvas(){const t=this._cacheCanvas,e=this._cacheContext,{width:r,height:s,zoomX:i,zoomY:n,x:o,y:l}=this._limitCacheSize(this._getCacheCanvasDimensions()),c=r!==t.width||s!==t.height,u=this.zoomX!==i||this.zoomY!==n;if(!t||!e)return!1;if(c||u){r!==t.width||s!==t.height?(t.width=r,t.height=s):(e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,t.width,t.height));const d=o/2,g=l/2;return this.cacheTranslationX=Math.round(t.width/2-d)+d,this.cacheTranslationY=Math.round(t.height/2-g)+g,e.translate(this.cacheTranslationX,this.cacheTranslationY),e.scale(i,n),this.zoomX=i,this.zoomY=n,!0}return!1}setOptions(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._setOptions(t)}transform(t){const e=this.group&&!this.group._transformDone||this.group&&this.canvas&&t===this.canvas.contextTop,r=this.calcTransformMatrix(!e);t.transform(r[0],r[1],r[2],r[3],r[4],r[5])}getObjectScaling(){if(!this.group)return new F(Math.abs(this.scaleX),Math.abs(this.scaleY));const t=Sn(this.calcTransformMatrix());return new F(Math.abs(t.scaleX),Math.abs(t.scaleY))}getTotalObjectScaling(){const t=this.getObjectScaling();if(this.canvas){const e=this.canvas.getZoom(),r=this.getCanvasRetinaScaling();return t.scalarMultiply(e*r)}return t}getObjectOpacity(){let t=this.opacity;return this.group&&(t*=this.group.getObjectOpacity()),t}_constrainScale(t){return Math.abs(t)<this.minScaleLimit?t<0?-this.minScaleLimit:this.minScaleLimit:t===0?1e-4:t}_set(t,e){t!==Ye&&t!==rr||(e=this._constrainScale(e)),t===Ye&&e<0?(this.flipX=!this.flipX,e*=-1):t==="scaleY"&&e<0?(this.flipY=!this.flipY,e*=-1):t!=="shadow"||!e||e instanceof Ur||(e=new Ur(e));const r=this[t]!==e;return this[t]=e,r&&this.constructor.cacheProperties.includes(t)&&(this.dirty=!0),this.parent&&(this.dirty||r&&this.constructor.stateProperties.includes(t))&&this.parent._set("dirty",!0),this}isNotVisible(){return this.opacity===0||!this.width&&!this.height&&this.strokeWidth===0||!this.visible}render(t){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(t.save(),this._setupCompositeOperation(t),this.drawSelectionBackground(t),this.transform(t),this._setOpacity(t),this._setShadow(t),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(t)):(this._removeCacheCanvas(),this.drawObject(t,!1,{}),this.dirty=!1),t.restore())}drawSelectionBackground(t){}renderCache(t){if(t=t||{},this._cacheCanvas&&this._cacheContext||this._createCacheCanvas(),this.isCacheDirty()&&this._cacheContext){const{zoomX:e,zoomY:r,cacheTranslationX:s,cacheTranslationY:i}=this,{width:n,height:o}=this._cacheCanvas;this.drawObject(this._cacheContext,t.forClipping,{zoomX:e,zoomY:r,cacheTranslationX:s,cacheTranslationY:i,width:n,height:o,parentClipPaths:[]}),this.dirty=!1}}_removeCacheCanvas(){this._cacheCanvas=void 0,this._cacheContext=null}hasStroke(){return this.stroke&&this.stroke!=="transparent"&&this.strokeWidth!==0}hasFill(){return this.fill&&this.fill!=="transparent"}needsItsOwnCache(){return!!(this.paintFirst===He&&this.hasFill()&&this.hasStroke()&&this.shadow)||!!this.clipPath}shouldCache(){return this.ownCaching=this.objectCaching&&(!this.parent||!this.parent.isOnACache())||this.needsItsOwnCache(),this.ownCaching}willDrawShadow(){return!!this.shadow&&(this.shadow.offsetX!==0||this.shadow.offsetY!==0)}drawClipPathOnCache(t,e,r){t.save(),e.inverted?t.globalCompositeOperation="destination-out":t.globalCompositeOperation="destination-in",t.setTransform(1,0,0,1,0,0),t.drawImage(r,0,0),t.restore()}drawObject(t,e,r){const s=this.fill,i=this.stroke;e?(this.fill="black",this.stroke="",this._setClippingProperties(t)):this._renderBackground(t),this._render(t),this._drawClipPath(t,this.clipPath,r),this.fill=s,this.stroke=i}createClipPathLayer(t,e){const r=sr(e),s=r.getContext("2d");if(s.translate(e.cacheTranslationX,e.cacheTranslationY),s.scale(e.zoomX,e.zoomY),t._cacheCanvas=r,e.parentClipPaths.forEach((i=>{i.transform(s)})),e.parentClipPaths.push(t),t.absolutePositioned){const i=ur(this.calcTransformMatrix());s.transform(i[0],i[1],i[2],i[3],i[4],i[5])}return t.transform(s),t.drawObject(s,!0,e),r}_drawClipPath(t,e,r){if(!e)return;e._transformDone=!0;const s=this.createClipPathLayer(e,r);this.drawClipPathOnCache(t,e,s)}drawCacheOnCanvas(t){t.scale(1/this.zoomX,1/this.zoomY),t.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)}isCacheDirty(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];if(this.isNotVisible())return!1;const e=this._cacheCanvas,r=this._cacheContext;return!(!e||!r||t||!this._updateCacheCanvas())||!!(this.dirty||this.clipPath&&this.clipPath.absolutePositioned)&&(e&&r&&!t&&(r.save(),r.setTransform(1,0,0,1,0,0),r.clearRect(0,0,e.width,e.height),r.restore()),!0)}_renderBackground(t){if(!this.backgroundColor)return;const e=this._getNonTransformedDimensions();t.fillStyle=this.backgroundColor,t.fillRect(-e.x/2,-e.y/2,e.x,e.y),this._removeShadow(t)}_setOpacity(t){this.group&&!this.group._transformDone?t.globalAlpha=this.getObjectOpacity():t.globalAlpha*=this.opacity}_setStrokeStyles(t,e){const r=e.stroke;r&&(t.lineWidth=e.strokeWidth,t.lineCap=e.strokeLineCap,t.lineDashOffset=e.strokeDashOffset,t.lineJoin=e.strokeLineJoin,t.miterLimit=e.strokeMiterLimit,Ze(r)?r.gradientUnits==="percentage"||r.gradientTransform||r.patternTransform?this._applyPatternForTransformedGradient(t,r):(t.strokeStyle=r.toLive(t),this._applyPatternGradientTransform(t,r)):t.strokeStyle=e.stroke)}_setFillStyles(t,e){let{fill:r}=e;r&&(Ze(r)?(t.fillStyle=r.toLive(t),this._applyPatternGradientTransform(t,r)):t.fillStyle=r)}_setClippingProperties(t){t.globalAlpha=1,t.strokeStyle="transparent",t.fillStyle="#000000"}_setLineDash(t,e){e&&e.length!==0&&t.setLineDash(e)}_setShadow(t){if(!this.shadow)return;const e=this.shadow,r=this.canvas,s=this.getCanvasRetinaScaling(),[i,,,n]=r?.viewportTransform||Fe,o=i*s,l=n*s,c=e.nonScaling?new F(1,1):this.getObjectScaling();t.shadowColor=e.color,t.shadowBlur=e.blur*Wt.browserShadowBlurConstant*(o+l)*(c.x+c.y)/4,t.shadowOffsetX=e.offsetX*o*c.x,t.shadowOffsetY=e.offsetY*l*c.y}_removeShadow(t){this.shadow&&(t.shadowColor="",t.shadowBlur=t.shadowOffsetX=t.shadowOffsetY=0)}_applyPatternGradientTransform(t,e){if(!Ze(e))return{offsetX:0,offsetY:0};const r=e.gradientTransform||e.patternTransform,s=-this.width/2+e.offsetX||0,i=-this.height/2+e.offsetY||0;return e.gradientUnits==="percentage"?t.transform(this.width,0,0,this.height,s,i):t.transform(1,0,0,1,s,i),r&&t.transform(r[0],r[1],r[2],r[3],r[4],r[5]),{offsetX:s,offsetY:i}}_renderPaintInOrder(t){this.paintFirst===He?(this._renderStroke(t),this._renderFill(t)):(this._renderFill(t),this._renderStroke(t))}_render(t){}_renderFill(t){this.fill&&(t.save(),this._setFillStyles(t,this),this.fillRule==="evenodd"?t.fill("evenodd"):t.fill(),t.restore())}_renderStroke(t){if(this.stroke&&this.strokeWidth!==0){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(t),t.save(),this.strokeUniform){const e=this.getObjectScaling();t.scale(1/e.x,1/e.y)}this._setLineDash(t,this.strokeDashArray),this._setStrokeStyles(t,this),t.stroke(),t.restore()}}_applyPatternForTransformedGradient(t,e){var r;const s=this._limitCacheSize(this._getCacheCanvasDimensions()),i=this.getCanvasRetinaScaling(),n=s.x/this.scaleX/i,o=s.y/this.scaleY/i,l=sr({width:Math.ceil(n),height:Math.ceil(o)}),c=l.getContext("2d");c&&(c.beginPath(),c.moveTo(0,0),c.lineTo(n,0),c.lineTo(n,o),c.lineTo(0,o),c.closePath(),c.translate(n/2,o/2),c.scale(s.zoomX/this.scaleX/i,s.zoomY/this.scaleY/i),this._applyPatternGradientTransform(c,e),c.fillStyle=e.toLive(t),c.fill(),t.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),t.scale(i*this.scaleX/s.zoomX,i*this.scaleY/s.zoomY),t.strokeStyle=(r=c.createPattern(l,"no-repeat"))!==null&&r!==void 0?r:"")}_findCenterFromElement(){return new F(this.left+this.width/2,this.top+this.height/2)}clone(t){const e=this.toObject(t);return this.constructor.fromObject(e)}cloneAsImage(t){const e=this.toCanvasElement(t);return new(gt.getClass("image"))(e)}toCanvasElement(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=Kl(this),r=this.group,s=this.shadow,i=Math.abs,n=t.enableRetinaScaling?Ll():1,o=(t.multiplier||1)*n,l=t.canvasProvider||(T=>new Di(T,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1}));delete this.group,t.withoutTransform&&fg(this),t.withoutShadow&&(this.shadow=null),t.viewportTransform&&pg(this,this.getViewportTransform()),this.setCoords();const c=$r(),u=this.getBoundingRect(),d=this.shadow,g=new F;if(d){const T=d.blur,A=d.nonScaling?new F(1,1):this.getObjectScaling();g.x=2*Math.round(i(d.offsetX)+T)*i(A.x),g.y=2*Math.round(i(d.offsetY)+T)*i(A.y)}const f=u.width+g.x,m=u.height+g.y;c.width=Math.ceil(f),c.height=Math.ceil(m);const p=l(c);t.format==="jpeg"&&(p.backgroundColor="#fff"),this.setPositionByOrigin(new F(p.width/2,p.height/2),Bt,Bt);const v=this.canvas;p._objects=[this],this.set("canvas",p),this.setCoords();const x=p.toCanvasElement(o||1,t);return this.set("canvas",v),this.shadow=s,r&&(this.group=r),this.set(e),this.setCoords(),p._objects=[],p.destroy(),x}toDataURL(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return Vl(this.toCanvasElement(t),t.format||"png",t.quality||1)}toBlob(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return Wl(this.toCanvasElement(t),t.format||"png",t.quality||1)}isType(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return e.includes(this.constructor.type)||e.includes(this.type)}complexity(){return 1}toJSON(){return this.toObject()}rotate(t){const{centeredRotation:e,originX:r,originY:s}=this;if(e){const{x:i,y:n}=this.getRelativeCenterPoint();this.originX=Bt,this.originY=Bt,this.left=i,this.top=n}if(this.set("angle",t),e){const{x:i,y:n}=this.translateToOriginPoint(this.getRelativeCenterPoint(),r,s);this.left=i,this.top=n,this.originX=r,this.originY=s}}setOnGroup(){}_setupCompositeOperation(t){this.globalCompositeOperation&&(t.globalCompositeOperation=this.globalCompositeOperation)}dispose(){bn.cancelByTarget(this),this.off(),this._set("canvas",void 0),this._cacheCanvas&&Ar().dispose(this._cacheCanvas),this._cacheCanvas=void 0,this._cacheContext=null}animate(t,e){return Object.entries(t).reduce(((r,s)=>{let[i,n]=s;return r[i]=this._animate(i,n,e),r}),{})}_animate(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};const s=t.split("."),i=this.constructor.colorProperties.includes(s[s.length-1]),{abort:n,startValue:o,onChange:l,onComplete:c}=r,u=C(C({},r),{},{target:this,startValue:o??s.reduce(((d,g)=>d[g]),this),endValue:e,abort:n?.bind(this),onChange:(d,g,f)=>{s.reduce(((m,p,v)=>(v===s.length-1&&(m[p]=d),m[p])),this),l&&l(d,g,f)},onComplete:(d,g,f)=>{this.setCoords(),c&&c(d,g,f)}});return i?Bg(u):cc(u)}isDescendantOf(t){const{parent:e,group:r}=this;return e===t||r===t||!!e&&e.isDescendantOf(t)||!!r&&r!==e&&r.isDescendantOf(t)}getAncestors(){const t=[];let e=this;do e=e.parent,e&&t.push(e);while(e);return t}findCommonAncestors(t){if(this===t)return{fork:[],otherFork:[],common:[this,...this.getAncestors()]};const e=this.getAncestors(),r=t.getAncestors();if(e.length===0&&r.length>0&&this===r[r.length-1])return{fork:[],otherFork:[t,...r.slice(0,r.length-1)],common:[this]};for(let s,i=0;i<e.length;i++){if(s=e[i],s===t)return{fork:[this,...e.slice(0,i)],otherFork:[],common:e.slice(i)};for(let n=0;n<r.length;n++){if(this===r[n])return{fork:[],otherFork:[t,...r.slice(0,n)],common:[this,...e]};if(s===r[n])return{fork:[this,...e.slice(0,i)],otherFork:[t,...r.slice(0,n)],common:e.slice(i)}}}return{fork:[this,...e],otherFork:[t,...r],common:[]}}hasCommonAncestors(t){const e=this.findCommonAncestors(t);return e&&!!e.common.length}isInFrontOf(t){if(this===t)return;const e=this.findCommonAncestors(t);if(e.fork.includes(t))return!0;if(e.otherFork.includes(this))return!1;const r=e.common[0]||this.canvas;if(!r)return;const s=e.fork.pop(),i=e.otherFork.pop(),n=r._objects.indexOf(s),o=r._objects.indexOf(i);return n>-1&&n>o}toObject(){const t=(arguments.length>0&&arguments[0]!==void 0?arguments[0]:[]).concat(un.customProperties,this.constructor.customProperties||[]);let e;const r=Wt.NUM_FRACTION_DIGITS,{clipPath:s,fill:i,stroke:n,shadow:o,strokeDashArray:l,left:c,top:u,originX:d,originY:g,width:f,height:m,strokeWidth:p,strokeLineCap:v,strokeDashOffset:x,strokeLineJoin:T,strokeUniform:A,strokeMiterLimit:O,scaleX:P,scaleY:L,angle:E,flipX:_,flipY:j,opacity:X,visible:G,backgroundColor:R,fillRule:B,paintFirst:V,globalCompositeOperation:Q,skewX:tt,skewY:z}=this;s&&!s.excludeFromExport&&(e=s.toObject(t.concat("inverted","absolutePositioned")));const $=rt=>re(rt,r),J=C(C({},ei(this,t)),{},{type:this.constructor.type,version:fo,originX:d,originY:g,left:$(c),top:$(u),width:$(f),height:$(m),fill:Ca(i)?i.toObject():i,stroke:Ca(n)?n.toObject():n,strokeWidth:$(p),strokeDashArray:l&&l.concat(),strokeLineCap:v,strokeDashOffset:x,strokeLineJoin:T,strokeUniform:A,strokeMiterLimit:$(O),scaleX:$(P),scaleY:$(L),angle:$(E),flipX:_,flipY:j,opacity:$(X),shadow:o&&o.toObject(),visible:G,backgroundColor:R,fillRule:B,paintFirst:V,globalCompositeOperation:Q,skewX:$(tt),skewY:$(z)},e?{clipPath:e}:null);return this.includeDefaultValues?J:this._removeDefaultValues(J)}toDatalessObject(t){return this.toObject(t)}_removeDefaultValues(t){const e=this.constructor.getDefaults(),r=Object.keys(e).length>0?e:Object.getPrototypeOf(this);return Yo(t,((s,i)=>{if(i===$t||i===Ve||i==="type")return!0;const n=r[i];return s!==n&&!(Array.isArray(s)&&Array.isArray(n)&&s.length===0&&n.length===0)}))}toString(){return"#<".concat(this.constructor.type,">")}static _fromObject(t){let e=ie(t,Vg),r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{extraParam:s}=r,i=ie(r,Wg);return zn(e,i).then((n=>s?(delete n[s],new this(e[s],n)):new this(n)))}static fromObject(t,e){return this._fromObject(t,e)}};S(zr,"stateProperties",Og),S(zr,"cacheProperties",Jr),S(zr,"ownDefaults",Ag),S(zr,"type","FabricObject"),S(zr,"colorProperties",[_e,He,"backgroundColor"]),S(zr,"customProperties",[]),gt.setClass(zr),gt.setClass(zr,"object");const ri=(a,t,e)=>(r,s,i,n)=>{const o=t(r,s,i,n);return o&&Zl(a,C(C({},Ql(r,s,i,n)),e)),o};function si(a){return(t,e,r,s)=>{const{target:i,originX:n,originY:o}=e,l=i.getRelativeCenterPoint(),c=i.translateToOriginPoint(l,n,o),u=a(t,e,r,s);return i.setPositionByOrigin(c,e.originX,e.originY),u}}const Va=ri(xi,si(((a,t,e,r)=>{const s=No(t,t.originX,t.originY,e,r);if(ve(t.originX)===ve(Bt)||ve(t.originX)===ve(de)&&s.x<0||ve(t.originX)===ve($t)&&s.x>0){const{target:i}=t,n=i.strokeWidth/(i.strokeUniform?i.scaleX:1),o=Jl(t)?2:1,l=i.width,c=Math.abs(s.x*o/i.scaleX)-n;return i.set("width",Math.max(c,1)),l!==i.width}return!1})));function Hg(a,t,e,r,s){r=r||{};const i=this.sizeX||r.cornerSize||s.cornerSize,n=this.sizeY||r.cornerSize||s.cornerSize,o=r.transparentCorners!==void 0?r.transparentCorners:s.transparentCorners,l=o?He:_e,c=!o&&(r.cornerStrokeColor||s.cornerStrokeColor);let u,d=t,g=e;a.save(),a.fillStyle=r.cornerColor||s.cornerColor||"",a.strokeStyle=r.cornerStrokeColor||s.cornerStrokeColor||"",i>n?(u=i,a.scale(1,n/i),g=e*i/n):n>i?(u=n,a.scale(i/n,1),d=t*n/i):u=i,a.beginPath(),a.arc(d,g,u/2,0,yn,!1),a[l](),c&&a.stroke(),a.restore()}function Yg(a,t,e,r,s){r=r||{};const i=this.sizeX||r.cornerSize||s.cornerSize,n=this.sizeY||r.cornerSize||s.cornerSize,o=r.transparentCorners!==void 0?r.transparentCorners:s.transparentCorners,l=o?He:_e,c=!o&&(r.cornerStrokeColor||s.cornerStrokeColor),u=i/2,d=n/2;a.save(),a.fillStyle=r.cornerColor||s.cornerColor||"",a.strokeStyle=r.cornerStrokeColor||s.cornerStrokeColor||"",a.translate(t,e);const g=s.getTotalAngle();a.rotate(ge(g)),a["".concat(l,"Rect")](-u,-d,i,n),c&&a.strokeRect(-u,-d,i,n),a.restore()}class ar{constructor(t){S(this,"visible",!0),S(this,"actionName",Rn),S(this,"angle",0),S(this,"x",0),S(this,"y",0),S(this,"offsetX",0),S(this,"offsetY",0),S(this,"sizeX",0),S(this,"sizeY",0),S(this,"touchSizeX",0),S(this,"touchSizeY",0),S(this,"cursorStyle","crosshair"),S(this,"withConnection",!1),Object.assign(this,t)}shouldActivate(t,e,r,s){var i;let{tl:n,tr:o,br:l,bl:c}=s;return((i=e.canvas)===null||i===void 0?void 0:i.getActiveObject())===e&&e.isControlVisible(t)&&le.isPointInPolygon(r,[n,o,l,c])}getActionHandler(t,e,r){return this.actionHandler}getMouseDownHandler(t,e,r){return this.mouseDownHandler}getMouseUpHandler(t,e,r){return this.mouseUpHandler}cursorStyleHandler(t,e,r){return e.cursorStyle}getActionName(t,e,r){return e.actionName}getVisibility(t,e){var r,s;return(r=(s=t._controlsVisibility)===null||s===void 0?void 0:s[e])!==null&&r!==void 0?r:this.visible}setVisibility(t,e,r){this.visible=t}positionHandler(t,e,r,s){return new F(this.x*t.x+this.offsetX,this.y*t.y+this.offsetY).transform(e)}calcCornerCoords(t,e,r,s,i,n){const o=Wo([Ai(r,s),ti({angle:t}),Ho((i?this.touchSizeX:this.sizeX)||e,(i?this.touchSizeY:this.sizeY)||e)]);return{tl:new F(-.5,-.5).transform(o),tr:new F(.5,-.5).transform(o),br:new F(.5,.5).transform(o),bl:new F(-.5,.5).transform(o)}}render(t,e,r,s,i){((s=s||{}).cornerStyle||i.cornerStyle)==="circle"?Hg.call(this,t,e,r,s,i):Yg.call(this,t,e,r,s,i)}}const Xg=(a,t,e)=>e.lockRotation?Tn:t.cursorStyle,Ng=ri(jl,si(((a,t,e,r)=>{let{target:s,ex:i,ey:n,theta:o,originX:l,originY:c}=t;const u=s.translateToOriginPoint(s.getRelativeCenterPoint(),l,c);if(mr(s,"lockRotation"))return!1;const d=Math.atan2(n-u.y,i-u.x),g=Math.atan2(r-u.y,e-u.x);let f=Kr(g-d+o);if(s.snapAngle&&s.snapAngle>0){const p=s.snapAngle,v=s.snapThreshold||p,x=Math.ceil(f/p)*p,T=Math.floor(f/p)*p;Math.abs(f-T)<v?f=T:Math.abs(f-x)<v&&(f=x)}f<0&&(f=360+f),f%=360;const m=s.angle!==f;return s.angle=f,m})));function hc(a,t){const e=t.canvas,r=a[e.uniScaleKey];return e.uniformScaling&&!r||!e.uniformScaling&&r}function uc(a,t,e){const r=mr(a,"lockScalingX"),s=mr(a,"lockScalingY");if(r&&s||!t&&(r||s)&&e||r&&t==="x"||s&&t==="y")return!0;const{width:i,height:n,strokeWidth:o}=a;return i===0&&o===0&&t!=="y"||n===0&&o===0&&t!=="x"}const Ug=["e","se","s","sw","w","nw","n","ne","e"],ui=(a,t,e)=>{const r=hc(a,e);if(uc(e,t.x!==0&&t.y===0?"x":t.x===0&&t.y!==0?"y":"",r))return Tn;const s=tc(e,t);return"".concat(Ug[s],"-resize")};function qo(a,t,e,r){let s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{};const i=t.target,n=s.by,o=hc(a,i);let l,c,u,d,g,f;if(uc(i,n,o))return!1;if(t.gestureScale)c=t.scaleX*t.gestureScale,u=t.scaleY*t.gestureScale;else{if(l=No(t,t.originX,t.originY,e,r),g=n!=="y"?Math.sign(l.x||t.signX||1):1,f=n!=="x"?Math.sign(l.y||t.signY||1):1,t.signX||(t.signX=g),t.signY||(t.signY=f),mr(i,"lockScalingFlip")&&(t.signX!==g||t.signY!==f))return!1;if(d=i._getTransformedDimensions(),o&&!n){const v=Math.abs(l.x)+Math.abs(l.y),{original:x}=t,T=v/(Math.abs(d.x*x.scaleX/i.scaleX)+Math.abs(d.y*x.scaleY/i.scaleY));c=x.scaleX*T,u=x.scaleY*T}else c=Math.abs(l.x*i.scaleX/d.x),u=Math.abs(l.y*i.scaleY/d.y);Jl(t)&&(c*=2,u*=2),t.signX!==g&&n!=="y"&&(t.originX=Aa(t.originX),c*=-1,t.signX=g),t.signY!==f&&n!=="x"&&(t.originY=Aa(t.originY),u*=-1,t.signY=f)}const m=i.scaleX,p=i.scaleY;return n?(n==="x"&&i.set(Ye,c),n==="y"&&i.set(rr,u)):(!mr(i,"lockScalingX")&&i.set(Ye,c),!mr(i,"lockScalingY")&&i.set(rr,u)),m!==i.scaleX||p!==i.scaleY}const Ii=ri(jn,si(((a,t,e,r)=>qo(a,t,e,r)))),Gg=ri(jn,si(((a,t,e,r)=>qo(a,t,e,r,{by:"x"})))),qg=ri(jn,si(((a,t,e,r)=>qo(a,t,e,r,{by:"y"})))),$g=["target","ex","ey","skewingSide"],so={x:{counterAxis:"y",scale:Ye,skew:Js,lockSkewing:"lockSkewingX",origin:"originX",flip:"flipX"},y:{counterAxis:"x",scale:rr,skew:Qs,lockSkewing:"lockSkewingY",origin:"originY",flip:"flipY"}},Kg=["ns","nesw","ew","nwse"],Zg=(a,t,e)=>{if(t.x!==0&&mr(e,"lockSkewingY")||t.y!==0&&mr(e,"lockSkewingX"))return Tn;const r=tc(e,t)%4;return"".concat(Kg[r],"-resize")};function dc(a,t,e,r,s){const{target:i}=e,{counterAxis:n,origin:o,lockSkewing:l,skew:c,flip:u}=so[a];if(mr(i,l))return!1;const{origin:d,flip:g}=so[n],f=ve(e[d])*(i[g]?-1:1),m=-Math.sign(f)*(i[u]?-1:1),p=.5*-((i[c]===0&&No(e,Bt,Bt,r,s)[a]>0||i[c]>0?1:-1)*m)+.5;return ri(Rl,si(((x,T,A,O)=>(function(P,L,E){let{target:_,ex:j,ey:X,skewingSide:G}=L,R=ie(L,$g);const{skew:B}=so[P],V=E.subtract(new F(j,X)).divide(new F(_.scaleX,_.scaleY))[P],Q=_[B],tt=R[B],z=Math.tan(ge(tt)),$=P==="y"?_._getTransformedDimensions({scaleX:1,scaleY:1,skewX:0}).x:_._getTransformedDimensions({scaleX:1,scaleY:1}).y,J=2*V*G/Math.max($,1)+z,rt=Kr(Math.atan(J));_.set(B,rt);const it=Q!==_[B];if(it&&P==="y"){const{skewX:ht,scaleX:nt}=_,ut=_._getTransformedDimensions({skewY:Q}),D=_._getTransformedDimensions(),W=ht!==0?ut.x/D.x:1;W!==1&&_.set(Ye,W*nt)}return it})(a,T,new F(A,O)))))(t,C(C({},e),{},{[o]:p,skewingSide:m}),r,s)}const Jg=(a,t,e,r)=>dc("x",a,t,e,r),Qg=(a,t,e,r)=>dc("y",a,t,e,r);function Hn(a,t){return a[t.canvas.altActionKey]}const Li=(a,t,e)=>{const r=Hn(a,e);return t.x===0?r?Js:rr:t.y===0?r?Qs:Ye:""},Vs=(a,t,e)=>Hn(a,e)?Zg(0,t,e):ui(a,t,e),Wa=(a,t,e,r)=>Hn(a,t.target)?Qg(a,t,e,r):Gg(a,t,e,r),Ha=(a,t,e,r)=>Hn(a,t.target)?Jg(a,t,e,r):qg(a,t,e,r),gc=()=>({ml:new ar({x:-.5,y:0,cursorStyleHandler:Vs,actionHandler:Wa,getActionName:Li}),mr:new ar({x:.5,y:0,cursorStyleHandler:Vs,actionHandler:Wa,getActionName:Li}),mb:new ar({x:0,y:.5,cursorStyleHandler:Vs,actionHandler:Ha,getActionName:Li}),mt:new ar({x:0,y:-.5,cursorStyleHandler:Vs,actionHandler:Ha,getActionName:Li}),tl:new ar({x:-.5,y:-.5,cursorStyleHandler:ui,actionHandler:Ii}),tr:new ar({x:.5,y:-.5,cursorStyleHandler:ui,actionHandler:Ii}),bl:new ar({x:-.5,y:.5,cursorStyleHandler:ui,actionHandler:Ii}),br:new ar({x:.5,y:.5,cursorStyleHandler:ui,actionHandler:Ii}),mtr:new ar({x:0,y:-.5,actionHandler:Ng,cursorStyleHandler:Xg,offsetY:-40,withConnection:!0,actionName:zo})}),tf=()=>({mr:new ar({x:.5,y:0,actionHandler:Va,cursorStyleHandler:Vs,actionName:xi}),ml:new ar({x:-.5,y:0,actionHandler:Va,cursorStyleHandler:Vs,actionName:xi})}),ef=()=>C(C({},gc()),tf());class Es extends zr{static getDefaults(){return C(C({},super.getDefaults()),Es.ownDefaults)}constructor(t){super(),Object.assign(this,this.constructor.createControls(),Es.ownDefaults),this.setOptions(t)}static createControls(){return{controls:gc()}}_updateCacheCanvas(){const t=this.canvas;if(this.noScaleCache&&t&&t._currentTransform){const e=t._currentTransform,r=e.target,s=e.action;if(this===r&&s&&s.startsWith(Rn))return!1}return super._updateCacheCanvas()}getActiveControl(){const t=this.__corner;return t?{key:t,control:this.controls[t],coord:this.oCoords[t]}:void 0}findControl(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!this.hasControls||!this.canvas)return;this.__corner=void 0;const r=Object.entries(this.oCoords);for(let s=r.length-1;s>=0;s--){const[i,n]=r[s],o=this.controls[i];if(o.shouldActivate(i,this,t,e?n.touchCorner:n.corner))return this.__corner=i,{key:i,control:o,coord:this.oCoords[i]}}}calcOCoords(){const t=this.getViewportTransform(),e=this.getCenterPoint(),r=Ai(e.x,e.y),s=ti({angle:this.getTotalAngle()-(this.group&&this.flipX?180:0)}),i=Te(r,s),n=Te(t,i),o=Te(n,[1/t[0],0,0,1/t[3],0,0]),l=this.group?Sn(this.calcTransformMatrix()):void 0;l&&(l.scaleX=Math.abs(l.scaleX),l.scaleY=Math.abs(l.scaleY));const c=this._calculateCurrentDimensions(l),u={};return this.forEachControl(((d,g)=>{const f=d.positionHandler(c,o,this,d);u[g]=Object.assign(f,this._calcCornerCoords(d,f))})),u}_calcCornerCoords(t,e){const r=this.getTotalAngle();return{corner:t.calcCornerCoords(r,this.cornerSize,e.x,e.y,!1,this),touchCorner:t.calcCornerCoords(r,this.touchCornerSize,e.x,e.y,!0,this)}}setCoords(){super.setCoords(),this.canvas&&(this.oCoords=this.calcOCoords())}forEachControl(t){for(const e in this.controls)t(this.controls[e],e,this)}drawSelectionBackground(t){if(!this.selectionBackgroundColor||this.canvas&&this.canvas._activeObject!==this)return;t.save();const e=this.getRelativeCenterPoint(),r=this._calculateCurrentDimensions(),s=this.getViewportTransform();t.translate(e.x,e.y),t.scale(1/s[0],1/s[3]),t.rotate(ge(this.angle)),t.fillStyle=this.selectionBackgroundColor,t.fillRect(-r.x/2,-r.y/2,r.x,r.y),t.restore()}strokeBorders(t,e){t.strokeRect(-e.x/2,-e.y/2,e.x,e.y)}_drawBorders(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};const s=C({hasControls:this.hasControls,borderColor:this.borderColor,borderDashArray:this.borderDashArray},r);t.save(),t.strokeStyle=s.borderColor,this._setLineDash(t,s.borderDashArray),this.strokeBorders(t,e),s.hasControls&&this.drawControlsConnectingLines(t,e),t.restore()}_renderControls(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const{hasBorders:r,hasControls:s}=this,i=C({hasBorders:r,hasControls:s},e),n=this.getViewportTransform(),o=i.hasBorders,l=i.hasControls,c=Te(n,this.calcTransformMatrix()),u=Sn(c);t.save(),t.translate(u.translateX,u.translateY),t.lineWidth=this.borderScaleFactor,this.group===this.parent&&(t.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),this.flipX&&(u.angle-=180),t.rotate(ge(this.group?u.angle:this.angle)),o&&this.drawBorders(t,u,e),l&&this.drawControls(t,e),t.restore()}drawBorders(t,e,r){let s;if(r&&r.forActiveSelection||this.group){const i=Xo(this.width,this.height,Bn(e)),n=this.isStrokeAccountedForInDimensions()?Vo:(this.strokeUniform?new F().scalarAdd(this.canvas?this.canvas.getZoom():1):new F(e.scaleX,e.scaleY)).scalarMultiply(this.strokeWidth);s=i.add(n).scalarAdd(this.borderScaleFactor).scalarAdd(2*this.padding)}else s=this._calculateCurrentDimensions().scalarAdd(this.borderScaleFactor);this._drawBorders(t,s,r)}drawControlsConnectingLines(t,e){let r=!1;t.beginPath(),this.forEachControl(((s,i)=>{s.withConnection&&s.getVisibility(this,i)&&(r=!0,t.moveTo(s.x*e.x,s.y*e.y),t.lineTo(s.x*e.x+s.offsetX,s.y*e.y+s.offsetY))})),r&&t.stroke()}drawControls(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};t.save();const r=this.getCanvasRetinaScaling(),{cornerStrokeColor:s,cornerDashArray:i,cornerColor:n}=this,o=C({cornerStrokeColor:s,cornerDashArray:i,cornerColor:n},e);t.setTransform(r,0,0,r,0,0),t.strokeStyle=t.fillStyle=o.cornerColor,this.transparentCorners||(t.strokeStyle=o.cornerStrokeColor),this._setLineDash(t,o.cornerDashArray),this.forEachControl(((l,c)=>{if(l.getVisibility(this,c)){const u=this.oCoords[c];l.render(t,u.x,u.y,o,this)}})),t.restore()}isControlVisible(t){return this.controls[t]&&this.controls[t].getVisibility(this,t)}setControlVisible(t,e){this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[t]=e}setControlsVisibility(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};Object.entries(t).forEach((e=>{let[r,s]=e;return this.setControlVisible(r,s)}))}clearContextTop(t){if(!this.canvas)return;const e=this.canvas.contextTop;if(!e)return;const r=this.canvas.viewportTransform;e.save(),e.transform(r[0],r[1],r[2],r[3],r[4],r[5]),this.transform(e);const s=this.width+4,i=this.height+4;return e.clearRect(-s/2,-i/2,s,i),t||e.restore(),e}onDeselect(t){return!1}onSelect(t){return!1}shouldStartDragging(t){return!1}onDragStart(t){return!1}canDrop(t){return!1}renderDragSourceEffect(t){}renderDropTargetEffect(t){}}function fc(a,t){return t.forEach((e=>{Object.getOwnPropertyNames(e.prototype).forEach((r=>{r!=="constructor"&&Object.defineProperty(a.prototype,r,Object.getOwnPropertyDescriptor(e.prototype,r)||Object.create(null))}))})),a}S(Es,"ownDefaults",{noScaleCache:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,cornerSize:13,touchCornerSize:24,transparentCorners:!0,cornerColor:"rgb(178,204,255)",cornerStrokeColor:"",cornerStyle:"rect",cornerDashArray:null,hasControls:!0,borderColor:"rgb(178,204,255)",borderDashArray:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,hasBorders:!0,selectionBackgroundColor:"",selectable:!0,evented:!0,perPixelTargetFind:!1,activeOn:"down",hoverCursor:null,moveCursor:null});class Me extends Es{}fc(Me,[ec]),gt.setClass(Me),gt.setClass(Me,"object");const rf=(a,t,e,r)=>{const s=2*(r=Math.round(r))+1,{data:i}=a.getImageData(t-r,e-r,s,s);for(let n=3;n<i.length;n+=4)if(i[n]>0)return!1;return!0};class mc{constructor(t){this.options=t,this.strokeProjectionMagnitude=this.options.strokeWidth/2,this.scale=new F(this.options.scaleX,this.options.scaleY),this.strokeUniformScalar=this.options.strokeUniform?new F(1/this.options.scaleX,1/this.options.scaleY):new F(1,1)}createSideVector(t,e){const r=_o(t,e);return this.options.strokeUniform?r.multiply(this.scale):r}projectOrthogonally(t,e,r){return this.applySkew(t.add(this.calcOrthogonalProjection(t,e,r)))}isSkewed(){return this.options.skewX!==0||this.options.skewY!==0}applySkew(t){const e=new F(t);return e.y+=e.x*Math.tan(ge(this.options.skewY)),e.x+=e.y*Math.tan(ge(this.options.skewX)),e}scaleUnitVector(t,e){return t.multiply(this.strokeUniformScalar).scalarMultiply(e)}}const sf=new F;class Gs extends mc{static getOrthogonalRotationFactor(t,e){const r=e?xo(t,e):Tg(t);return Math.abs(r)<Oi?-1:1}constructor(t,e,r,s){super(s),S(this,"AB",void 0),S(this,"AC",void 0),S(this,"alpha",void 0),S(this,"bisector",void 0),this.A=new F(t),this.B=new F(e),this.C=new F(r),this.AB=this.createSideVector(this.A,this.B),this.AC=this.createSideVector(this.A,this.C),this.alpha=xo(this.AB,this.AC),this.bisector=Uo(ac(this.AB.eq(sf)?this.AC:this.AB,this.alpha/2))}calcOrthogonalProjection(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.strokeProjectionMagnitude;const s=this.createSideVector(t,e),i=lc(s),n=Gs.getOrthogonalRotationFactor(i,this.bisector);return this.scaleUnitVector(i,r*n)}projectBevel(){const t=[];return(this.alpha%yn==0?[this.B]:[this.B,this.C]).forEach((e=>{t.push(this.projectOrthogonally(this.A,e)),t.push(this.projectOrthogonally(this.A,e,-this.strokeProjectionMagnitude))})),t}projectMiter(){const t=[],e=Math.abs(this.alpha),r=1/Math.sin(e/2),s=this.scaleUnitVector(this.bisector,-this.strokeProjectionMagnitude*r),i=this.options.strokeUniform?yo(this.scaleUnitVector(this.bisector,this.options.strokeMiterLimit)):this.options.strokeMiterLimit;return yo(s)/this.strokeProjectionMagnitude<=i&&t.push(this.applySkew(this.A.add(s))),t.push(...this.projectBevel()),t}projectRoundNoSkew(t,e){const r=[],s=new F(Gs.getOrthogonalRotationFactor(this.bisector),Gs.getOrthogonalRotationFactor(new F(this.bisector.y,this.bisector.x)));return[new F(1,0).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar).multiply(s),new F(0,1).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar).multiply(s)].forEach((i=>{Ra(i,t,e)&&r.push(this.A.add(i))})),r}projectRoundWithSkew(t,e){const r=[],{skewX:s,skewY:i,scaleX:n,scaleY:o,strokeUniform:l}=this.options,c=new F(Math.tan(ge(s)),Math.tan(ge(i))),u=this.strokeProjectionMagnitude,d=l?u/o/Math.sqrt(1/o**2+1/n**2*c.y**2):u/Math.sqrt(1+c.y**2),g=new F(Math.sqrt(Math.max(u**2-d**2,0)),d),f=l?u/Math.sqrt(1+c.x**2*(1/o)**2/(1/n+1/n*c.x*c.y)**2):u/Math.sqrt(1+c.x**2/(1+c.x*c.y)**2),m=new F(f,Math.sqrt(Math.max(u**2-f**2,0)));return[m,m.scalarMultiply(-1),g,g.scalarMultiply(-1)].map((p=>this.applySkew(l?p.multiply(this.strokeUniformScalar):p))).forEach((p=>{Ra(p,t,e)&&r.push(this.applySkew(this.A).add(p))})),r}projectRound(){const t=[];t.push(...this.projectBevel());const e=this.alpha%yn==0,r=this.applySkew(this.A),s=t[e?0:2].subtract(r),i=t[e?1:0].subtract(r),n=e?this.applySkew(this.AB.scalarMultiply(-1)):this.applySkew(this.bisector.multiply(this.strokeUniformScalar).scalarMultiply(-1)),o=pi(s,n)>0,l=o?s:i,c=o?i:s;return this.isSkewed()?t.push(...this.projectRoundWithSkew(l,c)):t.push(...this.projectRoundNoSkew(l,c)),t}projectPoints(){switch(this.options.strokeLineJoin){case"miter":return this.projectMiter();case"round":return this.projectRound();default:return this.projectBevel()}}project(){return this.projectPoints().map((t=>({originPoint:this.A,projectedPoint:t,angle:this.alpha,bisector:this.bisector})))}}class Ya extends mc{constructor(t,e,r){super(r),this.A=new F(t),this.T=new F(e)}calcOrthogonalProjection(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.strokeProjectionMagnitude;const s=this.createSideVector(t,e);return this.scaleUnitVector(lc(s),r)}projectButt(){return[this.projectOrthogonally(this.A,this.T,this.strokeProjectionMagnitude),this.projectOrthogonally(this.A,this.T,-this.strokeProjectionMagnitude)]}projectRound(){const t=[];if(!this.isSkewed()&&this.A.eq(this.T)){const e=new F(1,1).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar);t.push(this.applySkew(this.A.add(e)),this.applySkew(this.A.subtract(e)))}else t.push(...new Gs(this.A,this.T,this.T,this.options).projectRound());return t}projectSquare(){const t=[];if(this.A.eq(this.T)){const e=new F(1,1).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar);t.push(this.A.add(e),this.A.subtract(e))}else{const e=this.calcOrthogonalProjection(this.A,this.T,this.strokeProjectionMagnitude),r=this.scaleUnitVector(Uo(this.createSideVector(this.A,this.T)),-this.strokeProjectionMagnitude),s=this.A.add(r);t.push(s.add(e),s.subtract(e))}return t.map((e=>this.applySkew(e)))}projectPoints(){switch(this.options.strokeLineCap){case"round":return this.projectRound();case"square":return this.projectSquare();default:return this.projectButt()}}project(){return this.projectPoints().map((t=>({originPoint:this.A,projectedPoint:t})))}}const nf=function(a,t){let e=arguments.length>2&&arguments[2]!==void 0&&arguments[2];const r=[];if(a.length===0)return r;const s=a.reduce(((i,n)=>(i[i.length-1].eq(n)||i.push(new F(n)),i)),[new F(a[0])]);if(s.length===1)e=!0;else if(!e){const i=s[0],n=((o,l)=>{for(let c=o.length-1;c>=0;c--)if(l(o[c],c,o))return c;return-1})(s,(o=>!o.eq(i)));s.splice(n+1)}return s.forEach(((i,n,o)=>{let l,c;n===0?(c=o[1],l=e?i:o[o.length-1]):n===o.length-1?(l=o[n-1],c=e?i:o[0]):(l=o[n-1],c=o[n+1]),e&&o.length===1?r.push(...new Ya(i,i,t).project()):!e||n!==0&&n!==o.length-1?r.push(...new Gs(i,l,c,t).project()):r.push(...new Ya(i,n===0?c:l,t).project())})),r},$o=a=>{const t={};return Object.keys(a).forEach((e=>{t[e]={},Object.keys(a[e]).forEach((r=>{t[e][r]=C({},a[e][r])}))})),t},of=a=>a.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;");let ai;const Ko=a=>{if(ai||ai||(ai="Intl"in Fn()&&"Segmenter"in Intl&&new Intl.Segmenter(void 0,{granularity:"grapheme"})),ai){const t=ai.segment(a);return Array.from(t).map((e=>{let{segment:r}=e;return r}))}return af(a)},af=a=>{const t=[];for(let e,r=0;r<a.length;r++)(e=lf(a,r))!==!1&&t.push(e);return t},lf=(a,t)=>{const e=a.charCodeAt(t);if(isNaN(e))return"";if(e<55296||e>57343)return a.charAt(t);if(55296<=e&&e<=56319){if(a.length<=t+1)throw"High surrogate without following low surrogate";const s=a.charCodeAt(t+1);if(56320>s||s>57343)throw"High surrogate without following low surrogate";return a.charAt(t)+a.charAt(t+1)}if(t===0)throw"Low surrogate without preceding high surrogate";const r=a.charCodeAt(t-1);if(55296>r||r>56319)throw"Low surrogate without preceding high surrogate";return!1},Zo=function(a,t){let e=arguments.length>2&&arguments[2]!==void 0&&arguments[2];return a.fill!==t.fill||a.stroke!==t.stroke||a.strokeWidth!==t.strokeWidth||a.fontSize!==t.fontSize||a.fontFamily!==t.fontFamily||a.fontWeight!==t.fontWeight||a.fontStyle!==t.fontStyle||a.textDecorationThickness!==t.textDecorationThickness||a.textBackgroundColor!==t.textBackgroundColor||a.deltaY!==t.deltaY||e&&(a.overline!==t.overline||a.underline!==t.underline||a.linethrough!==t.linethrough)},cf=(a,t)=>{const e=t.split(`
`),r=[];let s=-1,i={};a=$o(a);for(let n=0;n<e.length;n++){const o=Ko(e[n]);if(a[n])for(let l=0;l<o.length;l++){s++;const c=a[n][l];c&&Object.keys(c).length>0&&(Zo(i,c,!0)?r.push({start:s,end:s+1,style:c}):r[r.length-1].end++),i=c||{}}else s+=o.length,i={}}return r},hf=(a,t)=>{if(!Array.isArray(a))return $o(a);const e=t.split(Bo),r={};let s=-1,i=0;for(let n=0;n<e.length;n++){const o=Ko(e[n]);for(let l=0;l<o.length;l++)s++,a[i]&&a[i].start<=s&&s<a[i].end&&(r[n]=r[n]||{},r[n][l]=C({},a[i].style),s===a[i].end-1&&i++)}return r},ms=["display","transform",_e,"fill-opacity","fill-rule","opacity",He,"stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"];function Xa(a,t){const e=a.nodeName,r=a.getAttribute("class"),s=a.getAttribute("id"),i="(?![a-zA-Z\\-]+)";let n;if(n=new RegExp("^"+e,"i"),t=t.replace(n,""),s&&t.length&&(n=new RegExp("#"+s+i,"i"),t=t.replace(n,"")),r&&t.length){const o=r.split(" ");for(let l=o.length;l--;)n=new RegExp("\\."+o[l]+i,"i"),t=t.replace(n,"")}return t.length===0}function uf(a,t){let e=!0;const r=Xa(a,t.pop());return r&&t.length&&(e=(function(s,i){let n,o=!0;for(;s.parentElement&&s.parentElement.nodeType===1&&i.length;)o&&(n=i.pop()),o=Xa(s=s.parentElement,n);return i.length===0})(a,t)),r&&e&&t.length===0}const df=a=>{var t;return(t=Sg[a])!==null&&t!==void 0?t:a},gf=new RegExp("(".concat(dr,")"),"gi"),ff=a=>kn(a.replace(gf," $1 ").replace(/,/gi," "));var Na,Ua,Ga,qa,$a,Ka,Za;const Le="(".concat(dr,")"),mf=String.raw(Na||(Na=Er(["(skewX)(",")"],["(skewX)\\(","\\)"])),Le),pf=String.raw(Ua||(Ua=Er(["(skewY)(",")"],["(skewY)\\(","\\)"])),Le),vf=String.raw(Ga||(Ga=Er(["(rotate)(","(?: "," ",")?)"],["(rotate)\\(","(?: "," ",")?\\)"])),Le,Le,Le),_f=String.raw(qa||(qa=Er(["(scale)(","(?: ",")?)"],["(scale)\\(","(?: ",")?\\)"])),Le,Le),yf=String.raw($a||($a=Er(["(translate)(","(?: ",")?)"],["(translate)\\(","(?: ",")?\\)"])),Le,Le),xf=String.raw(Ka||(Ka=Er(["(matrix)("," "," "," "," "," ",")"],["(matrix)\\("," "," "," "," "," ","\\)"])),Le,Le,Le,Le,Le,Le),Jo="(?:".concat(xf,"|").concat(yf,"|").concat(vf,"|").concat(_f,"|").concat(mf,"|").concat(pf,")"),wf="(?:".concat(Jo,"*)"),bf=String.raw(Za||(Za=Er(["^s*(?:","?)s*$"],["^\\s*(?:","?)\\s*$"])),wf),Sf=new RegExp(bf),Cf=new RegExp(Jo),Tf=new RegExp(Jo,"g");function wo(a){const t=[];if(!(a=ff(a).replace(/\s*([()])\s*/gi,"$1"))||a&&!Sf.test(a))return[...Fe];for(const e of a.matchAll(Tf)){const r=Cf.exec(e[0]);if(!r)continue;let s=Fe;const i=r.filter((m=>!!m)),[,n,...o]=i,[l,c,u,d,g,f]=o.map((m=>parseFloat(m)));switch(n){case"translate":s=Ai(l,c);break;case zo:s=ti({angle:l},{x:c,y:u});break;case Rn:s=Ho(l,c);break;case Js:s=Xl(l);break;case Qs:s=Nl(l);break;case"matrix":s=[l,c,u,d,g,f]}t.push(s)}return Wo(t)}function kf(a,t,e,r){const s=Array.isArray(t);let i,n=t;if(a!==_e&&a!==He||t!==We){if(a==="strokeUniform")return t==="non-scaling-stroke";if(a==="strokeDashArray")n=t===We?null:t.replace(/,/g," ").split(/\s+/).map(parseFloat);else if(a==="transformMatrix")n=e&&e.transformMatrix?Te(e.transformMatrix,wo(t)):wo(t);else if(a==="visible")n=t!==We&&t!=="hidden",e&&e.visible===!1&&(n=!1);else if(a==="opacity")n=parseFloat(t),e&&e.opacity!==void 0&&(n*=e.opacity);else if(a==="textAnchor")n=t==="start"?$t:t==="end"?de:Bt;else if(a==="charSpacing"||a===Ds)i=Us(t,r)/r*1e3;else if(a==="paintFirst"){const o=t.indexOf(_e),l=t.indexOf(He);n=_e,(o>-1&&l>-1&&l<o||o===-1&&l>-1)&&(n=He)}else{if(a==="href"||a==="xlink:href"||a==="font"||a==="id")return t;if(a==="imageSmoothing")return t==="optimizeQuality";i=s?t.map(Us):Us(t,r)}}else n="";return!s&&isNaN(i)?n:i}function Of(a,t){const e=a.match(bg);if(!e)return;const r=e[1],s=e[3],i=e[4],n=e[5],o=e[6];r&&(t.fontStyle=r),s&&(t.fontWeight=isNaN(parseFloat(s))?s:parseFloat(s)),i&&(t.fontSize=Us(i)),o&&(t.fontFamily=o),n&&(t.lineHeight=n==="normal"?1:n)}function Af(a,t){a.replace(/;\s*$/,"").split(";").forEach((e=>{if(!e)return;const[r,s]=e.split(":");t[r.trim().toLowerCase()]=s.trim()}))}function Df(a){const t={},e=a.getAttribute("style");return e&&(typeof e=="string"?Af(e,t):(function(r,s){Object.entries(r).forEach((i=>{let[n,o]=i;o!==void 0&&(s[n.toLowerCase()]=o)}))})(e,t)),t}const Ef={stroke:"strokeOpacity",fill:"fillOpacity"};function Qr(a,t,e){if(!a)return{};let r,s={},i=Ro;a.parentNode&&ja.test(a.parentNode.nodeName)&&(s=Qr(a.parentElement,t,e),s.fontSize&&(r=i=Us(s.fontSize)));const n=C(C(C({},t.reduce(((c,u)=>{const d=a.getAttribute(u);return d&&(c[u]=d),c}),{})),(function(c){let u=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},d={};for(const g in u)uf(c,g.split(" "))&&(d=C(C({},d),u[g]));return d})(a,e)),Df(a));n[eo]&&a.setAttribute(eo,n[eo]),n[to]&&(r=Us(n[to],i),n[to]="".concat(r));const o={};for(const c in n){const u=df(c),d=kf(u,n[c],s,r);o[u]=d}o&&o.font&&Of(o.font,o);const l=C(C({},s),o);return ja.test(a.nodeName)?l:(function(c){const u=Me.getDefaults();return Object.entries(Ef).forEach((d=>{let[g,f]=d;if(c[f]===void 0||c[g]==="")return;if(c[g]===void 0){if(!u[g])return;c[g]=u[g]}if(c[g].indexOf("url(")===0)return;const m=new Kt(c[g]);c[g]=m.setAlpha(re(m.getAlpha()*c[f],2)).toRgba()})),c})(l)}const Pf=["left","top","width","height","visible"],pc=["rx","ry"];class cr extends Me{static getDefaults(){return C(C({},super.getDefaults()),cr.ownDefaults)}constructor(t){super(),Object.assign(this,cr.ownDefaults),this.setOptions(t),this._initRxRy()}_initRxRy(){const{rx:t,ry:e}=this;t&&!e?this.ry=t:e&&!t&&(this.rx=e)}_render(t){const{width:e,height:r}=this,s=-e/2,i=-r/2,n=this.rx?Math.min(this.rx,e/2):0,o=this.ry?Math.min(this.ry,r/2):0,l=n!==0||o!==0;t.beginPath(),t.moveTo(s+n,i),t.lineTo(s+e-n,i),l&&t.bezierCurveTo(s+e-ns*n,i,s+e,i+ns*o,s+e,i+o),t.lineTo(s+e,i+r-o),l&&t.bezierCurveTo(s+e,i+r-ns*o,s+e-ns*n,i+r,s+e-n,i+r),t.lineTo(s+n,i+r),l&&t.bezierCurveTo(s+ns*n,i+r,s,i+r-ns*o,s,i+r-o),t.lineTo(s,i+o),l&&t.bezierCurveTo(s,i+ns*o,s+ns*n,i,s+n,i),t.closePath(),this._renderPaintInOrder(t)}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return super.toObject([...pc,...t])}_toSVG(){const{width:t,height:e,rx:r,ry:s}=this;return["<rect ","COMMON_PARTS",'x="'.concat(-t/2,'" y="').concat(-e/2,'" rx="').concat(r,'" ry="').concat(s,'" width="').concat(t,'" height="').concat(e,`" />
`)]}static async fromElement(t,e,r){const s=Qr(t,this.ATTRIBUTE_NAMES,r),{left:i=0,top:n=0,width:o=0,height:l=0,visible:c=!0}=s,u=ie(s,Pf);return new this(C(C(C({},e),u),{},{left:i,top:n,width:o,height:l,visible:!!(c&&o&&l)}))}}S(cr,"type","Rect"),S(cr,"cacheProperties",[...Jr,...pc]),S(cr,"ownDefaults",{rx:0,ry:0}),S(cr,"ATTRIBUTE_NAMES",[...ms,"x","y","rx","ry","width","height"]),gt.setClass(cr),gt.setSVGClass(cr);const Yr="initialization",An="added",Qo="removed",Dn="imperative",vc=(a,t)=>{const{strokeUniform:e,strokeWidth:r,width:s,height:i,group:n}=t,o=n&&n!==a?Vn(n.calcTransformMatrix(),a.calcTransformMatrix()):null,l=o?t.getRelativeCenterPoint().transform(o):t.getRelativeCenterPoint(),c=!t.isStrokeAccountedForInDimensions(),u=e&&c?mg(new F(r,r),void 0,a.calcTransformMatrix()):Vo,d=!e&&c?r:0,g=Xo(s+d,i+d,Wo([o,t.calcOwnMatrix()],!0)).add(u).scalarDivide(2);return[l.subtract(g),l.add(g)]};class Yn{calcLayoutResult(t,e){if(this.shouldPerformLayout(t))return this.calcBoundingBox(e,t)}shouldPerformLayout(t){let{type:e,prevStrategy:r,strategy:s}=t;return e===Yr||e===Dn||!!r&&s!==r}shouldLayoutClipPath(t){let{type:e,target:{clipPath:r}}=t;return e!==Yr&&r&&!r.absolutePositioned}getInitialSize(t,e){return e.size}calcBoundingBox(t,e){const{type:r,target:s}=e;if(r===Dn&&e.overrides)return e.overrides;if(t.length===0)return;const{left:i,top:n,width:o,height:l}=Nr(t.map((d=>vc(s,d))).reduce(((d,g)=>d.concat(g)),[])),c=new F(o,l),u=new F(i,n).add(c.scalarDivide(2));if(r===Yr){const d=this.getInitialSize(e,{size:c,center:u});return{center:u,relativeCorrection:new F(0,0),size:d}}return{center:u.transform(s.calcOwnMatrix()),size:c}}}S(Yn,"type","strategy");class bo extends Yn{shouldPerformLayout(t){return!0}}S(bo,"type","fit-content"),gt.setClass(bo);const Mf=["strategy"],If=["target","strategy","bubbles","prevStrategy"],_c="layoutManager";class Ci{constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:new bo;S(this,"strategy",void 0),this.strategy=t,this._subscriptions=new Map}performLayout(t){const e=C(C({bubbles:!0,strategy:this.strategy},t),{},{prevStrategy:this._prevLayoutStrategy,stopPropagation(){this.bubbles=!1}});this.onBeforeLayout(e);const r=this.getLayoutResult(e);r&&this.commitLayout(e,r),this.onAfterLayout(e,r),this._prevLayoutStrategy=e.strategy}attachHandlers(t,e){const{target:r}=e;return[wn,Fl,xi,jl,jn,Rl,xn,tg,eg].map((s=>t.on(s,(i=>this.performLayout(s===wn?{type:"object_modified",trigger:s,e:i,target:r}:{type:"object_modifying",trigger:s,e:i,target:r})))))}subscribe(t,e){this.unsubscribe(t,e);const r=this.attachHandlers(t,e);this._subscriptions.set(t,r)}unsubscribe(t,e){(this._subscriptions.get(t)||[]).forEach((r=>r())),this._subscriptions.delete(t)}unsubscribeTargets(t){t.targets.forEach((e=>this.unsubscribe(e,t)))}subscribeTargets(t){t.targets.forEach((e=>this.subscribe(e,t)))}onBeforeLayout(t){const{target:e,type:r}=t,{canvas:s}=e;if(r===Yr||r===An?this.subscribeTargets(t):r===Qo&&this.unsubscribeTargets(t),e.fire("layout:before",{context:t}),s&&s.fire("object:layout:before",{target:e,context:t}),r===Dn&&t.deep){const i=ie(t,Mf);e.forEachObject((n=>n.layoutManager&&n.layoutManager.performLayout(C(C({},i),{},{bubbles:!1,target:n}))))}}getLayoutResult(t){const{target:e,strategy:r,type:s}=t,i=r.calcLayoutResult(t,e.getObjects());if(!i)return;const n=s===Yr?new F:e.getRelativeCenterPoint(),{center:o,correction:l=new F,relativeCorrection:c=new F}=i,u=n.subtract(o).add(l).transform(s===Yr?Fe:ur(e.calcOwnMatrix()),!0).add(c);return{result:i,prevCenter:n,nextCenter:o,offset:u}}commitLayout(t,e){const{target:r}=t,{result:{size:s},nextCenter:i}=e;var n,o;r.set({width:s.x,height:s.y}),this.layoutObjects(t,e),t.type===Yr?r.set({left:(n=t.x)!==null&&n!==void 0?n:i.x+s.x*ve(r.originX),top:(o=t.y)!==null&&o!==void 0?o:i.y+s.y*ve(r.originY)}):(r.setPositionByOrigin(i,Bt,Bt),r.setCoords(),r.set("dirty",!0))}layoutObjects(t,e){const{target:r}=t;r.forEachObject((s=>{s.group===r&&this.layoutObject(t,e,s)})),t.strategy.shouldLayoutClipPath(t)&&this.layoutObject(t,e,r.clipPath)}layoutObject(t,e,r){let{offset:s}=e;r.set({left:r.left+s.x,top:r.top+s.y})}onAfterLayout(t,e){const{target:r,strategy:s,bubbles:i,prevStrategy:n}=t,o=ie(t,If),{canvas:l}=r;r.fire("layout:after",{context:t,result:e}),l&&l.fire("object:layout:after",{context:t,result:e,target:r});const c=r.parent;i&&c!=null&&c.layoutManager&&((o.path||(o.path=[])).push(r),c.layoutManager.performLayout(C(C({},o),{},{target:c}))),r.set("dirty",!0)}dispose(){const{_subscriptions:t}=this;t.forEach((e=>e.forEach((r=>r())))),t.clear()}toObject(){return{type:_c,strategy:this.strategy.constructor.type}}toJSON(){return this.toObject()}}gt.setClass(Ci,_c);const Lf=["type","objects","layoutManager"];class Ff extends Ci{performLayout(){}}class As extends Bl(Me){static getDefaults(){return C(C({},super.getDefaults()),As.ownDefaults)}constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),S(this,"_activeObjects",[]),S(this,"__objectSelectionTracker",void 0),S(this,"__objectSelectionDisposer",void 0),Object.assign(this,As.ownDefaults),this.setOptions(e),this.groupInit(t,e)}groupInit(t,e){var r;this._objects=[...t],this.__objectSelectionTracker=this.__objectSelectionMonitor.bind(this,!0),this.__objectSelectionDisposer=this.__objectSelectionMonitor.bind(this,!1),this.forEachObject((s=>{this.enterGroup(s,!1)})),this.layoutManager=(r=e.layoutManager)!==null&&r!==void 0?r:new Ci,this.layoutManager.performLayout({type:Yr,target:this,targets:[...t],x:e.left,y:e.top})}canEnterGroup(t){return t===this||this.isDescendantOf(t)?(gs("error","Group: circular object trees are not supported, this call has no effect"),!1):this._objects.indexOf(t)===-1||(gs("error","Group: duplicate objects are not supported inside group, this call has no effect"),!1)}_filterObjectsBeforeEnteringGroup(t){return t.filter(((e,r,s)=>this.canEnterGroup(e)&&s.indexOf(e)===r))}add(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];const s=this._filterObjectsBeforeEnteringGroup(e),i=super.add(...s);return this._onAfterObjectsChange(An,s),i}insertAt(t){for(var e=arguments.length,r=new Array(e>1?e-1:0),s=1;s<e;s++)r[s-1]=arguments[s];const i=this._filterObjectsBeforeEnteringGroup(r),n=super.insertAt(t,...i);return this._onAfterObjectsChange(An,i),n}remove(){const t=super.remove(...arguments);return this._onAfterObjectsChange(Qo,t),t}_onObjectAdded(t){this.enterGroup(t,!0),this.fire("object:added",{target:t}),t.fire("added",{target:this})}_onObjectRemoved(t,e){this.exitGroup(t,e),this.fire("object:removed",{target:t}),t.fire("removed",{target:this})}_onAfterObjectsChange(t,e){this.layoutManager.performLayout({type:t,targets:e,target:this})}_onStackOrderChanged(){this._set("dirty",!0)}_set(t,e){const r=this[t];return super._set(t,e),t==="canvas"&&r!==e&&(this._objects||[]).forEach((s=>{s._set(t,e)})),this}_shouldSetNestedCoords(){return this.subTargetCheck}removeAll(){return this._activeObjects=[],this.remove(...this._objects)}__objectSelectionMonitor(t,e){let{target:r}=e;const s=this._activeObjects;if(t)s.push(r),this._set("dirty",!0);else if(s.length>0){const i=s.indexOf(r);i>-1&&(s.splice(i,1),this._set("dirty",!0))}}_watchObject(t,e){t&&this._watchObject(!1,e),t?(e.on("selected",this.__objectSelectionTracker),e.on("deselected",this.__objectSelectionDisposer)):(e.off("selected",this.__objectSelectionTracker),e.off("deselected",this.__objectSelectionDisposer))}enterGroup(t,e){t.group&&t.group.remove(t),t._set("parent",this),this._enterGroup(t,e)}_enterGroup(t,e){e&&Cn(t,Te(ur(this.calcTransformMatrix()),t.calcTransformMatrix())),this._shouldSetNestedCoords()&&t.setCoords(),t._set("group",this),t._set("canvas",this.canvas),this._watchObject(!0,t);const r=this.canvas&&this.canvas.getActiveObject&&this.canvas.getActiveObject();r&&(r===t||t.isDescendantOf(r))&&this._activeObjects.push(t)}exitGroup(t,e){this._exitGroup(t,e),t._set("parent",void 0),t._set("canvas",void 0)}_exitGroup(t,e){t._set("group",void 0),e||(Cn(t,Te(this.calcTransformMatrix(),t.calcTransformMatrix())),t.setCoords()),this._watchObject(!1,t);const r=this._activeObjects.length>0?this._activeObjects.indexOf(t):-1;r>-1&&this._activeObjects.splice(r,1)}shouldCache(){const t=Me.prototype.shouldCache.call(this);if(t){for(let e=0;e<this._objects.length;e++)if(this._objects[e].willDrawShadow())return this.ownCaching=!1,!1}return t}willDrawShadow(){if(super.willDrawShadow())return!0;for(let t=0;t<this._objects.length;t++)if(this._objects[t].willDrawShadow())return!0;return!1}isOnACache(){return this.ownCaching||!!this.parent&&this.parent.isOnACache()}drawObject(t,e,r){this._renderBackground(t);for(let i=0;i<this._objects.length;i++){var s;const n=this._objects[i];(s=this.canvas)!==null&&s!==void 0&&s.preserveObjectStacking&&n.group!==this?(t.save(),t.transform(...ur(this.calcTransformMatrix())),n.render(t),t.restore()):n.group===this&&n.render(t)}this._drawClipPath(t,this.clipPath,r)}setCoords(){super.setCoords(),this._shouldSetNestedCoords()&&this.forEachObject((t=>t.setCoords()))}triggerLayout(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.layoutManager.performLayout(C({target:this,type:Dn},t))}render(t){this._transformDone=!0,super.render(t),this._transformDone=!1}__serializeObjects(t,e){const r=this.includeDefaultValues;return this._objects.filter((function(s){return!s.excludeFromExport})).map((function(s){const i=s.includeDefaultValues;s.includeDefaultValues=r;const n=s[t||"toObject"](e);return s.includeDefaultValues=i,n}))}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];const e=this.layoutManager.toObject();return C(C(C({},super.toObject(["subTargetCheck","interactive",...t])),e.strategy!=="fit-content"||this.includeDefaultValues?{layoutManager:e}:{}),{},{objects:this.__serializeObjects("toObject",t)})}toString(){return"#<Group: (".concat(this.complexity(),")>")}dispose(){this.layoutManager.unsubscribeTargets({targets:this.getObjects(),target:this}),this._activeObjects=[],this.forEachObject((t=>{this._watchObject(!1,t),t.dispose()})),super.dispose()}_createSVGBgRect(t){if(!this.backgroundColor)return"";const e=cr.prototype._toSVG.call(this),r=e.indexOf("COMMON_PARTS");e[r]='for="group" ';const s=e.join("");return t?t(s):s}_toSVG(t){const e=["<g ","COMMON_PARTS",` >
`],r=this._createSVGBgRect(t);r&&e.push("		",r);for(let s=0;s<this._objects.length;s++)e.push("		",this._objects[s].toSVG(t));return e.push(`</g>
`),e}getSvgStyles(){const t=this.opacity!==void 0&&this.opacity!==1?"opacity: ".concat(this.opacity,";"):"",e=this.visible?"":" visibility: hidden;";return[t,this.getSvgFilter(),e].join("")}toClipPathSVG(t){const e=[],r=this._createSVGBgRect(t);r&&e.push("	",r);for(let s=0;s<this._objects.length;s++)e.push("	",this._objects[s].toClipPathSVG(t));return this._createBaseClipPathSVGMarkup(e,{reviver:t})}static fromObject(t,e){let{type:r,objects:s=[],layoutManager:i}=t,n=ie(t,Lf);return Promise.all([wi(s,e),zn(n,e)]).then((o=>{let[l,c]=o;const u=new this(l,C(C(C({},n),c),{},{layoutManager:new Ff}));if(i){const d=gt.getClass(i.type),g=gt.getClass(i.strategy);u.layoutManager=new d(new g)}else u.layoutManager=new Ci;return u.layoutManager.subscribeTargets({type:Yr,target:u,targets:u.getObjects()}),u.setCoords(),u}))}}S(As,"type","Group"),S(As,"ownDefaults",{strokeWidth:0,subTargetCheck:!1,interactive:!1}),gt.setClass(As);const jf=(a,t)=>Math.min(t.width/a.width,t.height/a.height),Rf=(a,t)=>Math.max(t.width/a.width,t.height/a.height),So="\\s*,?\\s*",li="".concat(So,"(").concat(dr,")"),Bf="".concat(li).concat(li).concat(li).concat(So,"([01])").concat(So,"([01])").concat(li).concat(li),zf={m:"l",M:"L"},Vf=(a,t,e,r,s,i,n,o,l,c,u)=>{const d=Gr(a),g=qr(a),f=Gr(t),m=qr(t),p=e*s*f-r*i*m+n,v=r*s*f+e*i*m+o;return["C",c+l*(-e*s*g-r*i*d),u+l*(-r*s*g+e*i*d),p+l*(e*s*m+r*i*f),v+l*(r*s*m-e*i*f),p,v]},Ja=(a,t,e,r)=>{const s=Math.atan2(t,a),i=Math.atan2(r,e);return i>=s?i-s:2*Math.PI-(s-i)};function Qa(a,t,e,r,s,i,n,o){let l;if(Wt.cachesBoundsOfCurve&&(l=[...arguments].join(),gi.boundsOfCurveCache[l]))return gi.boundsOfCurveCache[l];const c=Math.sqrt,u=Math.abs,d=[],g=[[0,0],[0,0]];let f=6*a-12*e+6*s,m=-3*a+9*e-9*s+3*n,p=3*e-3*a;for(let O=0;O<2;++O){if(O>0&&(f=6*t-12*r+6*i,m=-3*t+9*r-9*i+3*o,p=3*r-3*t),u(m)<1e-12){if(u(f)<1e-12)continue;const j=-p/f;0<j&&j<1&&d.push(j);continue}const P=f*f-4*p*m;if(P<0)continue;const L=c(P),E=(-f+L)/(2*m);0<E&&E<1&&d.push(E);const _=(-f-L)/(2*m);0<_&&_<1&&d.push(_)}let v=d.length;const x=v,T=yc(a,t,e,r,s,i,n,o);for(;v--;){const{x:O,y:P}=T(d[v]);g[0][v]=O,g[1][v]=P}g[0][x]=a,g[1][x]=t,g[0][x+1]=n,g[1][x+1]=o;const A=[new F(Math.min(...g[0]),Math.min(...g[1])),new F(Math.max(...g[0]),Math.max(...g[1]))];return Wt.cachesBoundsOfCurve&&(gi.boundsOfCurveCache[l]=A),A}const Wf=(a,t,e)=>{let[r,s,i,n,o,l,c,u]=e;const d=((g,f,m,p,v,x,T)=>{if(m===0||p===0)return[];let A=0,O=0,P=0;const L=Math.PI,E=T*jo,_=qr(E),j=Gr(E),X=.5*(-j*g-_*f),G=.5*(-j*f+_*g),R=m**2,B=p**2,V=G**2,Q=X**2,tt=R*B-R*V-B*Q;let z=Math.abs(m),$=Math.abs(p);if(tt<0){const Z=Math.sqrt(1-tt/(R*B));z*=Z,$*=Z}else P=(v===x?-1:1)*Math.sqrt(tt/(R*V+B*Q));const J=P*z*G/$,rt=-P*$*X/z,it=j*J-_*rt+.5*g,ht=_*J+j*rt+.5*f;let nt=Ja(1,0,(X-J)/z,(G-rt)/$),ut=Ja((X-J)/z,(G-rt)/$,(-X-J)/z,(-G-rt)/$);x===0&&ut>0?ut-=2*L:x===1&&ut<0&&(ut+=2*L);const D=Math.ceil(Math.abs(ut/L*2)),W=[],H=ut/D,Y=8/3*Math.sin(H/4)*Math.sin(H/4)/Math.sin(H/2);let M=nt+H;for(let Z=0;Z<D;Z++)W[Z]=Vf(nt,M,j,_,z,$,it,ht,Y,A,O),A=W[Z][5],O=W[Z][6],nt=M,M+=H;return W})(c-a,u-t,s,i,o,l,n);for(let g=0,f=d.length;g<f;g++)d[g][1]+=a,d[g][2]+=t,d[g][3]+=a,d[g][4]+=t,d[g][5]+=a,d[g][6]+=t;return d},Hf=a=>{let t=0,e=0,r=0,s=0;const i=[];let n,o=0,l=0;for(const c of a){const u=[...c];let d;switch(u[0]){case"l":u[1]+=t,u[2]+=e;case"L":t=u[1],e=u[2],d=["L",t,e];break;case"h":u[1]+=t;case"H":t=u[1],d=["L",t,e];break;case"v":u[1]+=e;case"V":e=u[1],d=["L",t,e];break;case"m":u[1]+=t,u[2]+=e;case"M":t=u[1],e=u[2],r=u[1],s=u[2],d=["M",t,e];break;case"c":u[1]+=t,u[2]+=e,u[3]+=t,u[4]+=e,u[5]+=t,u[6]+=e;case"C":o=u[3],l=u[4],t=u[5],e=u[6],d=["C",u[1],u[2],o,l,t,e];break;case"s":u[1]+=t,u[2]+=e,u[3]+=t,u[4]+=e;case"S":n==="C"?(o=2*t-o,l=2*e-l):(o=t,l=e),t=u[3],e=u[4],d=["C",o,l,u[1],u[2],t,e],o=d[3],l=d[4];break;case"q":u[1]+=t,u[2]+=e,u[3]+=t,u[4]+=e;case"Q":o=u[1],l=u[2],t=u[3],e=u[4],d=["Q",o,l,t,e];break;case"t":u[1]+=t,u[2]+=e;case"T":n==="Q"?(o=2*t-o,l=2*e-l):(o=t,l=e),t=u[1],e=u[2],d=["Q",o,l,t,e];break;case"a":u[6]+=t,u[7]+=e;case"A":Wf(t,e,u).forEach((g=>i.push(g))),t=u[6],e=u[7];break;case"z":case"Z":t=r,e=s,d=["Z"]}d?(i.push(d),n=d[0]):n=""}return i},En=(a,t,e,r)=>Math.sqrt((e-a)**2+(r-t)**2),yc=(a,t,e,r,s,i,n,o)=>l=>{const c=l**3,u=(f=>3*f**2*(1-f))(l),d=(f=>3*f*(1-f)**2)(l),g=(f=>(1-f)**3)(l);return new F(n*c+s*u+e*d+a*g,o*c+i*u+r*d+t*g)},xc=a=>a**2,wc=a=>2*a*(1-a),bc=a=>(1-a)**2,Yf=(a,t,e,r,s,i,n,o)=>l=>{const c=xc(l),u=wc(l),d=bc(l),g=3*(d*(e-a)+u*(s-e)+c*(n-s)),f=3*(d*(r-t)+u*(i-r)+c*(o-i));return Math.atan2(f,g)},Xf=(a,t,e,r,s,i)=>n=>{const o=xc(n),l=wc(n),c=bc(n);return new F(s*o+e*l+a*c,i*o+r*l+t*c)},Nf=(a,t,e,r,s,i)=>n=>{const o=1-n,l=2*(o*(e-a)+n*(s-e)),c=2*(o*(r-t)+n*(i-r));return Math.atan2(c,l)},tl=(a,t,e)=>{let r=new F(t,e),s=0;for(let i=1;i<=100;i+=1){const n=a(i/100);s+=En(r.x,r.y,n.x,n.y),r=n}return s},Uf=(a,t)=>{let e,r=0,s=0,i={x:a.x,y:a.y},n=C({},i),o=.01,l=0;const c=a.iterator,u=a.angleFinder;for(;s<t&&o>1e-4;)n=c(r),l=r,e=En(i.x,i.y,n.x,n.y),e+s>t?(r-=o,o/=2):(i=n,r+=o,s+=e);return C(C({},n),{},{angle:u(l)})},Sc=a=>{let t,e,r=0,s=0,i=0,n=0,o=0;const l=[];for(const c of a){const u={x:s,y:i,command:c[0],length:0};switch(c[0]){case"M":e=u,e.x=n=s=c[1],e.y=o=i=c[2];break;case"L":e=u,e.length=En(s,i,c[1],c[2]),s=c[1],i=c[2];break;case"C":t=yc(s,i,c[1],c[2],c[3],c[4],c[5],c[6]),e=u,e.iterator=t,e.angleFinder=Yf(s,i,c[1],c[2],c[3],c[4],c[5],c[6]),e.length=tl(t,s,i),s=c[5],i=c[6];break;case"Q":t=Xf(s,i,c[1],c[2],c[3],c[4]),e=u,e.iterator=t,e.angleFinder=Nf(s,i,c[1],c[2],c[3],c[4]),e.length=tl(t,s,i),s=c[3],i=c[4];break;case"Z":e=u,e.destX=n,e.destY=o,e.length=En(s,i,n,o),s=n,i=o}r+=e.length,l.push(e)}return l.push({length:r,x:s,y:i}),l},Gf=function(a,t){let e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Sc(a),r=0;for(;t-e[r].length>0&&r<e.length-2;)t-=e[r].length,r++;const s=e[r],i=t/s.length,n=a[r];switch(s.command){case"M":return{x:s.x,y:s.y,angle:0};case"Z":return C(C({},new F(s.x,s.y).lerp(new F(s.destX,s.destY),i)),{},{angle:Math.atan2(s.destY-s.y,s.destX-s.x)});case"L":return C(C({},new F(s.x,s.y).lerp(new F(n[1],n[2]),i)),{},{angle:Math.atan2(n[2]-s.y,n[1]-s.x)});case"C":case"Q":return Uf(s,t)}},qf=new RegExp("[mzlhvcsqta][^mzlhvcsqta]*","gi"),el=new RegExp(Bf,"g"),$f=new RegExp(dr,"gi"),Kf={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},Zf=a=>{var t;const e=[],r=(t=a.match(qf))!==null&&t!==void 0?t:[];for(const s of r){const i=s[0];if(i==="z"||i==="Z"){e.push([i]);continue}const n=Kf[i.toLowerCase()];let o=[];if(i==="a"||i==="A"){el.lastIndex=0;for(let l=null;l=el.exec(s);)o.push(...l.slice(1))}else o=s.match($f)||[];for(let l=0;l<o.length;l+=n){const c=new Array(n),u=zf[i];c[0]=l>0&&u?u:i;for(let d=0;d<n;d++)c[d+1]=parseFloat(o[l+d]);e.push(c)}}return e},Jf=(a,t)=>a.map((e=>e.map(((r,s)=>s===0||t===void 0?r:re(r,t))).join(" "))).join(" ");function Co(a,t){const e=a.style;e&&t&&(typeof t=="string"?e.cssText+=";"+t:Object.entries(t).forEach((r=>{let[s,i]=r;return e.setProperty(s,i)})))}class Qf extends $l{constructor(t){let{allowTouchScrolling:e=!1,containerClass:r=""}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(t),S(this,"upper",void 0),S(this,"container",void 0);const{el:s}=this.lower,i=this.createUpperCanvas();this.upper={el:i,ctx:i.getContext("2d")},this.applyCanvasStyle(s,{allowTouchScrolling:e}),this.applyCanvasStyle(i,{allowTouchScrolling:e,styles:{position:"absolute",left:"0",top:"0"}});const n=this.createContainerElement();n.classList.add(r),s.parentNode&&s.parentNode.replaceChild(n,s),n.append(s,i),this.container=n}createUpperCanvas(){const{el:t}=this.lower,e=$r();return e.className=t.className,e.classList.remove("lower-canvas"),e.classList.add("upper-canvas"),e.setAttribute("data-fabric","top"),e.style.cssText=t.style.cssText,e.setAttribute("draggable","true"),e}createContainerElement(){const t=Zs().createElement("div");return t.setAttribute("data-fabric","wrapper"),Co(t,{position:"relative"}),ka(t),t}applyCanvasStyle(t,e){const{styles:r,allowTouchScrolling:s}=e;Co(t,C(C({},r),{},{"touch-action":s?"manipulation":We})),ka(t)}setDimensions(t,e){super.setDimensions(t,e);const{el:r,ctx:s}=this.upper;ql(r,s,t,e)}setCSSDimensions(t){super.setCSSDimensions(t),po(this.upper.el,t),po(this.container,t)}cleanupDOM(t){const e=this.container,{el:r}=this.lower,{el:s}=this.upper;super.cleanupDOM(t),e.removeChild(s),e.removeChild(r),e.parentNode&&e.parentNode.replaceChild(r,e)}dispose(){super.dispose(),Ar().dispose(this.upper.el),delete this.upper,delete this.container}}class Xn extends Di{constructor(){super(...arguments),S(this,"targets",[]),S(this,"_hoveredTargets",[]),S(this,"_currentTransform",null),S(this,"_groupSelector",null),S(this,"contextTopDirty",!1)}static getDefaults(){return C(C({},super.getDefaults()),Xn.ownDefaults)}get upperCanvasEl(){var t;return(t=this.elements.upper)===null||t===void 0?void 0:t.el}get contextTop(){var t;return(t=this.elements.upper)===null||t===void 0?void 0:t.ctx}get wrapperEl(){return this.elements.container}initElements(t){this.elements=new Qf(t,{allowTouchScrolling:this.allowTouchScrolling,containerClass:this.containerClass}),this._createCacheCanvas()}_onObjectAdded(t){this._objectsToRender=void 0,super._onObjectAdded(t)}_onObjectRemoved(t){this._objectsToRender=void 0,t===this._activeObject&&(this.fire("before:selection:cleared",{deselected:[t]}),this._discardActiveObject(),this.fire("selection:cleared",{deselected:[t]}),t.fire("deselected",{target:t})),t===this._hoveredTarget&&(this._hoveredTarget=void 0,this._hoveredTargets=[]),super._onObjectRemoved(t)}_onStackOrderChanged(){this._objectsToRender=void 0,super._onStackOrderChanged()}_chooseObjectsToRender(){const t=this._activeObject;return!this.preserveObjectStacking&&t?this._objects.filter((e=>!e.group&&e!==t)).concat(t):this._objects}renderAll(){this.cancelRequestedRender(),this.destroyed||(!this.contextTopDirty||this._groupSelector||this.isDrawingMode||(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&(this.renderTopLayer(this.contextTop),this.hasLostContext=!1),!this._objectsToRender&&(this._objectsToRender=this._chooseObjectsToRender()),this.renderCanvas(this.getContext(),this._objectsToRender))}renderTopLayer(t){t.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(t),this.contextTopDirty=!0),t.restore()}renderTop(){const t=this.contextTop;this.clearContext(t),this.renderTopLayer(t),this.fire("after:render",{ctx:t})}setTargetFindTolerance(t){t=Math.round(t),this.targetFindTolerance=t;const e=this.getRetinaScaling(),r=Math.ceil((2*t+1)*e);this.pixelFindCanvasEl.width=this.pixelFindCanvasEl.height=r,this.pixelFindContext.scale(e,e)}isTargetTransparent(t,e,r){const s=this.targetFindTolerance,i=this.pixelFindContext;this.clearContext(i),i.save(),i.translate(-e+s,-r+s),i.transform(...this.viewportTransform);const n=t.selectionBackgroundColor;t.selectionBackgroundColor="",t.render(i),t.selectionBackgroundColor=n,i.restore();const o=Math.round(s*this.getRetinaScaling());return rf(i,o,o,o)}_isSelectionKeyPressed(t){const e=this.selectionKey;return!!e&&(Array.isArray(e)?!!e.find((r=>!!r&&t[r]===!0)):t[e])}_shouldClearSelection(t,e){const r=this.getActiveObjects(),s=this._activeObject;return!!(!e||e&&s&&r.length>1&&r.indexOf(e)===-1&&s!==e&&!this._isSelectionKeyPressed(t)||e&&!e.evented||e&&!e.selectable&&s&&s!==e)}_shouldCenterTransform(t,e,r){if(!t)return;let s;return e===Rn||e===Ye||e===rr||e===xi?s=this.centeredScaling||t.centeredScaling:e===zo&&(s=this.centeredRotation||t.centeredRotation),s?!r:r}_getOriginFromCorner(t,e){const r={x:t.originX,y:t.originY};return e&&(["ml","tl","bl"].includes(e)?r.x=de:["mr","tr","br"].includes(e)&&(r.x=$t),["tl","mt","tr"].includes(e)?r.y=mo:["bl","mb","br"].includes(e)&&(r.y=Ve)),r}_setupCurrentTransform(t,e,r){var s;const i=e.group?Ns(this.getScenePoint(t),void 0,e.group.calcTransformMatrix()):this.getScenePoint(t),{key:n="",control:o}=e.getActiveControl()||{},l=r&&o?(s=o.getActionHandler(t,e,o))===null||s===void 0?void 0:s.bind(o):_g,c=((f,m,p,v)=>{if(!m||!f)return"drag";const x=v.controls[m];return x.getActionName(p,x,v)})(r,n,t,e),u=t[this.centeredKey],d=this._shouldCenterTransform(e,c,u)?{x:Bt,y:Bt}:this._getOriginFromCorner(e,n),g={target:e,action:c,actionHandler:l,actionPerformed:!1,corner:n,scaleX:e.scaleX,scaleY:e.scaleY,skewX:e.skewX,skewY:e.skewY,offsetX:i.x-e.left,offsetY:i.y-e.top,originX:d.x,originY:d.y,ex:i.x,ey:i.y,lastX:i.x,lastY:i.y,theta:ge(e.angle),width:e.width,height:e.height,shiftKey:t.shiftKey,altKey:u,original:C(C({},Kl(e)),{},{originX:d.x,originY:d.y})};this._currentTransform=g,this.fire("before:transform",{e:t,transform:g})}setCursor(t){this.upperCanvasEl.style.cursor=t}_drawSelection(t){const{x:e,y:r,deltaX:s,deltaY:i}=this._groupSelector,n=new F(e,r).transform(this.viewportTransform),o=new F(e+s,r+i).transform(this.viewportTransform),l=this.selectionLineWidth/2;let c=Math.min(n.x,o.x),u=Math.min(n.y,o.y),d=Math.max(n.x,o.x),g=Math.max(n.y,o.y);this.selectionColor&&(t.fillStyle=this.selectionColor,t.fillRect(c,u,d-c,g-u)),this.selectionLineWidth&&this.selectionBorderColor&&(t.lineWidth=this.selectionLineWidth,t.strokeStyle=this.selectionBorderColor,c+=l,u+=l,d-=l,g-=l,Me.prototype._setLineDash.call(this,t,this.selectionDashArray),t.strokeRect(c,u,d-c,g-u))}findTarget(t){if(this.skipTargetFind)return;const e=this.getViewportPoint(t),r=this._activeObject,s=this.getActiveObjects();if(this.targets=[],r&&s.length>=1){if(r.findControl(e,vo(t))||s.length>1&&this.searchPossibleTargets([r],e))return r;if(r===this.searchPossibleTargets([r],e)){if(this.preserveObjectStacking){const i=this.targets;this.targets=[];const n=this.searchPossibleTargets(this._objects,e);return t[this.altSelectionKey]&&n&&n!==r?(this.targets=i,r):n}return r}}return this.searchPossibleTargets(this._objects,e)}_pointIsInObjectSelectionArea(t,e){let r=t.getCoords();const s=this.getZoom(),i=t.padding/s;if(i){const[n,o,l,c]=r,u=Math.atan2(o.y-n.y,o.x-n.x),d=Gr(u)*i,g=qr(u)*i,f=d+g,m=d-g;r=[new F(n.x-m,n.y-f),new F(o.x+f,o.y-m),new F(l.x+m,l.y+f),new F(c.x-f,c.y+m)]}return le.isPointInPolygon(e,r)}_checkTarget(t,e){return!!(t&&t.visible&&t.evented&&this._pointIsInObjectSelectionArea(t,Ns(e,void 0,this.viewportTransform))&&(!this.perPixelTargetFind&&!t.perPixelTargetFind||t.isEditing||!this.isTargetTransparent(t,e.x,e.y)))}_searchPossibleTargets(t,e){let r=t.length;for(;r--;){const s=t[r];if(this._checkTarget(s,e)){if(ln(s)&&s.subTargetCheck){const i=this._searchPossibleTargets(s._objects,e);i&&this.targets.push(i)}return s}}}searchPossibleTargets(t,e){const r=this._searchPossibleTargets(t,e);if(r&&ln(r)&&r.interactive&&this.targets[0]){const s=this.targets;for(let i=s.length-1;i>0;i--){const n=s[i];if(!ln(n)||!n.interactive)return n}return s[0]}return r}getViewportPoint(t){return this._pointer?this._pointer:this.getPointer(t,!0)}getScenePoint(t){return this._absolutePointer?this._absolutePointer:this.getPointer(t)}getPointer(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const r=this.upperCanvasEl,s=r.getBoundingClientRect();let i=ug(t),n=s.width||0,o=s.height||0;n&&o||(Ve in s&&mo in s&&(o=Math.abs(s.top-s.bottom)),de in s&&$t in s&&(n=Math.abs(s.right-s.left))),this.calcOffset(),i.x=i.x-this._offset.left,i.y=i.y-this._offset.top,e||(i=Ns(i,void 0,this.viewportTransform));const l=this.getRetinaScaling();l!==1&&(i.x/=l,i.y/=l);const c=n===0||o===0?new F(1,1):new F(r.width/n,r.height/o);return i.multiply(c)}_setDimensionsImpl(t,e){this._resetTransformEventData(),super._setDimensionsImpl(t,e),this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(this.contextTop)}_createCacheCanvas(){this.pixelFindCanvasEl=$r(),this.pixelFindContext=this.pixelFindCanvasEl.getContext("2d",{willReadFrequently:!0}),this.setTargetFindTolerance(this.targetFindTolerance)}getTopContext(){return this.elements.upper.ctx}getSelectionContext(){return this.elements.upper.ctx}getSelectionElement(){return this.elements.upper.el}getActiveObject(){return this._activeObject}getActiveObjects(){const t=this._activeObject;return ys(t)?t.getObjects():t?[t]:[]}_fireSelectionEvents(t,e){let r=!1,s=!1;const i=this.getActiveObjects(),n=[],o=[];t.forEach((l=>{i.includes(l)||(r=!0,l.fire("deselected",{e,target:l}),o.push(l))})),i.forEach((l=>{t.includes(l)||(r=!0,l.fire("selected",{e,target:l}),n.push(l))})),t.length>0&&i.length>0?(s=!0,r&&this.fire("selection:updated",{e,selected:n,deselected:o})):i.length>0?(s=!0,this.fire("selection:created",{e,selected:n})):t.length>0&&(s=!0,this.fire("selection:cleared",{e,deselected:o})),s&&(this._objectsToRender=void 0)}setActiveObject(t,e){const r=this.getActiveObjects(),s=this._setActiveObject(t,e);return this._fireSelectionEvents(r,e),s}_setActiveObject(t,e){const r=this._activeObject;return r!==t&&!(!this._discardActiveObject(e,t)&&this._activeObject)&&!t.onSelect({e})&&(this._activeObject=t,ys(t)&&r!==t&&t.set("canvas",this),t.setCoords(),!0)}_discardActiveObject(t,e){const r=this._activeObject;return!!r&&!r.onDeselect({e:t,object:e})&&(this._currentTransform&&this._currentTransform.target===r&&this.endCurrentTransform(t),ys(r)&&r===this._hoveredTarget&&(this._hoveredTarget=void 0),this._activeObject=void 0,!0)}discardActiveObject(t){const e=this.getActiveObjects(),r=this.getActiveObject();e.length&&this.fire("before:selection:cleared",{e:t,deselected:[r]});const s=this._discardActiveObject(t);return this._fireSelectionEvents(e,t),s}endCurrentTransform(t){const e=this._currentTransform;this._finalizeCurrentTransform(t),e&&e.target&&(e.target.isMoving=!1),this._currentTransform=null}_finalizeCurrentTransform(t){const e=this._currentTransform,r=e.target,s={e:t,target:r,transform:e,action:e.action};r._scaling&&(r._scaling=!1),r.setCoords(),e.actionPerformed&&(this.fire("object:modified",s),r.fire(wn,s))}setViewportTransform(t){super.setViewportTransform(t);const e=this._activeObject;e&&e.setCoords()}destroy(){const t=this._activeObject;ys(t)&&(t.removeAll(),t.dispose()),delete this._activeObject,super.destroy(),this.pixelFindContext=null,this.pixelFindCanvasEl=void 0}clear(){this.discardActiveObject(),this._activeObject=void 0,this.clearContext(this.contextTop),super.clear()}drawControls(t){const e=this._activeObject;e&&e._renderControls(t)}_toObject(t,e,r){const s=this._realizeGroupTransformOnObject(t),i=super._toObject(t,e,r);return t.set(s),i}_realizeGroupTransformOnObject(t){const{group:e}=t;if(e&&ys(e)&&this._activeObject===e){const r=ei(t,["angle","flipX","flipY",$t,Ye,rr,Js,Qs,Ve]);return gg(t,e.calcOwnMatrix()),r}return{}}_setSVGObject(t,e,r){const s=this._realizeGroupTransformOnObject(e);super._setSVGObject(t,e,r),e.set(s)}}S(Xn,"ownDefaults",{uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",selection:!0,selectionKey:"shiftKey",selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",notAllowedCursor:"not-allowed",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,enablePointerEvents:!1,containerClass:"canvas-container",preserveObjectStacking:!1});class tm{constructor(t){S(this,"targets",[]),S(this,"__disposer",void 0);const e=()=>{const{hiddenTextarea:s}=t.getActiveObject()||{};s&&s.focus()},r=t.upperCanvasEl;r.addEventListener("click",e),this.__disposer=()=>r.removeEventListener("click",e)}exitTextEditing(){this.target=void 0,this.targets.forEach((t=>{t.isEditing&&t.exitEditing()}))}add(t){this.targets.push(t)}remove(t){this.unregister(t),Bs(this.targets,t)}register(t){this.target=t}unregister(t){t===this.target&&(this.target=void 0)}onMouseMove(t){var e;!((e=this.target)===null||e===void 0)&&e.isEditing&&this.target.updateSelectionOnMouseMove(t)}clear(){this.targets=[],this.target=void 0}dispose(){this.clear(),this.__disposer(),delete this.__disposer}}const em=["target","oldTarget","fireCanvas","e"],Xe={passive:!1},js=(a,t)=>{const e=a.getViewportPoint(t),r=a.getScenePoint(t);return{viewportPoint:e,scenePoint:r,pointer:e,absolutePointer:r}},os=function(a){for(var t=arguments.length,e=new Array(t>1?t-1:0),r=1;r<t;r++)e[r-1]=arguments[r];return a.addEventListener(...e)},Ge=function(a){for(var t=arguments.length,e=new Array(t>1?t-1:0),r=1;r<t;r++)e[r-1]=arguments[r];return a.removeEventListener(...e)},rm={mouse:{in:"over",out:"out",targetIn:"mouseover",targetOut:"mouseout",canvasIn:"mouse:over",canvasOut:"mouse:out"},drag:{in:"enter",out:"leave",targetIn:"dragenter",targetOut:"dragleave",canvasIn:"drag:enter",canvasOut:"drag:leave"}};class To extends Xn{constructor(t){super(t,arguments.length>1&&arguments[1]!==void 0?arguments[1]:{}),S(this,"_isClick",void 0),S(this,"textEditingManager",new tm(this)),["_onMouseDown","_onTouchStart","_onMouseMove","_onMouseUp","_onTouchEnd","_onResize","_onMouseWheel","_onMouseOut","_onMouseEnter","_onContextMenu","_onClick","_onDragStart","_onDragEnd","_onDragProgress","_onDragOver","_onDragEnter","_onDragLeave","_onDrop"].forEach((e=>{this[e]=this[e].bind(this)})),this.addOrRemove(os,"add")}_getEventPrefix(){return this.enablePointerEvents?"pointer":"mouse"}addOrRemove(t,e){const r=this.upperCanvasEl,s=this._getEventPrefix();t(Gl(r),"resize",this._onResize),t(r,s+"down",this._onMouseDown),t(r,"".concat(s,"move"),this._onMouseMove,Xe),t(r,"".concat(s,"out"),this._onMouseOut),t(r,"".concat(s,"enter"),this._onMouseEnter),t(r,"wheel",this._onMouseWheel,{passive:!1}),t(r,"contextmenu",this._onContextMenu),t(r,"click",this._onClick),t(r,"dblclick",this._onClick),t(r,"dragstart",this._onDragStart),t(r,"dragend",this._onDragEnd),t(r,"dragover",this._onDragOver),t(r,"dragenter",this._onDragEnter),t(r,"dragleave",this._onDragLeave),t(r,"drop",this._onDrop),this.enablePointerEvents||t(r,"touchstart",this._onTouchStart,Xe)}removeListeners(){this.addOrRemove(Ge,"remove");const t=this._getEventPrefix(),e=hr(this.upperCanvasEl);Ge(e,"".concat(t,"up"),this._onMouseUp),Ge(e,"touchend",this._onTouchEnd,Xe),Ge(e,"".concat(t,"move"),this._onMouseMove,Xe),Ge(e,"touchmove",this._onMouseMove,Xe),clearTimeout(this._willAddMouseDown)}_onMouseWheel(t){this.__onMouseWheel(t)}_onMouseOut(t){const e=this._hoveredTarget,r=C({e:t},js(this,t));this.fire("mouse:out",C(C({},r),{},{target:e})),this._hoveredTarget=void 0,e&&e.fire("mouseout",C({},r)),this._hoveredTargets.forEach((s=>{this.fire("mouse:out",C(C({},r),{},{target:s})),s&&s.fire("mouseout",C({},r))})),this._hoveredTargets=[]}_onMouseEnter(t){this._currentTransform||this.findTarget(t)||(this.fire("mouse:over",C({e:t},js(this,t))),this._hoveredTarget=void 0,this._hoveredTargets=[])}_onDragStart(t){this._isClick=!1;const e=this.getActiveObject();if(e&&e.onDragStart(t)){this._dragSource=e;const r={e:t,target:e};return this.fire("dragstart",r),e.fire("dragstart",r),void os(this.upperCanvasEl,"drag",this._onDragProgress)}Oa(t)}_renderDragEffects(t,e,r){let s=!1;const i=this._dropTarget;i&&i!==e&&i!==r&&(i.clearContextTop(),s=!0),e?.clearContextTop(),r!==e&&r?.clearContextTop();const n=this.contextTop;n.save(),n.transform(...this.viewportTransform),e&&(n.save(),e.transform(n),e.renderDragSourceEffect(t),n.restore(),s=!0),r&&(n.save(),r.transform(n),r.renderDropTargetEffect(t),n.restore(),s=!0),n.restore(),s&&(this.contextTopDirty=!0)}_onDragEnd(t){const e=!!t.dataTransfer&&t.dataTransfer.dropEffect!==We,r=e?this._activeObject:void 0,s={e:t,target:this._dragSource,subTargets:this.targets,dragSource:this._dragSource,didDrop:e,dropTarget:r};Ge(this.upperCanvasEl,"drag",this._onDragProgress),this.fire("dragend",s),this._dragSource&&this._dragSource.fire("dragend",s),delete this._dragSource,this._onMouseUp(t)}_onDragProgress(t){const e={e:t,target:this._dragSource,dragSource:this._dragSource,dropTarget:this._draggedoverTarget};this.fire("drag",e),this._dragSource&&this._dragSource.fire("drag",e)}findDragTargets(t){return this.targets=[],{target:this._searchPossibleTargets(this._objects,this.getViewportPoint(t)),targets:[...this.targets]}}_onDragOver(t){const e="dragover",{target:r,targets:s}=this.findDragTargets(t),i=this._dragSource,n={e:t,target:r,subTargets:s,dragSource:i,canDrop:!1,dropTarget:void 0};let o;this.fire(e,n),this._fireEnterLeaveEvents(r,n),r&&(r.canDrop(t)&&(o=r),r.fire(e,n));for(let l=0;l<s.length;l++){const c=s[l];c.canDrop(t)&&(o=c),c.fire(e,n)}this._renderDragEffects(t,i,o),this._dropTarget=o}_onDragEnter(t){const{target:e,targets:r}=this.findDragTargets(t),s={e:t,target:e,subTargets:r,dragSource:this._dragSource};this.fire("dragenter",s),this._fireEnterLeaveEvents(e,s)}_onDragLeave(t){const e={e:t,target:this._draggedoverTarget,subTargets:this.targets,dragSource:this._dragSource};this.fire("dragleave",e),this._fireEnterLeaveEvents(void 0,e),this._renderDragEffects(t,this._dragSource),this._dropTarget=void 0,this.targets=[],this._hoveredTargets=[]}_onDrop(t){const{target:e,targets:r}=this.findDragTargets(t),s=this._basicEventHandler("drop:before",C({e:t,target:e,subTargets:r,dragSource:this._dragSource},js(this,t)));s.didDrop=!1,s.dropTarget=void 0,this._basicEventHandler("drop",s),this.fire("drop:after",s)}_onContextMenu(t){const e=this.findTarget(t),r=this.targets||[],s=this._basicEventHandler("contextmenu:before",{e:t,target:e,subTargets:r});return this.stopContextMenu&&Oa(t),this._basicEventHandler("contextmenu",s),!1}_onClick(t){const e=t.detail;e>3||e<2||(this._cacheTransformEventData(t),e==2&&t.type==="dblclick"&&this._handleEvent(t,"dblclick"),e==3&&this._handleEvent(t,"tripleclick"),this._resetTransformEventData())}getPointerId(t){const e=t.changedTouches;return e?e[0]&&e[0].identifier:this.enablePointerEvents?t.pointerId:-1}_isMainEvent(t){return t.isPrimary===!0||t.isPrimary!==!1&&(t.type==="touchend"&&t.touches.length===0||!t.changedTouches||t.changedTouches[0].identifier===this.mainTouchId)}_onTouchStart(t){let e=!this.allowTouchScrolling;const r=this._activeObject;this.mainTouchId===void 0&&(this.mainTouchId=this.getPointerId(t)),this.__onMouseDown(t),(this.isDrawingMode||r&&this._target===r)&&(e=!0),e&&t.preventDefault(),this._resetTransformEventData();const s=this.upperCanvasEl,i=this._getEventPrefix(),n=hr(s);os(n,"touchend",this._onTouchEnd,Xe),e&&os(n,"touchmove",this._onMouseMove,Xe),Ge(s,"".concat(i,"down"),this._onMouseDown)}_onMouseDown(t){this.__onMouseDown(t),this._resetTransformEventData();const e=this.upperCanvasEl,r=this._getEventPrefix();Ge(e,"".concat(r,"move"),this._onMouseMove,Xe);const s=hr(e);os(s,"".concat(r,"up"),this._onMouseUp),os(s,"".concat(r,"move"),this._onMouseMove,Xe)}_onTouchEnd(t){if(t.touches.length>0)return;this.__onMouseUp(t),this._resetTransformEventData(),delete this.mainTouchId;const e=this._getEventPrefix(),r=hr(this.upperCanvasEl);Ge(r,"touchend",this._onTouchEnd,Xe),Ge(r,"touchmove",this._onMouseMove,Xe),this._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout((()=>{os(this.upperCanvasEl,"".concat(e,"down"),this._onMouseDown),this._willAddMouseDown=0}),400)}_onMouseUp(t){this.__onMouseUp(t),this._resetTransformEventData();const e=this.upperCanvasEl,r=this._getEventPrefix();if(this._isMainEvent(t)){const s=hr(this.upperCanvasEl);Ge(s,"".concat(r,"up"),this._onMouseUp),Ge(s,"".concat(r,"move"),this._onMouseMove,Xe),os(e,"".concat(r,"move"),this._onMouseMove,Xe)}}_onMouseMove(t){const e=this.getActiveObject();!this.allowTouchScrolling&&(!e||!e.shouldStartDragging(t))&&t.preventDefault&&t.preventDefault(),this.__onMouseMove(t)}_onResize(){this.calcOffset(),this._resetTransformEventData()}_shouldRender(t){const e=this.getActiveObject();return!!e!=!!t||e&&t&&e!==t}__onMouseUp(t){var e;this._cacheTransformEventData(t),this._handleEvent(t,"up:before");const r=this._currentTransform,s=this._isClick,i=this._target,{button:n}=t;if(n)return(this.fireMiddleClick&&n===1||this.fireRightClick&&n===2)&&this._handleEvent(t,"up"),void this._resetTransformEventData();if(this.isDrawingMode&&this._isCurrentlyDrawing)return void this._onMouseUpInDrawingMode(t);if(!this._isMainEvent(t))return;let o,l,c=!1;if(r&&(this._finalizeCurrentTransform(t),c=r.actionPerformed),!s){const u=i===this._activeObject;this.handleSelection(t),c||(c=this._shouldRender(i)||!u&&i===this._activeObject)}if(i){const u=i.findControl(this.getViewportPoint(t),vo(t)),{key:d,control:g}=u||{};if(l=d,i.selectable&&i!==this._activeObject&&i.activeOn==="up")this.setActiveObject(i,t),c=!0;else if(g){const f=g.getMouseUpHandler(t,i,g);f&&(o=this.getScenePoint(t),f.call(g,t,r,o.x,o.y))}i.isMoving=!1}if(r&&(r.target!==i||r.corner!==l)){const u=r.target&&r.target.controls[r.corner],d=u&&u.getMouseUpHandler(t,r.target,u);o=o||this.getScenePoint(t),d&&d.call(u,t,r,o.x,o.y)}this._setCursorFromEvent(t,i),this._handleEvent(t,"up"),this._groupSelector=null,this._currentTransform=null,i&&(i.__corner=void 0),c?this.requestRenderAll():s||(e=this._activeObject)!==null&&e!==void 0&&e.isEditing||this.renderTop()}_basicEventHandler(t,e){const{target:r,subTargets:s=[]}=e;this.fire(t,e),r&&r.fire(t,e);for(let i=0;i<s.length;i++)s[i]!==r&&s[i].fire(t,e);return e}_handleEvent(t,e,r){const s=this._target,i=this.targets||[],n=C(C(C({e:t,target:s,subTargets:i},js(this,t)),{},{transform:this._currentTransform},e==="up:before"||e==="up"?{isClick:this._isClick,currentTarget:this.findTarget(t),currentSubTargets:this.targets}:{}),e==="down:before"||e==="down"?r:{});this.fire("mouse:".concat(e),n),s&&s.fire("mouse".concat(e),n);for(let o=0;o<i.length;o++)i[o]!==s&&i[o].fire("mouse".concat(e),n)}_onMouseDownInDrawingMode(t){this._isCurrentlyDrawing=!0,this.getActiveObject()&&(this.discardActiveObject(t),this.requestRenderAll());const e=this.getScenePoint(t);this.freeDrawingBrush&&this.freeDrawingBrush.onMouseDown(e,{e:t,pointer:e}),this._handleEvent(t,"down",{alreadySelected:!1})}_onMouseMoveInDrawingMode(t){if(this._isCurrentlyDrawing){const e=this.getScenePoint(t);this.freeDrawingBrush&&this.freeDrawingBrush.onMouseMove(e,{e:t,pointer:e})}this.setCursor(this.freeDrawingCursor),this._handleEvent(t,"move")}_onMouseUpInDrawingMode(t){const e=this.getScenePoint(t);this.freeDrawingBrush?this._isCurrentlyDrawing=!!this.freeDrawingBrush.onMouseUp({e:t,pointer:e}):this._isCurrentlyDrawing=!1,this._handleEvent(t,"up")}__onMouseDown(t){this._isClick=!0,this._cacheTransformEventData(t),this._handleEvent(t,"down:before");let e=this._target,r=!!e&&e===this._activeObject;const{button:s}=t;if(s)return(this.fireMiddleClick&&s===1||this.fireRightClick&&s===2)&&this._handleEvent(t,"down",{alreadySelected:r}),void this._resetTransformEventData();if(this.isDrawingMode)return void this._onMouseDownInDrawingMode(t);if(!this._isMainEvent(t)||this._currentTransform)return;let i=this._shouldRender(e),n=!1;if(this.handleMultiSelection(t,e)?(e=this._activeObject,n=!0,i=!0):this._shouldClearSelection(t,e)&&this.discardActiveObject(t),this.selection&&(!e||!e.selectable&&!e.isEditing&&e!==this._activeObject)){const o=this.getScenePoint(t);this._groupSelector={x:o.x,y:o.y,deltaY:0,deltaX:0}}if(r=!!e&&e===this._activeObject,e){e.selectable&&e.activeOn==="down"&&this.setActiveObject(e,t);const o=e.findControl(this.getViewportPoint(t),vo(t));if(e===this._activeObject&&(o||!n)){this._setupCurrentTransform(t,e,r);const l=o?o.control:void 0,c=this.getScenePoint(t),u=l&&l.getMouseDownHandler(t,e,l);u&&u.call(l,t,this._currentTransform,c.x,c.y)}}i&&(this._objectsToRender=void 0),this._handleEvent(t,"down",{alreadySelected:r}),i&&this.requestRenderAll()}_resetTransformEventData(){this._target=this._pointer=this._absolutePointer=void 0}_cacheTransformEventData(t){this._resetTransformEventData(),this._pointer=this.getViewportPoint(t),this._absolutePointer=Ns(this._pointer,void 0,this.viewportTransform),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(t)}__onMouseMove(t){if(this._isClick=!1,this._cacheTransformEventData(t),this._handleEvent(t,"move:before"),this.isDrawingMode)return void this._onMouseMoveInDrawingMode(t);if(!this._isMainEvent(t))return;const e=this._groupSelector;if(e){const r=this.getScenePoint(t);e.deltaX=r.x-e.x,e.deltaY=r.y-e.y,this.renderTop()}else if(this._currentTransform)this._transformObject(t);else{const r=this.findTarget(t);this._setCursorFromEvent(t,r),this._fireOverOutEvents(t,r)}this.textEditingManager.onMouseMove(t),this._handleEvent(t,"move"),this._resetTransformEventData()}_fireOverOutEvents(t,e){const r=this._hoveredTarget,s=this._hoveredTargets,i=this.targets,n=Math.max(s.length,i.length);this.fireSyntheticInOutEvents("mouse",{e:t,target:e,oldTarget:r,fireCanvas:!0});for(let o=0;o<n;o++)i[o]===e||s[o]&&s[o]===r||this.fireSyntheticInOutEvents("mouse",{e:t,target:i[o],oldTarget:s[o]});this._hoveredTarget=e,this._hoveredTargets=this.targets.concat()}_fireEnterLeaveEvents(t,e){const r=this._draggedoverTarget,s=this._hoveredTargets,i=this.targets,n=Math.max(s.length,i.length);this.fireSyntheticInOutEvents("drag",C(C({},e),{},{target:t,oldTarget:r,fireCanvas:!0}));for(let o=0;o<n;o++)this.fireSyntheticInOutEvents("drag",C(C({},e),{},{target:i[o],oldTarget:s[o]}));this._draggedoverTarget=t}fireSyntheticInOutEvents(t,e){let{target:r,oldTarget:s,fireCanvas:i,e:n}=e,o=ie(e,em);const{targetIn:l,targetOut:c,canvasIn:u,canvasOut:d}=rm[t],g=s!==r;if(s&&g){const f=C(C({},o),{},{e:n,target:s,nextTarget:r},js(this,n));i&&this.fire(d,f),s.fire(c,f)}if(r&&g){const f=C(C({},o),{},{e:n,target:r,previousTarget:s},js(this,n));i&&this.fire(u,f),r.fire(l,f)}}__onMouseWheel(t){this._cacheTransformEventData(t),this._handleEvent(t,"wheel"),this._resetTransformEventData()}_transformObject(t){const e=this.getScenePoint(t),r=this._currentTransform,s=r.target,i=s.group?Ns(e,void 0,s.group.calcTransformMatrix()):e;r.shiftKey=t.shiftKey,r.altKey=!!this.centeredKey&&t[this.centeredKey],this._performTransformAction(t,r,i),r.actionPerformed&&this.requestRenderAll()}_performTransformAction(t,e,r){const{action:s,actionHandler:i,target:n}=e,o=!!i&&i(t,e,r.x,r.y);o&&n.setCoords(),s==="drag"&&o&&(e.target.isMoving=!0,this.setCursor(e.target.moveCursor||this.moveCursor)),e.actionPerformed=e.actionPerformed||o}_setCursorFromEvent(t,e){if(!e)return void this.setCursor(this.defaultCursor);let r=e.hoverCursor||this.hoverCursor;const s=ys(this._activeObject)?this._activeObject:null,i=(!s||e.group!==s)&&e.findControl(this.getViewportPoint(t));if(i){const n=i.control;this.setCursor(n.cursorStyleHandler(t,n,e))}else e.subTargetCheck&&this.targets.concat().reverse().map((n=>{r=n.hoverCursor||r})),this.setCursor(r)}handleMultiSelection(t,e){const r=this._activeObject,s=ys(r);if(r&&this._isSelectionKeyPressed(t)&&this.selection&&e&&e.selectable&&(r!==e||s)&&(s||!e.isDescendantOf(r)&&!r.isDescendantOf(e))&&!e.onSelect({e:t})&&!r.getActiveControl()){if(s){const i=r.getObjects();if(e===r){const n=this.getViewportPoint(t);if(!(e=this.searchPossibleTargets(i,n)||this.searchPossibleTargets(this._objects,n))||!e.selectable)return!1}e.group===r?(r.remove(e),this._hoveredTarget=e,this._hoveredTargets=[...this.targets],r.size()===1&&this._setActiveObject(r.item(0),t)):(r.multiSelectAdd(e),this._hoveredTarget=r,this._hoveredTargets=[...this.targets]),this._fireSelectionEvents(i,t)}else{r.isEditing&&r.exitEditing();const i=new(gt.getClass("ActiveSelection"))([],{canvas:this});i.multiSelectAdd(r,e),this._hoveredTarget=i,this._setActiveObject(i,t),this._fireSelectionEvents([r],t)}return!0}return!1}handleSelection(t){if(!this.selection||!this._groupSelector)return!1;const{x:e,y:r,deltaX:s,deltaY:i}=this._groupSelector,n=new F(e,r),o=n.add(new F(s,i)),l=n.min(o),c=n.max(o).subtract(l),u=this.collectObjects({left:l.x,top:l.y,width:c.x,height:c.y},{includeIntersecting:!this.selectionFullyContained}),d=n.eq(o)?u[0]?[u[0]]:[]:u.length>1?u.filter((g=>!g.onSelect({e:t}))).reverse():u;if(d.length===1)this.setActiveObject(d[0],t);else if(d.length>1){const g=gt.getClass("ActiveSelection");this.setActiveObject(new g(d,{canvas:this}),t)}return this._groupSelector=null,!0}toCanvasElement(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1,e=arguments.length>1?arguments[1]:void 0;const{upper:r}=this.elements;r.ctx=void 0;const s=super.toCanvasElement(t,e);return r.ctx=r.el.getContext("2d"),s}clear(){this.textEditingManager.clear(),super.clear()}destroy(){this.removeListeners(),this.textEditingManager.dispose(),super.destroy()}}const Cc={x1:0,y1:0,x2:0,y2:0},sm=C(C({},Cc),{},{r1:0,r2:0}),Ws=(a,t)=>isNaN(a)&&typeof t=="number"?t:a;function Tc(a){return a&&/%$/.test(a)&&Number.isFinite(parseFloat(a))}function kc(a,t){const e=typeof a=="number"?a:typeof a=="string"?parseFloat(a)/(Tc(a)?100:1):NaN;return Ks(0,Ws(e,t),1)}const im=/\s*;\s*/,nm=/\s*:\s*/;function om(a,t){let e,r;const s=a.getAttribute("style");if(s){const n=s.split(im);n[n.length-1]===""&&n.pop();for(let o=n.length;o--;){const[l,c]=n[o].split(nm).map((u=>u.trim()));l==="stop-color"?e=c:l==="stop-opacity"&&(r=c)}}const i=new Kt(e||a.getAttribute("stop-color")||"rgb(0,0,0)");return{offset:kc(a.getAttribute("offset"),0),color:i.toRgb(),opacity:Ws(parseFloat(r||a.getAttribute("stop-opacity")||""),1)*i.getAlpha()*t}}function am(a,t){const e=[],r=a.getElementsByTagName("stop"),s=kc(t,1);for(let i=r.length;i--;)e.push(om(r[i],s));return e}function Oc(a){return a.nodeName==="linearGradient"||a.nodeName==="LINEARGRADIENT"?"linear":"radial"}function Ac(a){return a.getAttribute("gradientUnits")==="userSpaceOnUse"?"pixels":"percentage"}function or(a,t){return a.getAttribute(t)}function lm(a,t){return(function(e,r){let s,{width:i,height:n,gradientUnits:o}=r;return Object.entries(e).reduce(((l,c)=>{let[u,d]=c;if(d==="Infinity")s=1;else if(d==="-Infinity")s=0;else{const g=typeof d=="string";s=g?parseFloat(d):d,g&&Tc(d)&&(s*=.01,o==="pixels"&&(u!=="x1"&&u!=="x2"&&u!=="r2"||(s*=i),u!=="y1"&&u!=="y2"||(s*=n)))}return l[u]=s,l}),{})})(Oc(a)==="linear"?(function(e){return{x1:or(e,"x1")||0,y1:or(e,"y1")||0,x2:or(e,"x2")||"100%",y2:or(e,"y2")||0}})(a):(function(e){return{x1:or(e,"fx")||or(e,"cx")||"50%",y1:or(e,"fy")||or(e,"cy")||"50%",r1:0,x2:or(e,"cx")||"50%",y2:or(e,"cy")||"50%",r2:or(e,"r")||"50%"}})(a),C(C({},t),{},{gradientUnits:Ac(a)}))}class Fi{constructor(t){const{type:e="linear",gradientUnits:r="pixels",coords:s={},colorStops:i=[],offsetX:n=0,offsetY:o=0,gradientTransform:l,id:c}=t||{};Object.assign(this,{type:e,gradientUnits:r,coords:C(C({},e==="radial"?sm:Cc),s),colorStops:i,offsetX:n,offsetY:o,gradientTransform:l,id:c?"".concat(c,"_").concat(fs()):fs()})}addColorStop(t){for(const e in t){const r=new Kt(t[e]);this.colorStops.push({offset:parseFloat(e),color:r.toRgb(),opacity:r.getAlpha()})}return this}toObject(t){return C(C({},ei(this,t)),{},{type:this.type,coords:C({},this.coords),colorStops:this.colorStops.map((e=>C({},e))),offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform?[...this.gradientTransform]:void 0})}toSVG(t){let{additionalTransform:e}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const r=[],s=this.gradientTransform?this.gradientTransform.concat():Fe.concat(),i=this.gradientUnits==="pixels"?"userSpaceOnUse":"objectBoundingBox",n=this.colorStops.map((d=>C({},d))).sort(((d,g)=>d.offset-g.offset));let o=-this.offsetX,l=-this.offsetY;var c;i==="objectBoundingBox"?(o/=t.width,l/=t.height):(o+=t.width/2,l+=t.height/2),(c=t)&&typeof c._renderPathCommands=="function"&&this.gradientUnits!=="percentage"&&(o-=t.pathOffset.x,l-=t.pathOffset.y),s[4]-=o,s[5]-=l;const u=['id="SVGID_'.concat(this.id,'"'),'gradientUnits="'.concat(i,'"'),'gradientTransform="'.concat(e?e+" ":"").concat(bi(s),'"'),""].join(" ");if(this.type==="linear"){const{x1:d,y1:g,x2:f,y2:m}=this.coords;r.push("<linearGradient ",u,' x1="',d,'" y1="',g,'" x2="',f,'" y2="',m,`">
`)}else if(this.type==="radial"){const{x1:d,y1:g,x2:f,y2:m,r1:p,r2:v}=this.coords,x=p>v;r.push("<radialGradient ",u,' cx="',x?d:f,'" cy="',x?g:m,'" r="',x?p:v,'" fx="',x?f:d,'" fy="',x?m:g,`">
`),x&&(n.reverse(),n.forEach((A=>{A.offset=1-A.offset})));const T=Math.min(p,v);if(T>0){const A=T/Math.max(p,v);n.forEach((O=>{O.offset+=A*(1-O.offset)}))}}return n.forEach((d=>{let{color:g,offset:f,opacity:m}=d;r.push("<stop ",'offset="',100*f+"%",'" style="stop-color:',g,m!==void 0?";stop-opacity: "+m:";",`"/>
`)})),r.push(this.type==="linear"?"</linearGradient>":"</radialGradient>",`
`),r.join("")}toLive(t){const{x1:e,y1:r,x2:s,y2:i,r1:n,r2:o}=this.coords,l=this.type==="linear"?t.createLinearGradient(e,r,s,i):t.createRadialGradient(e,r,n,s,i,o);return this.colorStops.forEach((c=>{let{color:u,opacity:d,offset:g}=c;l.addColorStop(g,d!==void 0?new Kt(u).setAlpha(d).toRgba():u)})),l}static async fromObject(t){const{colorStops:e,gradientTransform:r}=t;return new this(C(C({},t),{},{colorStops:e?e.map((s=>C({},s))):void 0,gradientTransform:r?[...r]:void 0}))}static fromElement(t,e,r){const s=Ac(t),i=e._findCenterFromElement();return new this(C({id:t.getAttribute("id")||void 0,type:Oc(t),coords:lm(t,{width:r.viewBoxWidth||r.width,height:r.viewBoxHeight||r.height}),colorStops:am(t,r.opacity),gradientUnits:s,gradientTransform:wo(t.getAttribute("gradientTransform")||"")},s==="pixels"?{offsetX:e.width/2-i.x,offsetY:e.height/2-i.y}:{offsetX:0,offsetY:0}))}}S(Fi,"type","Gradient"),gt.setClass(Fi,"gradient"),gt.setClass(Fi,"linear"),gt.setClass(Fi,"radial");const cm=["type","source","patternTransform"];class io{get type(){return"pattern"}set type(t){gs("warn","Setting type has no effect",t)}constructor(t){S(this,"repeat","repeat"),S(this,"offsetX",0),S(this,"offsetY",0),S(this,"crossOrigin",""),this.id=fs(),Object.assign(this,t)}isImageSource(){return!!this.source&&typeof this.source.src=="string"}isCanvasSource(){return!!this.source&&!!this.source.toDataURL}sourceToString(){return this.isImageSource()?this.source.src:this.isCanvasSource()?this.source.toDataURL():""}toLive(t){return this.source&&(!this.isImageSource()||this.source.complete&&this.source.naturalWidth!==0&&this.source.naturalHeight!==0)?t.createPattern(this.source,this.repeat):null}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];const{repeat:e,crossOrigin:r}=this;return C(C({},ei(this,t)),{},{type:"pattern",source:this.sourceToString(),repeat:e,crossOrigin:r,offsetX:re(this.offsetX,Wt.NUM_FRACTION_DIGITS),offsetY:re(this.offsetY,Wt.NUM_FRACTION_DIGITS),patternTransform:this.patternTransform?[...this.patternTransform]:null})}toSVG(t){let{width:e,height:r}=t;const{source:s,repeat:i,id:n}=this,o=Ws(this.offsetX/e,0),l=Ws(this.offsetY/r,0),c=i==="repeat-y"||i==="no-repeat"?1+Math.abs(o||0):Ws(s.width/e,0),u=i==="repeat-x"||i==="no-repeat"?1+Math.abs(l||0):Ws(s.height/r,0);return['<pattern id="SVGID_'.concat(n,'" x="').concat(o,'" y="').concat(l,'" width="').concat(c,'" height="').concat(u,'">'),'<image x="0" y="0" width="'.concat(s.width,'" height="').concat(s.height,'" xlink:href="').concat(this.sourceToString(),'"></image>'),"</pattern>",""].join(`
`)}static async fromObject(t,e){let{type:r,source:s,patternTransform:i}=t,n=ie(t,cm);const o=await hn(s,C(C({},e),{},{crossOrigin:n.crossOrigin}));return new this(C(C({},n),{},{patternTransform:i&&i.slice(0),source:o}))}}S(io,"type","Pattern"),gt.setClass(io),gt.setClass(io,"pattern");const hm=["path","left","top"],um=["d"];class xs extends Me{constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{path:r,left:s,top:i}=e,n=ie(e,hm);super(),Object.assign(this,xs.ownDefaults),this.setOptions(n),this._setPath(t||[],!0),typeof s=="number"&&this.set($t,s),typeof i=="number"&&this.set(Ve,i)}_setPath(t,e){this.path=Hf(Array.isArray(t)?t:Zf(t)),this.setBoundingBox(e)}_findCenterFromElement(){const t=this._calcBoundsFromPath();return new F(t.left+t.width/2,t.top+t.height/2)}_renderPathCommands(t){const e=-this.pathOffset.x,r=-this.pathOffset.y;t.beginPath();for(const s of this.path)switch(s[0]){case"L":t.lineTo(s[1]+e,s[2]+r);break;case"M":t.moveTo(s[1]+e,s[2]+r);break;case"C":t.bezierCurveTo(s[1]+e,s[2]+r,s[3]+e,s[4]+r,s[5]+e,s[6]+r);break;case"Q":t.quadraticCurveTo(s[1]+e,s[2]+r,s[3]+e,s[4]+r);break;case"Z":t.closePath()}}_render(t){this._renderPathCommands(t),this._renderPaintInOrder(t)}toString(){return"#<Path (".concat(this.complexity(),'): { "top": ').concat(this.top,', "left": ').concat(this.left," }>")}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return C(C({},super.toObject(t)),{},{path:this.path.map((e=>e.slice()))})}toDatalessObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];const e=this.toObject(t);return this.sourcePath&&(delete e.path,e.sourcePath=this.sourcePath),e}_toSVG(){const t=Jf(this.path,Wt.NUM_FRACTION_DIGITS);return["<path ","COMMON_PARTS",'d="'.concat(t,`" stroke-linecap="round" />
`)]}_getOffsetTransform(){const t=Wt.NUM_FRACTION_DIGITS;return" translate(".concat(re(-this.pathOffset.x,t),", ").concat(re(-this.pathOffset.y,t),")")}toClipPathSVG(t){const e=this._getOffsetTransform();return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:t,additionalTransform:e})}toSVG(t){const e=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:t,additionalTransform:e})}complexity(){return this.path.length}setDimensions(){this.setBoundingBox()}setBoundingBox(t){const{width:e,height:r,pathOffset:s}=this._calcDimensions();this.set({width:e,height:r,pathOffset:s}),t&&this.setPositionByOrigin(s,Bt,Bt)}_calcBoundsFromPath(){const t=[];let e=0,r=0,s=0,i=0;for(const n of this.path)switch(n[0]){case"L":s=n[1],i=n[2],t.push({x:e,y:r},{x:s,y:i});break;case"M":s=n[1],i=n[2],e=s,r=i;break;case"C":t.push(...Qa(s,i,n[1],n[2],n[3],n[4],n[5],n[6])),s=n[5],i=n[6];break;case"Q":t.push(...Qa(s,i,n[1],n[2],n[1],n[2],n[3],n[4])),s=n[3],i=n[4];break;case"Z":s=e,i=r}return Nr(t)}_calcDimensions(){const t=this._calcBoundsFromPath();return C(C({},t),{},{pathOffset:new F(t.left+t.width/2,t.top+t.height/2)})}static fromObject(t){return this._fromObject(t,{extraParam:"path"})}static async fromElement(t,e,r){const s=Qr(t,this.ATTRIBUTE_NAMES,r),{d:i}=s;return new this(i,C(C(C({},ie(s,um)),e),{},{left:void 0,top:void 0}))}}S(xs,"type","Path"),S(xs,"cacheProperties",[...Jr,"path","fillRule"]),S(xs,"ATTRIBUTE_NAMES",[...ms,"d"]),gt.setClass(xs),gt.setSVGClass(xs);const dm=["left","top","radius"],Dc=["radius","startAngle","endAngle","counterClockwise"];class Vr extends Me{static getDefaults(){return C(C({},super.getDefaults()),Vr.ownDefaults)}constructor(t){super(),Object.assign(this,Vr.ownDefaults),this.setOptions(t)}_set(t,e){return super._set(t,e),t==="radius"&&this.setRadius(e),this}_render(t){t.beginPath(),t.arc(0,0,this.radius,ge(this.startAngle),ge(this.endAngle),this.counterClockwise),this._renderPaintInOrder(t)}getRadiusX(){return this.get("radius")*this.get(Ye)}getRadiusY(){return this.get("radius")*this.get(rr)}setRadius(t){this.radius=t,this.set({width:2*t,height:2*t})}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return super.toObject([...Dc,...t])}_toSVG(){const t=(this.endAngle-this.startAngle)%360;if(t===0)return["<circle ","COMMON_PARTS",'cx="0" cy="0" ','r="',"".concat(this.radius),`" />
`];{const{radius:e}=this,r=ge(this.startAngle),s=ge(this.endAngle),i=Gr(r)*e,n=qr(r)*e,o=Gr(s)*e,l=qr(s)*e,c=t>180?1:0,u=this.counterClockwise?0:1;return['<path d="M '.concat(i," ").concat(n," A ").concat(e," ").concat(e," 0 ").concat(c," ").concat(u," ").concat(o," ").concat(l,'" '),"COMMON_PARTS",` />
`]}}static async fromElement(t,e,r){const s=Qr(t,this.ATTRIBUTE_NAMES,r),{left:i=0,top:n=0,radius:o=0}=s;return new this(C(C({},ie(s,dm)),{},{radius:o,left:i-o,top:n-o}))}static fromObject(t){return super._fromObject(t)}}S(Vr,"type","Circle"),S(Vr,"cacheProperties",[...Jr,...Dc]),S(Vr,"ownDefaults",{radius:0,startAngle:0,endAngle:360,counterClockwise:!1}),S(Vr,"ATTRIBUTE_NAMES",["cx","cy","r",...ms]),gt.setClass(Vr),gt.setSVGClass(Vr);const gm=["x1","y1","x2","y2"],fm=["x1","y1","x2","y2"],ko=["x1","x2","y1","y2"];class ws extends Me{constructor(){let[t,e,r,s]=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[0,0,0,0],i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),Object.assign(this,ws.ownDefaults),this.setOptions(i),this.x1=t,this.x2=r,this.y1=e,this.y2=s,this._setWidthHeight();const{left:n,top:o}=i;typeof n=="number"&&this.set($t,n),typeof o=="number"&&this.set(Ve,o)}_setWidthHeight(){const{x1:t,y1:e,x2:r,y2:s}=this;this.width=Math.abs(r-t),this.height=Math.abs(s-e);const{left:i,top:n,width:o,height:l}=Nr([{x:t,y:e},{x:r,y:s}]),c=new F(i+o/2,n+l/2);this.setPositionByOrigin(c,Bt,Bt)}_set(t,e){return super._set(t,e),ko.includes(t)&&this._setWidthHeight(),this}_render(t){t.beginPath();const e=this.calcLinePoints();t.moveTo(e.x1,e.y1),t.lineTo(e.x2,e.y2),t.lineWidth=this.strokeWidth;const r=t.strokeStyle;var s;Ze(this.stroke)?t.strokeStyle=this.stroke.toLive(t):t.strokeStyle=(s=this.stroke)!==null&&s!==void 0?s:t.fillStyle,this.stroke&&this._renderStroke(t),t.strokeStyle=r}_findCenterFromElement(){return new F((this.x1+this.x2)/2,(this.y1+this.y2)/2)}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return C(C({},super.toObject(t)),this.calcLinePoints())}_getNonTransformedDimensions(){const t=super._getNonTransformedDimensions();return this.strokeLineCap==="butt"&&(this.width===0&&(t.y-=this.strokeWidth),this.height===0&&(t.x-=this.strokeWidth)),t}calcLinePoints(){const{x1:t,x2:e,y1:r,y2:s,width:i,height:n}=this,o=t<=e?-1:1,l=r<=s?-1:1;return{x1:o*i/2,x2:o*-i/2,y1:l*n/2,y2:l*-n/2}}_toSVG(){const{x1:t,x2:e,y1:r,y2:s}=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="'.concat(t,'" y1="').concat(r,'" x2="').concat(e,'" y2="').concat(s,`" />
`)]}static async fromElement(t,e,r){const s=Qr(t,this.ATTRIBUTE_NAMES,r),{x1:i=0,y1:n=0,x2:o=0,y2:l=0}=s;return new this([i,n,o,l],ie(s,gm))}static fromObject(t){let{x1:e,y1:r,x2:s,y2:i}=t,n=ie(t,fm);return this._fromObject(C(C({},n),{},{points:[e,r,s,i]}),{extraParam:"points"})}}S(ws,"type","Line"),S(ws,"cacheProperties",[...Jr,...ko]),S(ws,"ATTRIBUTE_NAMES",ms.concat(ko)),gt.setClass(ws),gt.setSVGClass(ws);class bs extends Me{static getDefaults(){return C(C({},super.getDefaults()),bs.ownDefaults)}constructor(t){super(),Object.assign(this,bs.ownDefaults),this.setOptions(t)}_render(t){const e=this.width/2,r=this.height/2;t.beginPath(),t.moveTo(-e,r),t.lineTo(0,-r),t.lineTo(e,r),t.closePath(),this._renderPaintInOrder(t)}_toSVG(){const t=this.width/2,e=this.height/2;return["<polygon ","COMMON_PARTS",'points="',"".concat(-t," ").concat(e,",0 ").concat(-e,",").concat(t," ").concat(e),'" />']}}S(bs,"type","Triangle"),S(bs,"ownDefaults",{width:100,height:100}),gt.setClass(bs),gt.setSVGClass(bs);const Ec=["rx","ry"];class Wr extends Me{static getDefaults(){return C(C({},super.getDefaults()),Wr.ownDefaults)}constructor(t){super(),Object.assign(this,Wr.ownDefaults),this.setOptions(t)}_set(t,e){switch(super._set(t,e),t){case"rx":this.rx=e,this.set("width",2*e);break;case"ry":this.ry=e,this.set("height",2*e)}return this}getRx(){return this.get("rx")*this.get(Ye)}getRy(){return this.get("ry")*this.get(rr)}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return super.toObject([...Ec,...t])}_toSVG(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" rx="'.concat(this.rx,'" ry="').concat(this.ry,`" />
`)]}_render(t){t.beginPath(),t.save(),t.transform(1,0,0,this.ry/this.rx,0,0),t.arc(0,0,this.rx,0,yn,!1),t.restore(),this._renderPaintInOrder(t)}static async fromElement(t,e,r){const s=Qr(t,this.ATTRIBUTE_NAMES,r);return s.left=(s.left||0)-s.rx,s.top=(s.top||0)-s.ry,new this(s)}}function mm(a){if(!a)return[];const t=a.replace(/,/g," ").trim().split(/\s+/),e=[];for(let r=0;r<t.length;r+=2)e.push({x:parseFloat(t[r]),y:parseFloat(t[r+1])});return e}S(Wr,"type","Ellipse"),S(Wr,"cacheProperties",[...Jr,...Ec]),S(Wr,"ownDefaults",{rx:0,ry:0}),S(Wr,"ATTRIBUTE_NAMES",[...ms,"cx","cy","rx","ry"]),gt.setClass(Wr),gt.setSVGClass(Wr);const pm=["left","top"],Pc={exactBoundingBox:!1};class lr extends Me{static getDefaults(){return C(C({},super.getDefaults()),lr.ownDefaults)}constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),S(this,"strokeDiff",void 0),Object.assign(this,lr.ownDefaults),this.setOptions(e),this.points=t;const{left:r,top:s}=e;this.initialized=!0,this.setBoundingBox(!0),typeof r=="number"&&this.set($t,r),typeof s=="number"&&this.set(Ve,s)}isOpen(){return!0}_projectStrokeOnPoints(t){return nf(this.points,t,this.isOpen())}_calcDimensions(t){t=C({scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,strokeLineCap:this.strokeLineCap,strokeLineJoin:this.strokeLineJoin,strokeMiterLimit:this.strokeMiterLimit,strokeUniform:this.strokeUniform,strokeWidth:this.strokeWidth},t||{});const e=this.exactBoundingBox?this._projectStrokeOnPoints(t).map((c=>c.projectedPoint)):this.points;if(e.length===0)return{left:0,top:0,width:0,height:0,pathOffset:new F,strokeOffset:new F,strokeDiff:new F};const r=Nr(e),s=Bn(C(C({},t),{},{scaleX:1,scaleY:1})),i=Nr(this.points.map((c=>Re(c,s,!0)))),n=new F(this.scaleX,this.scaleY);let o=r.left+r.width/2,l=r.top+r.height/2;return this.exactBoundingBox&&(o-=l*Math.tan(ge(this.skewX)),l-=o*Math.tan(ge(this.skewY))),C(C({},r),{},{pathOffset:new F(o,l),strokeOffset:new F(i.left,i.top).subtract(new F(r.left,r.top)).multiply(n),strokeDiff:new F(r.width,r.height).subtract(new F(i.width,i.height)).multiply(n)})}_findCenterFromElement(){const t=Nr(this.points);return new F(t.left+t.width/2,t.top+t.height/2)}setDimensions(){this.setBoundingBox()}setBoundingBox(t){const{left:e,top:r,width:s,height:i,pathOffset:n,strokeOffset:o,strokeDiff:l}=this._calcDimensions();this.set({width:s,height:i,pathOffset:n,strokeOffset:o,strokeDiff:l}),t&&this.setPositionByOrigin(new F(e+s/2,r+i/2),Bt,Bt)}isStrokeAccountedForInDimensions(){return this.exactBoundingBox}_getNonTransformedDimensions(){return this.exactBoundingBox?new F(this.width,this.height):super._getNonTransformedDimensions()}_getTransformedDimensions(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(this.exactBoundingBox){let n;if(Object.keys(t).some((o=>this.strokeUniform||this.constructor.layoutProperties.includes(o)))){var e,r;const{width:o,height:l}=this._calcDimensions(t);n=new F((e=t.width)!==null&&e!==void 0?e:o,(r=t.height)!==null&&r!==void 0?r:l)}else{var s,i;n=new F((s=t.width)!==null&&s!==void 0?s:this.width,(i=t.height)!==null&&i!==void 0?i:this.height)}return n.multiply(new F(t.scaleX||this.scaleX,t.scaleY||this.scaleY))}return super._getTransformedDimensions(t)}_set(t,e){const r=this.initialized&&this[t]!==e,s=super._set(t,e);return this.exactBoundingBox&&r&&((t===Ye||t===rr)&&this.strokeUniform&&this.constructor.layoutProperties.includes("strokeUniform")||this.constructor.layoutProperties.includes(t))&&this.setDimensions(),s}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return C(C({},super.toObject(t)),{},{points:this.points.map((e=>{let{x:r,y:s}=e;return{x:r,y:s}}))})}_toSVG(){const t=[],e=this.pathOffset.x,r=this.pathOffset.y,s=Wt.NUM_FRACTION_DIGITS;for(let i=0,n=this.points.length;i<n;i++)t.push(re(this.points[i].x-e,s),",",re(this.points[i].y-r,s)," ");return["<".concat(this.constructor.type.toLowerCase()," "),"COMMON_PARTS",'points="'.concat(t.join(""),`" />
`)]}_render(t){const e=this.points.length,r=this.pathOffset.x,s=this.pathOffset.y;if(e&&!isNaN(this.points[e-1].y)){t.beginPath(),t.moveTo(this.points[0].x-r,this.points[0].y-s);for(let i=0;i<e;i++){const n=this.points[i];t.lineTo(n.x-r,n.y-s)}!this.isOpen()&&t.closePath(),this._renderPaintInOrder(t)}}complexity(){return this.points.length}static async fromElement(t,e,r){return new this(mm(t.getAttribute("points")),C(C({},ie(Qr(t,this.ATTRIBUTE_NAMES,r),pm)),e))}static fromObject(t){return this._fromObject(t,{extraParam:"points"})}}S(lr,"ownDefaults",Pc),S(lr,"type","Polyline"),S(lr,"layoutProperties",[Js,Qs,"strokeLineCap","strokeLineJoin","strokeMiterLimit","strokeWidth","strokeUniform","points"]),S(lr,"cacheProperties",[...Jr,"points"]),S(lr,"ATTRIBUTE_NAMES",[...ms]),gt.setClass(lr),gt.setSVGClass(lr);class ji extends lr{isOpen(){return!1}}S(ji,"ownDefaults",Pc),S(ji,"type","Polygon"),gt.setClass(ji),gt.setSVGClass(ji);class Mc extends Me{isEmptyStyles(t){if(!this.styles||t!==void 0&&!this.styles[t])return!0;const e=t===void 0?this.styles:{line:this.styles[t]};for(const r in e)for(const s in e[r])for(const i in e[r][s])return!1;return!0}styleHas(t,e){if(!this.styles||e!==void 0&&!this.styles[e])return!1;const r=e===void 0?this.styles:{0:this.styles[e]};for(const s in r)for(const i in r[s])if(r[s][i][t]!==void 0)return!0;return!1}cleanStyle(t){if(!this.styles)return!1;const e=this.styles;let r,s,i=0,n=!0,o=0;for(const l in e){r=0;for(const c in e[l]){const u=e[l][c]||{};i++,u[t]!==void 0?(s?u[t]!==s&&(n=!1):s=u[t],u[t]===this[t]&&delete u[t]):n=!1,Object.keys(u).length!==0?r++:delete e[l][c]}r===0&&delete e[l]}for(let l=0;l<this._textLines.length;l++)o+=this._textLines[l].length;n&&i===o&&(this[t]=s,this.removeStyle(t))}removeStyle(t){if(!this.styles)return;const e=this.styles;let r,s,i;for(s in e){for(i in r=e[s],r)delete r[i][t],Object.keys(r[i]).length===0&&delete r[i];Object.keys(r).length===0&&delete e[s]}}_extendStyles(t,e){const{lineIndex:r,charIndex:s}=this.get2DCursorLocation(t);this._getLineStyle(r)||this._setLineStyle(r);const i=Yo(C(C({},this._getStyleDeclaration(r,s)),e),(n=>n!==void 0));this._setStyleDeclaration(r,s,i)}getSelectionStyles(t,e,r){const s=[];for(let i=t;i<(e||t);i++)s.push(this.getStyleAtPosition(i,r));return s}getStyleAtPosition(t,e){const{lineIndex:r,charIndex:s}=this.get2DCursorLocation(t);return e?this.getCompleteStyleDeclaration(r,s):this._getStyleDeclaration(r,s)}setSelectionStyles(t,e,r){for(let s=e;s<(r||e);s++)this._extendStyles(s,t);this._forceClearCache=!0}_getStyleDeclaration(t,e){var r;const s=this.styles&&this.styles[t];return s&&(r=s[e])!==null&&r!==void 0?r:{}}getCompleteStyleDeclaration(t,e){return C(C({},ei(this,this.constructor._styleProperties)),this._getStyleDeclaration(t,e))}_setStyleDeclaration(t,e,r){this.styles[t][e]=r}_deleteStyleDeclaration(t,e){delete this.styles[t][e]}_getLineStyle(t){return!!this.styles[t]}_setLineStyle(t){this.styles[t]={}}_deleteLineStyle(t){delete this.styles[t]}}S(Mc,"_styleProperties",xg);const vm=/  +/g,_m=/"/g;function no(a,t,e,r,s){return"		".concat((function(i,n){let{left:o,top:l,width:c,height:u}=n,d=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Wt.NUM_FRACTION_DIGITS;const g=Si(_e,i,!1),[f,m,p,v]=[o,l,c,u].map((x=>re(x,d)));return"<rect ".concat(g,' x="').concat(f,'" y="').concat(m,'" width="').concat(p,'" height="').concat(v,'"></rect>')})(a,{left:t,top:e,width:r,height:s}),`
`)}const ym=["textAnchor","textDecoration","dx","dy","top","left","fontSize","strokeWidth"];let oo;class Ie extends Mc{static getDefaults(){return C(C({},super.getDefaults()),Ie.ownDefaults)}constructor(t,e){super(),S(this,"__charBounds",[]),Object.assign(this,Ie.ownDefaults),this.setOptions(e),this.styles||(this.styles={}),this.text=t,this.initialized=!0,this.path&&this.setPathInfo(),this.initDimensions(),this.setCoords()}setPathInfo(){const t=this.path;t&&(t.segmentsInfo=Sc(t.path))}_splitText(){const t=this._splitTextIntoLines(this.text);return this.textLines=t.lines,this._textLines=t.graphemeLines,this._unwrappedTextLines=t._unwrappedLines,this._text=t.graphemeText,t}initDimensions(){this._splitText(),this._clearCache(),this.dirty=!0,this.path?(this.width=this.path.width,this.height=this.path.height):(this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight()),this.textAlign.includes(Cr)&&this.enlargeSpaces()}enlargeSpaces(){let t,e,r,s,i,n,o;for(let l=0,c=this._textLines.length;l<c;l++)if((this.textAlign===Cr||l!==c-1&&!this.isEndOfWrapping(l))&&(s=0,i=this._textLines[l],e=this.getLineWidth(l),e<this.width&&(o=this.textLines[l].match(this._reSpacesAndTabs)))){r=o.length,t=(this.width-e)/r;for(let u=0;u<=i.length;u++)n=this.__charBounds[l][u],this._reSpaceAndTab.test(i[u])?(n.width+=t,n.kernedWidth+=t,n.left+=s,s+=t):n.left+=s}}isEndOfWrapping(t){return t===this._textLines.length-1}missingNewlineOffset(t){return 1}get2DCursorLocation(t,e){const r=e?this._unwrappedTextLines:this._textLines;let s;for(s=0;s<r.length;s++){if(t<=r[s].length)return{lineIndex:s,charIndex:t};t-=r[s].length+this.missingNewlineOffset(s,e)}return{lineIndex:s-1,charIndex:r[s-1].length<t?r[s-1].length:t}}toString(){return"#<Text (".concat(this.complexity(),'): { "text": "').concat(this.text,'", "fontFamily": "').concat(this.fontFamily,'" }>')}_getCacheCanvasDimensions(){const t=super._getCacheCanvasDimensions(),e=this.fontSize;return t.width+=e*t.zoomX,t.height+=e*t.zoomY,t}_render(t){const e=this.path;e&&!e.isNotVisible()&&e._render(t),this._setTextStyles(t),this._renderTextLinesBackground(t),this._renderTextDecoration(t,"underline"),this._renderText(t),this._renderTextDecoration(t,"overline"),this._renderTextDecoration(t,"linethrough")}_renderText(t){this.paintFirst===He?(this._renderTextStroke(t),this._renderTextFill(t)):(this._renderTextFill(t),this._renderTextStroke(t))}_setTextStyles(t,e,r){if(t.textBaseline="alphabetic",this.path)switch(this.pathAlign){case Bt:t.textBaseline="middle";break;case"ascender":t.textBaseline=Ve;break;case"descender":t.textBaseline=mo}t.font=this._getFontDeclaration(e,r)}calcTextWidth(){let t=this.getLineWidth(0);for(let e=1,r=this._textLines.length;e<r;e++){const s=this.getLineWidth(e);s>t&&(t=s)}return t}_renderTextLine(t,e,r,s,i,n){this._renderChars(t,e,r,s,i,n)}_renderTextLinesBackground(t){if(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor"))return;const e=t.fillStyle,r=this._getLeftOffset();let s=this._getTopOffset();for(let i=0,n=this._textLines.length;i<n;i++){const o=this.getHeightOfLine(i);if(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor",i)){s+=o;continue}const l=this._textLines[i].length,c=this._getLineLeftOffset(i);let u,d,g=0,f=0,m=this.getValueOfPropertyAt(i,0,"textBackgroundColor");const p=this.getHeightOfLineImpl(i);for(let v=0;v<l;v++){const x=this.__charBounds[i][v];d=this.getValueOfPropertyAt(i,v,"textBackgroundColor"),this.path?(t.save(),t.translate(x.renderLeft,x.renderTop),t.rotate(x.angle),t.fillStyle=d,d&&t.fillRect(-x.width/2,-p*(1-this._fontSizeFraction),x.width,p),t.restore()):d!==m?(u=r+c+f,this.direction==="rtl"&&(u=this.width-u-g),t.fillStyle=m,m&&t.fillRect(u,s,g,p),f=x.left,g=x.width,m=d):g+=x.kernedWidth}d&&!this.path&&(u=r+c+f,this.direction==="rtl"&&(u=this.width-u-g),t.fillStyle=d,t.fillRect(u,s,g,p)),s+=o}t.fillStyle=e,this._removeShadow(t)}_measureChar(t,e,r,s){const i=gi.getFontCache(e),n=this._getFontDeclaration(e),o=r?r+t:t,l=r&&n===this._getFontDeclaration(s),c=e.fontSize/this.CACHE_FONT_SIZE;let u,d,g,f;if(r&&i.has(r)&&(g=i.get(r)),i.has(t)&&(f=u=i.get(t)),l&&i.has(o)&&(d=i.get(o),f=d-g),u===void 0||g===void 0||d===void 0){const m=(function(){return oo||(oo=sr({width:0,height:0}).getContext("2d")),oo})();this._setTextStyles(m,e,!0),u===void 0&&(f=u=m.measureText(t).width,i.set(t,u)),g===void 0&&l&&r&&(g=m.measureText(r).width,i.set(r,g)),l&&d===void 0&&(d=m.measureText(o).width,i.set(o,d),f=d-g)}return{width:u*c,kernedWidth:f*c}}getHeightOfChar(t,e){return this.getValueOfPropertyAt(t,e,"fontSize")}measureLine(t){const e=this._measureLine(t);return this.charSpacing!==0&&(e.width-=this._getWidthOfCharSpacing()),e.width<0&&(e.width=0),e}_measureLine(t){let e,r,s=0;const i=this.pathSide===de,n=this.path,o=this._textLines[t],l=o.length,c=new Array(l);this.__charBounds[t]=c;for(let u=0;u<l;u++){const d=o[u];r=this._getGraphemeBox(d,t,u,e),c[u]=r,s+=r.kernedWidth,e=d}if(c[l]={left:r?r.left+r.width:0,width:0,kernedWidth:0,height:this.fontSize,deltaY:0},n&&n.segmentsInfo){let u=0;const d=n.segmentsInfo[n.segmentsInfo.length-1].length;switch(this.textAlign){case $t:u=i?d-s:0;break;case Bt:u=(d-s)/2;break;case de:u=i?0:d-s}u+=this.pathStartOffset*(i?-1:1);for(let g=i?l-1:0;i?g>=0:g<l;i?g--:g++)r=c[g],u>d?u%=d:u<0&&(u+=d),this._setGraphemeOnPath(u,r),u+=r.kernedWidth}return{width:s,numOfSpaces:0}}_setGraphemeOnPath(t,e){const r=t+e.kernedWidth/2,s=this.path,i=Gf(s.path,r,s.segmentsInfo);e.renderLeft=i.x-s.pathOffset.x,e.renderTop=i.y-s.pathOffset.y,e.angle=i.angle+(this.pathSide===de?Math.PI:0)}_getGraphemeBox(t,e,r,s,i){const n=this.getCompleteStyleDeclaration(e,r),o=s?this.getCompleteStyleDeclaration(e,r-1):{},l=this._measureChar(t,n,s,o);let c,u=l.kernedWidth,d=l.width;this.charSpacing!==0&&(c=this._getWidthOfCharSpacing(),d+=c,u+=c);const g={width:d,left:0,height:n.fontSize,kernedWidth:u,deltaY:n.deltaY};if(r>0&&!i){const f=this.__charBounds[e][r-1];g.left=f.left+f.width+l.kernedWidth-l.width}return g}getHeightOfLineImpl(t){const e=this.__lineHeights;if(e[t])return e[t];let r=this.getHeightOfChar(t,0);for(let s=1,i=this._textLines[t].length;s<i;s++)r=Math.max(this.getHeightOfChar(t,s),r);return e[t]=r*this._fontSizeMult}getHeightOfLine(t){return this.getHeightOfLineImpl(t)*this.lineHeight}calcTextHeight(){let t=0;for(let e=0,r=this._textLines.length;e<r;e++)t+=e===r-1?this.getHeightOfLineImpl(e):this.getHeightOfLine(e);return t}_getLeftOffset(){return this.direction==="ltr"?-this.width/2:this.width/2}_getTopOffset(){return-this.height/2}_renderTextCommon(t,e){t.save();let r=0;const s=this._getLeftOffset(),i=this._getTopOffset();for(let n=0,o=this._textLines.length;n<o;n++)this._renderTextLine(e,t,this._textLines[n],s+this._getLineLeftOffset(n),i+r+this.getHeightOfLineImpl(n),n),r+=this.getHeightOfLine(n);t.restore()}_renderTextFill(t){(this.fill||this.styleHas(_e))&&this._renderTextCommon(t,"fillText")}_renderTextStroke(t){(this.stroke&&this.strokeWidth!==0||!this.isEmptyStyles())&&(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(t),t.save(),this._setLineDash(t,this.strokeDashArray),t.beginPath(),this._renderTextCommon(t,"strokeText"),t.closePath(),t.restore())}_renderChars(t,e,r,s,i,n){const o=this.textAlign.includes(Cr),l=this.path,c=!o&&this.charSpacing===0&&this.isEmptyStyles(n)&&!l,u=this.direction==="ltr",d=this.direction==="ltr"?1:-1,g=e.direction;let f,m,p,v,x,T="",A=0;if(e.save(),g!==this.direction&&(e.canvas.setAttribute("dir",u?"ltr":"rtl"),e.direction=u?"ltr":"rtl",e.textAlign=u?$t:de),i-=this.getHeightOfLineImpl(n)*this._fontSizeFraction,c)return this._renderChar(t,e,n,0,r.join(""),s,i),void e.restore();for(let O=0,P=r.length-1;O<=P;O++)v=O===P||this.charSpacing||l,T+=r[O],p=this.__charBounds[n][O],A===0?(s+=d*(p.kernedWidth-p.width),A+=p.width):A+=p.kernedWidth,o&&!v&&this._reSpaceAndTab.test(r[O])&&(v=!0),v||(f=f||this.getCompleteStyleDeclaration(n,O),m=this.getCompleteStyleDeclaration(n,O+1),v=Zo(f,m,!1)),v&&(l?(e.save(),e.translate(p.renderLeft,p.renderTop),e.rotate(p.angle),this._renderChar(t,e,n,O,T,-A/2,0),e.restore()):(x=s,this._renderChar(t,e,n,O,T,x,i)),T="",f=m,s+=d*A,A=0);e.restore()}_applyPatternGradientTransformText(t){const e=this.width+this.strokeWidth,r=this.height+this.strokeWidth,s=sr({width:e,height:r}),i=s.getContext("2d");return s.width=e,s.height=r,i.beginPath(),i.moveTo(0,0),i.lineTo(e,0),i.lineTo(e,r),i.lineTo(0,r),i.closePath(),i.translate(e/2,r/2),i.fillStyle=t.toLive(i),this._applyPatternGradientTransform(i,t),i.fill(),i.createPattern(s,"no-repeat")}handleFiller(t,e,r){let s,i;return Ze(r)?r.gradientUnits==="percentage"||r.gradientTransform||r.patternTransform?(s=-this.width/2,i=-this.height/2,t.translate(s,i),t[e]=this._applyPatternGradientTransformText(r),{offsetX:s,offsetY:i}):(t[e]=r.toLive(t),this._applyPatternGradientTransform(t,r)):(t[e]=r,{offsetX:0,offsetY:0})}_setStrokeStyles(t,e){let{stroke:r,strokeWidth:s}=e;return t.lineWidth=s,t.lineCap=this.strokeLineCap,t.lineDashOffset=this.strokeDashOffset,t.lineJoin=this.strokeLineJoin,t.miterLimit=this.strokeMiterLimit,this.handleFiller(t,"strokeStyle",r)}_setFillStyles(t,e){let{fill:r}=e;return this.handleFiller(t,"fillStyle",r)}_renderChar(t,e,r,s,i,n,o){const l=this._getStyleDeclaration(r,s),c=this.getCompleteStyleDeclaration(r,s),u=t==="fillText"&&c.fill,d=t==="strokeText"&&c.stroke&&c.strokeWidth;if(d||u){if(e.save(),e.font=this._getFontDeclaration(c),l.textBackgroundColor&&this._removeShadow(e),l.deltaY&&(o+=l.deltaY),u){const g=this._setFillStyles(e,c);e.fillText(i,n-g.offsetX,o-g.offsetY)}if(d){const g=this._setStrokeStyles(e,c);e.strokeText(i,n-g.offsetX,o-g.offsetY)}e.restore()}}setSuperscript(t,e){this._setScript(t,e,this.superscript)}setSubscript(t,e){this._setScript(t,e,this.subscript)}_setScript(t,e,r){const s=this.get2DCursorLocation(t,!0),i=this.getValueOfPropertyAt(s.lineIndex,s.charIndex,"fontSize"),n=this.getValueOfPropertyAt(s.lineIndex,s.charIndex,"deltaY"),o={fontSize:i*r.size,deltaY:n+i*r.baseline};this.setSelectionStyles(o,t,e)}_getLineLeftOffset(t){const e=this.getLineWidth(t),r=this.width-e,s=this.textAlign,i=this.direction,n=this.isEndOfWrapping(t);let o=0;return s===Cr||s===mi&&!n||s===fi&&!n||s===On&&!n?0:(s===Bt&&(o=r/2),s===de&&(o=r),s===mi&&(o=r/2),s===fi&&(o=r),i==="rtl"&&(s===de||s===Cr||s===fi?o=0:s===$t||s===On?o=-r:s!==Bt&&s!==mi||(o=-r/2)),o)}_clearCache(){this._forceClearCache=!1,this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]}getLineWidth(t){if(this.__lineWidths[t]!==void 0)return this.__lineWidths[t];const{width:e}=this.measureLine(t);return this.__lineWidths[t]=e,e}_getWidthOfCharSpacing(){return this.charSpacing!==0?this.fontSize*this.charSpacing/1e3:0}getValueOfPropertyAt(t,e,r){var s;return(s=this._getStyleDeclaration(t,e)[r])!==null&&s!==void 0?s:this[r]}_renderTextDecoration(t,e){if(!this[e]&&!this.styleHas(e))return;let r=this._getTopOffset();const s=this._getLeftOffset(),i=this.path,n=this._getWidthOfCharSpacing(),o=e==="linethrough"?.5:e==="overline"?1:0,l=this.offsets[e];for(let c=0,u=this._textLines.length;c<u;c++){const d=this.getHeightOfLine(c);if(!this[e]&&!this.styleHas(e,c)){r+=d;continue}const g=this._textLines[c],f=d/this.lineHeight,m=this._getLineLeftOffset(c);let p=0,v=0,x=this.getValueOfPropertyAt(c,0,e),T=this.getValueOfPropertyAt(c,0,_e),A=this.getValueOfPropertyAt(c,0,Ds),O=x,P=T,L=A;const E=r+f*(1-this._fontSizeFraction);let _=this.getHeightOfChar(c,0),j=this.getValueOfPropertyAt(c,0,"deltaY");for(let R=0,B=g.length;R<B;R++){const V=this.__charBounds[c][R];O=this.getValueOfPropertyAt(c,R,e),P=this.getValueOfPropertyAt(c,R,_e),L=this.getValueOfPropertyAt(c,R,Ds);const Q=this.getHeightOfChar(c,R),tt=this.getValueOfPropertyAt(c,R,"deltaY");if(i&&O&&P){const z=this.fontSize*L/1e3;t.save(),t.fillStyle=T,t.translate(V.renderLeft,V.renderTop),t.rotate(V.angle),t.fillRect(-V.kernedWidth/2,l*Q+tt-o*z,V.kernedWidth,z),t.restore()}else if((O!==x||P!==T||Q!==_||L!==A||tt!==j)&&v>0){const z=this.fontSize*A/1e3;let $=s+m+p;this.direction==="rtl"&&($=this.width-$-v),x&&T&&A&&(t.fillStyle=T,t.fillRect($,E+l*_+j-o*z,v,z)),p=V.left,v=V.width,x=O,A=L,T=P,_=Q,j=tt}else v+=V.kernedWidth}let X=s+m+p;this.direction==="rtl"&&(X=this.width-X-v),t.fillStyle=P;const G=this.fontSize*L/1e3;O&&P&&L&&t.fillRect(X,E+l*_+j-o*G,v-n,G),r+=d}this._removeShadow(t)}_getFontDeclaration(){let{fontFamily:t=this.fontFamily,fontStyle:e=this.fontStyle,fontWeight:r=this.fontWeight,fontSize:s=this.fontSize}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},i=arguments.length>1?arguments[1]:void 0;const n=t.includes("'")||t.includes('"')||t.includes(",")||Ie.genericFonts.includes(t.toLowerCase())?t:'"'.concat(t,'"');return[e,r,"".concat(i?this.CACHE_FONT_SIZE:s,"px"),n].join(" ")}render(t){this.visible&&(this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._forceClearCache&&this.initDimensions(),super.render(t)))}graphemeSplit(t){return Ko(t)}_splitTextIntoLines(t){const e=t.split(this._reNewline),r=new Array(e.length),s=[`
`];let i=[];for(let n=0;n<e.length;n++)r[n]=this.graphemeSplit(e[n]),i=i.concat(r[n],s);return i.pop(),{_unwrappedLines:r,lines:e,graphemeText:i,graphemeLines:r}}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return C(C({},super.toObject([...nc,...t])),{},{styles:cf(this.styles,this.text)},this.path?{path:this.path.toObject()}:{})}set(t,e){const{textLayoutProperties:r}=this.constructor;super.set(t,e);let s=!1,i=!1;if(typeof t=="object")for(const n in t)n==="path"&&this.setPathInfo(),s=s||r.includes(n),i=i||n==="path";else s=r.includes(t),i=t==="path";return i&&this.setPathInfo(),s&&this.initialized&&(this.initDimensions(),this.setCoords()),this}complexity(){return 1}static async fromElement(t,e,r){const s=Qr(t,Ie.ATTRIBUTE_NAMES,r),i=C(C({},e),s),{textAnchor:n=$t,textDecoration:o="",dx:l=0,dy:c=0,top:u=0,left:d=0,fontSize:g=Ro,strokeWidth:f=1}=i,m=ie(i,ym),p=new this(kn(t.textContent||"").trim(),C({left:d+l,top:u+c,underline:o.includes("underline"),overline:o.includes("overline"),linethrough:o.includes("line-through"),strokeWidth:0,fontSize:g},m)),v=p.getScaledHeight()/p.height,x=((p.height+p.strokeWidth)*p.lineHeight-p.height)*v,T=p.getScaledHeight()+x;let A=0;return n===Bt&&(A=p.getScaledWidth()/2),n===de&&(A=p.getScaledWidth()),p.set({left:p.left-A,top:p.top-(T-p.fontSize*(.07+p._fontSizeFraction))/p.lineHeight,strokeWidth:f}),p}static fromObject(t){return this._fromObject(C(C({},t),{},{styles:hf(t.styles||{},t.text)}),{extraParam:"text"})}}S(Ie,"textLayoutProperties",ic),S(Ie,"cacheProperties",[...Jr,...nc]),S(Ie,"ownDefaults",wg),S(Ie,"type","Text"),S(Ie,"genericFonts",["serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]),S(Ie,"ATTRIBUTE_NAMES",ms.concat("x","y","dx","dy","font-family","font-style","font-weight","font-size","letter-spacing","text-decoration","text-anchor")),fc(Ie,[class extends ec{_toSVG(){const a=this._getSVGLeftTopOffsets(),t=this._getSVGTextAndBg(a.textTop,a.textLeft);return this._wrapSVGTextAndBg(t)}toSVG(a){const t=this._createBaseSVGMarkup(this._toSVG(),{reviver:a,noStyle:!0,withShadow:!0}),e=this.path;return e?t+e._createBaseSVGMarkup(e._toSVG(),{reviver:a,withShadow:!0,additionalTransform:bi(this.calcOwnMatrix())}):t}_getSVGLeftTopOffsets(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}}_wrapSVGTextAndBg(a){let{textBgRects:t,textSpans:e}=a;const r=this.getSvgTextDecoration(this);return[t.join(""),'		<text xml:space="preserve" ','font-family="'.concat(this.fontFamily.replace(_m,"'"),'" '),'font-size="'.concat(this.fontSize,'" '),this.fontStyle?'font-style="'.concat(this.fontStyle,'" '):"",this.fontWeight?'font-weight="'.concat(this.fontWeight,'" '):"",r?'text-decoration="'.concat(r,'" '):"",this.direction==="rtl"?'direction="'.concat(this.direction,'" '):"",'style="',this.getSvgStyles(!0),'"',this.addPaintOrder()," >",e.join(""),`</text>
`]}_getSVGTextAndBg(a,t){const e=[],r=[];let s,i=a;this.backgroundColor&&r.push(...no(this.backgroundColor,-this.width/2,-this.height/2,this.width,this.height));for(let n=0,o=this._textLines.length;n<o;n++)s=this._getLineLeftOffset(n),this.direction==="rtl"&&(s+=this.width),(this.textBackgroundColor||this.styleHas("textBackgroundColor",n))&&this._setSVGTextLineBg(r,n,t+s,i),this._setSVGTextLineText(e,n,t+s,i),i+=this.getHeightOfLine(n);return{textSpans:e,textBgRects:r}}_createTextCharSpan(a,t,e,r,s){const i=Wt.NUM_FRACTION_DIGITS,n=this.getSvgSpanStyles(t,a!==a.trim()||!!a.match(vm)),o=n?'style="'.concat(n,'"'):"",l=t.deltaY,c=l?' dy="'.concat(re(l,i),'" '):"",{angle:u,renderLeft:d,renderTop:g,width:f}=s;let m="";if(d!==void 0){const p=f/2;u&&(m=' rotate="'.concat(re(Kr(u),i),'"'));const v=ti({angle:Kr(u)});v[4]=d,v[5]=g;const x=new F(-p,0).transform(v);e=x.x,r=x.y}return'<tspan x="'.concat(re(e,i),'" y="').concat(re(r,i),'" ').concat(c).concat(m).concat(o,">").concat(of(a),"</tspan>")}_setSVGTextLineText(a,t,e,r){const s=this.getHeightOfLine(t),i=this.textAlign.includes(Cr),n=this._textLines[t];let o,l,c,u,d,g="",f=0;r+=s*(1-this._fontSizeFraction)/this.lineHeight;for(let m=0,p=n.length-1;m<=p;m++)d=m===p||this.charSpacing||this.path,g+=n[m],c=this.__charBounds[t][m],f===0?(e+=c.kernedWidth-c.width,f+=c.width):f+=c.kernedWidth,i&&!d&&this._reSpaceAndTab.test(n[m])&&(d=!0),d||(o=o||this.getCompleteStyleDeclaration(t,m),l=this.getCompleteStyleDeclaration(t,m+1),d=Zo(o,l,!0)),d&&(u=this._getStyleDeclaration(t,m),a.push(this._createTextCharSpan(g,u,e,r,c)),g="",o=l,this.direction==="rtl"?e-=f:e+=f,f=0)}_setSVGTextLineBg(a,t,e,r){const s=this._textLines[t],i=this.getHeightOfLine(t)/this.lineHeight;let n,o=0,l=0,c=this.getValueOfPropertyAt(t,0,"textBackgroundColor");for(let u=0;u<s.length;u++){const{left:d,width:g,kernedWidth:f}=this.__charBounds[t][u];n=this.getValueOfPropertyAt(t,u,"textBackgroundColor"),n!==c?(c&&a.push(...no(c,e+l,r,o,i)),l=d,o=g,c=n):o+=f}n&&a.push(...no(c,e+l,r,o,i))}_getSVGLineTopOffset(a){let t,e=0;for(t=0;t<a;t++)e+=this.getHeightOfLine(t);const r=this.getHeightOfLine(t);return{lineTop:e,offset:(this._fontSizeMult-this._fontSizeFraction)*r/(this.lineHeight*this._fontSizeMult)}}getSvgStyles(a){return"".concat(super.getSvgStyles(a)," text-decoration-thickness: ").concat(re(this.textDecorationThickness*this.getObjectScaling().y/10,Wt.NUM_FRACTION_DIGITS),"%; white-space: pre;")}getSvgSpanStyles(a,t){const{fontFamily:e,strokeWidth:r,stroke:s,fill:i,fontSize:n,fontStyle:o,fontWeight:l,deltaY:c,textDecorationThickness:u,linethrough:d,overline:g,underline:f}=a,m=this.getSvgTextDecoration({underline:f??this.underline,overline:g??this.overline,linethrough:d??this.linethrough}),p=u||this.textDecorationThickness;return[s?Si(He,s):"",r?"stroke-width: ".concat(r,"; "):"",e?"font-family: ".concat(e.includes("'")||e.includes('"')?e:"'".concat(e,"'"),"; "):"",n?"font-size: ".concat(n,"px; "):"",o?"font-style: ".concat(o,"; "):"",l?"font-weight: ".concat(l,"; "):"",m?"text-decoration: ".concat(m,"; text-decoration-thickness: ").concat(re(p*this.getObjectScaling().y/10,Wt.NUM_FRACTION_DIGITS),"%; "):"",i?Si(_e,i):"",c?"baseline-shift: ".concat(-c,"; "):"",t?"white-space: pre; ":""].join("")}getSvgTextDecoration(a){return["overline","underline","line-through"].filter((t=>a[t.replace("-","")])).join(" ")}}]),gt.setClass(Ie),gt.setSVGClass(Ie);class xm{constructor(t){S(this,"target",void 0),S(this,"__mouseDownInPlace",!1),S(this,"__dragStartFired",!1),S(this,"__isDraggingOver",!1),S(this,"__dragStartSelection",void 0),S(this,"__dragImageDisposer",void 0),S(this,"_dispose",void 0),this.target=t;const e=[this.target.on("dragenter",this.dragEnterHandler.bind(this)),this.target.on("dragover",this.dragOverHandler.bind(this)),this.target.on("dragleave",this.dragLeaveHandler.bind(this)),this.target.on("dragend",this.dragEndHandler.bind(this)),this.target.on("drop",this.dropHandler.bind(this))];this._dispose=()=>{e.forEach((r=>r())),this._dispose=void 0}}isPointerOverSelection(t){const e=this.target,r=e.getSelectionStartFromPointer(t);return e.isEditing&&r>=e.selectionStart&&r<=e.selectionEnd&&e.selectionStart<e.selectionEnd}start(t){return this.__mouseDownInPlace=this.isPointerOverSelection(t)}isActive(){return this.__mouseDownInPlace}end(t){const e=this.isActive();return e&&!this.__dragStartFired&&(this.target.setCursorByClick(t),this.target.initDelayedCursor(!0)),this.__mouseDownInPlace=!1,this.__dragStartFired=!1,this.__isDraggingOver=!1,e}getDragStartSelection(){return this.__dragStartSelection}setDragImage(t,e){var r;let{selectionStart:s,selectionEnd:i}=e;const n=this.target,o=n.canvas,l=new F(n.flipX?-1:1,n.flipY?-1:1),c=n._getCursorBoundaries(s),u=new F(c.left+c.leftOffset,c.top+c.topOffset).multiply(l).transform(n.calcTransformMatrix()),d=o.getScenePoint(t).subtract(u),g=n.getCanvasRetinaScaling(),f=n.getBoundingRect(),m=u.subtract(new F(f.left,f.top)),p=o.viewportTransform,v=m.add(d).transform(p,!0),x=n.backgroundColor,T=$o(n.styles);n.backgroundColor="";const A={stroke:"transparent",fill:"transparent",textBackgroundColor:"transparent"};n.setSelectionStyles(A,0,s),n.setSelectionStyles(A,i,n.text.length),n.dirty=!0;const O=n.toCanvasElement({enableRetinaScaling:o.enableRetinaScaling,viewportTransform:!0});n.backgroundColor=x,n.styles=T,n.dirty=!0,Co(O,{position:"fixed",left:"".concat(-O.width,"px"),border:We,width:"".concat(O.width/g,"px"),height:"".concat(O.height/g,"px")}),this.__dragImageDisposer&&this.__dragImageDisposer(),this.__dragImageDisposer=()=>{O.remove()},hr(t.target||this.target.hiddenTextarea).body.appendChild(O),(r=t.dataTransfer)===null||r===void 0||r.setDragImage(O,v.x,v.y)}onDragStart(t){this.__dragStartFired=!0;const e=this.target,r=this.isActive();if(r&&t.dataTransfer){const s=this.__dragStartSelection={selectionStart:e.selectionStart,selectionEnd:e.selectionEnd},i=e._text.slice(s.selectionStart,s.selectionEnd).join(""),n=C({text:e.text,value:i},s);t.dataTransfer.setData("text/plain",i),t.dataTransfer.setData("application/fabric",JSON.stringify({value:i,styles:e.getSelectionStyles(s.selectionStart,s.selectionEnd,!0)})),t.dataTransfer.effectAllowed="copyMove",this.setDragImage(t,n)}return e.abortCursorAnimation(),r}canDrop(t){if(this.target.editable&&!this.target.getActiveControl()&&!t.defaultPrevented){if(this.isActive()&&this.__dragStartSelection){const e=this.target.getSelectionStartFromPointer(t),r=this.__dragStartSelection;return e<r.selectionStart||e>r.selectionEnd}return!0}return!1}targetCanDrop(t){return this.target.canDrop(t)}dragEnterHandler(t){let{e}=t;const r=this.targetCanDrop(e);!this.__isDraggingOver&&r&&(this.__isDraggingOver=!0)}dragOverHandler(t){const{e}=t,r=this.targetCanDrop(e);!this.__isDraggingOver&&r?this.__isDraggingOver=!0:this.__isDraggingOver&&!r&&(this.__isDraggingOver=!1),this.__isDraggingOver&&(e.preventDefault(),t.canDrop=!0,t.dropTarget=this.target)}dragLeaveHandler(){(this.__isDraggingOver||this.isActive())&&(this.__isDraggingOver=!1)}dropHandler(t){var e;const{e:r}=t,s=r.defaultPrevented;this.__isDraggingOver=!1,r.preventDefault();let i=(e=r.dataTransfer)===null||e===void 0?void 0:e.getData("text/plain");if(i&&!s){const n=this.target,o=n.canvas;let l=n.getSelectionStartFromPointer(r);const{styles:c}=r.dataTransfer.types.includes("application/fabric")?JSON.parse(r.dataTransfer.getData("application/fabric")):{},u=i[Math.max(0,i.length-1)],d=0;if(this.__dragStartSelection){const g=this.__dragStartSelection.selectionStart,f=this.__dragStartSelection.selectionEnd;l>g&&l<=f?l=g:l>f&&(l-=f-g),n.removeChars(g,f),delete this.__dragStartSelection}n._reNewline.test(u)&&(n._reNewline.test(n._text[l])||l===n._text.length)&&(i=i.trimEnd()),t.didDrop=!0,t.dropTarget=n,n.insertChars(i,c,l),o.setActiveObject(n),n.enterEditing(r),n.selectionStart=Math.min(l+d,n._text.length),n.selectionEnd=Math.min(n.selectionStart+i.length,n._text.length),n.hiddenTextarea.value=n.text,n._updateTextarea(),n.hiddenTextarea.focus(),n.fire(xn,{index:l+d,action:"drop"}),o.fire("text:changed",{target:n}),o.contextTopDirty=!0,o.requestRenderAll()}}dragEndHandler(t){let{e}=t;if(this.isActive()&&this.__dragStartFired&&this.__dragStartSelection){var r;const s=this.target,i=this.target.canvas,{selectionStart:n,selectionEnd:o}=this.__dragStartSelection,l=((r=e.dataTransfer)===null||r===void 0?void 0:r.dropEffect)||We;l===We?(s.selectionStart=n,s.selectionEnd=o,s._updateTextarea(),s.hiddenTextarea.focus()):(s.clearContextTop(),l==="move"&&(s.removeChars(n,o),s.selectionStart=s.selectionEnd=n,s.hiddenTextarea&&(s.hiddenTextarea.value=s.text),s._updateTextarea(),s.fire(xn,{index:n,action:"dragend"}),i.fire("text:changed",{target:s}),i.requestRenderAll()),s.exitEditing())}this.__dragImageDisposer&&this.__dragImageDisposer(),delete this.__dragImageDisposer,delete this.__dragStartSelection,this.__isDraggingOver=!1}dispose(){this._dispose&&this._dispose()}}const rl=/[ \n\.,;!\?\-]/;class wm extends Ie{constructor(){super(...arguments),S(this,"_currentCursorOpacity",1)}initBehavior(){this._tick=this._tick.bind(this),this._onTickComplete=this._onTickComplete.bind(this),this.updateSelectionOnMouseMove=this.updateSelectionOnMouseMove.bind(this)}onDeselect(t){return this.isEditing&&this.exitEditing(),this.selected=!1,super.onDeselect(t)}_animateCursor(t){let{toValue:e,duration:r,delay:s,onComplete:i}=t;return cc({startValue:this._currentCursorOpacity,endValue:e,duration:r,delay:s,onComplete:i,abort:()=>!this.canvas||this.selectionStart!==this.selectionEnd,onChange:n=>{this._currentCursorOpacity=n,this.renderCursorOrSelection()}})}_tick(t){this._currentTickState=this._animateCursor({toValue:0,duration:this.cursorDuration/2,delay:Math.max(t||0,100),onComplete:this._onTickComplete})}_onTickComplete(){var t;(t=this._currentTickCompleteState)===null||t===void 0||t.abort(),this._currentTickCompleteState=this._animateCursor({toValue:1,duration:this.cursorDuration,onComplete:this._tick})}initDelayedCursor(t){this.abortCursorAnimation(),this._tick(t?0:this.cursorDelay)}abortCursorAnimation(){let t=!1;[this._currentTickState,this._currentTickCompleteState].forEach((e=>{e&&!e.isDone()&&(t=!0,e.abort())})),this._currentCursorOpacity=1,t&&this.clearContextTop()}restartCursorIfNeeded(){[this._currentTickState,this._currentTickCompleteState].some((t=>!t||t.isDone()))&&this.initDelayedCursor()}selectAll(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this}cmdAll(){this.selectAll(),this.renderCursorOrSelection()}getSelectedText(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")}findWordBoundaryLeft(t){let e=0,r=t-1;if(this._reSpace.test(this._text[r]))for(;this._reSpace.test(this._text[r]);)e++,r--;for(;/\S/.test(this._text[r])&&r>-1;)e++,r--;return t-e}findWordBoundaryRight(t){let e=0,r=t;if(this._reSpace.test(this._text[r]))for(;this._reSpace.test(this._text[r]);)e++,r++;for(;/\S/.test(this._text[r])&&r<this._text.length;)e++,r++;return t+e}findLineBoundaryLeft(t){let e=0,r=t-1;for(;!/\n/.test(this._text[r])&&r>-1;)e++,r--;return t-e}findLineBoundaryRight(t){let e=0,r=t;for(;!/\n/.test(this._text[r])&&r<this._text.length;)e++,r++;return t+e}searchWordBoundary(t,e){const r=this._text;let s=t>0&&this._reSpace.test(r[t])&&(e===-1||!Bo.test(r[t-1]))?t-1:t,i=r[s];for(;s>0&&s<r.length&&!rl.test(i);)s+=e,i=r[s];return e===-1&&rl.test(i)&&s++,s}selectWord(t){var e;t=(e=t)!==null&&e!==void 0?e:this.selectionStart;const r=this.searchWordBoundary(t,-1),s=Math.max(r,this.searchWordBoundary(t,1));this.selectionStart=r,this.selectionEnd=s,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()}selectLine(t){var e;t=(e=t)!==null&&e!==void 0?e:this.selectionStart;const r=this.findLineBoundaryLeft(t),s=this.findLineBoundaryRight(t);this.selectionStart=r,this.selectionEnd=s,this._fireSelectionChanged(),this._updateTextarea()}enterEditing(t){!this.isEditing&&this.editable&&(this.enterEditingImpl(),this.fire("editing:entered",t?{e:t}:void 0),this._fireSelectionChanged(),this.canvas&&(this.canvas.fire("text:editing:entered",{target:this,e:t}),this.canvas.requestRenderAll()))}enterEditingImpl(){this.canvas&&(this.canvas.calcOffset(),this.canvas.textEditingManager.exitTextEditing()),this.isEditing=!0,this.initHiddenTextarea(),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick()}updateSelectionOnMouseMove(t){if(this.getActiveControl())return;const e=this.hiddenTextarea;hr(e).activeElement!==e&&e.focus();const r=this.getSelectionStartFromPointer(t),s=this.selectionStart,i=this.selectionEnd;(r===this.__selectionStartOnMouseDown&&s!==i||s!==r&&i!==r)&&(r>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=r):(this.selectionStart=r,this.selectionEnd=this.__selectionStartOnMouseDown),this.selectionStart===s&&this.selectionEnd===i||(this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()))}_setEditingProps(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0}fromStringToGraphemeSelection(t,e,r){const s=r.slice(0,t),i=this.graphemeSplit(s).length;if(t===e)return{selectionStart:i,selectionEnd:i};const n=r.slice(t,e);return{selectionStart:i,selectionEnd:i+this.graphemeSplit(n).length}}fromGraphemeToStringSelection(t,e,r){const s=r.slice(0,t).join("").length;return t===e?{selectionStart:s,selectionEnd:s}:{selectionStart:s,selectionEnd:s+r.slice(t,e).join("").length}}_updateTextarea(){if(this.cursorOffsetCache={},this.hiddenTextarea){if(!this.inCompositionMode){const t=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=t.selectionStart,this.hiddenTextarea.selectionEnd=t.selectionEnd}this.updateTextareaPosition()}}updateFromTextArea(){if(!this.hiddenTextarea)return;this.cursorOffsetCache={};const t=this.hiddenTextarea;this.text=t.value,this.set("dirty",!0),this.initDimensions(),this.setCoords();const e=this.fromStringToGraphemeSelection(t.selectionStart,t.selectionEnd,t.value);this.selectionEnd=this.selectionStart=e.selectionEnd,this.inCompositionMode||(this.selectionStart=e.selectionStart),this.updateTextareaPosition()}updateTextareaPosition(){if(this.selectionStart===this.selectionEnd){const t=this._calcTextareaPosition();this.hiddenTextarea.style.left=t.left,this.hiddenTextarea.style.top=t.top}}_calcTextareaPosition(){if(!this.canvas)return{left:"1px",top:"1px"};const t=this.inCompositionMode?this.compositionStart:this.selectionStart,e=this._getCursorBoundaries(t),r=this.get2DCursorLocation(t),s=r.lineIndex,i=r.charIndex,n=this.getValueOfPropertyAt(s,i,"fontSize")*this.lineHeight,o=e.leftOffset,l=this.getCanvasRetinaScaling(),c=this.canvas.upperCanvasEl,u=c.width/l,d=c.height/l,g=u-n,f=d-n,m=new F(e.left+o,e.top+e.topOffset+n).transform(this.calcTransformMatrix()).transform(this.canvas.viewportTransform).multiply(new F(c.clientWidth/u,c.clientHeight/d));return m.x<0&&(m.x=0),m.x>g&&(m.x=g),m.y<0&&(m.y=0),m.y>f&&(m.y=f),m.x+=this.canvas._offset.left,m.y+=this.canvas._offset.top,{left:"".concat(m.x,"px"),top:"".concat(m.y,"px"),fontSize:"".concat(n,"px"),charHeight:n}}_saveEditingProps(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}}_restoreEditingProps(){this._savedProps&&(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor||this.canvas.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor||this.canvas.moveCursor),delete this._savedProps)}_exitEditing(){const t=this.hiddenTextarea;this.selected=!1,this.isEditing=!1,t&&(t.blur&&t.blur(),t.parentNode&&t.parentNode.removeChild(t)),this.hiddenTextarea=null,this.abortCursorAnimation(),this.selectionStart!==this.selectionEnd&&this.clearContextTop()}exitEditingImpl(){this._exitEditing(),this.selectionEnd=this.selectionStart,this._restoreEditingProps(),this._forceClearCache&&(this.initDimensions(),this.setCoords())}exitEditing(){const t=this._textBeforeEdit!==this.text;return this.exitEditingImpl(),this.fire("editing:exited"),t&&this.fire(wn),this.canvas&&(this.canvas.fire("text:editing:exited",{target:this}),t&&this.canvas.fire("object:modified",{target:this})),this}_removeExtraneousStyles(){for(const t in this.styles)this._textLines[t]||delete this.styles[t]}removeStyleFromTo(t,e){const{lineIndex:r,charIndex:s}=this.get2DCursorLocation(t,!0),{lineIndex:i,charIndex:n}=this.get2DCursorLocation(e,!0);if(r!==i){if(this.styles[r])for(let o=s;o<this._unwrappedTextLines[r].length;o++)delete this.styles[r][o];if(this.styles[i])for(let o=n;o<this._unwrappedTextLines[i].length;o++){const l=this.styles[i][o];l&&(this.styles[r]||(this.styles[r]={}),this.styles[r][s+o-n]=l)}for(let o=r+1;o<=i;o++)delete this.styles[o];this.shiftLineStyles(i,r-i)}else if(this.styles[r]){const o=this.styles[r],l=n-s;for(let c=s;c<n;c++)delete o[c];for(const c in this.styles[r]){const u=parseInt(c,10);u>=n&&(o[u-l]=o[c],delete o[c])}}}shiftLineStyles(t,e){const r=Object.assign({},this.styles);for(const s in this.styles){const i=parseInt(s,10);i>t&&(this.styles[i+e]=r[i],r[i-e]||delete this.styles[i])}}insertNewlineStyleObject(t,e,r,s){const i={},n=this._unwrappedTextLines[t].length,o=n===e;let l=!1;r||(r=1),this.shiftLineStyles(t,r);const c=this.styles[t]?this.styles[t][e===0?e:e-1]:void 0;for(const d in this.styles[t]){const g=parseInt(d,10);g>=e&&(l=!0,i[g-e]=this.styles[t][d],o&&e===0||delete this.styles[t][d])}let u=!1;for(l&&!o&&(this.styles[t+r]=i,u=!0),(u||n>e)&&r--;r>0;)s&&s[r-1]?this.styles[t+r]={0:C({},s[r-1])}:c?this.styles[t+r]={0:C({},c)}:delete this.styles[t+r],r--;this._forceClearCache=!0}insertCharStyleObject(t,e,r,s){this.styles||(this.styles={});const i=this.styles[t],n=i?C({},i):{};r||(r=1);for(const l in n){const c=parseInt(l,10);c>=e&&(i[c+r]=n[c],n[c-r]||delete i[c])}if(this._forceClearCache=!0,s){for(;r--;)Object.keys(s[r]).length&&(this.styles[t]||(this.styles[t]={}),this.styles[t][e+r]=C({},s[r]));return}if(!i)return;const o=i[e?e-1:1];for(;o&&r--;)this.styles[t][e+r]=C({},o)}insertNewStyleBlock(t,e,r){const s=this.get2DCursorLocation(e,!0),i=[0];let n,o=0;for(let l=0;l<t.length;l++)t[l]===`
`?(o++,i[o]=0):i[o]++;for(i[0]>0&&(this.insertCharStyleObject(s.lineIndex,s.charIndex,i[0],r),r=r&&r.slice(i[0]+1)),o&&this.insertNewlineStyleObject(s.lineIndex,s.charIndex+i[0],o),n=1;n<o;n++)i[n]>0?this.insertCharStyleObject(s.lineIndex+n,0,i[n],r):r&&this.styles[s.lineIndex+n]&&r[0]&&(this.styles[s.lineIndex+n][0]=r[0]),r=r&&r.slice(i[n]+1);i[n]>0&&this.insertCharStyleObject(s.lineIndex+n,0,i[n],r)}removeChars(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:t+1;this.removeStyleFromTo(t,e),this._text.splice(t,e-t),this.text=this._text.join(""),this.set("dirty",!0),this.initDimensions(),this.setCoords(),this._removeExtraneousStyles()}insertChars(t,e,r){let s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:r;s>r&&this.removeStyleFromTo(r,s);const i=this.graphemeSplit(t);this.insertNewStyleBlock(i,r,e),this._text=[...this._text.slice(0,r),...i,...this._text.slice(s)],this.text=this._text.join(""),this.set("dirty",!0),this.initDimensions(),this.setCoords(),this._removeExtraneousStyles()}setSelectionStartEndWithShift(t,e,r){r<=t?(e===t?this._selectionDirection=$t:this._selectionDirection===de&&(this._selectionDirection=$t,this.selectionEnd=t),this.selectionStart=r):r>t&&r<e?this._selectionDirection===de?this.selectionEnd=r:this.selectionStart=r:(e===t?this._selectionDirection=de:this._selectionDirection===$t&&(this._selectionDirection=de,this.selectionStart=e),this.selectionEnd=r)}}class bm extends wm{initHiddenTextarea(){const t=this.canvas&&hr(this.canvas.getElement())||Zs(),e=t.createElement("textarea");Object.entries({autocapitalize:"off",autocorrect:"off",autocomplete:"off",spellcheck:"false","data-fabric":"textarea",wrap:"off",name:"fabricTextarea"}).map((n=>{let[o,l]=n;return e.setAttribute(o,l)}));const{top:r,left:s,fontSize:i}=this._calcTextareaPosition();e.style.cssText="position: absolute; top: ".concat(r,"; left: ").concat(s,"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; padding-top: ").concat(i,";"),(this.hiddenTextareaContainer||t.body).appendChild(e),Object.entries({blur:"blur",keydown:"onKeyDown",keyup:"onKeyUp",input:"onInput",copy:"copy",cut:"copy",paste:"paste",compositionstart:"onCompositionStart",compositionupdate:"onCompositionUpdate",compositionend:"onCompositionEnd"}).map((n=>{let[o,l]=n;return e.addEventListener(o,this[l].bind(this))})),this.hiddenTextarea=e}blur(){this.abortCursorAnimation()}onKeyDown(t){if(!this.isEditing)return;const e=this.direction==="rtl"?this.keysMapRtl:this.keysMap;if(t.keyCode in e)this[e[t.keyCode]](t);else{if(!(t.keyCode in this.ctrlKeysMapDown)||!t.ctrlKey&&!t.metaKey)return;this[this.ctrlKeysMapDown[t.keyCode]](t)}t.stopImmediatePropagation(),t.preventDefault(),t.keyCode>=33&&t.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}onKeyUp(t){!this.isEditing||this._copyDone||this.inCompositionMode?this._copyDone=!1:t.keyCode in this.ctrlKeysMapUp&&(t.ctrlKey||t.metaKey)&&(this[this.ctrlKeysMapUp[t.keyCode]](t),t.stopImmediatePropagation(),t.preventDefault(),this.canvas&&this.canvas.requestRenderAll())}onInput(t){const e=this.fromPaste,{value:r,selectionStart:s,selectionEnd:i}=this.hiddenTextarea;if(this.fromPaste=!1,t&&t.stopPropagation(),!this.isEditing)return;const n=()=>{this.updateFromTextArea(),this.fire(xn),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())};if(this.hiddenTextarea.value==="")return this.styles={},void n();const o=this._splitTextIntoLines(r).graphemeText,l=this._text.length,c=o.length,u=this.selectionStart,d=this.selectionEnd,g=u!==d;let f,m,p,v,x=c-l;const T=this.fromStringToGraphemeSelection(s,i,r),A=u>T.selectionStart;g?(m=this._text.slice(u,d),x+=d-u):c<l&&(m=A?this._text.slice(d+x,d):this._text.slice(u,u-x));const O=o.slice(T.selectionEnd-x,T.selectionEnd);if(m&&m.length&&(O.length&&(f=this.getSelectionStyles(u,u+1,!1),f=O.map((()=>f[0]))),g?(p=u,v=d):A?(p=d-m.length,v=d):(p=d,v=d+m.length),this.removeStyleFromTo(p,v)),O.length){const{copyPasteData:P}=Ar();e&&O.join("")===P.copiedText&&!Wt.disableStyleCopyPaste&&(f=P.copiedTextStyle),this.insertNewStyleBlock(O,u,f)}n()}onCompositionStart(){this.inCompositionMode=!0}onCompositionEnd(){this.inCompositionMode=!1}onCompositionUpdate(t){let{target:e}=t;const{selectionStart:r,selectionEnd:s}=e;this.compositionStart=r,this.compositionEnd=s,this.updateTextareaPosition()}copy(){if(this.selectionStart===this.selectionEnd)return;const{copyPasteData:t}=Ar();t.copiedText=this.getSelectedText(),Wt.disableStyleCopyPaste?t.copiedTextStyle=void 0:t.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0}paste(){this.fromPaste=!0}_getWidthBeforeCursor(t,e){let r,s=this._getLineLeftOffset(t);return e>0&&(r=this.__charBounds[t][e-1],s+=r.left+r.width),s}getDownCursorOffset(t,e){const r=this._getSelectionForOffset(t,e),s=this.get2DCursorLocation(r),i=s.lineIndex;if(i===this._textLines.length-1||t.metaKey||t.keyCode===34)return this._text.length-r;const n=s.charIndex,o=this._getWidthBeforeCursor(i,n),l=this._getIndexOnLine(i+1,o);return this._textLines[i].slice(n).length+l+1+this.missingNewlineOffset(i)}_getSelectionForOffset(t,e){return t.shiftKey&&this.selectionStart!==this.selectionEnd&&e?this.selectionEnd:this.selectionStart}getUpCursorOffset(t,e){const r=this._getSelectionForOffset(t,e),s=this.get2DCursorLocation(r),i=s.lineIndex;if(i===0||t.metaKey||t.keyCode===33)return-r;const n=s.charIndex,o=this._getWidthBeforeCursor(i,n),l=this._getIndexOnLine(i-1,o),c=this._textLines[i].slice(0,n),u=this.missingNewlineOffset(i-1);return-this._textLines[i-1].length+l-c.length+(1-u)}_getIndexOnLine(t,e){const r=this._textLines[t];let s,i,n=this._getLineLeftOffset(t),o=0;for(let l=0,c=r.length;l<c;l++)if(s=this.__charBounds[t][l].width,n+=s,n>e){i=!0;const u=n-s,d=n,g=Math.abs(u-e);o=Math.abs(d-e)<g?l:l-1;break}return i||(o=r.length-1),o}moveCursorDown(t){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",t)}moveCursorUp(t){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorUpOrDown("Up",t)}_moveCursorUpOrDown(t,e){const r=this["get".concat(t,"CursorOffset")](e,this._selectionDirection===de);if(e.shiftKey?this.moveCursorWithShift(r):this.moveCursorWithoutShift(r),r!==0){const s=this.text.length;this.selectionStart=Ks(0,this.selectionStart,s),this.selectionEnd=Ks(0,this.selectionEnd,s),this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea()}}moveCursorWithShift(t){const e=this._selectionDirection===$t?this.selectionStart+t:this.selectionEnd+t;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,e),t!==0}moveCursorWithoutShift(t){return t<0?(this.selectionStart+=t,this.selectionEnd=this.selectionStart):(this.selectionEnd+=t,this.selectionStart=this.selectionEnd),t!==0}moveCursorLeft(t){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorLeftOrRight("Left",t)}_move(t,e,r){let s;if(t.altKey)s=this["findWordBoundary".concat(r)](this[e]);else{if(!t.metaKey&&t.keyCode!==35&&t.keyCode!==36)return this[e]+=r==="Left"?-1:1,!0;s=this["findLineBoundary".concat(r)](this[e])}return s!==void 0&&this[e]!==s&&(this[e]=s,!0)}_moveLeft(t,e){return this._move(t,e,"Left")}_moveRight(t,e){return this._move(t,e,"Right")}moveCursorLeftWithoutShift(t){let e=!0;return this._selectionDirection=$t,this.selectionEnd===this.selectionStart&&this.selectionStart!==0&&(e=this._moveLeft(t,"selectionStart")),this.selectionEnd=this.selectionStart,e}moveCursorLeftWithShift(t){return this._selectionDirection===de&&this.selectionStart!==this.selectionEnd?this._moveLeft(t,"selectionEnd"):this.selectionStart!==0?(this._selectionDirection=$t,this._moveLeft(t,"selectionStart")):void 0}moveCursorRight(t){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",t)}_moveCursorLeftOrRight(t,e){const r="moveCursor".concat(t).concat(e.shiftKey?"WithShift":"WithoutShift");this._currentCursorOpacity=1,this[r](e)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())}moveCursorRightWithShift(t){return this._selectionDirection===$t&&this.selectionStart!==this.selectionEnd?this._moveRight(t,"selectionStart"):this.selectionEnd!==this._text.length?(this._selectionDirection=de,this._moveRight(t,"selectionEnd")):void 0}moveCursorRightWithoutShift(t){let e=!0;return this._selectionDirection=de,this.selectionStart===this.selectionEnd?(e=this._moveRight(t,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,e}}const sl=a=>!!a.button;class Sm extends bm{constructor(){super(...arguments),S(this,"draggableTextDelegate",void 0)}initBehavior(){this.on("mousedown",this._mouseDownHandler),this.on("mouseup",this.mouseUpHandler),this.on("mousedblclick",this.doubleClickHandler),this.on("mousetripleclick",this.tripleClickHandler),this.draggableTextDelegate=new xm(this),super.initBehavior()}shouldStartDragging(){return this.draggableTextDelegate.isActive()}onDragStart(t){return this.draggableTextDelegate.onDragStart(t)}canDrop(t){return this.draggableTextDelegate.canDrop(t)}doubleClickHandler(t){this.isEditing&&(this.selectWord(this.getSelectionStartFromPointer(t.e)),this.renderCursorOrSelection())}tripleClickHandler(t){this.isEditing&&(this.selectLine(this.getSelectionStartFromPointer(t.e)),this.renderCursorOrSelection())}_mouseDownHandler(t){let{e,alreadySelected:r}=t;this.canvas&&this.editable&&!sl(e)&&!this.getActiveControl()&&(this.draggableTextDelegate.start(e)||(this.canvas.textEditingManager.register(this),r&&(this.inCompositionMode=!1,this.setCursorByClick(e)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()),this.selected||(this.selected=r||this.isEditing)))}mouseUpHandler(t){let{e,transform:r}=t;const s=this.draggableTextDelegate.end(e);if(this.canvas){this.canvas.textEditingManager.unregister(this);const i=this.canvas._activeObject;if(i&&i!==this)return}!this.editable||this.group&&!this.group.interactive||r&&r.actionPerformed||sl(e)||s||this.selected&&!this.getActiveControl()&&(this.enterEditing(e),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection())}setCursorByClick(t){const e=this.getSelectionStartFromPointer(t),r=this.selectionStart,s=this.selectionEnd;t.shiftKey?this.setSelectionStartEndWithShift(r,s,e):(this.selectionStart=e,this.selectionEnd=e),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())}getSelectionStartFromPointer(t){const e=this.canvas.getScenePoint(t).transform(ur(this.calcTransformMatrix())).add(new F(-this._getLeftOffset(),-this._getTopOffset()));let r=0,s=0,i=0;for(let c=0;c<this._textLines.length&&r<=e.y;c++)r+=this.getHeightOfLine(c),i=c,c>0&&(s+=this._textLines[c-1].length+this.missingNewlineOffset(c-1));let n=Math.abs(this._getLineLeftOffset(i));const o=this._textLines[i].length,l=this.__charBounds[i];for(let c=0;c<o;c++){const u=n+l[c].kernedWidth;if(e.x<=u){Math.abs(e.x-u)<=Math.abs(e.x-n)&&s++;break}n=u,s++}return Math.min(this.flipX?o-s:s,this._text.length)}}const Ri="moveCursorUp",Bi="moveCursorDown",zi="moveCursorLeft",Vi="moveCursorRight",Wi="exitEditing",il=(a,t)=>{const e=t.getRetinaScaling();a.setTransform(e,0,0,e,0,0);const r=t.viewportTransform;a.transform(r[0],r[1],r[2],r[3],r[4],r[5])},Cm=C({selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,hiddenTextareaContainer:null,keysMap:{9:Wi,27:Wi,33:Ri,34:Bi,35:Vi,36:zi,37:zi,38:Ri,39:Vi,40:Bi},keysMapRtl:{9:Wi,27:Wi,33:Ri,34:Bi,35:zi,36:Vi,37:Vi,38:Ri,39:zi,40:Bi},ctrlKeysMapDown:{65:"cmdAll"},ctrlKeysMapUp:{67:"copy",88:"cut"}},{_selectionDirection:null,_reSpace:/\s|\r?\n/,inCompositionMode:!1});class Xr extends Sm{static getDefaults(){return C(C({},super.getDefaults()),Xr.ownDefaults)}get type(){const t=super.type;return t==="itext"?"i-text":t}constructor(t,e){super(t,C(C({},Xr.ownDefaults),e)),this.initBehavior()}_set(t,e){return this.isEditing&&this._savedProps&&t in this._savedProps?(this._savedProps[t]=e,this):(t==="canvas"&&(this.canvas instanceof To&&this.canvas.textEditingManager.remove(this),e instanceof To&&e.textEditingManager.add(this)),super._set(t,e))}setSelectionStart(t){t=Math.max(t,0),this._updateAndFire("selectionStart",t)}setSelectionEnd(t){t=Math.min(t,this.text.length),this._updateAndFire("selectionEnd",t)}_updateAndFire(t,e){this[t]!==e&&(this._fireSelectionChanged(),this[t]=e),this._updateTextarea()}_fireSelectionChanged(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})}initDimensions(){this.isEditing&&this.initDelayedCursor(),super.initDimensions()}getSelectionStyles(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.selectionStart||0,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.selectionEnd,r=arguments.length>2?arguments[2]:void 0;return super.getSelectionStyles(t,e,r)}setSelectionStyles(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.selectionStart||0,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.selectionEnd;return super.setSelectionStyles(t,e,r)}get2DCursorLocation(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.selectionStart,e=arguments.length>1?arguments[1]:void 0;return super.get2DCursorLocation(t,e)}render(t){super.render(t),this.cursorOffsetCache={},this.renderCursorOrSelection()}toCanvasElement(t){const e=this.isEditing;this.isEditing=!1;const r=super.toCanvasElement(t);return this.isEditing=e,r}renderCursorOrSelection(){if(!this.isEditing||!this.canvas)return;const t=this.clearContextTop(!0);if(!t)return;const e=this._getCursorBoundaries(),r=this.findAncestorsWithClipPath(),s=r.length>0;let i,n=t;if(s){i=sr(t.canvas),n=i.getContext("2d"),il(n,this.canvas);const o=this.calcTransformMatrix();n.transform(o[0],o[1],o[2],o[3],o[4],o[5])}if(this.selectionStart!==this.selectionEnd||this.inCompositionMode?this.renderSelection(n,e):this.renderCursor(n,e),s)for(const o of r){const l=o.clipPath,c=sr(t.canvas),u=c.getContext("2d");if(il(u,this.canvas),!l.absolutePositioned){const d=o.calcTransformMatrix();u.transform(d[0],d[1],d[2],d[3],d[4],d[5])}l.transform(u),l.drawObject(u,!0,{}),this.drawClipPathOnCache(n,l,c)}s&&(t.setTransform(1,0,0,1,0,0),t.drawImage(i,0,0)),this.canvas.contextTopDirty=!0,t.restore()}findAncestorsWithClipPath(){const t=[];let e=this;for(;e;)e.clipPath&&t.push(e),e=e.parent;return t}_getCursorBoundaries(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.selectionStart,e=arguments.length>1?arguments[1]:void 0;const r=this._getLeftOffset(),s=this._getTopOffset(),i=this._getCursorBoundariesOffsets(t,e);return{left:r,top:s,leftOffset:i.left,topOffset:i.top}}_getCursorBoundariesOffsets(t,e){return e?this.__getCursorBoundariesOffsets(t):this.cursorOffsetCache&&"top"in this.cursorOffsetCache?this.cursorOffsetCache:this.cursorOffsetCache=this.__getCursorBoundariesOffsets(t)}__getCursorBoundariesOffsets(t){let e=0,r=0;const{charIndex:s,lineIndex:i}=this.get2DCursorLocation(t);for(let c=0;c<i;c++)e+=this.getHeightOfLine(c);const n=this._getLineLeftOffset(i),o=this.__charBounds[i][s];o&&(r=o.left),this.charSpacing!==0&&s===this._textLines[i].length&&(r-=this._getWidthOfCharSpacing());const l={top:e,left:n+(r>0?r:0)};return this.direction==="rtl"&&(this.textAlign===de||this.textAlign===Cr||this.textAlign===fi?l.left*=-1:this.textAlign===$t||this.textAlign===On?l.left=n-(r>0?r:0):this.textAlign!==Bt&&this.textAlign!==mi||(l.left=n-(r>0?r:0))),l}renderCursorAt(t){this._renderCursor(this.canvas.contextTop,this._getCursorBoundaries(t,!0),t)}renderCursor(t,e){this._renderCursor(t,e,this.selectionStart)}getCursorRenderingData(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.selectionStart,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this._getCursorBoundaries(t);const r=this.get2DCursorLocation(t),s=r.lineIndex,i=r.charIndex>0?r.charIndex-1:0,n=this.getValueOfPropertyAt(s,i,"fontSize"),o=this.getObjectScaling().x*this.canvas.getZoom(),l=this.cursorWidth/o,c=this.getValueOfPropertyAt(s,i,"deltaY"),u=e.topOffset+(1-this._fontSizeFraction)*this.getHeightOfLine(s)/this.lineHeight-n*(1-this._fontSizeFraction);return{color:this.cursorColor||this.getValueOfPropertyAt(s,i,"fill"),opacity:this._currentCursorOpacity,left:e.left+e.leftOffset-l/2,top:u+e.top+c,width:l,height:n}}_renderCursor(t,e,r){const{color:s,opacity:i,left:n,top:o,width:l,height:c}=this.getCursorRenderingData(r,e);t.fillStyle=s,t.globalAlpha=i,t.fillRect(n,o,l,c)}renderSelection(t,e){const r={selectionStart:this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,selectionEnd:this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd};this._renderSelection(t,r,e)}renderDragSourceEffect(){const t=this.draggableTextDelegate.getDragStartSelection();this._renderSelection(this.canvas.contextTop,t,this._getCursorBoundaries(t.selectionStart,!0))}renderDropTargetEffect(t){const e=this.getSelectionStartFromPointer(t);this.renderCursorAt(e)}_renderSelection(t,e,r){const s=e.selectionStart,i=e.selectionEnd,n=this.textAlign.includes(Cr),o=this.get2DCursorLocation(s),l=this.get2DCursorLocation(i),c=o.lineIndex,u=l.lineIndex,d=o.charIndex<0?0:o.charIndex,g=l.charIndex<0?0:l.charIndex;for(let f=c;f<=u;f++){const m=this._getLineLeftOffset(f)||0;let p=this.getHeightOfLine(f),v=0,x=0,T=0;if(f===c&&(x=this.__charBounds[c][d].left),f>=c&&f<u)T=n&&!this.isEndOfWrapping(f)?this.width:this.getLineWidth(f)||5;else if(f===u)if(g===0)T=this.__charBounds[u][g].left;else{const E=this._getWidthOfCharSpacing();T=this.__charBounds[u][g-1].left+this.__charBounds[u][g-1].width-E}v=p,(this.lineHeight<1||f===u&&this.lineHeight>1)&&(p/=this.lineHeight);let A=r.left+m+x,O=p,P=0;const L=T-x;this.inCompositionMode?(t.fillStyle=this.compositionColor||"black",O=1,P=p):t.fillStyle=this.selectionColor,this.direction==="rtl"&&(this.textAlign===de||this.textAlign===Cr||this.textAlign===fi?A=this.width-A-L:this.textAlign===$t||this.textAlign===On?A=r.left+m-T:this.textAlign!==Bt&&this.textAlign!==mi||(A=r.left+m-T)),t.fillRect(A,r.top+r.topOffset+P,L,O),r.topOffset+=v}}getCurrentCharFontSize(){const t=this._getCurrentCharIndex();return this.getValueOfPropertyAt(t.l,t.c,"fontSize")}getCurrentCharColor(){const t=this._getCurrentCharIndex();return this.getValueOfPropertyAt(t.l,t.c,_e)}_getCurrentCharIndex(){const t=this.get2DCursorLocation(this.selectionStart,!0),e=t.charIndex>0?t.charIndex-1:0;return{l:t.lineIndex,c:e}}dispose(){this.exitEditingImpl(),this.draggableTextDelegate.dispose(),super.dispose()}}S(Xr,"ownDefaults",Cm),S(Xr,"type","IText"),gt.setClass(Xr),gt.setClass(Xr,"i-text");class Ss extends Xr{static getDefaults(){return C(C({},super.getDefaults()),Ss.ownDefaults)}constructor(t,e){super(t,C(C({},Ss.ownDefaults),e))}static createControls(){return{controls:ef()}}initDimensions(){this.initialized&&(this.isEditing&&this.initDelayedCursor(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),this.textAlign.includes(Cr)&&this.enlargeSpaces(),this.height=this.calcTextHeight())}_generateStyleMap(t){let e=0,r=0,s=0;const i={};for(let n=0;n<t.graphemeLines.length;n++)t.graphemeText[s]===`
`&&n>0?(r=0,s++,e++):!this.splitByGrapheme&&this._reSpaceAndTab.test(t.graphemeText[s])&&n>0&&(r++,s++),i[n]={line:e,offset:r},s+=t.graphemeLines[n].length,r+=t.graphemeLines[n].length;return i}styleHas(t,e){if(this._styleMap&&!this.isWrapping){const r=this._styleMap[e];r&&(e=r.line)}return super.styleHas(t,e)}isEmptyStyles(t){if(!this.styles)return!0;let e,r=0,s=t+1,i=!1;const n=this._styleMap[t],o=this._styleMap[t+1];n&&(t=n.line,r=n.offset),o&&(s=o.line,i=s===t,e=o.offset);const l=t===void 0?this.styles:{line:this.styles[t]};for(const c in l)for(const u in l[c]){const d=parseInt(u,10);if(d>=r&&(!i||d<e))for(const g in l[c][u])return!1}return!0}_getStyleDeclaration(t,e){if(this._styleMap&&!this.isWrapping){const r=this._styleMap[t];if(!r)return{};t=r.line,e=r.offset+e}return super._getStyleDeclaration(t,e)}_setStyleDeclaration(t,e,r){const s=this._styleMap[t];super._setStyleDeclaration(s.line,s.offset+e,r)}_deleteStyleDeclaration(t,e){const r=this._styleMap[t];super._deleteStyleDeclaration(r.line,r.offset+e)}_getLineStyle(t){const e=this._styleMap[t];return!!this.styles[e.line]}_setLineStyle(t){const e=this._styleMap[t];super._setLineStyle(e.line)}_wrapText(t,e){this.isWrapping=!0;const r=this.getGraphemeDataForRender(t),s=[];for(let i=0;i<r.wordsData.length;i++)s.push(...this._wrapLine(i,e,r));return this.isWrapping=!1,s}getGraphemeDataForRender(t){const e=this.splitByGrapheme,r=e?"":" ";let s=0;return{wordsData:t.map(((i,n)=>{let o=0;const l=e?this.graphemeSplit(i):this.wordSplit(i);return l.length===0?[{word:[],width:0}]:l.map((c=>{const u=e?[c]:this.graphemeSplit(c),d=this._measureWord(u,n,o);return s=Math.max(d,s),o+=u.length+r.length,{word:u,width:d}}))})),largestWordWidth:s}}_measureWord(t,e){let r,s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,i=0;for(let n=0,o=t.length;n<o;n++)i+=this._getGraphemeBox(t[n],e,n+s,r,!0).kernedWidth,r=t[n];return i}wordSplit(t){return t.split(this._wordJoiners)}_wrapLine(t,e,r){let{largestWordWidth:s,wordsData:i}=r,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:0;const o=this._getWidthOfCharSpacing(),l=this.splitByGrapheme,c=[],u=l?"":" ";let d=0,g=[],f=0,m=0,p=!0;e-=n;const v=Math.max(e,s,this.dynamicMinWidth),x=i[t];let T;for(f=0,T=0;T<x.length;T++){const{word:A,width:O}=x[T];f+=A.length,d+=m+O-o,d>v&&!p?(c.push(g),g=[],d=O,p=!0):d+=o,p||l||g.push(u),g=g.concat(A),m=l?0:this._measureWord([u],t,f),f++,p=!1}return T&&c.push(g),s+n>this.dynamicMinWidth&&(this.dynamicMinWidth=s-o+n),c}isEndOfWrapping(t){return!this._styleMap[t+1]||this._styleMap[t+1].line!==this._styleMap[t].line}missingNewlineOffset(t,e){return this.splitByGrapheme&&!e?this.isEndOfWrapping(t)?1:0:1}_splitTextIntoLines(t){const e=super._splitTextIntoLines(t),r=this._wrapText(e.lines,this.width),s=new Array(r.length);for(let i=0;i<r.length;i++)s[i]=r[i].join("");return e.lines=s,e.graphemeLines=r,e}getMinWidth(){return Math.max(this.minWidth,this.dynamicMinWidth)}_removeExtraneousStyles(){const t=new Map;for(const e in this._styleMap){const r=parseInt(e,10);if(this._textLines[r]){const s=this._styleMap[e].line;t.set("".concat(s),!0)}}for(const e in this.styles)t.has(e)||delete this.styles[e]}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return super.toObject(["minWidth","splitByGrapheme",...t])}}S(Ss,"type","Textbox"),S(Ss,"textLayoutProperties",[...Xr.textLayoutProperties,"width"]),S(Ss,"ownDefaults",{minWidth:20,dynamicMinWidth:2,lockScalingFlip:!0,noScaleCache:!1,_wordJoiners:/[ \t\r]/,splitByGrapheme:!1}),gt.setClass(Ss);class nl extends Yn{shouldPerformLayout(t){return!!t.target.clipPath&&super.shouldPerformLayout(t)}shouldLayoutClipPath(){return!1}calcLayoutResult(t,e){const{target:r}=t,{clipPath:s,group:i}=r;if(!s||!this.shouldPerformLayout(t))return;const{width:n,height:o}=Nr(vc(r,s)),l=new F(n,o);if(s.absolutePositioned)return{center:Ns(s.getRelativeCenterPoint(),void 0,i?i.calcTransformMatrix():void 0),size:l};{const c=s.getRelativeCenterPoint().transform(r.calcOwnMatrix(),!0);if(this.shouldPerformLayout(t)){const{center:u=new F,correction:d=new F}=this.calcBoundingBox(e,t)||{};return{center:u.add(c),correction:d.subtract(c),size:l}}return{center:r.getRelativeCenterPoint().add(c),size:l}}}}S(nl,"type","clip-path"),gt.setClass(nl);class ol extends Yn{getInitialSize(t,e){let{target:r}=t,{size:s}=e;return new F(r.width||s.x,r.height||s.y)}}S(ol,"type","fixed"),gt.setClass(ol);class Tm extends Ci{subscribeTargets(t){const e=t.target;t.targets.reduce(((r,s)=>(s.parent&&r.add(s.parent),r)),new Set).forEach((r=>{r.layoutManager.subscribeTargets({target:r,targets:[e]})}))}unsubscribeTargets(t){const e=t.target,r=e.getObjects();t.targets.reduce(((s,i)=>(i.parent&&s.add(i.parent),s)),new Set).forEach((s=>{!r.some((i=>i.parent===s))&&s.layoutManager.unsubscribeTargets({target:s,targets:[e]})}))}}class Cs extends As{static getDefaults(){return C(C({},super.getDefaults()),Cs.ownDefaults)}constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),Object.assign(this,Cs.ownDefaults),this.setOptions(e);const{left:r,top:s,layoutManager:i}=e;this.groupInit(t,{left:r,top:s,layoutManager:i??new Tm})}_shouldSetNestedCoords(){return!0}__objectSelectionMonitor(){}multiSelectAdd(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];this.multiSelectionStacking==="selection-order"?this.add(...e):e.forEach((s=>{const i=this._objects.findIndex((o=>o.isInFrontOf(s))),n=i===-1?this.size():i;this.insertAt(n,s)}))}canEnterGroup(t){return this.getObjects().some((e=>e.isDescendantOf(t)||t.isDescendantOf(e)))?(gs("error","ActiveSelection: circular object trees are not supported, this call has no effect"),!1):super.canEnterGroup(t)}enterGroup(t,e){t.parent&&t.parent===t.group?t.parent._exitGroup(t):t.group&&t.parent!==t.group&&t.group.remove(t),this._enterGroup(t,e)}exitGroup(t,e){this._exitGroup(t,e),t.parent&&t.parent._enterGroup(t,!0)}_onAfterObjectsChange(t,e){super._onAfterObjectsChange(t,e);const r=new Set;e.forEach((s=>{const{parent:i}=s;i&&r.add(i)})),t===Qo?r.forEach((s=>{s._onAfterObjectsChange(An,e)})):r.forEach((s=>{s._set("dirty",!0)}))}onDeselect(){return this.removeAll(),!1}toString(){return"#<ActiveSelection: (".concat(this.complexity(),")>")}shouldCache(){return!1}isOnACache(){return!1}_renderControls(t,e,r){t.save(),t.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1;const s=C(C({hasControls:!1},r),{},{forActiveSelection:!0});for(let i=0;i<this._objects.length;i++)this._objects[i]._renderControls(t,s);super._renderControls(t,e),t.restore()}}S(Cs,"type","ActiveSelection"),S(Cs,"ownDefaults",{multiSelectionStacking:"canvas-stacking"}),gt.setClass(Cs),gt.setClass(Cs,"activeSelection");class km{constructor(){S(this,"resources",{})}applyFilters(t,e,r,s,i){const n=i.getContext("2d");if(!n)return;n.drawImage(e,0,0,r,s);const o={sourceWidth:r,sourceHeight:s,imageData:n.getImageData(0,0,r,s),originalEl:e,originalImageData:n.getImageData(0,0,r,s),canvasEl:i,ctx:n,filterBackend:this};t.forEach((c=>{c.applyTo(o)}));const{imageData:l}=o;return l.width===r&&l.height===s||(i.width=l.width,i.height=l.height),n.putImageData(l,0,0),o}}class Ic{constructor(){let{tileSize:t=Wt.textureSize}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};S(this,"aPosition",new Float32Array([0,0,0,1,1,0,1,1])),S(this,"resources",{}),this.tileSize=t,this.setupGLContext(t,t),this.captureGPUInfo()}setupGLContext(t,e){this.dispose(),this.createWebGLCanvas(t,e)}createWebGLCanvas(t,e){const r=sr({width:t,height:e}),s=r.getContext("webgl",{alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1});s&&(s.clearColor(0,0,0,0),this.canvas=r,this.gl=s)}applyFilters(t,e,r,s,i,n){const o=this.gl,l=i.getContext("2d");if(!o||!l)return;let c;n&&(c=this.getCachedTexture(n,e));const u={originalWidth:e.width||e.naturalWidth||0,originalHeight:e.height||e.naturalHeight||0,sourceWidth:r,sourceHeight:s,destinationWidth:r,destinationHeight:s,context:o,sourceTexture:this.createTexture(o,r,s,c?void 0:e),targetTexture:this.createTexture(o,r,s),originalTexture:c||this.createTexture(o,r,s,c?void 0:e),passes:t.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:i},d=o.createFramebuffer();return o.bindFramebuffer(o.FRAMEBUFFER,d),t.forEach((g=>{g&&g.applyTo(u)})),(function(g){const f=g.targetCanvas,m=f.width,p=f.height,v=g.destinationWidth,x=g.destinationHeight;m===v&&p===x||(f.width=v,f.height=x)})(u),this.copyGLTo2D(o,u),o.bindTexture(o.TEXTURE_2D,null),o.deleteTexture(u.sourceTexture),o.deleteTexture(u.targetTexture),o.deleteFramebuffer(d),l.setTransform(1,0,0,1,0,0),u}dispose(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()}clearWebGLCaches(){this.programCache={},this.textureCache={}}createTexture(t,e,r,s,i){const{NEAREST:n,TEXTURE_2D:o,RGBA:l,UNSIGNED_BYTE:c,CLAMP_TO_EDGE:u,TEXTURE_MAG_FILTER:d,TEXTURE_MIN_FILTER:g,TEXTURE_WRAP_S:f,TEXTURE_WRAP_T:m}=t,p=t.createTexture();return t.bindTexture(o,p),t.texParameteri(o,d,i||n),t.texParameteri(o,g,i||n),t.texParameteri(o,f,u),t.texParameteri(o,m,u),s?t.texImage2D(o,0,l,l,c,s):t.texImage2D(o,0,l,e,r,0,l,c,null),p}getCachedTexture(t,e,r){const{textureCache:s}=this;if(s[t])return s[t];{const i=this.createTexture(this.gl,e.width,e.height,e,r);return i&&(s[t]=i),i}}evictCachesForKey(t){this.textureCache[t]&&(this.gl.deleteTexture(this.textureCache[t]),delete this.textureCache[t])}copyGLTo2D(t,e){const r=t.canvas,s=e.targetCanvas,i=s.getContext("2d");if(!i)return;i.translate(0,s.height),i.scale(1,-1);const n=r.height-s.height;i.drawImage(r,0,n,s.width,s.height,0,0,s.width,s.height)}copyGLTo2DPutImageData(t,e){const r=e.targetCanvas.getContext("2d"),s=e.destinationWidth,i=e.destinationHeight,n=s*i*4;if(!r)return;const o=new Uint8Array(this.imageBuffer,0,n),l=new Uint8ClampedArray(this.imageBuffer,0,n);t.readPixels(0,0,s,i,t.RGBA,t.UNSIGNED_BYTE,o);const c=new ImageData(l,s,i);r.putImageData(c,0,0)}captureGPUInfo(){if(this.gpuInfo)return this.gpuInfo;const t=this.gl,e={renderer:"",vendor:""};if(!t)return e;const r=t.getExtension("WEBGL_debug_renderer_info");if(r){const s=t.getParameter(r.UNMASKED_RENDERER_WEBGL),i=t.getParameter(r.UNMASKED_VENDOR_WEBGL);s&&(e.renderer=s.toLowerCase()),i&&(e.vendor=i.toLowerCase())}return this.gpuInfo=e,e}}let ao;function Om(){const{WebGLProbe:a}=Ar();return a.queryWebGL($r()),Wt.enableGLFiltering&&a.isSupported(Wt.textureSize)?new Ic({tileSize:Wt.textureSize}):new km}function lo(){return!ao&&(!(arguments.length>0&&arguments[0]!==void 0)||arguments[0])&&(ao=Om()),ao}const Am=["filters","resizeFilter","src","crossOrigin","type"],Lc=["cropX","cropY"];class Ke extends Me{static getDefaults(){return C(C({},super.getDefaults()),Ke.ownDefaults)}constructor(t,e){super(),S(this,"_lastScaleX",1),S(this,"_lastScaleY",1),S(this,"_filterScalingX",1),S(this,"_filterScalingY",1),this.filters=[],Object.assign(this,Ke.ownDefaults),this.setOptions(e),this.cacheKey="texture".concat(fs()),this.setElement(typeof t=="string"?(this.canvas&&hr(this.canvas.getElement())||Zs()).getElementById(t):t,e)}getElement(){return this._element}setElement(t){var e;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.removeTexture(this.cacheKey),this.removeTexture("".concat(this.cacheKey,"_filtered")),this._element=t,this._originalElement=t,this._setWidthHeight(r),(e=t.classList)===null||e===void 0||e.add(Ke.CSS_CANVAS),this.filters.length!==0&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters()}removeTexture(t){const e=lo(!1);e instanceof Ic&&e.evictCachesForKey(t)}dispose(){super.dispose(),this.removeTexture(this.cacheKey),this.removeTexture("".concat(this.cacheKey,"_filtered")),this._cacheContext=null,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach((t=>{const e=this[t];e&&Ar().dispose(e),this[t]=void 0}))}getCrossOrigin(){return this._originalElement&&(this._originalElement.crossOrigin||null)}getOriginalSize(){const t=this.getElement();return t?{width:t.naturalWidth||t.width,height:t.naturalHeight||t.height}:{width:0,height:0}}_stroke(t){if(!this.stroke||this.strokeWidth===0)return;const e=this.width/2,r=this.height/2;t.beginPath(),t.moveTo(-e,-r),t.lineTo(e,-r),t.lineTo(e,r),t.lineTo(-e,r),t.lineTo(-e,-r),t.closePath()}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];const e=[];return this.filters.forEach((r=>{r&&e.push(r.toObject())})),C(C({},super.toObject([...Lc,...t])),{},{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:e},this.resizeFilter?{resizeFilter:this.resizeFilter.toObject()}:{})}hasCrop(){return!!this.cropX||!!this.cropY||this.width<this._element.width||this.height<this._element.height}_toSVG(){const t=[],e=this._element,r=-this.width/2,s=-this.height/2;let i=[],n=[],o="",l="";if(!e)return[];if(this.hasCrop()){const c=fs();i.push('<clipPath id="imageCrop_'+c+`">
`,'	<rect x="'+r+'" y="'+s+'" width="'+this.width+'" height="'+this.height+`" />
`,`</clipPath>
`),o=' clip-path="url(#imageCrop_'+c+')" '}if(this.imageSmoothing||(l=' image-rendering="optimizeSpeed"'),t.push("	<image ","COMMON_PARTS",'xlink:href="'.concat(this.getSvgSrc(!0),'" x="').concat(r-this.cropX,'" y="').concat(s-this.cropY,'" width="').concat(e.width||e.naturalWidth,'" height="').concat(e.height||e.naturalHeight,'"').concat(l).concat(o,`></image>
`)),this.stroke||this.strokeDashArray){const c=this.fill;this.fill=null,n=['	<rect x="'.concat(r,'" y="').concat(s,'" width="').concat(this.width,'" height="').concat(this.height,'" style="').concat(this.getSvgStyles(),`" />
`)],this.fill=c}return i=this.paintFirst!==_e?i.concat(n,t):i.concat(t,n),i}getSrc(t){const e=t?this._element:this._originalElement;return e?e.toDataURL?e.toDataURL():this.srcFromAttribute?e.getAttribute("src")||"":e.src:this.src||""}getSvgSrc(t){return this.getSrc(t)}setSrc(t){let{crossOrigin:e,signal:r}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return hn(t,{crossOrigin:e,signal:r}).then((s=>{e!==void 0&&this.set({crossOrigin:e}),this.setElement(s)}))}toString(){return'#<Image: { src: "'.concat(this.getSrc(),'" }>')}applyResizeFilters(){const t=this.resizeFilter,e=this.minimumScaleTrigger,r=this.getTotalObjectScaling(),s=r.x,i=r.y,n=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!t||s>e&&i>e)return this._element=n,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=s,void(this._lastScaleY=i);const o=sr(n),{width:l,height:c}=n;this._element=o,this._lastScaleX=t.scaleX=s,this._lastScaleY=t.scaleY=i,lo().applyFilters([t],n,l,c,this._element),this._filterScalingX=o.width/this._originalElement.width,this._filterScalingY=o.height/this._originalElement.height}applyFilters(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.filters||[];if(t=t.filter((i=>i&&!i.isNeutralState())),this.set("dirty",!0),this.removeTexture("".concat(this.cacheKey,"_filtered")),t.length===0)return this._element=this._originalElement,this._filteredEl=void 0,this._filterScalingX=1,void(this._filterScalingY=1);const e=this._originalElement,r=e.naturalWidth||e.width,s=e.naturalHeight||e.height;if(this._element===this._originalElement){const i=sr({width:r,height:s});this._element=i,this._filteredEl=i}else this._filteredEl&&(this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,r,s),this._lastScaleX=1,this._lastScaleY=1);lo().applyFilters(t,this._originalElement,r,s,this._element,this.cacheKey),this._originalElement.width===this._element.width&&this._originalElement.height===this._element.height||(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height)}_render(t){t.imageSmoothingEnabled=this.imageSmoothing,this.isMoving!==!0&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(t),this._renderPaintInOrder(t)}drawCacheOnCanvas(t){t.imageSmoothingEnabled=this.imageSmoothing,super.drawCacheOnCanvas(t)}shouldCache(){return this.needsItsOwnCache()}_renderFill(t){const e=this._element;if(!e)return;const r=this._filterScalingX,s=this._filterScalingY,i=this.width,n=this.height,o=Math.max(this.cropX,0),l=Math.max(this.cropY,0),c=e.naturalWidth||e.width,u=e.naturalHeight||e.height,d=o*r,g=l*s,f=Math.min(i*r,c-d),m=Math.min(n*s,u-g),p=-i/2,v=-n/2,x=Math.min(i,c/r-o),T=Math.min(n,u/s-l);e&&t.drawImage(e,d,g,f,m,p,v,x,T)}_needsResize(){const t=this.getTotalObjectScaling();return t.x!==this._lastScaleX||t.y!==this._lastScaleY}_resetWidthHeight(){this.set(this.getOriginalSize())}_setWidthHeight(){let{width:t,height:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const r=this.getOriginalSize();this.width=t||r.width,this.height=e||r.height}parsePreserveAspectRatioAttribute(){const t=yg(this.preserveAspectRatio||""),e=this.width,r=this.height,s={width:e,height:r};let i,n=this._element.width,o=this._element.height,l=1,c=1,u=0,d=0,g=0,f=0;return!t||t.alignX===We&&t.alignY===We?(l=e/n,c=r/o):(t.meetOrSlice==="meet"&&(l=c=jf(this._element,s),i=(e-n*l)/2,t.alignX==="Min"&&(u=-i),t.alignX==="Max"&&(u=i),i=(r-o*c)/2,t.alignY==="Min"&&(d=-i),t.alignY==="Max"&&(d=i)),t.meetOrSlice==="slice"&&(l=c=Rf(this._element,s),i=n-e/l,t.alignX==="Mid"&&(g=i/2),t.alignX==="Max"&&(g=i),i=o-r/c,t.alignY==="Mid"&&(f=i/2),t.alignY==="Max"&&(f=i),n=e/l,o=r/c)),{width:n,height:o,scaleX:l,scaleY:c,offsetLeft:u,offsetTop:d,cropX:g,cropY:f}}static fromObject(t,e){let{filters:r,resizeFilter:s,src:i,crossOrigin:n,type:o}=t,l=ie(t,Am);return Promise.all([hn(i,C(C({},e),{},{crossOrigin:n})),r&&wi(r,e),s&&wi([s],e),zn(l,e)]).then((c=>{let[u,d=[],[g]=[],f={}]=c;return new this(u,C(C({},l),{},{src:i,filters:d,resizeFilter:g},f))}))}static fromURL(t){let{crossOrigin:e=null,signal:r}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},s=arguments.length>2?arguments[2]:void 0;return hn(t,{crossOrigin:e,signal:r}).then((i=>new this(i,s)))}static async fromElement(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0;const s=Qr(t,this.ATTRIBUTE_NAMES,r);return this.fromURL(s["xlink:href"]||s.href,e,s).catch((i=>(gs("log","Unable to parse Image",i),null)))}}S(Ke,"type","Image"),S(Ke,"cacheProperties",[...Jr,...Lc]),S(Ke,"ownDefaults",{strokeWidth:0,srcFromAttribute:!1,minimumScaleTrigger:.5,cropX:0,cropY:0,imageSmoothing:!0}),S(Ke,"CSS_CANVAS","canvas-img"),S(Ke,"ATTRIBUTE_NAMES",[...ms,"x","y","width","height","preserveAspectRatio","xlink:href","href","crossOrigin","image-rendering"]),gt.setClass(Ke),gt.setSVGClass(Ke);Wn(["pattern","defs","symbol","metadata","clipPath","mask","desc"]);const Nn=a=>a.webgl!==void 0,ta="precision highp float",Dm=`
    `.concat(ta,`;
    varying vec2 vTexCoord;
    uniform sampler2D uTexture;
    void main() {
      gl_FragColor = texture2D(uTexture, vTexCoord);
    }`),Em=["type"],Pm=["type"],Mm=new RegExp(ta,"g");class ye{get type(){return this.constructor.type}constructor(){let t=ie(arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},Em);Object.assign(this,this.constructor.defaults,t)}getFragmentSource(){return Dm}getVertexSource(){return`
    attribute vec2 aPosition;
    varying vec2 vTexCoord;
    void main() {
      vTexCoord = aPosition;
      gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
    }`}createProgram(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.getFragmentSource(),r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.getVertexSource();const{WebGLProbe:{GLPrecision:s="highp"}}=Ar();s!=="highp"&&(e=e.replace(Mm,ta.replace("highp",s)));const i=t.createShader(t.VERTEX_SHADER),n=t.createShader(t.FRAGMENT_SHADER),o=t.createProgram();if(!i||!n||!o)throw new Tr("Vertex, fragment shader or program creation error");if(t.shaderSource(i,r),t.compileShader(i),!t.getShaderParameter(i,t.COMPILE_STATUS))throw new Tr("Vertex shader compile error for ".concat(this.type,": ").concat(t.getShaderInfoLog(i)));if(t.shaderSource(n,e),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS))throw new Tr("Fragment shader compile error for ".concat(this.type,": ").concat(t.getShaderInfoLog(n)));if(t.attachShader(o,i),t.attachShader(o,n),t.linkProgram(o),!t.getProgramParameter(o,t.LINK_STATUS))throw new Tr('Shader link error for "'.concat(this.type,'" ').concat(t.getProgramInfoLog(o)));const l=this.getUniformLocations(t,o)||{};return l.uStepW=t.getUniformLocation(o,"uStepW"),l.uStepH=t.getUniformLocation(o,"uStepH"),{program:o,attributeLocations:this.getAttributeLocations(t,o),uniformLocations:l}}getAttributeLocations(t,e){return{aPosition:t.getAttribLocation(e,"aPosition")}}getUniformLocations(t,e){const r=this.constructor.uniformLocations,s={};for(let i=0;i<r.length;i++)s[r[i]]=t.getUniformLocation(e,r[i]);return s}sendAttributeData(t,e,r){const s=e.aPosition,i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.enableVertexAttribArray(s),t.vertexAttribPointer(s,2,t.FLOAT,!1,0,0),t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW)}_setupFrameBuffer(t){const e=t.context;if(t.passes>1){const r=t.destinationWidth,s=t.destinationHeight;t.sourceWidth===r&&t.sourceHeight===s||(e.deleteTexture(t.targetTexture),t.targetTexture=t.filterBackend.createTexture(e,r,s)),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t.targetTexture,0)}else e.bindFramebuffer(e.FRAMEBUFFER,null),e.finish()}_swapTextures(t){t.passes--,t.pass++;const e=t.targetTexture;t.targetTexture=t.sourceTexture,t.sourceTexture=e}isNeutralState(t){return!1}applyTo(t){Nn(t)?(this._setupFrameBuffer(t),this.applyToWebGL(t),this._swapTextures(t)):this.applyTo2d(t)}applyTo2d(t){}getCacheKey(){return this.type}retrieveShader(t){const e=this.getCacheKey();return t.programCache[e]||(t.programCache[e]=this.createProgram(t.context)),t.programCache[e]}applyToWebGL(t){const e=t.context,r=this.retrieveShader(t);t.pass===0&&t.originalTexture?e.bindTexture(e.TEXTURE_2D,t.originalTexture):e.bindTexture(e.TEXTURE_2D,t.sourceTexture),e.useProgram(r.program),this.sendAttributeData(e,r.attributeLocations,t.aPosition),e.uniform1f(r.uniformLocations.uStepW,1/t.sourceWidth),e.uniform1f(r.uniformLocations.uStepH,1/t.sourceHeight),this.sendUniformData(e,r.uniformLocations),e.viewport(0,0,t.destinationWidth,t.destinationHeight),e.drawArrays(e.TRIANGLE_STRIP,0,4)}bindAdditionalTexture(t,e,r){t.activeTexture(r),t.bindTexture(t.TEXTURE_2D,e),t.activeTexture(t.TEXTURE0)}unbindAdditionalTexture(t,e){t.activeTexture(e),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE0)}sendUniformData(t,e){}createHelpLayer(t){if(!t.helpLayer){const{sourceWidth:e,sourceHeight:r}=t,s=sr({width:e,height:r});t.helpLayer=s}}toObject(){const t=Object.keys(this.constructor.defaults||{});return C({type:this.type},t.reduce(((e,r)=>(e[r]=this[r],e)),{}))}toJSON(){return this.toObject()}static async fromObject(t,e){return new this(ie(t,Pm))}}S(ye,"type","BaseFilter"),S(ye,"uniformLocations",[]);const Im={multiply:`gl_FragColor.rgb *= uColor.rgb;
`,screen:`gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);
`,add:`gl_FragColor.rgb += uColor.rgb;
`,difference:`gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);
`,subtract:`gl_FragColor.rgb -= uColor.rgb;
`,lighten:`gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);
`,darken:`gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);
`,exclusion:`gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);
`,overlay:`
    if (uColor.r < 0.5) {
      gl_FragColor.r *= 2.0 * uColor.r;
    } else {
      gl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);
    }
    if (uColor.g < 0.5) {
      gl_FragColor.g *= 2.0 * uColor.g;
    } else {
      gl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);
    }
    if (uColor.b < 0.5) {
      gl_FragColor.b *= 2.0 * uColor.b;
    } else {
      gl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);
    }
    `,tint:`
    gl_FragColor.rgb *= (1.0 - uColor.a);
    gl_FragColor.rgb += uColor.rgb;
    `};class Hi extends ye{getCacheKey(){return"".concat(this.type,"_").concat(this.mode)}getFragmentSource(){return`
      precision highp float;
      uniform sampler2D uTexture;
      uniform vec4 uColor;
      varying vec2 vTexCoord;
      void main() {
        vec4 color = texture2D(uTexture, vTexCoord);
        gl_FragColor = color;
        if (color.a > 0.0) {
          `.concat(Im[this.mode],`
        }
      }
      `)}applyTo2d(t){let{imageData:{data:e}}=t;const r=new Kt(this.color).getSource(),s=this.alpha,i=r[0]*s,n=r[1]*s,o=r[2]*s,l=1-s;for(let c=0;c<e.length;c+=4){const u=e[c],d=e[c+1],g=e[c+2];let f,m,p;switch(this.mode){case"multiply":f=u*i/255,m=d*n/255,p=g*o/255;break;case"screen":f=255-(255-u)*(255-i)/255,m=255-(255-d)*(255-n)/255,p=255-(255-g)*(255-o)/255;break;case"add":f=u+i,m=d+n,p=g+o;break;case"difference":f=Math.abs(u-i),m=Math.abs(d-n),p=Math.abs(g-o);break;case"subtract":f=u-i,m=d-n,p=g-o;break;case"darken":f=Math.min(u,i),m=Math.min(d,n),p=Math.min(g,o);break;case"lighten":f=Math.max(u,i),m=Math.max(d,n),p=Math.max(g,o);break;case"overlay":f=i<128?2*u*i/255:255-2*(255-u)*(255-i)/255,m=n<128?2*d*n/255:255-2*(255-d)*(255-n)/255,p=o<128?2*g*o/255:255-2*(255-g)*(255-o)/255;break;case"exclusion":f=i+u-2*i*u/255,m=n+d-2*n*d/255,p=o+g-2*o*g/255;break;case"tint":f=i+u*l,m=n+d*l,p=o+g*l}e[c]=f,e[c+1]=m,e[c+2]=p}}sendUniformData(t,e){const r=new Kt(this.color).getSource();r[0]=this.alpha*r[0]/255,r[1]=this.alpha*r[1]/255,r[2]=this.alpha*r[2]/255,r[3]=this.alpha,t.uniform4fv(e.uColor,r)}}S(Hi,"defaults",{color:"#F95C63",mode:"multiply",alpha:1}),S(Hi,"type","BlendColor"),S(Hi,"uniformLocations",["uColor"]),gt.setClass(Hi);const Lm={multiply:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform sampler2D uImage;
    uniform vec4 uColor;
    varying vec2 vTexCoord;
    varying vec2 vTexCoord2;
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      vec4 color2 = texture2D(uImage, vTexCoord2);
      color.rgba *= color2.rgba;
      gl_FragColor = color;
    }
    `,mask:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform sampler2D uImage;
    uniform vec4 uColor;
    varying vec2 vTexCoord;
    varying vec2 vTexCoord2;
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      vec4 color2 = texture2D(uImage, vTexCoord2);
      color.a = color2.a;
      gl_FragColor = color;
    }
    `},Fm=["type","image"];class Yi extends ye{getCacheKey(){return"".concat(this.type,"_").concat(this.mode)}getFragmentSource(){return Lm[this.mode]}getVertexSource(){return`
    attribute vec2 aPosition;
    varying vec2 vTexCoord;
    varying vec2 vTexCoord2;
    uniform mat3 uTransformMatrix;
    void main() {
      vTexCoord = aPosition;
      vTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;
      gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
    }
    `}applyToWebGL(t){const e=t.context,r=this.createTexture(t.filterBackend,this.image);this.bindAdditionalTexture(e,r,e.TEXTURE1),super.applyToWebGL(t),this.unbindAdditionalTexture(e,e.TEXTURE1)}createTexture(t,e){return t.getCachedTexture(e.cacheKey,e.getElement())}calculateMatrix(){const t=this.image,{width:e,height:r}=t.getElement();return[1/t.scaleX,0,0,0,1/t.scaleY,0,-t.left/e,-t.top/r,1]}applyTo2d(t){let{imageData:{data:e,width:r,height:s},filterBackend:{resources:i}}=t;const n=this.image;i.blendImage||(i.blendImage=$r());const o=i.blendImage,l=o.getContext("2d");o.width!==r||o.height!==s?(o.width=r,o.height=s):l.clearRect(0,0,r,s),l.setTransform(n.scaleX,0,0,n.scaleY,n.left,n.top),l.drawImage(n.getElement(),0,0,r,s);const c=l.getImageData(0,0,r,s).data;for(let u=0;u<e.length;u+=4){const d=e[u],g=e[u+1],f=e[u+2],m=e[u+3],p=c[u],v=c[u+1],x=c[u+2],T=c[u+3];switch(this.mode){case"multiply":e[u]=d*p/255,e[u+1]=g*v/255,e[u+2]=f*x/255,e[u+3]=m*T/255;break;case"mask":e[u+3]=T}}}sendUniformData(t,e){const r=this.calculateMatrix();t.uniform1i(e.uImage,1),t.uniformMatrix3fv(e.uTransformMatrix,!1,r)}toObject(){return C(C({},super.toObject()),{},{image:this.image&&this.image.toObject()})}static async fromObject(t,e){let{type:r,image:s}=t,i=ie(t,Fm);return Ke.fromObject(s,e).then((n=>new this(C(C({},i),{},{image:n}))))}}S(Yi,"type","BlendImage"),S(Yi,"defaults",{mode:"multiply",alpha:1}),S(Yi,"uniformLocations",["uTransformMatrix","uImage"]),gt.setClass(Yi);class Xi extends ye{getFragmentSource(){return`
    precision highp float;
    uniform sampler2D uTexture;
    uniform vec2 uDelta;
    varying vec2 vTexCoord;
    const float nSamples = 15.0;
    vec3 v3offset = vec3(12.9898, 78.233, 151.7182);
    float random(vec3 scale) {
      /* use the fragment position for a different seed per-pixel */
      return fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);
    }
    void main() {
      vec4 color = vec4(0.0);
      float totalC = 0.0;
      float totalA = 0.0;
      float offset = random(v3offset);
      for (float t = -nSamples; t <= nSamples; t++) {
        float percent = (t + offset - 0.5) / nSamples;
        vec4 sample = texture2D(uTexture, vTexCoord + uDelta * percent);
        float weight = 1.0 - abs(percent);
        float alpha = weight * sample.a;
        color.rgb += sample.rgb * alpha;
        color.a += alpha;
        totalA += weight;
        totalC += alpha;
      }
      gl_FragColor.rgb = color.rgb / totalC;
      gl_FragColor.a = color.a / totalA;
    }
  `}applyTo(t){Nn(t)?(this.aspectRatio=t.sourceWidth/t.sourceHeight,t.passes++,this._setupFrameBuffer(t),this.horizontal=!0,this.applyToWebGL(t),this._swapTextures(t),this._setupFrameBuffer(t),this.horizontal=!1,this.applyToWebGL(t),this._swapTextures(t)):this.applyTo2d(t)}applyTo2d(t){let{imageData:{data:e,width:r,height:s}}=t;this.aspectRatio=r/s,this.horizontal=!0;let i=this.getBlurValue()*r;const n=new Uint8ClampedArray(e),o=15,l=4*r;for(let c=0;c<e.length;c+=4){let u=0,d=0,g=0,f=0,m=0;const p=c-c%l,v=p+l;for(let x=-14;x<o;x++){const T=x/o,A=4*Math.floor(i*T),O=1-Math.abs(T);let P=c+A;P<p?P=p:P>v&&(P=v);const L=e[P+3]*O;u+=e[P]*L,d+=e[P+1]*L,g+=e[P+2]*L,f+=L,m+=O}n[c]=u/f,n[c+1]=d/f,n[c+2]=g/f,n[c+3]=f/m}this.horizontal=!1,i=this.getBlurValue()*s;for(let c=0;c<n.length;c+=4){let u=0,d=0,g=0,f=0,m=0;const p=c%l,v=n.length-l+p;for(let x=-14;x<o;x++){const T=x/o,A=Math.floor(i*T)*l,O=1-Math.abs(T);let P=c+A;P<p?P=p:P>v&&(P=v);const L=n[P+3]*O;u+=n[P]*L,d+=n[P+1]*L,g+=n[P+2]*L,f+=L,m+=O}e[c]=u/f,e[c+1]=d/f,e[c+2]=g/f,e[c+3]=f/m}}sendUniformData(t,e){const r=this.chooseRightDelta();t.uniform2fv(e.uDelta,r)}isNeutralState(){return this.blur===0}getBlurValue(){let t=1;const{horizontal:e,aspectRatio:r}=this;return e?r>1&&(t=1/r):r<1&&(t=r),t*this.blur*.12}chooseRightDelta(){const t=this.getBlurValue();return this.horizontal?[t,0]:[0,t]}}S(Xi,"type","Blur"),S(Xi,"defaults",{blur:0}),S(Xi,"uniformLocations",["uDelta"]),gt.setClass(Xi);class Ni extends ye{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uBrightness;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    color.rgb += uBrightness;
    gl_FragColor = color;
  }
`}applyTo2d(t){let{imageData:{data:e}}=t;const r=Math.round(255*this.brightness);for(let s=0;s<e.length;s+=4)e[s]+=r,e[s+1]+=r,e[s+2]+=r}isNeutralState(){return this.brightness===0}sendUniformData(t,e){t.uniform1f(e.uBrightness,this.brightness)}}S(Ni,"type","Brightness"),S(Ni,"defaults",{brightness:0}),S(Ni,"uniformLocations",["uBrightness"]),gt.setClass(Ni);const Fc={matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],colorsOnly:!0};class Hs extends ye{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  varying vec2 vTexCoord;
  uniform mat4 uColorMatrix;
  uniform vec4 uConstants;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    color *= uColorMatrix;
    color += uConstants;
    gl_FragColor = color;
  }`}applyTo2d(t){const e=t.imageData.data,r=this.matrix,s=this.colorsOnly;for(let i=0;i<e.length;i+=4){const n=e[i],o=e[i+1],l=e[i+2];if(e[i]=n*r[0]+o*r[1]+l*r[2]+255*r[4],e[i+1]=n*r[5]+o*r[6]+l*r[7]+255*r[9],e[i+2]=n*r[10]+o*r[11]+l*r[12]+255*r[14],!s){const c=e[i+3];e[i]+=c*r[3],e[i+1]+=c*r[8],e[i+2]+=c*r[13],e[i+3]=n*r[15]+o*r[16]+l*r[17]+c*r[18]+255*r[19]}}}sendUniformData(t,e){const r=this.matrix,s=[r[0],r[1],r[2],r[3],r[5],r[6],r[7],r[8],r[10],r[11],r[12],r[13],r[15],r[16],r[17],r[18]],i=[r[4],r[9],r[14],r[19]];t.uniformMatrix4fv(e.uColorMatrix,!1,s),t.uniform4fv(e.uConstants,i)}toObject(){return C(C({},super.toObject()),{},{matrix:[...this.matrix]})}}function Ms(a,t){var e;const r=(S(e=class extends Hs{toObject(){return{type:this.type,colorsOnly:this.colorsOnly}}},"type",a),S(e,"defaults",{colorsOnly:!1,matrix:t}),e);return gt.setClass(r,a),r}S(Hs,"type","ColorMatrix"),S(Hs,"defaults",Fc),S(Hs,"uniformLocations",["uColorMatrix","uConstants"]),gt.setClass(Hs);Ms("Brownie",[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0]);Ms("Vintage",[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0]);Ms("Kodachrome",[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0]);Ms("Technicolor",[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0]);Ms("Polaroid",[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0]);Ms("Sepia",[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0]);Ms("BlackWhite",[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]);class al extends ye{constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(t),this.subFilters=t.subFilters||[]}applyTo(t){Nn(t)&&(t.passes+=this.subFilters.length-1),this.subFilters.forEach((e=>{e.applyTo(t)}))}toObject(){return{type:this.type,subFilters:this.subFilters.map((t=>t.toObject()))}}isNeutralState(){return!this.subFilters.some((t=>!t.isNeutralState()))}static fromObject(t,e){return Promise.all((t.subFilters||[]).map((r=>gt.getClass(r.type).fromObject(r,e)))).then((r=>new this({subFilters:r})))}}S(al,"type","Composed"),gt.setClass(al);class Ui extends ye{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uContrast;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    float contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));
    color.rgb = contrastF * (color.rgb - 0.5) + 0.5;
    gl_FragColor = color;
  }`}isNeutralState(){return this.contrast===0}applyTo2d(t){let{imageData:{data:e}}=t;const r=Math.floor(255*this.contrast),s=259*(r+255)/(255*(259-r));for(let i=0;i<e.length;i+=4)e[i]=s*(e[i]-128)+128,e[i+1]=s*(e[i+1]-128)+128,e[i+2]=s*(e[i+2]-128)+128}sendUniformData(t,e){t.uniform1f(e.uContrast,this.contrast)}}S(Ui,"type","Contrast"),S(Ui,"defaults",{contrast:0}),S(Ui,"uniformLocations",["uContrast"]),gt.setClass(Ui);const jm={Convolute_3_1:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[9];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 0);
      for (float h = 0.0; h < 3.0; h+=1.0) {
        for (float w = 0.0; w < 3.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));
          color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];
        }
      }
      gl_FragColor = color;
    }
    `,Convolute_3_0:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[9];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 1);
      for (float h = 0.0; h < 3.0; h+=1.0) {
        for (float w = 0.0; w < 3.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));
          color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];
        }
      }
      float alpha = texture2D(uTexture, vTexCoord).a;
      gl_FragColor = color;
      gl_FragColor.a = alpha;
    }
    `,Convolute_5_1:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[25];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 0);
      for (float h = 0.0; h < 5.0; h+=1.0) {
        for (float w = 0.0; w < 5.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
          color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];
        }
      }
      gl_FragColor = color;
    }
    `,Convolute_5_0:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[25];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 1);
      for (float h = 0.0; h < 5.0; h+=1.0) {
        for (float w = 0.0; w < 5.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
          color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];
        }
      }
      float alpha = texture2D(uTexture, vTexCoord).a;
      gl_FragColor = color;
      gl_FragColor.a = alpha;
    }
    `,Convolute_7_1:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[49];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 0);
      for (float h = 0.0; h < 7.0; h+=1.0) {
        for (float w = 0.0; w < 7.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
          color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];
        }
      }
      gl_FragColor = color;
    }
    `,Convolute_7_0:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[49];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 1);
      for (float h = 0.0; h < 7.0; h+=1.0) {
        for (float w = 0.0; w < 7.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
          color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];
        }
      }
      float alpha = texture2D(uTexture, vTexCoord).a;
      gl_FragColor = color;
      gl_FragColor.a = alpha;
    }
    `,Convolute_9_1:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[81];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 0);
      for (float h = 0.0; h < 9.0; h+=1.0) {
        for (float w = 0.0; w < 9.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
          color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];
        }
      }
      gl_FragColor = color;
    }
    `,Convolute_9_0:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[81];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 1);
      for (float h = 0.0; h < 9.0; h+=1.0) {
        for (float w = 0.0; w < 9.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
          color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];
        }
      }
      float alpha = texture2D(uTexture, vTexCoord).a;
      gl_FragColor = color;
      gl_FragColor.a = alpha;
    }
    `};class Gi extends ye{getCacheKey(){return"".concat(this.type,"_").concat(Math.sqrt(this.matrix.length),"_").concat(this.opaque?1:0)}getFragmentSource(){return jm[this.getCacheKey()]}applyTo2d(t){const e=t.imageData,r=e.data,s=this.matrix,i=Math.round(Math.sqrt(s.length)),n=Math.floor(i/2),o=e.width,l=e.height,c=t.ctx.createImageData(o,l),u=c.data,d=this.opaque?1:0;let g,f,m,p,v,x,T,A,O,P,L,E,_;for(L=0;L<l;L++)for(P=0;P<o;P++){for(v=4*(L*o+P),g=0,f=0,m=0,p=0,_=0;_<i;_++)for(E=0;E<i;E++)T=L+_-n,x=P+E-n,T<0||T>=l||x<0||x>=o||(A=4*(T*o+x),O=s[_*i+E],g+=r[A]*O,f+=r[A+1]*O,m+=r[A+2]*O,d||(p+=r[A+3]*O));u[v]=g,u[v+1]=f,u[v+2]=m,u[v+3]=d?r[v+3]:p}t.imageData=c}sendUniformData(t,e){t.uniform1fv(e.uMatrix,this.matrix)}toObject(){return C(C({},super.toObject()),{},{opaque:this.opaque,matrix:[...this.matrix]})}}S(Gi,"type","Convolute"),S(Gi,"defaults",{opaque:!1,matrix:[0,0,0,0,1,0,0,0,0]}),S(Gi,"uniformLocations",["uMatrix","uOpaque","uHalfSize","uSize"]),gt.setClass(Gi);const jc="Gamma";class qi extends ye{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform vec3 uGamma;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    vec3 correction = (1.0 / uGamma);
    color.r = pow(color.r, correction.r);
    color.g = pow(color.g, correction.g);
    color.b = pow(color.b, correction.b);
    gl_FragColor = color;
    gl_FragColor.rgb *= color.a;
  }
`}constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(t),this.gamma=t.gamma||this.constructor.defaults.gamma.concat()}applyTo2d(t){let{imageData:{data:e}}=t;const r=this.gamma,s=1/r[0],i=1/r[1],n=1/r[2];this.rgbValues||(this.rgbValues={r:new Uint8Array(256),g:new Uint8Array(256),b:new Uint8Array(256)});const o=this.rgbValues;for(let l=0;l<256;l++)o.r[l]=255*Math.pow(l/255,s),o.g[l]=255*Math.pow(l/255,i),o.b[l]=255*Math.pow(l/255,n);for(let l=0;l<e.length;l+=4)e[l]=o.r[e[l]],e[l+1]=o.g[e[l+1]],e[l+2]=o.b[e[l+2]]}sendUniformData(t,e){t.uniform3fv(e.uGamma,this.gamma)}isNeutralState(){const{gamma:t}=this;return t[0]===1&&t[1]===1&&t[2]===1}toObject(){return{type:jc,gamma:this.gamma.concat()}}}S(qi,"type",jc),S(qi,"defaults",{gamma:[1,1,1]}),S(qi,"uniformLocations",["uGamma"]),gt.setClass(qi);const Rm={average:`
    precision highp float;
    uniform sampler2D uTexture;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      float average = (color.r + color.b + color.g) / 3.0;
      gl_FragColor = vec4(average, average, average, color.a);
    }
    `,lightness:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform int uMode;
    varying vec2 vTexCoord;
    void main() {
      vec4 col = texture2D(uTexture, vTexCoord);
      float average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;
      gl_FragColor = vec4(average, average, average, col.a);
    }
    `,luminosity:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform int uMode;
    varying vec2 vTexCoord;
    void main() {
      vec4 col = texture2D(uTexture, vTexCoord);
      float average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;
      gl_FragColor = vec4(average, average, average, col.a);
    }
    `};class $i extends ye{applyTo2d(t){let{imageData:{data:e}}=t;for(let r,s=0;s<e.length;s+=4){const i=e[s],n=e[s+1],o=e[s+2];switch(this.mode){case"average":r=(i+n+o)/3;break;case"lightness":r=(Math.min(i,n,o)+Math.max(i,n,o))/2;break;case"luminosity":r=.21*i+.72*n+.07*o}e[s+2]=e[s+1]=e[s]=r}}getCacheKey(){return"".concat(this.type,"_").concat(this.mode)}getFragmentSource(){return Rm[this.mode]}sendUniformData(t,e){t.uniform1i(e.uMode,1)}isNeutralState(){return!1}}S($i,"type","Grayscale"),S($i,"defaults",{mode:"average"}),S($i,"uniformLocations",["uMode"]),gt.setClass($i);const Bm=C(C({},Fc),{},{rotation:0});class co extends Hs{calculateMatrix(){const t=this.rotation*Math.PI,e=Gr(t),r=qr(t),s=1/3,i=Math.sqrt(s)*r,n=1-e;this.matrix=[e+n/3,s*n-i,s*n+i,0,0,s*n+i,e+s*n,s*n-i,0,0,s*n-i,s*n+i,e+s*n,0,0,0,0,0,1,0]}isNeutralState(){return this.rotation===0}applyTo(t){this.calculateMatrix(),super.applyTo(t)}toObject(){return{type:this.type,rotation:this.rotation}}}S(co,"type","HueRotation"),S(co,"defaults",Bm),gt.setClass(co);class Ki extends ye{applyTo2d(t){let{imageData:{data:e}}=t;for(let r=0;r<e.length;r+=4)e[r]=255-e[r],e[r+1]=255-e[r+1],e[r+2]=255-e[r+2],this.alpha&&(e[r+3]=255-e[r+3])}getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform int uInvert;
  uniform int uAlpha;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    if (uInvert == 1) {
      if (uAlpha == 1) {
        gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,1.0 -color.a);
      } else {
        gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);
      }
    } else {
      gl_FragColor = color;
    }
  }
`}isNeutralState(){return!this.invert}sendUniformData(t,e){t.uniform1i(e.uInvert,Number(this.invert)),t.uniform1i(e.uAlpha,Number(this.alpha))}}S(Ki,"type","Invert"),S(Ki,"defaults",{alpha:!1,invert:!0}),S(Ki,"uniformLocations",["uInvert","uAlpha"]),gt.setClass(Ki);class Zi extends ye{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uStepH;
  uniform float uNoise;
  uniform float uSeed;
  varying vec2 vTexCoord;
  float rand(vec2 co, float seed, float vScale) {
    return fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);
  }
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    color.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;
    gl_FragColor = color;
  }
`}applyTo2d(t){let{imageData:{data:e}}=t;const r=this.noise;for(let s=0;s<e.length;s+=4){const i=(.5-Math.random())*r;e[s]+=i,e[s+1]+=i,e[s+2]+=i}}sendUniformData(t,e){t.uniform1f(e.uNoise,this.noise/255),t.uniform1f(e.uSeed,Math.random())}isNeutralState(){return this.noise===0}}S(Zi,"type","Noise"),S(Zi,"defaults",{noise:0}),S(Zi,"uniformLocations",["uNoise","uSeed"]),gt.setClass(Zi);class Ji extends ye{applyTo2d(t){let{imageData:{data:e,width:r,height:s}}=t;for(let i=0;i<s;i+=this.blocksize)for(let n=0;n<r;n+=this.blocksize){const o=4*i*r+4*n,l=e[o],c=e[o+1],u=e[o+2],d=e[o+3];for(let g=i;g<Math.min(i+this.blocksize,s);g++)for(let f=n;f<Math.min(n+this.blocksize,r);f++){const m=4*g*r+4*f;e[m]=l,e[m+1]=c,e[m+2]=u,e[m+3]=d}}}isNeutralState(){return this.blocksize===1}getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uBlocksize;
  uniform float uStepW;
  uniform float uStepH;
  varying vec2 vTexCoord;
  void main() {
    float blockW = uBlocksize * uStepW;
    float blockH = uBlocksize * uStepH;
    int posX = int(vTexCoord.x / blockW);
    int posY = int(vTexCoord.y / blockH);
    float fposX = float(posX);
    float fposY = float(posY);
    vec2 squareCoords = vec2(fposX * blockW, fposY * blockH);
    vec4 color = texture2D(uTexture, squareCoords);
    gl_FragColor = color;
  }
`}sendUniformData(t,e){t.uniform1f(e.uBlocksize,this.blocksize)}}S(Ji,"type","Pixelate"),S(Ji,"defaults",{blocksize:4}),S(Ji,"uniformLocations",["uBlocksize"]),gt.setClass(Ji);class Qi extends ye{getFragmentSource(){return`
precision highp float;
uniform sampler2D uTexture;
uniform vec4 uLow;
uniform vec4 uHigh;
varying vec2 vTexCoord;
void main() {
  gl_FragColor = texture2D(uTexture, vTexCoord);
  if(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {
    gl_FragColor.a = 0.0;
  }
}
`}applyTo2d(t){let{imageData:{data:e}}=t;const r=255*this.distance,s=new Kt(this.color).getSource(),i=[s[0]-r,s[1]-r,s[2]-r],n=[s[0]+r,s[1]+r,s[2]+r];for(let o=0;o<e.length;o+=4){const l=e[o],c=e[o+1],u=e[o+2];l>i[0]&&c>i[1]&&u>i[2]&&l<n[0]&&c<n[1]&&u<n[2]&&(e[o+3]=0)}}sendUniformData(t,e){const r=new Kt(this.color).getSource(),s=this.distance,i=[0+r[0]/255-s,0+r[1]/255-s,0+r[2]/255-s,1],n=[r[0]/255+s,r[1]/255+s,r[2]/255+s,1];t.uniform4fv(e.uLow,i),t.uniform4fv(e.uHigh,n)}}S(Qi,"type","RemoveColor"),S(Qi,"defaults",{color:"#FFFFFF",distance:.02,useAlpha:!1}),S(Qi,"uniformLocations",["uLow","uHigh"]),gt.setClass(Qi);class tn extends ye{sendUniformData(t,e){t.uniform2fv(e.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),t.uniform1fv(e.uTaps,this.taps)}getFilterWindow(){const t=this.tempScale;return Math.ceil(this.lanczosLobes/t)}getCacheKey(){const t=this.getFilterWindow();return"".concat(this.type,"_").concat(t)}getFragmentSource(){const t=this.getFilterWindow();return this.generateShader(t)}getTaps(){const t=this.lanczosCreate(this.lanczosLobes),e=this.tempScale,r=this.getFilterWindow(),s=new Array(r);for(let i=1;i<=r;i++)s[i-1]=t(i*e);return s}generateShader(t){const e=new Array(t);for(let r=1;r<=t;r++)e[r-1]="".concat(r,".0 * uDelta");return`
      precision highp float;
      uniform sampler2D uTexture;
      uniform vec2 uDelta;
      varying vec2 vTexCoord;
      uniform float uTaps[`.concat(t,`];
      void main() {
        vec4 color = texture2D(uTexture, vTexCoord);
        float sum = 1.0;
        `).concat(e.map(((r,s)=>`
              color += texture2D(uTexture, vTexCoord + `.concat(r,") * uTaps[").concat(s,"] + texture2D(uTexture, vTexCoord - ").concat(r,") * uTaps[").concat(s,`];
              sum += 2.0 * uTaps[`).concat(s,`];
            `))).join(`
`),`
        gl_FragColor = color / sum;
      }
    `)}applyToForWebgl(t){t.passes++,this.width=t.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=t.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),t.destinationWidth=this.dW,super.applyTo(t),t.sourceWidth=t.destinationWidth,this.height=t.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),t.destinationHeight=this.dH,super.applyTo(t),t.sourceHeight=t.destinationHeight}applyTo(t){Nn(t)?this.applyToForWebgl(t):this.applyTo2d(t)}isNeutralState(){return this.scaleX===1&&this.scaleY===1}lanczosCreate(t){return e=>{if(e>=t||e<=-t)return 0;if(e<11920929e-14&&e>-11920929e-14)return 1;const r=(e*=Math.PI)/t;return Math.sin(e)/e*Math.sin(r)/r}}applyTo2d(t){const e=t.imageData,r=this.scaleX,s=this.scaleY;this.rcpScaleX=1/r,this.rcpScaleY=1/s;const i=e.width,n=e.height,o=Math.round(i*r),l=Math.round(n*s);let c;c=this.resizeType==="sliceHack"?this.sliceByTwo(t,i,n,o,l):this.resizeType==="hermite"?this.hermiteFastResize(t,i,n,o,l):this.resizeType==="bilinear"?this.bilinearFiltering(t,i,n,o,l):this.resizeType==="lanczos"?this.lanczosResize(t,i,n,o,l):new ImageData(o,l),t.imageData=c}sliceByTwo(t,e,r,s,i){const n=t.imageData,o=.5;let l=!1,c=!1,u=e*o,d=r*o;const g=t.filterBackend.resources;let f=0,m=0;const p=e;let v=0;g.sliceByTwo||(g.sliceByTwo=$r());const x=g.sliceByTwo;(x.width<1.5*e||x.height<r)&&(x.width=1.5*e,x.height=r);const T=x.getContext("2d");for(T.clearRect(0,0,1.5*e,r),T.putImageData(n,0,0),s=Math.floor(s),i=Math.floor(i);!l||!c;)e=u,r=d,s<Math.floor(u*o)?u=Math.floor(u*o):(u=s,l=!0),i<Math.floor(d*o)?d=Math.floor(d*o):(d=i,c=!0),T.drawImage(x,f,m,e,r,p,v,u,d),f=p,m=v,v+=d;return T.getImageData(f,m,s,i)}lanczosResize(t,e,r,s,i){const n=t.imageData.data,o=t.ctx.createImageData(s,i),l=o.data,c=this.lanczosCreate(this.lanczosLobes),u=this.rcpScaleX,d=this.rcpScaleY,g=2/this.rcpScaleX,f=2/this.rcpScaleY,m=Math.ceil(u*this.lanczosLobes/2),p=Math.ceil(d*this.lanczosLobes/2),v={},x={x:0,y:0},T={x:0,y:0};return(function A(O){let P,L,E,_,j,X,G,R,B,V,Q;for(x.x=(O+.5)*u,T.x=Math.floor(x.x),P=0;P<i;P++){for(x.y=(P+.5)*d,T.y=Math.floor(x.y),j=0,X=0,G=0,R=0,B=0,L=T.x-m;L<=T.x+m;L++)if(!(L<0||L>=e)){V=Math.floor(1e3*Math.abs(L-x.x)),v[V]||(v[V]={});for(let tt=T.y-p;tt<=T.y+p;tt++)tt<0||tt>=r||(Q=Math.floor(1e3*Math.abs(tt-x.y)),v[V][Q]||(v[V][Q]=c(Math.sqrt(Math.pow(V*g,2)+Math.pow(Q*f,2))/1e3)),E=v[V][Q],E>0&&(_=4*(tt*e+L),j+=E,X+=E*n[_],G+=E*n[_+1],R+=E*n[_+2],B+=E*n[_+3]))}_=4*(P*s+O),l[_]=X/j,l[_+1]=G/j,l[_+2]=R/j,l[_+3]=B/j}return++O<s?A(O):o})(0)}bilinearFiltering(t,e,r,s,i){let n,o,l,c,u,d,g,f,m,p,v,x,T,A=0;const O=this.rcpScaleX,P=this.rcpScaleY,L=4*(e-1),E=t.imageData.data,_=t.ctx.createImageData(s,i),j=_.data;for(g=0;g<i;g++)for(f=0;f<s;f++)for(u=Math.floor(O*f),d=Math.floor(P*g),m=O*f-u,p=P*g-d,T=4*(d*e+u),v=0;v<4;v++)n=E[T+v],o=E[T+4+v],l=E[T+L+v],c=E[T+L+4+v],x=n*(1-m)*(1-p)+o*m*(1-p)+l*p*(1-m)+c*m*p,j[A++]=x;return _}hermiteFastResize(t,e,r,s,i){const n=this.rcpScaleX,o=this.rcpScaleY,l=Math.ceil(n/2),c=Math.ceil(o/2),u=t.imageData.data,d=t.ctx.createImageData(s,i),g=d.data;for(let f=0;f<i;f++)for(let m=0;m<s;m++){const p=4*(m+f*s);let v=0,x=0,T=0,A=0,O=0,P=0,L=0;const E=(f+.5)*o;for(let _=Math.floor(f*o);_<(f+1)*o;_++){const j=Math.abs(E-(_+.5))/c,X=(m+.5)*n,G=j*j;for(let R=Math.floor(m*n);R<(m+1)*n;R++){let B=Math.abs(X-(R+.5))/l;const V=Math.sqrt(G+B*B);V>1&&V<-1||(v=2*V*V*V-3*V*V+1,v>0&&(B=4*(R+_*e),L+=v*u[B+3],T+=v,u[B+3]<255&&(v=v*u[B+3]/250),A+=v*u[B],O+=v*u[B+1],P+=v*u[B+2],x+=v))}}g[p]=A/x,g[p+1]=O/x,g[p+2]=P/x,g[p+3]=L/T}return d}}S(tn,"type","Resize"),S(tn,"defaults",{resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3}),S(tn,"uniformLocations",["uDelta","uTaps"]),gt.setClass(tn);class en extends ye{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uSaturation;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    float rgMax = max(color.r, color.g);
    float rgbMax = max(rgMax, color.b);
    color.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;
    color.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;
    color.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;
    gl_FragColor = color;
  }
`}applyTo2d(t){let{imageData:{data:e}}=t;const r=-this.saturation;for(let s=0;s<e.length;s+=4){const i=e[s],n=e[s+1],o=e[s+2],l=Math.max(i,n,o);e[s]+=l!==i?(l-i)*r:0,e[s+1]+=l!==n?(l-n)*r:0,e[s+2]+=l!==o?(l-o)*r:0}}sendUniformData(t,e){t.uniform1f(e.uSaturation,-this.saturation)}isNeutralState(){return this.saturation===0}}S(en,"type","Saturation"),S(en,"defaults",{saturation:0}),S(en,"uniformLocations",["uSaturation"]),gt.setClass(en);class rn extends ye{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uVibrance;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    float max = max(color.r, max(color.g, color.b));
    float avg = (color.r + color.g + color.b) / 3.0;
    float amt = (abs(max - avg) * 2.0) * uVibrance;
    color.r += max != color.r ? (max - color.r) * amt : 0.00;
    color.g += max != color.g ? (max - color.g) * amt : 0.00;
    color.b += max != color.b ? (max - color.b) * amt : 0.00;
    gl_FragColor = color;
  }
`}applyTo2d(t){let{imageData:{data:e}}=t;const r=-this.vibrance;for(let s=0;s<e.length;s+=4){const i=e[s],n=e[s+1],o=e[s+2],l=Math.max(i,n,o),c=(i+n+o)/3,u=2*Math.abs(l-c)/255*r;e[s]+=l!==i?(l-i)*u:0,e[s+1]+=l!==n?(l-n)*u:0,e[s+2]+=l!==o?(l-o)*u:0}}sendUniformData(t,e){t.uniform1f(e.uVibrance,-this.vibrance)}isNeutralState(){return this.vibrance===0}}S(rn,"type","Vibrance"),S(rn,"defaults",{vibrance:0}),S(rn,"uniformLocations",["uVibrance"]),gt.setClass(rn);var zm=q('<button type="button" class="w-full flex place-items-center gap-2 rounded-lg ps-1 pe-4 py-2 hover:bg-immich-primary/25"><!> <p class="text-sm"> </p></button>'),Vm=q('<div class="mt-2 rounded-lg"></div>'),Wm=q('<div class="flex items-center justify-center py-4"><p class="text-sm text-gray-500"> </p></div>'),Hm=q('<div class="absolute start-0 top-0"><canvas id="face-editor" class="absolute top-0 start-0"></canvas> <div id="face-selector" class="absolute top-[calc(50%-250px)] start-[calc(50%-125px)] max-w-[250px] w-[250px] bg-white dark:bg-immich-dark-gray dark:text-immich-dark-fg backdrop-blur-sm px-2 py-4 rounded-xl border border-gray-200 dark:border-gray-800"><p class="text-center text-sm"> </p> <div class="my-3 relative"><!></div> <div class="h-62.5 overflow-y-auto mt-2"><!></div> <!></div></div>');function Rc(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It();let i=st(void 0),n=st(void 0),o=st(void 0),l=st(void 0),c=st(1),u=st(ue([])),d=st(""),g=y(()=>h(d)?h(u).filter(z=>z.name.toLowerCase().includes(h(d).toLowerCase())):h(u));const f=()=>{Es.ownDefaults={...Es.ownDefaults,cornerStyle:"circle",cornerColor:"rgb(153,166,251)",cornerSize:10,padding:8,transparentCorners:!1,lockRotation:!0,hasBorders:!0}},m=()=>{!h(i)||!t.htmlElement||(U(n,new To(h(i)),!0),f(),U(o,new cr({fill:"rgba(66,80,175,0.25)",stroke:"rgb(66,80,175)",strokeWidth:2,strokeUniform:!0,width:112,height:112,objectCaching:!0,rx:8,ry:8}),!0),h(n).add(h(o)),h(n).setActiveObject(h(o)))};tr(async()=>{m(),await x()}),Ee(()=>{const{actualWidth:z,actualHeight:$}=p(t.htmlElement),J={width:(t.containerWidth-z)/2,height:(t.containerHeight-$)/2},rt={top:J.height,left:J.width,width:t.containerWidth-J.width*2,height:t.containerHeight-J.height*2};h(n)&&(h(n).setDimensions({width:t.containerWidth,height:t.containerHeight}),h(o)&&(h(o).set({top:rt.top+200,left:rt.left+200}),h(o).setCoords(),T()))});const p=z=>{if(z instanceof HTMLImageElement){const $=z.naturalWidth/z.naturalHeight;let J=z.height*$,rt=z.height;return J>z.width&&(J=z.width,rt=z.width/$),{actualWidth:J,actualHeight:rt}}else if(z instanceof HTMLVideoElement){const $=z.videoWidth/z.videoHeight;let J=z.clientHeight*$,rt=z.clientHeight;return J>z.clientWidth&&(J=z.clientWidth,rt=z.clientWidth/$),{actualWidth:J,actualHeight:rt}}return{actualWidth:0,actualHeight:0}},v=()=>{ds.value=!1},x=async()=>{const{hasNextPage:z,people:$,total:J}=await Al({page:h(c),size:1e3,withHidden:!1});h(u).length!==J&&(U(u,[...h(u),...$],!0),z&&qc(c))},T=()=>{if(!h(o)||!h(l))return;const z=h(o).getBoundingRect(),$=h(l).offsetWidth,J=h(l).offsetHeight,rt=z.top,it=t.containerHeight-(z.top+z.height),ht=z.left,nt=t.containerWidth-(z.left+z.width);let ut,D;it>=J||it>=rt&&it>=ht&&it>=nt?(ut=z.top+z.height+15,D=z.left):rt>=J||rt>=it&&rt>=ht&&rt>=nt?(ut=z.top-J-15,D=z.left):nt>=$||nt>=ht&&nt>=rt&&nt>=it?(ut=z.top,D=z.left+z.width+15):(ut=z.top,D=z.left-$-15),D+$>t.containerWidth&&(D=t.containerWidth-$-15),D<0&&(D=15),ut+J>t.containerHeight&&(ut=t.containerHeight-J-15),ut<0&&(ut=15),h(l).style.top=`${ut}px`,h(l).style.left=`${D}px`};Ee(()=>{h(o)&&(h(o).on("moving",T),h(o).on("scaling",T))});const A=()=>{if(!h(o)||!t.htmlElement)return;const{left:z,top:$,width:J,height:rt}=h(o).getBoundingRect(),{actualWidth:it,actualHeight:ht}=p(t.htmlElement),nt={width:(t.containerWidth-it)/2,height:(t.containerHeight-ht)/2},ut=(z-nt.width)/it,D=($-nt.height)/ht,W=(z+J-nt.width)/it,H=($+rt-nt.height)/ht;if(t.htmlElement instanceof HTMLImageElement){const Y=ut*t.htmlElement.naturalWidth,M=D*t.htmlElement.naturalHeight,Z=W*t.htmlElement.naturalWidth,ft=H*t.htmlElement.naturalHeight;return{imageWidth:t.htmlElement.naturalWidth,imageHeight:t.htmlElement.naturalHeight,x:Math.floor(Y),y:Math.floor(M),width:Math.floor(Z-Y),height:Math.floor(ft-M)}}else if(t.htmlElement instanceof HTMLVideoElement){const Y=ut*t.htmlElement.videoWidth,M=D*t.htmlElement.videoHeight,Z=W*t.htmlElement.videoWidth,ft=H*t.htmlElement.videoHeight;return{imageWidth:t.htmlElement.videoWidth,imageHeight:t.htmlElement.videoHeight,x:Math.floor(Y),y:Math.floor(M),width:Math.floor(Z-Y),height:Math.floor(ft-M)}}},O=async z=>{try{const $=A();if(!$){er.warning(e()("error_tag_face_bounding_box"));return}if(!await Dr.showDialog({prompt:z.name?e()("confirm_tag_face",{values:{name:z.name}}):e()("confirm_tag_face_unnamed")}))return;await Pu({assetFaceCreateDto:{assetId:t.assetId,personId:z.id,...$}}),await _n.setAssetId(t.assetId)}catch($){ce($,"Error tagging face")}finally{ds.value=!1}};var P=Hm(),L=b(P);Je(L,z=>U(i,z),()=>h(i));var E=k(L,2),_=b(E),j=b(_,!0);w(_);var X=k(_,2),G=b(X);{let z=y(()=>e()("search_people"));Ku(G,{get placeholder(){return h(z)},size:"tiny",get value(){return h(d)},set value($){U(d,$,!0)}})}w(X);var R=k(X,2),B=b(R);{var V=z=>{var $=Vm();pr($,21,()=>h(g),J=>J.id,(J,rt)=>{var it=zm();it.__click=()=>O(h(rt));var ht=b(it);{let D=y(()=>vi(h(rt)));as(ht,{curve:!0,shadow:!0,get url(){return h(D)},get altText(){return h(rt).name},get title(){return h(rt).name},widthStyle:"30px",heightStyle:"30px"})}var nt=k(ht,2),ut=b(nt,!0);w(nt),w(it),lt(()=>dt(ut,h(rt).name)),I(J,it)}),w($),I(z,$)},Q=z=>{var $=Wm(),J=b($),rt=b(J,!0);w(J),w($),lt(it=>dt(rt,it),[()=>e()("no_people_found")]),I(z,$)};K(B,z=>{h(g).length>0?z(V):z(Q,!1)})}w(R);var tt=k(R,2);gn(tt,{size:"small",fullWidth:!0,onclick:v,color:"danger",class:"mt-2",children:(z,$)=>{Ne();var J=pe();lt(rt=>dt(J,rt),[()=>e()("cancel")]),I(z,J)},$$slots:{default:!0}}),w(E),Je(E,z=>U(l,z),()=>h(l)),w(P),lt(z=>dt(j,z),[()=>e()("select_person_to_tag")]),I(a,P),Dt(),s()}Zr(["click"]);const Ym=a=>{const t=a.naturalWidth/a.naturalHeight;let e=a.height*t,r=a.height;return e>a.width&&(e=a.width,r=a.width/t),{width:e,height:r}},Xm=a=>{const[t,e,r,s]=a,i=Math.min(...a.map(({x:O})=>O)),n=Math.max(...a.map(({x:O})=>O)),o=Math.min(...a.map(({y:O})=>O)),l=Math.max(...a.map(({y:O})=>O)),c=n-i,u=l-o,d=(i+n)/2,g=(o+l)/2,f=Math.atan2(r.y-s.y,r.x-s.x)*(180/Math.PI),m=Math.atan2(s.y-t.y,s.x-t.x),v=(Math.atan2(r.y-e.y,r.x-e.x)-m)*(180/Math.PI),x=Math.atan2(e.y-t.y,e.x-t.x),A=(Math.atan2(r.y-s.y,r.x-s.x)-x)*(180/Math.PI);return{minX:i,maxX:n,minY:o,maxY:l,width:c,height:u,centerX:d,centerY:g,rotation:f,skewX:v,skewY:A}},Nm=(a,t,e)=>{const r=[];if(e===null||!e.naturalWidth||!e.naturalHeight)return r;const s=e.clientHeight,i=e.clientWidth,{width:n,height:o}=Ym(e),l=e.naturalWidth,c=e.naturalHeight;for(const u of a){const d=[{x:u.x1,y:u.y1},{x:u.x2,y:u.y2},{x:u.x3,y:u.y3},{x:u.x4,y:u.y4}].map(g=>({x:n/l*t.currentZoom*g.x*l+(i-n)/2*t.currentZoom+t.currentPositionX,y:o/c*t.currentZoom*g.y*c+(s-o)/2*t.currentZoom+t.currentPositionY}));r.push({id:u.id,points:d,text:u.text,confidence:u.textScore})}return r};var Um=q('<div class="absolute group left-0 top-0 pointer-events-none"><div class="absolute border-2 border-blue-500 bg-blue-500/10 cursor-pointer pointer-events-auto transition-all group-hover:bg-blue-500/30 group-hover:border-blue-600 group-hover:border-[3px]"></div> <div class="absolute flex items-center justify-center text-transparent text-sm px-2 py-1 pointer-events-auto cursor-text whitespace-pre-wrap wrap-break-word select-text group-hover:text-white group-hover:bg-black/75 group-hover:z-10"> </div></div>');function Gm(a,t){At(t,!0);const e=y(()=>Xm(t.ocrBox.points)),r=y(()=>`translate(${h(e).minX}px, ${h(e).minY}px) rotate(${h(e).rotation}deg) skew(${h(e).skewX}deg, ${h(e).skewY}deg)`),s=y(()=>`${h(e).centerX-h(e).minX}px ${h(e).centerY-h(e).minY}px`);var i=Um(),n=b(i),o=k(n,2),l=b(o,!0);w(o),w(i),lt(()=>{us(n,`width: ${h(e).width??""}px; height: ${h(e).height??""}px; transform: ${h(r)??""}; transform-origin: ${h(s)??""};`),us(o,`width: ${h(e).width??""}px; height: ${h(e).height??""}px; transform: ${h(r)??""}; transform-origin: ${h(s)??""};`),dt(l,t.ocrBox.text)}),I(a,i),Dt()}function qm(a,t){At(t,!0);const e=qh(t,["$$slots","$$events","$$legacy"]);tr(()=>{const r={};for(const[s,i]of Object.entries(e))if(i){const n=s.slice(2);r[n]=i}return Rt.on(r)}),Dt()}class $m{#t=st(ue([]));#r=st(!1);get showOverlay(){return h(this.#r)}set showOverlay(t){U(this.#r,t,!0)}#i=y(()=>h(this.#t).length>0);#s=new Ju;#e=!1;get data(){return h(this.#t)}get hasOcrData(){return h(this.#i)}async getAssetOcr(t){this.#e&&(await this.#s.reset(),this.#e=!1),await this.#s.execute(async()=>{U(this.#t,await Zu.getAssetOcr(t),!0)},!1)}clear(){this.#e=!0,U(this.#t,[],!0),this.showOverlay=!1}toggleOcrBoundingBox(){this.showOverlay=!this.showOverlay}}const kr=new $m,Or=$c([]),Km=a=>{const t=a.naturalWidth/a.naturalHeight;let e=a.height*t,r=a.height;return e>a.width&&(e=a.width,r=a.width/t),{width:e,height:r}},Zm=(a,t,e)=>{const r=[];if(!e)return r;const s=e.clientHeight,i=e.clientWidth,{width:n,height:o}=Km(e);for(const l of a){const c={x1:n/l.imageWidth*t.currentZoom*l.boundingBoxX1+(i-n)/2*t.currentZoom+t.currentPositionX,x2:n/l.imageWidth*t.currentZoom*l.boundingBoxX2+(i-n)/2*t.currentZoom+t.currentPositionX,y1:o/l.imageHeight*t.currentZoom*l.boundingBoxY1+(s-o)/2*t.currentZoom+t.currentPositionY,y2:o/l.imageHeight*t.currentZoom*l.boundingBoxY2+(s-o)/2*t.currentZoom+t.currentPositionY};r.push({top:Math.round(c.y1),left:Math.round(c.x1),width:Math.round(c.x2-c.x1),height:Math.round(c.y2-c.y1)})}return r},Bc=async(a,t,e,r)=>{let s;if(e===cs.Image)s=r;else if(e===cs.Video){const x=ks({id:t}),T=new Image;T.src=x,await new Promise(A=>{T.addEventListener("load",()=>A()),T.addEventListener("error",()=>A())}),s=T}if(!s)return null;const{boundingBoxX1:i,boundingBoxX2:n,boundingBoxY1:o,boundingBoxY2:l,imageWidth:c,imageHeight:u}=a,d={x1:s.naturalWidth/c*i,x2:s.naturalWidth/c*n,y1:s.naturalHeight/u*o,y2:s.naturalHeight/u*l},g=d.x2-d.x1,f=d.y2-d.y1,m=new Image;m.src=s.src,await new Promise(x=>{m.addEventListener("load",x),m.addEventListener("error",()=>x(null))});const p=document.createElement("canvas");p.width=g,p.height=f;const v=p.getContext("2d");return v?(v.drawImage(m,d.x1,d.y1,g,f,0,0,g,f),p.toDataURL()):null},Jm=300,Qm=60,zc="none";function tp(a){return Array.isArray(a)?a:[a]}function ci(a,t,e){return a.addEventListener(t,e),()=>a.removeEventListener(t,e)}function ep(a,t){return t.filter(e=>a.pointerId!==e.pointerId)}function rp(a,t){const e=a.getBoundingClientRect();return{x:Math.round(t.clientX-e.left),y:Math.round(t.clientY-e.top)}}function sp(a,t,e){const{x:r,y:s}=rp(a,t);return{event:t,pointersCount:e.length,target:t.target,x:r,y:s,attachmentNode:a}}function ho(a,t,e,r,s){const i=sp(a,e,r);return a.dispatchEvent(new CustomEvent(`${t}${s}`,{detail:i})),i}function ip(){let a=[],t=()=>{},e=[];return{setPointerControls:(r,s,i,n,o,l=zc,c=[])=>(s.style.touchAction=tp(l).join(" "),e=c,e.forEach(u=>{u.onInit?.(a)}),a.length||(t=ci(s,"pointerdown",function(d){a.push(d);const g=ho(s,r,d,a,"down");n?.(a,d),setTimeout(()=>{e.forEach(A=>{A.onDown?.(g,a)})});function f(A){const O=a.length;if(a=ep(A,a),O>a.length){a.length||m();const L=ho(s,r,A,a,"up");o?.(a,A),setTimeout(()=>{e.forEach(E=>{E.onUp?.(L,a)})})}}function m(){p(),v(),x(),T()}const p=ci(s,"pointermove",A=>{a=a.map(P=>A.pointerId===P.pointerId?A:P);const O=ho(s,r,A,a,"move");i?.(a,A),e.forEach(P=>{P.onMove?.(O,a)})}),v=ci(s,"lostpointercapture",A=>{f(A)}),x=ci(s,"pointerup",A=>{f(A)}),T=ci(s,"pointerleave",A=>{f(A)})})),{destroy:()=>{a.length||(t(),e.forEach(u=>{u.onDestroy?.()}))}})}}const np="@attach";function op(){return Symbol(np)}const dn="swipe";function ea(a,t,e,r=!1){const{setPointerControls:s}=ip(),i=r?dn:op();return{...e,[`on${dn}`]:a,[i]:n=>{const{onDown:o,onUp:l,parameters:c}=ap(n,t?.());return s(dn,n,null,o,l,c.touchAction,c.plugins).destroy}}}function ap(a,t){const e={timeframe:Jm,minSwipeDistance:Qm,touchAction:zc,composed:!1,...t};let r,s,i,n;function o(c,u){s=u.clientX,i=u.clientY,r=Date.now(),c.length===1&&(n=u.target)}function l(c,u){if(u.type==="pointerup"&&c.length===0&&Date.now()-r<e.timeframe){const d=u.clientX-s,g=u.clientY-i,f=Math.abs(d),m=Math.abs(g);let p=null;f>=2*m&&f>e.minSwipeDistance?p=d>0?"right":"left":m>=2*f&&m>e.minSwipeDistance&&(p=g>0?"bottom":"top"),p&&a.dispatchEvent(new CustomEvent(dn,{detail:{direction:p,target:n,pointerType:u.pointerType}}))}}return{onDown:o,onUp:l,parameters:e}}var lp=q('<div id="broken-asset" class="h-full w-full svelte-raj50z"><!></div>'),cp=q('<div id="spinner" class="flex h-full items-center justify-center svelte-raj50z"><!></div>'),hp=q('<img alt="" class="-z-1 absolute top-0 start-0 object-cover h-full w-full blur-lg" draggable="false"/>'),up=q('<div class="absolute border-solid border-white border-3 rounded-lg"></div>'),dp=q('<div><!> <img draggable="false"/> <!> <!></div> <!>',1),gp=q('<!> <!> <img style="display:none" alt="" aria-hidden="true"/> <div class="relative h-full w-full select-none"><!></div>',1);function Oo(a,t){At(t,!0);const e=()=>at(Or,"$boundingBoxesArray",o),r=()=>at(zt,"$t",o),s=()=>at(m,"$slideshowState",o),i=()=>at(p,"$slideshowLook",o),n=()=>at(Ol,"$getAltText",o),[o,l]=It();let c=Tt(t,"element",15),u=Tt(t,"haveFadeTransition",3,!0),d=Tt(t,"sharedLink",3,void 0),g=Tt(t,"onPreviousAsset",3,null),f=Tt(t,"onNextAsset",3,null);const{slideshowState:m,slideshowLook:p}=Ln,v=y(()=>t.cursor.current);let x=st(!1),T=st(!1),A=st(!1),O=st(void 0);Kc(()=>{h(v).id,ls(()=>{Rt.resetZoomState(),Zt(Or,[])})}),qs(()=>{Zt(Or,[])});let P=y(()=>kr.showOverlay&&Rt.imgRef?Nm(kr.data,Rt.zoomState,Rt.imgRef):[]),L=y(()=>kr.showOverlay);const E=async()=>{if(!(!au()||!Rt.imgRef))try{await lu(Rt.imgRef),er.info(r()("copied_image_to_clipboard"))}catch(M){ce(M,r()("copy_error"))}},_=()=>{Rt.zoom=Rt.zoom>1?1:2},j=()=>Zt(m,oe.PlaySlideshow);Ee(()=>{ds.value&&Rt.zoom>1&&_()});const X=M=>{globalThis.getSelection()?.type!=="Range"&&(M.preventDefault(),Sr(E()))},G=M=>{Rt.zoom>1||kr.showOverlay||(f()&&M.detail.direction==="left"&&f()(),g()&&M.detail.direction==="right"&&g()())},R=y(()=>cu(h(v),h(T)||Rt.zoom>1));Ee(()=>{h(tt)&&B(h(tt))});const B=async M=>{if(!M||!be.isCasting)return;const Z=new URL(M,globalThis.location.href);try{await be.loadMedia(Z.href)}catch(ft){ce(ft,"Unable to cast");return}},V=()=>{U(x,!0),U(T,h(R)===hs.Fullsize||h(R)==="original",!0)},Q=()=>{U(A,U(x,!0),!0)};qs(()=>hi.cancelPreloadUrl(h(tt)));let tt=y(()=>Do({asset:h(v),sharedLink:d(),forceOriginal:h(T)||Rt.zoom>1})),z=st(0),$=st(0),J;Ee(()=>{J&&J!==h(tt)&&ls(()=>{U(x,!1),U(T,!1),U(A,!1)}),J=h(tt)});var rt=gp();Ue(ze,(M,Z)=>Ps?.(M,Z),()=>[{shortcut:{key:"z"},onShortcut:_,preventDefault:!0},{shortcut:{key:"s"},onShortcut:j,preventDefault:!0},{shortcut:{key:"c",ctrl:!0},onShortcut:X,preventDefault:!1},{shortcut:{key:"c",meta:!0},onShortcut:X,preventDefault:!1}]);var it=Ct(rt);qm(it,{onCopy:E,onZoom:_});var ht=k(it,2);{var nt=M=>{var Z=lp(),ft=b(Z);$u(ft,{class:"text-xl h-full w-full"}),w(Z),I(M,Z)};K(ht,M=>{h(A)&&M(nt)})}var ut=k(ht,2);Je(ut,M=>U(O,M),()=>h(O));var D=k(ut,2),W=b(D);{var H=M=>{var Z=cp(),ft=b(Z);gr(ft,{}),w(Z),I(M,Z)},Y=M=>{var Z=dp(),ft=Ct(Z);pl(ft,Ft=>({...Ft,class:"h-full w-full"}),[()=>ea(G)],void 0,void 0,"svelte-raj50z");var Lt=b(ft);{var vt=Ft=>{var me=hp();lt(()=>Nt(me,"src",h(tt))),I(Ft,me)};K(Lt,Ft=>{s()!==oe.None&&i()===nn.BlurredBackground&&Ft(vt)})}var Pt=k(Lt,2);Je(Pt,Ft=>Rt.imgRef=Ft,()=>Rt?.imgRef);var Ht=k(Pt,2);pr(Ht,1,()=>Zm(e(),Rt.zoomState,Rt.imgRef),dl,(Ft,me)=>{var vr=up();lt(()=>us(vr,`top: ${h(me).top??""}px; left: ${h(me).left??""}px; height: ${h(me).height??""}px; width: ${h(me).width??""}px;`)),I(Ft,vr)});var ke=k(Ht,2);pr(ke,17,()=>h(P),Ft=>Ft.id,(Ft,me)=>{Gm(Ft,{get ocrBox(){return h(me)}})}),w(ft),Ue(ft,(Ft,me)=>$d?.(Ft,me),()=>({disabled:h(L)}));var Vt=k(ft,2);{var fe=Ft=>{Rc(Ft,{get htmlElement(){return Rt.imgRef},get containerWidth(){return h(z)},get containerHeight(){return h($)},get assetId(){return h(v).id}})};K(Vt,Ft=>{ds.value&&Ft(fe)})}lt(Ft=>{Nt(Pt,"src",h(tt)),Nt(Pt,"alt",Ft),fr(Pt,1,`h-full w-full ${(s()===oe.None?"object-contain":td[i()])??""}`)},[()=>n()(Pe(h(v)))]),Qe(3,ft,()=>Pn,()=>({duration:u()?bl:0})),I(M,Z)};K(W,M=>{h(x)?h(A)||M(Y,1):M(H)})}w(D),Je(D,M=>c(M),()=>c()),lt(()=>Nt(ut,"src",h(tt))),Be("load",ut,V),Be("error",ut,Q),Xc(ut),vn(D,"clientWidth",M=>U(z,M)),vn(D,"clientHeight",M=>U($,M)),I(a,rt),Dt(),l()}var fp=q('<div class="flex place-items-center items-center justify-center"><div class="relative flex aspect-square w-62.5 overflow-hidden rounded-full border-4 border-immich-primary bg-immich-dark-primary dark:border-immich-dark-primary dark:bg-immich-primary"><!></div></div>');function mp(a,t){At(t,!0);const e=()=>at(zt,"$t",s),r=()=>at(Xs,"$user",s),[s,i]=It();let n=st(void 0);tr(()=>{h(n)&&(h(n).style.width="100%")});const o=async c=>{const u=new Image;u.src=URL.createObjectURL(c),await u.decode();const d=document.createElement("canvas");d.width=u.width,d.height=u.height;const g=d.getContext("2d");if(!g)throw new Error("Could not get canvas context.");g.drawImage(u,0,0);const m=g.getImageData(0,0,d.width,d.height)?.data;if(!m)throw new Error("Could not get image data.");for(let p=0;p<m.length;p+=4)if(m[p+3]<255)return!0;return!1},l=async()=>{if(h(n))try{const c=h(n).offsetHeight,u=h(n).offsetWidth,d=await Wd.toBlob(h(n),{width:u,height:c});if(await o(d)){er.danger(e()("errors.profile_picture_transparent_pixels"));return}const g=new File([d],"profile-picture.png",{type:"image/png"}),{profileImagePath:f,profileChangedAt:m}=await Mu({createProfileImageDto:{file:g}});er.success(e()("profile_picture_set")),la(Xs,ls(r).profileImagePath=f,ls(r)),la(Xs,ls(r).profileChangedAt=m,ls(r)),t.onClose()}catch(c){ce(c,e()("errors.unable_to_set_profile_picture"))}};{let c=y(()=>e()("set_profile_picture"));Io(a,{size:"small",get title(){return h(c)},get onClose(){return t.onClose},onSubmit:l,children:(u,d)=>{var g=fp(),f=b(g),m=b(f);{let p=y(()=>({current:t.asset}));Oo(m,{get cursor(){return h(p)},get element(){return h(n)},set element(v){U(n,v,!0)}})}w(f),w(g),I(u,g)},$$slots:{default:!0}})}Dt(),i()}function pp(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It();{let i=y(()=>e()("set_as_profile_picture"));Se(a,{get icon(){return lh},onClick:()=>Dr.show(mp,{asset:t.asset}),get text(){return h(i)}})}Dt(),s()}function vp(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It(),i=async()=>{const n=await Iu({id:t.stack.id,stackUpdateDto:{primaryAssetId:t.asset.id}});n&&t.onAction({type:Gt.SET_STACK_PRIMARY_ASSET,stack:n})};{let n=y(()=>e()("set_stack_primary_asset"));Se(a,{get icon(){return ch},onClick:i,get text(){return h(n)}})}Dt(),s()}function _p(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It(),i=t.asset.visibility===sn.Locked,n=async()=>{if(await Dr.showDialog({title:i?e()("remove_from_locked_folder"):e()("move_to_locked_folder"),prompt:i?e()("remove_from_locked_folder_confirmation"):e()("move_to_locked_folder_confirmation"),confirmText:e()("move"),confirmColor:i?"danger":"primary",icon:i?ia:na}))try{t.preAction({type:i?Gt.SET_VISIBILITY_TIMELINE:Gt.SET_VISIBILITY_LOCKED,asset:t.asset}),await Lu({assetBulkUpdateDto:{ids:[t.asset.id],visibility:i?sn.Timeline:sn.Locked}}),t.onAction({type:i?Gt.SET_VISIBILITY_TIMELINE:Gt.SET_VISIBILITY_LOCKED,asset:t.asset})}catch(l){ce(l,e()("errors.unable_to_save_settings"))}};{let o=y(()=>i?e()("move_off_locked_folder"):e()("move_to_locked_folder")),l=y(()=>i?ia:na);Se(a,{onClick:()=>n(),get text(){return h(o)},get icon(){return h(l)}})}Dt(),s()}function yp(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It(),i=async()=>{const n=await hu([t.stack.id]);n&&t.onAction({type:Gt.UNSTACK,assets:n.map(o=>Pe(o))})};{let n=y(()=>e()("unstack"));Se(a,{get icon(){return hh},onClick:i,get text(){return h(n)}})}Dt(),s()}var xp=q("<!> <!>",1),wp=q("<!> <!>",1),bp=q("<!> <!> <!>",1),Sp=q("<!> <!>",1),Cp=q("<!> <!> <!>",1),Tp=q("<!> <!>",1),kp=q("<hr/> <!> <!> <!> <!>",1),Op=q("<!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!>",1),Ap=q('<!> <div class="flex h-16 place-items-center justify-between bg-linear-to-b from-black/40 px-3 transition-transform duration-200"><div class="dark"><!></div> <div class="flex gap-2 overflow-x-auto dark" data-testid="asset-viewer-navbar-actions"><!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!></div></div>',1);function Dp(a,t){At(t,!0);const e=()=>at(Xs,"$user",s),r=()=>at(zt,"$t",s),[s,i]=It();let n=Tt(t,"album",3,null),o=Tt(t,"person",3,null),l=Tt(t,"stack",3,null),c=Tt(t,"showSlideshow",3,!1),u=Tt(t,"onUndoDelete",3,void 0),d=Tt(t,"playOriginalVideo",3,!1);const g=y(()=>e()&&t.asset.ownerId===e()?.id),f=y(()=>t.asset.visibility===sn.Locked),m=y(()=>Eo.value.smartSearch),p=y(()=>Zh(r())),v=y(()=>h(p).Cast),x=y(()=>({title:r()("go_back"),type:r()("assets"),icon:fh,$if:()=>!!t.onClose,onAction:()=>t.onClose?.(),shortcuts:[{key:"Escape"}]})),T=y(()=>Mo(r(),t.asset)),A=y(()=>h(T).Share),O=y(()=>h(T).Download),P=y(()=>h(T).DownloadOriginal),L=y(()=>h(T).SharedLinkDownload),E=y(()=>h(T).Offline),_=y(()=>h(T).Favorite),j=y(()=>h(T).Unfavorite),X=y(()=>h(T).PlayMotionPhoto),G=y(()=>h(T).StopMotionPhoto),R=y(()=>h(T).ZoomIn),B=y(()=>h(T).ZoomOut),V=y(()=>h(T).Copy),Q=y(()=>h(T).Info),tt=y(()=>h(T).Edit),z=y(()=>h(T).RefreshFacesJob),$=y(()=>h(T).RefreshMetadataJob),J=y(()=>h(T).RegenerateThumbnailJob),rt=y(()=>h(T).TranscodeVideoJob),it=Cl();var ht=Ap(),nt=Ct(ht);{let ae=y(()=>r()("assets")),xr=y(()=>uu([h(x),h(v),h(A),h(O),h(P),h(L),h(E),h(_),h(j),h(X),h(G),h(R),h(B),h(V),h(Q),h(tt),h(z),h($),h(J),h(rt)]));Dl(nt,{get name(){return h(ae)},get actions(){return h(xr)}})}var ut=k(nt,2),D=b(ut),W=b(D);je(W,{get action(){return h(x)}}),w(D);var H=k(D,2),Y=b(H);je(Y,{get action(){return h(v)}});var M=k(Y,2);je(M,{get action(){return h(A)}});var Z=k(M,2);je(Z,{get action(){return h(E)}});var ft=k(Z,2);je(ft,{get action(){return h(X)}});var Lt=k(ft,2);je(Lt,{get action(){return h(G)}});var vt=k(Lt,2);je(vt,{get action(){return h(R)}});var Pt=k(vt,2);je(Pt,{get action(){return h(B)}});var Ht=k(Pt,2);je(Ht,{get action(){return h(V)}});var ke=k(Ht,2);je(ke,{get action(){return h(L)}});var Vt=k(ke,2);je(Vt,{get action(){return h(Q)}});var fe=k(Vt,2);je(fe,{get action(){return h(_)}});var Ft=k(fe,2);je(Ft,{get action(){return h(j)}});var me=k(Ft,2);{var vr=ae=>{Ld(ae,{get asset(){return t.asset},get onAction(){return t.onAction}})};K(me,ae=>{h(g)&&ae(vr)})}var Pr=k(me,2);je(Pr,{get action(){return h(tt)}});var ts=k(Pr,2);{var _r=ae=>{Md(ae,{get asset(){return t.asset},get onAction(){return t.onAction},get preAction(){return t.preAction},get onUndoDelete(){return u()}})};K(ts,ae=>{h(g)&&ae(_r)})}var es=k(ts,2);{var yr=ae=>{{let xr=y(()=>r()("more"));ed(ae,{direction:"left",align:"top-right",color:"secondary",get title(){return h(xr)},get icon(){return uh},children:(rs,Mr)=>{var Ir=Op(),Lr=Ct(Ir);{var ss=xt=>{{let te=y(()=>r()("slideshow"));Se(xt,{get icon(){return dh},get text(){return h(te)},get onClick(){return t.onPlaySlideshow}})}};K(Lr,xt=>{c()&&!h(f)&&xt(ss)})}var wr=k(Lr,2);Ls(wr,{get action(){return h(O)}});var jt=k(wr,2);Ls(jt,{get action(){return h(P)}});var Yt=k(jt,2);{var et=xt=>{var te=Ce(),se=Ct(te);{var N=yt=>{jd(yt,{get asset(){return t.asset},get onAction(){return t.onAction}})},ct=yt=>{var Ut=xp(),Oe=Ct(Ut);pa(Oe,{get asset(){return t.asset},get onAction(){return t.onAction}});var xe=k(Oe,2);pa(xe,{get asset(){return t.asset},get onAction(){return t.onAction},shared:!0}),I(yt,Ut)};K(se,yt=>{t.asset.isTrashed?yt(N):yt(ct,!1)})}I(xt,te)};K(Yt,xt=>{h(f)||xt(et)})}var ot=k(Yt,2);{var _t=xt=>{var te=Sp(),se=Ct(te);Ed(se,{get asset(){return t.asset},get stack(){return l()},get onAction(){return t.onAction}});var N=k(se,2);{var ct=yt=>{var Ut=bp(),Oe=Ct(Ut);yp(Oe,{get stack(){return l()},get onAction(){return t.onAction}});var xe=k(Oe,2);Id(xe,{get stack(){return l()},get asset(){return t.asset},get onAction(){return t.onAction}});var we=k(xe,2);{var br=ir=>{var Ae=wp(),Fr=Ct(Ae);vp(Fr,{get stack(){return l()},get asset(){return t.asset},get onAction(){return t.onAction}});var jr=k(Fr,2);{var ps=Rr=>{Fd(Rr,{get asset(){return t.asset},get stack(){return l()},get onAction(){return t.onAction}})};K(jr,Rr=>{l()?.assets?.length>2&&Rr(ps)})}I(ir,Ae)};K(we,ir=>{l()?.primaryAssetId!==t.asset.id&&ir(br)})}I(yt,Ut)};K(N,yt=>{l()&&yt(ct)})}I(xt,te)};K(ot,xt=>{h(g)&&xt(_t)})}var bt=k(ot,2);{var St=xt=>{Rd(xt,{get asset(){return t.asset},get album(){return n()}})};K(bt,xt=>{n()&&xt(St)})}var kt=k(bt,2);{var Ot=xt=>{Bd(xt,{get asset(){return t.asset},get person(){return o()},get onAction(){return t.onAction}})};K(kt,xt=>{o()&&xt(Ot)})}var Et=k(kt,2);{var Xt=xt=>{pp(xt,{get asset(){return t.asset}})};K(Et,xt=>{t.asset.type===cs.Image&&!h(f)&&xt(Xt)})}var qt=k(Et,2);{var ne=xt=>{var te=Tp(),se=Ct(te);{var N=Ut=>{var Oe=Cp(),xe=Ct(Oe);Pd(xe,{get asset(){return t.asset},get onAction(){return t.onAction},get preAction(){return t.preAction}});var we=k(xe,2);{let Ae=y(()=>r()("replace_with_upload"));Se(we,{get icon(){return mh},onClick:()=>qu(t.asset.id),get text(){return h(Ae)}})}var br=k(we,2);{var ir=Ae=>{{let Fr=y(()=>r()("view_in_timeline"));Se(Ae,{get icon(){return vh},onClick:()=>fn($e.photos({at:l()?.primaryAssetId??t.asset.id})),get text(){return h(Fr)}})}};K(br,Ae=>{!t.asset.isArchived&&!t.asset.isTrashed&&Ae(ir)})}I(Ut,Oe)};K(se,Ut=>{h(g)&&Ut(N)})}var ct=k(se,2);{var yt=Ut=>{{let Oe=y(()=>r()("view_similar_photos"));Se(Ut,{get icon(){return ph},onClick:()=>fn($e.search({queryAssetId:l()?.primaryAssetId??t.asset.id})),get text(){return h(Oe)}})}};K(ct,Ut=>{!t.asset.isArchived&&!t.asset.isTrashed&&h(m)&&Ut(yt)})}I(xt,te)};K(qt,xt=>{h(f)||xt(ne)})}var ee=k(qt,2);{var mt=xt=>{{let te=y(()=>Pe(t.asset));_p(xt,{get asset(){return h(te)},get onAction(){return t.onAction},get preAction(){return t.preAction}})}};K(ee,xt=>{!t.asset.isTrashed&&h(g)&&xt(mt)})}var pt=k(ee,2);{var wt=xt=>{{let te=y(()=>d()?r()("play_transcoded_video"):r()("play_original_video"));Se(xt,{get icon(){return gh},onClick:()=>t.setPlayOriginalVideo(!d()),get text(){return h(te)}})}};K(pt,xt=>{t.asset.type===cs.Video&&xt(wt)})}var Mt=k(pt,2);{var he=xt=>{var te=kp(),se=k(Ct(te),2);Ls(se,{get action(){return h(z)}});var N=k(se,2);Ls(N,{get action(){return h($)}});var ct=k(N,2);Ls(ct,{get action(){return h(J)}});var yt=k(ct,2);Ls(yt,{get action(){return h(rt)}}),I(xt,te)};K(Mt,xt=>{h(g)&&xt(he)})}I(rs,Ir)},$$slots:{default:!0}})}};K(es,ae=>{it||ae(yr)})}w(H),w(ut),I(a,ht),Dt(),i()}function ll(){return{a:1,c:0,e:0,b:0,d:1,f:0}}function Vc(...a){a=Array.isArray(a[0])?a[0]:a;const t=(e,r)=>({a:e.a*r.a+e.c*r.b,c:e.a*r.c+e.c*r.d,e:e.a*r.e+e.c*r.f+e.e,b:e.b*r.a+e.d*r.b,d:e.b*r.c+e.d*r.d,f:e.b*r.e+e.d*r.f+e.f});switch(a.length){case 0:throw new Error("no matrices provided");case 1:return a[0];case 2:return t(a[0],a[1]);default:{const[e,r,...s]=a,i=t(e,r);return Vc(i,...s)}}}function Ep(...a){return Vc(...a)}const{cos:Pp,sin:Mp}=Math;function Ip(a,t,e){const r=Pp(a),s=Mp(a);return{a:r,c:-s,e:0,b:s,d:r,f:0}}function Lp(){return{a:1,c:0,e:0,b:0,d:-1,f:0}}function Fp(){return{a:-1,c:0,e:0,b:0,d:1,f:0}}const cl=(a,t=1e-15)=>Math.abs(a)<t,jp=a=>{const{a:t,b:e,c:r,d:s}=Rp(a),i=(cl(t)?Math.asin(r):Math.acos(t))*180/Math.PI;return{rotation:i<0?360+i:i,mirrorHorizontal:!1,mirrorVertical:cl(t)?e===r:t===-s}},Rp=a=>Ep(ll(),...a.map(t=>{switch(t.action){case"rotate":{const r=-t.parameters.angle*Math.PI/180;return Ip(r)}case"mirror":return t.parameters.axis==="horizontal"?Fp():Lp();default:return ll()}}));class Bp{#t=y(()=>this.checkEdits());get canReset(){return h(this.#t)}set canReset(t){U(this.#t,t)}#r=st(!1);get hasChanges(){return h(this.#r)}set hasChanges(t){U(this.#r,t,!0)}#i=st(.65);get darkenLevel(){return h(this.#i)}set darkenLevel(t){U(this.#i,t,!0)}#s=st(!1);get isInteracting(){return h(this.#s)}set isInteracting(t){U(this.#s,t,!0)}#e=st(!1);get isDragging(){return h(this.#e)}set isDragging(t){U(this.#e,t,!0)}#n=st(null);get animationFrame(){return h(this.#n)}set animationFrame(t){U(this.#n,t,!0)}#o=st("default");get canvasCursor(){return h(this.#o)}set canvasCursor(t){U(this.#o,t,!0)}#a=st(ue({x:0,y:0}));get dragOffset(){return h(this.#a)}set dragOffset(t){U(this.#a,t,!0)}#l=st("");get resizeSide(){return h(this.#l)}set resizeSide(t){U(this.#l,t,!0)}#c=st(null);get imgElement(){return h(this.#c)}set imgElement(t){U(this.#c,t,!0)}#h=st(null);get cropAreaEl(){return h(this.#h)}set cropAreaEl(t){U(this.#h,t,!0)}#u=st(null);get overlayEl(){return h(this.#u)}set overlayEl(t){U(this.#u,t,!0)}#d=st(null);get cropFrame(){return h(this.#d)}set cropFrame(t){U(this.#d,t,!0)}#g=st(ue({width:1e3,height:1e3}));get cropImageSize(){return h(this.#g)}set cropImageSize(t){U(this.#g,t,!0)}#f=st(1);get cropImageScale(){return h(this.#f)}set cropImageScale(t){U(this.#f,t,!0)}#m=st("free");get cropAspectRatio(){return h(this.#m)}set cropAspectRatio(t){U(this.#m,t,!0)}#p=st(ue({width:1e3,height:1e3}));get originalImageSize(){return h(this.#p)}set originalImageSize(t){U(this.#p,t,!0)}#v=st(ue({x:0,y:0,width:100,height:100}));get region(){return h(this.#v)}set region(t){U(this.#v,t,!0)}#_=y(()=>({width:this.cropImageSize.width*this.cropImageScale,height:this.cropImageSize.height*this.cropImageScale}));get previewImageSize(){return h(this.#_)}set previewImageSize(t){U(this.#_,t)}#y=st(0);get imageRotation(){return h(this.#y)}set imageRotation(t){U(this.#y,t,!0)}#x=st(!1);get mirrorHorizontal(){return h(this.#x)}set mirrorHorizontal(t){U(this.#x,t,!0)}#w=st(!1);get mirrorVertical(){return h(this.#w)}set mirrorVertical(t){U(this.#w,t,!0)}#b=y(()=>{const t=this.imageRotation%360;return t<0?t+360:t});get normalizedRotation(){return h(this.#b)}set normalizedRotation(t){U(this.#b,t)}#S=y(()=>this.normalizedRotation%180>0);get orientationChanged(){return h(this.#S)}set orientationChanged(t){U(this.#S,t)}#C=y(()=>this.getEdits());get edits(){return h(this.#C)}set edits(t){U(this.#C,t)}setAspectRatio(t){if(this.hasChanges=!0,this.cropAspectRatio=t,!this.imgElement||!this.cropAreaEl)return;const e=Qt.recalculateCrop(t);e&&(Qt.animateCropChange(this.cropAreaEl,this.region,e),this.region=e)}checkEdits(){return Math.abs(this.previewImageSize.width-this.region.width)>2||Math.abs(this.previewImageSize.height-this.region.height)>2||this.mirrorHorizontal||this.mirrorVertical||this.normalizedRotation!==0}checkCropEdits(){return Math.abs(this.previewImageSize.width-this.region.width)>2||Math.abs(this.previewImageSize.height-this.region.height)>2}getEdits(){const t=[];if(this.checkCropEdits()){let e=this.getRegionInPreviewCoords(this.region);e=this.applyMirrorToCoords(e,this.cropImageSize),e=this.convertRegion({region:e,from:this.cropImageSize,to:this.originalImageSize}),e=this.constrainToBounds(e,this.originalImageSize),t.push({action:ni.Crop,parameters:e})}return this.mirrorHorizontal&&t.push({action:ni.Mirror,parameters:{axis:ga.Horizontal}}),this.mirrorVertical&&t.push({action:ni.Mirror,parameters:{axis:ga.Vertical}}),this.normalizedRotation!==0&&t.push({action:ni.Rotate,parameters:{angle:this.normalizedRotation}}),t}async resetAllChanges(){this.imageRotation=0,this.mirrorHorizontal=!1,this.mirrorVertical=!1,await Gn(),this.onImageLoad([])}async onActivate(t,e){const r=Tl(t.exifInfo);this.originalImageSize={width:r.width??0,height:r.height??0},this.imgElement=new Image;const s=ks({id:t.id,cacheKey:t.thumbhash,edited:!1,size:hs.Preview});this.imgElement.src=s,this.imgElement.addEventListener("load",()=>Qt.onImageLoad(e),{passive:!0}),this.imgElement.addEventListener("error",o=>ce(o,"ErrorLoadingImage"),{passive:!0}),globalThis.addEventListener("mousemove",o=>Qt.handleMouseMove(o),{passive:!0});const i=e.filter(o=>o.action==="rotate"||o.action==="mirror"),n=jp(i);this.imageRotation=n.rotation,this.mirrorHorizontal=n.mirrorHorizontal,this.mirrorVertical=n.mirrorVertical,await Gn(),this.resizeCanvas()}onDeactivate(){globalThis.removeEventListener("mousemove",Qt.handleMouseMove),this.reset()}reset(){this.darkenLevel=.65,this.isInteracting=!1,this.animationFrame=null,this.canvasCursor="default",this.dragOffset={x:0,y:0},this.resizeSide="",this.imgElement=null,this.cropAreaEl&&(this.cropAreaEl.style.cursor=""),document.body.style.cursor="",this.cropAreaEl=null,this.isDragging=!1,this.overlayEl=null,this.imageRotation=0,this.mirrorHorizontal=!1,this.mirrorVertical=!1,this.region={x:0,y:0,width:100,height:100},this.cropImageSize={width:1e3,height:1e3},this.originalImageSize={width:1e3,height:1e3},this.cropImageScale=1,this.cropAspectRatio="free",this.hasChanges=!1}mirror(t){this.hasChanges=!0,this.imageRotation%180!==0&&(t=t==="horizontal"?"vertical":"horizontal"),t==="horizontal"?this.mirrorHorizontal=!this.mirrorHorizontal:this.mirrorVertical=!this.mirrorVertical}async rotate(t){this.hasChanges=!0,this.imageRotation+=t,await Gn(),this.onImageLoad()}recalculateCrop(t=this.cropAspectRatio){if(!this.cropAreaEl)return this.region;const e=this.cropAreaEl.clientWidth,r=this.cropAreaEl.clientHeight,{newWidth:s,newHeight:i}=this.keepAspectRatio(this.region.width,this.region.height,t);let n=s,o=i;return s>e?(n=e,o=e/(s/i)):i>r&&(o=r,n=r*(s/i)),{x:Math.max(0,Math.min(this.region.x,e-n)),y:Math.max(0,Math.min(this.region.y,r-o)),width:n,height:o}}animateCropChange(t,e,r,s=100){if(!t.querySelector(".crop-frame"))return;const n=performance.now(),o={...e},l=c=>{const u=c-n,d=Math.min(u/s,1);e.x=o.x+(r.x-o.x)*d,e.y=o.y+(r.y-o.y)*d,e.width=o.width+(r.width-o.width)*d,e.height=o.height+(r.height-o.height)*d,this.draw(e),d<1&&requestAnimationFrame(l)};requestAnimationFrame(l)}keepAspectRatio(t,e,r=this.cropAspectRatio){const[s,i]=r.split(":").map(Number);return s&&i?{newWidth:e*s/i,newHeight:e}:{newWidth:t,newHeight:e}}getConstrainedDimensions(t,e,r,s,i=50){const{newWidth:n,newHeight:o}=this.adjustDimensions(t,e,this.cropAspectRatio,r,s,i);return{width:Math.max(i,Math.min(n,r)),height:Math.max(i,Math.min(o,s))}}adjustDimensions(t,e,r,s,i,n){let o=t,l=e,c;if(r==="free")c=t/e;else{const[u,d]=r.split(":").map(Number);c=u&&d?u/d:t/e}return r!=="free"&&(l=o/c),o>s&&(o=s,r!=="free"&&(l=o/c)),l>i&&(l=i,r!=="free"&&(o=l*c)),o<n&&(o=n,r!=="free"&&(l=o/c)),l<n&&(l=n,r!=="free"&&(o=l*c)),r!=="free"&&o/l!==c&&(o<n&&(l=o/c),l<n&&(o=l*c)),{newWidth:o,newHeight:l}}draw(t=this.region){this.cropFrame&&(this.cropFrame.style.left=`${t.x}px`,this.cropFrame.style.top=`${t.y}px`,this.cropFrame.style.width=`${t.width}px`,this.cropFrame.style.height=`${t.height}px`,this.drawOverlay(t))}drawOverlay(t){this.overlayEl&&(this.overlayEl.style.clipPath=`
    polygon(
      0% 0%,
      0% 100%,
      100% 100%,
      100% 0%,
      0% 0%,
      ${t.x}px ${t.y}px,
      ${t.x+t.width}px ${t.y}px,
      ${t.x+t.width}px ${t.y+t.height}px,
      ${t.x}px ${t.y+t.height}px,
      ${t.x}px ${t.y}px
    )
  `)}onImageLoad(t=null){const e=this.imgElement;if(!this.cropAreaEl||!e)return;this.cropImageSize={width:e.width,height:e.height};const r=this.calculateScale();if(t===null){const s=this.cropFrame;s?.classList.add("transition"),this.region=this.normalizeCropArea(r),s?.classList.add("transition"),s?.addEventListener("transitionend",()=>s?.classList.remove("transition"),{passive:!0})}else{const s=t.find(i=>i.action===ni.Crop);if(s){const i=s.parameters;let{x:n,y:o,width:l,height:c}=this.convertRegion({region:i,from:this.originalImageSize,to:this.cropImageSize});this.mirrorHorizontal&&(n=e.width-n-l),this.mirrorVertical&&(o=e.height-o-c),this.region={x:n*r,y:o*r,width:l*r,height:c*r}}else this.region={x:0,y:0,width:e.width*r,height:e.height*r}}this.cropImageScale=r,e.style.width=`${e.width*r}px`,e.style.height=`${e.height*r}px`,this.draw()}calculateScale(){const t=this.imgElement,e=this.cropAreaEl;if(!e||!t)return 1;const r=e.clientWidth,s=e.clientHeight;let i=r/t.width;return t.height*i>s&&(i=s/t.height),i}normalizeCropArea(t){const e=this.imgElement;if(!e)return{...this.region};const r=t/this.cropImageScale,s={x:this.region.x*r,y:this.region.y*r,width:this.region.width*r,height:this.region.height*r};return this.constrainToBounds(s,{width:e.width*t,height:e.height*t})}resizeCanvas(){const t=this.imgElement;if(!this.cropAreaEl||!t)return;const r=this.calculateScale();this.region=this.normalizeCropArea(r),this.cropImageScale=r,t.style.width=`${t.width*r}px`,t.style.height=`${t.height*r}px`,this.draw()}handleMouseDown(t){if(!this.cropAreaEl)return;const{mouseX:r,mouseY:s}=this.getMousePosition(t),{onLeftBoundary:i,onRightBoundary:n,onTopBoundary:o,onBottomBoundary:l,onTopLeftCorner:c,onTopRightCorner:u,onBottomLeftCorner:d,onBottomRightCorner:g}=this.isOnCropBoundary(r,s);c||u||d||g||i||n||o||l?this.setResizeSide(r,s):this.isInCropArea(r,s)&&this.startDragging(r,s),document.body.style.userSelect="none",globalThis.addEventListener("mouseup",()=>this.handleMouseUp(),{passive:!0})}handleMouseMove(t){if(!this.cropAreaEl)return;const r=this.resizeSide,{mouseX:s,mouseY:i}=this.getMousePosition(t);this.isDragging?this.moveCrop(s,i):r?this.resizeCrop(s,i):this.updateCursor(s,i)}handleMouseUp(){globalThis.removeEventListener("mouseup",this.handleMouseUp),document.body.style.userSelect="",this.isInteracting=!1,this.isDragging=!1,this.resizeSide="",this.fadeOverlay(!0)}getMousePosition(t){let e=t.clientX,r=t.clientY;const s=this.cropAreaEl?.getBoundingClientRect(),i=this.normalizedRotation;return i==90?(e=t.clientY-(s?.top??0),r=window.innerWidth-t.clientX-(window.innerWidth-(s?.right??0))):i==180?(e=window.innerWidth-t.clientX-(window.innerWidth-(s?.right??0)),r=window.innerHeight-t.clientY-(window.innerHeight-(s?.bottom??0))):i==270?(e=window.innerHeight-t.clientY-(window.innerHeight-(s?.bottom??0)),r=t.clientX-(s?.left??0)):i==0&&(e-=s?.left??0,r-=s?.top??0),{mouseX:e,mouseY:r}}isInRange(t,e,r){return t>=e-r&&t<=e+r}isWithinBounds(t,e,r){return t>=e&&t<=r}isOnCropBoundary(t,e){const{x:r,y:s,width:i,height:n}=this.region,o=10,l=15,{width:c,height:u}=this.cropImageSize;if(t>c||e>u||t<0||e<0)return{onLeftBoundary:!1,onRightBoundary:!1,onTopBoundary:!1,onBottomBoundary:!1,onTopLeftCorner:!1,onTopRightCorner:!1,onBottomLeftCorner:!1,onBottomRightCorner:!1};const g=this.isInRange(t,r,o)&&this.isWithinBounds(e,s,s+n),f=this.isInRange(t,r+i,o)&&this.isWithinBounds(e,s,s+n),m=this.isInRange(e,s,o)&&this.isWithinBounds(t,r,r+i),p=this.isInRange(e,s+n,o)&&this.isWithinBounds(t,r,r+i),v=this.isInRange(t,r,l)&&this.isInRange(e,s,l),x=this.isInRange(t,r+i,l)&&this.isInRange(e,s,l),T=this.isInRange(t,r,l)&&this.isInRange(e,s+n,l),A=this.isInRange(t,r+i,l)&&this.isInRange(e,s+n,l);return{onLeftBoundary:g,onRightBoundary:f,onTopBoundary:m,onBottomBoundary:p,onTopLeftCorner:v,onTopRightCorner:x,onBottomLeftCorner:T,onBottomRightCorner:A}}isInCropArea(t,e){const{x:r,y:s,width:i,height:n}=this.region;return t>=r&&t<=r+i&&e>=s&&e<=s+n}setResizeSide(t,e){const{onLeftBoundary:r,onRightBoundary:s,onTopBoundary:i,onBottomBoundary:n,onTopLeftCorner:o,onTopRightCorner:l,onBottomLeftCorner:c,onBottomRightCorner:u}=this.isOnCropBoundary(t,e);o?this.resizeSide="top-left":l?this.resizeSide="top-right":c?this.resizeSide="bottom-left":u?this.resizeSide="bottom-right":r?this.resizeSide="left":s?this.resizeSide="right":i?this.resizeSide="top":n&&(this.resizeSide="bottom")}startDragging(t,e){this.isDragging=!0;const r=this.region;this.isInteracting=!0,this.dragOffset={x:t-r.x,y:e-r.y},this.fadeOverlay(!1)}moveCrop(t,e){const r=this.cropAreaEl;if(!r)return;this.hasChanges=!0;const s=Math.max(0,Math.min(t-this.dragOffset.x,r.clientWidth-this.region.width)),i=Math.max(0,Math.min(e-this.dragOffset.y,r.clientHeight-this.region.height));this.region={...this.region,x:s,y:i},this.draw()}resizeCrop(t,e){const r=this.cropAreaEl,s=this.region,i=this.resizeSide;if(!r||!i)return;this.fadeOverlay(!1),this.hasChanges=!0;const{x:n,y:o,width:l,height:c}=s,u=50;let d={...s};switch(i){case"left":{const g=l+(n-t);if(g>=u&&t>=0){const{newWidth:f,newHeight:m}=this.keepAspectRatio(g,c),p=Math.max(u,Math.min(f,r.clientWidth)),v=Math.max(u,Math.min(m,r.clientHeight));d={x:Math.max(0,n+l-p),y:o,width:p,height:v}}break}case"right":{const g=t-n;if(g>=u&&t<=r.clientWidth){const{newWidth:f,newHeight:m}=this.keepAspectRatio(g,c);d={...d,width:Math.max(u,Math.min(f,r.clientWidth-n)),height:Math.max(u,Math.min(m,r.clientHeight))}}break}case"top":{const g=c+(o-e);if(g>=u&&e>=0){const{newWidth:f,newHeight:m}=this.adjustDimensions(l,g,this.cropAspectRatio,r.clientWidth,r.clientHeight,u);d={x:n,y:Math.max(0,o+c-m),width:f,height:m}}break}case"bottom":{const g=e-o;if(g>=u&&e<=r.clientHeight){const{newWidth:f,newHeight:m}=this.adjustDimensions(l,g,this.cropAspectRatio,r.clientWidth,r.clientHeight-o,u);d={...d,width:f,height:m}}break}case"top-left":{const g=l+(n-Math.max(t,0)),f=c+(o-Math.max(e,0)),{newWidth:m,newHeight:p}=this.adjustDimensions(g,f,this.cropAspectRatio,r.clientWidth,r.clientHeight,u);d={x:Math.max(0,n+l-m),y:Math.max(0,o+c-p),width:m,height:p};break}case"top-right":{const g=Math.max(t,0)-n,f=c+(o-Math.max(e,0)),{newWidth:m,newHeight:p}=this.adjustDimensions(g,f,this.cropAspectRatio,r.clientWidth-n,o+c,u);d={x:n,y:Math.max(0,o+c-p),width:m,height:p};break}case"bottom-left":{const g=l+(n-Math.max(t,0)),f=Math.max(e,0)-o,{newWidth:m,newHeight:p}=this.adjustDimensions(g,f,this.cropAspectRatio,r.clientWidth,r.clientHeight-o,u);d={x:Math.max(0,n+l-m),y:o,width:m,height:p};break}case"bottom-right":{const g=Math.max(t,0)-n,f=Math.max(e,0)-o,{newWidth:m,newHeight:p}=this.adjustDimensions(g,f,this.cropAspectRatio,r.clientWidth-n,r.clientHeight-o,u);d={...d,width:m,height:p};break}}this.region={...d,x:Math.max(0,Math.min(d.x,r.clientWidth-d.width)),y:Math.max(0,Math.min(d.y,r.clientHeight-d.height))},this.draw()}updateCursor(t,e){if(!this.cropAreaEl)return;let{onLeftBoundary:r,onRightBoundary:s,onTopBoundary:i,onBottomBoundary:n,onTopLeftCorner:o,onTopRightCorner:l,onBottomLeftCorner:c,onBottomRightCorner:u}=this.isOnCropBoundary(t,e);this.normalizedRotation==90?([i,s,n,r]=[r,i,s,n],[o,l,u,c]=[c,o,l,u]):this.normalizedRotation==180?([i,n]=[n,i],[r,s]=[s,r],[o,u]=[u,o],[l,c]=[c,l]):this.normalizedRotation==270&&([i,s,n,r]=[s,n,r,i],[o,l,u,c]=[l,u,c,o]);let d="";o||u?d="nwse-resize":l||c?d="nesw-resize":r||s?d="ew-resize":i||n?d="ns-resize":this.isInCropArea(t,e)?d="move":d="default",this.canvasCursor!=d&&this.cropAreaEl&&!qe.isShowingConfirmDialog&&(this.canvasCursor=d,document.body.style.cursor=d,this.cropAreaEl.style.cursor=d)}fadeOverlay(t){const e=this.overlayEl,r=document.querySelector(".crop-frame");t?(e?.classList.remove("light"),r?.classList.remove("resizing")):(e?.classList.add("light"),r?.classList.add("resizing")),this.isInteracting=!t}resetCrop(){this.cropAspectRatio="free",this.region={x:0,y:0,width:this.cropImageSize.width*this.cropImageScale-1,height:this.cropImageSize.height*this.cropImageScale-1}}rotateAspectRatio(){const t=this.cropAspectRatio;if(t==="free"||t==="reset")return;const[e,r]=t.split(":");this.setAspectRatio(`${r}:${e}`)}convertRegion(t){const{region:e,from:r,to:s}=t,i=s.width/r.width,n=s.height/r.height;return{x:Math.round(e.x*i),y:Math.round(e.y*n),width:Math.round(e.width*i),height:Math.round(e.height*n)}}getRegionInPreviewCoords(t){return{x:Math.round(t.x/this.cropImageScale),y:Math.round(t.y/this.cropImageScale),width:Math.round(t.width/this.cropImageScale),height:Math.round(t.height/this.cropImageScale)}}applyMirrorToCoords(t,e){let{x:r,y:s}=t;const{width:i,height:n}=t;return this.mirrorHorizontal&&(r=e.width-r-i),this.mirrorVertical&&(s=e.height-s-n),{x:r,y:s,width:i,height:n}}constrainToBounds(t,e){const{x:r,y:s,width:i,height:n}=t;return{x:Math.max(0,Math.min(r,e.width-i)),y:Math.max(0,Math.min(s,e.height-n)),width:Math.min(i,e.width-Math.max(0,r)),height:Math.min(n,e.height-Math.max(0,s))}}}const Qt=new Bp;var zp=q("<!> <!> <!> <!>",1),Vp=q("<div></div>"),Wp=q("<div></div>"),Hp=q('<!> <span class="text-sm text-white text-left"> </span>',1),Yp=q('<div class="mt-3 px-4"><div class="flex h-10 w-full items-center justify-between text-sm mt-2"><h2> </h2></div> <!> <div class="flex h-10 w-full items-center justify-between text-sm mt-6"><h2> </h2></div> <div class="grid grid-cols-2 mb-4"></div></div>');function Xp(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It(),i=[{label:e()("crop_aspect_ratio_free"),value:"free",isFree:!0},{label:e()("crop_aspect_ratio_original"),value:"original",width:24,height:18},{label:"5:4",value:"5:4",width:22,height:18},{label:"4:5",value:"4:5",width:18,height:22},{label:"4:3",value:"4:3",width:24,height:18},{label:"3:4",value:"3:4",width:18,height:24},{label:"3:2",value:"3:2",width:24,height:16},{label:"2:3",value:"2:3",width:16,height:24},{label:"16:9",value:"16:9",width:24,height:14},{label:"9:16",value:"9:16",width:14,height:24},{label:"Square",value:"1:1",width:20,height:20}];let n=y(()=>Qt.normalizedRotation%180!==0);function o(P){if(P.value==="free")return P.value;if(h(n)){let[L,E]=P.value.split(":");return`${E}:${L}`}else return P.value}function l(P){let L;if(P.value==="original"){const{width:E,height:_}=Qt.cropImageSize;h(n)&&(L=`${_}:${E}`),L=`${E}:${_}`}return L=o(P),Qt.cropAspectRatio===L}function c(P){let L;if(P.value==="original"){const{width:E,height:_}=Qt.cropImageSize;L=`${E}:${_}`}else L=o(P);Qt.setAspectRatio(L)}async function u(P){await Qt.rotate(P)}function d(P){Qt.mirror(P)}var g=Yp(),f=b(g),m=b(f),p=b(m,!0);w(m),w(f);var v=k(f,2);pn(v,{children:(P,L)=>{var E=zp(),_=Ct(E);{let R=y(()=>e()("editor_rotate_left"));Jt(_,{class:"w-full",size:"small",get"aria-label"(){return h(R)},get icon(){return _h},onclick:()=>u(-90)})}var j=k(_,2);{let R=y(()=>e()("editor_rotate_right"));Jt(j,{class:"w-full",size:"small",get"aria-label"(){return h(R)},get icon(){return yh},onclick:()=>u(90)})}var X=k(j,2);{let R=y(()=>e()("editor_flip_horizontal"));Jt(X,{class:"w-full",size:"small",get"aria-label"(){return h(R)},get icon(){return xh},onclick:()=>d("horizontal")})}var G=k(X,2);{let R=y(()=>e()("editor_flip_vertical"));Jt(G,{class:"w-full",size:"small",get"aria-label"(){return h(R)},get icon(){return wh},onclick:()=>d("vertical")})}I(P,E)},$$slots:{default:!0}});var x=k(v,2),T=b(x),A=b(T,!0);w(T),w(x);var O=k(x,2);pr(O,21,()=>i,P=>P.value,(P,L)=>{pn(P,{children:(E,_)=>{var j=Hp(),X=Ct(j);{let B=y(()=>l(h(L))?"primary":"secondary"),V=y(()=>l(h(L))?"filled":"outline");gn(X,{class:"w-14 h-14 m-2",shape:"round",onclick:()=>c(h(L)),get"aria-label"(){return h(L).label},get color(){return h(B)},get variant(){return h(V)},children:(Q,tt)=>{var z=Ce(),$=Ct(z);{var J=it=>{var ht=Vp();lt(nt=>fr(ht,1,`w-6 h-6 border-2 border-dashed rounded-xs flex-shrink-0 ${nt??""}`),[()=>l(h(L))?"border-black":"border-white"]),I(it,ht)},rt=it=>{var ht=Wp();lt(nt=>{fr(ht,1,`border-2 rounded-xs flex-shrink-0 ${nt??""}`),us(ht,`width: ${h(L).width??""}px; height: ${h(L).height??""}px;`)},[()=>l(h(L))?"border-black":"border-white"]),I(it,ht)};K($,it=>{h(L).isFree?it(J):it(rt,!1)})}I(Q,z)},$$slots:{default:!0}})}var G=k(X,2),R=b(G,!0);w(G),lt(()=>dt(R,h(L).label)),I(E,j)},$$slots:{default:!0}})}),w(O),w(g),lt((P,L)=>{dt(p,P),dt(A,L)},[()=>e()("editor_orientation"),()=>e()("crop")]),I(a,g),Dt(),s()}var ra=(a=>(a.Transform="transform",a))(ra||{});class Np{tools=[{type:"transform",icon:bh,component:Xp,manager:Qt}];#t=st(null);get currentAsset(){return h(this.#t)}set currentAsset(t){U(this.#t,t,!0)}#r=st(null);get selectedTool(){return h(this.#r)}set selectedTool(t){U(this.#r,t,!0)}#i=st(!1);get isShowingConfirmDialog(){return h(this.#i)}set isShowingConfirmDialog(t){U(this.#i,t,!0)}#s=st(!1);get isApplyingEdits(){return h(this.#s)}set isApplyingEdits(t){U(this.#s,t,!0)}#e=st(!1);get hasAppliedEdits(){return h(this.#e)}set hasAppliedEdits(t){U(this.#e,t,!0)}#n=y(()=>this.tools.some(t=>t.manager.hasChanges)&&!this.hasAppliedEdits);get hasUnsavedChanges(){return h(this.#n)}set hasUnsavedChanges(t){U(this.#n,t)}#o=y(()=>this.tools.some(t=>t.manager.canReset));get canReset(){return h(this.#o)}set canReset(t){U(this.#o,t)}async closeConfirm(){if(this.isShowingConfirmDialog)return!1;if(!this.hasUnsavedChanges)return!0;this.isShowingConfirmDialog=!0;const t=await ca(),e=await Dr.show(Su,{title:t("editor_discard_edits_title"),prompt:t("editor_discard_edits_prompt"),confirmText:t("editor_discard_edits_confirm")});return this.isShowingConfirmDialog=!1,e}reset(){for(const t of this.tools)t.manager.onDeactivate?.();this.selectedTool=this.tools[0]}async activateTool(t,e,r){if(this.hasAppliedEdits=!1,this.selectedTool?.type===t)return;this.currentAsset=e,this.selectedTool?.manager.onDeactivate?.();const s=this.tools.find(i=>i.type===t);s&&(this.selectedTool=s,await s.manager.onActivate?.(e,r.edits))}cleanup(){for(const t of this.tools)t.manager.onDeactivate?.();this.currentAsset=null,this.selectedTool=null}async resetAllChanges(){for(const t of this.tools)await t.manager.resetAllChanges()}async applyEdits(){this.isApplyingEdits=!0;const t=this.tools.flatMap(s=>s.manager.edits);if(!this.currentAsset)return!1;const e=this.currentAsset.id,r=await ca();try{const s=du("AssetEditReadyV1",i=>i.asset.id===e,1e4);return await(t.length===0?Fu({id:e}):ju({id:e,assetEditActionListDto:{edits:t}})),await s,Fo.emit("AssetEditsApplied",e),er.success(r("editor_edits_applied_success")),this.hasAppliedEdits=!0,!0}catch{return er.danger(r("editor_edits_applied_error")),!1}finally{this.isApplyingEdits=!1}}}const qe=new Np;class Up{constructor(t){this.onChange=t}history=[];index=0;reset(){this.history=[],this.index=0}queue(t){this.history.push(t),this.index===this.history.length-2&&this.index++}next(){return this.index===this.history.length-1?!1:(this.index++,this.onChange(this.history[this.index]),!0)}previous(){return this.index===0?!1:(this.index--,this.onChange(this.history[this.index]),!0)}}var Gp=q('<section class="px-4 mt-10"><!></section>'),qp=q('<section class="px-4 mt-6"><p class="wrap-break-word whitespace-pre-line w-full text-black dark:text-white text-base"> </p></section>');function $p(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It();let i=y(()=>t.asset.exifInfo?.description??"");const n=async()=>{const d=t.asset.exifInfo?.description??"";if(h(i)!==d)try{await ki({id:t.asset.id,updateAssetDto:{description:h(i)}}),er.success(e()("asset_description_updated"))}catch(g){ce(g,e()("cannot_update_the_description"))}};var o=Ce(),l=Ct(o);{var c=d=>{var g=Gp(),f=b(g);{let m=y(()=>e()("add_a_description"));nd(f,{class:"max-h-40 pl-0 outline-none border-b border-gray-500 bg-transparent ring-0 focus:ring-0 resize-none focus:border-b-2 focus:border-immich-primary dark:focus:border-immich-dark-primary dark:bg-transparent",rows:1,grow:!0,shape:"rectangle",onfocusout:n,get placeholder(){return h(m)},"data-testid":"autogrow-textarea",[Ch()]:p=>(Sh(In,()=>({shortcut:{key:"Enter",ctrl:!0},onShortcut:v=>v.currentTarget.blur()}))||Ao)(p),get value(){return h(i)},set value(p){U(i,p)}})}w(g),I(d,g)},u=d=>{var g=qp(),f=b(g),m=b(f,!0);w(f),w(g),lt(()=>dt(m,h(i))),I(d,g)};K(l,d=>{t.isOwner?d(c):h(i)&&d(u,1)})}I(a,o),Dt(),s()}var Kp=q("<p> </p>"),Zp=q('<div class="flex gap-2 text-sm"><p> </p></div>'),Jp=q('<div class="flex gap-2 text-sm"><p> </p></div>'),Qp=q("<div><!></div>"),tv=q('<button type="button"><div class="flex gap-4"><div><!></div> <div><!> <!> <!></div></div> <!></button>'),ev=q('<button type="button" class="flex w-full text-start justify-between place-items-start gap-4 py-4 rounded-lg hover:text-primary"><div class="flex gap-4"><div><!></div> <p> </p></div> <div class="focus:outline-none p-1"><!></div></button>'),rv=q("<!> <!>",1);function sv(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It();let i=Tt(t,"asset",15),n=st(!1);const o=async m=>{if(U(n,!1),!!m)try{i(await ki({id:i().id,updateAssetDto:{latitude:m.lat,longitude:m.lng}}))}catch(p){ce(p,e()("errors.unable_to_change_location"))}};var l=rv(),c=Ct(l);{var u=m=>{var p=tv();let v;p.__click=()=>t.isOwner?U(n,!0):null;var x=b(p),T=b(x),A=b(T);De(A,{get icon(){return oa},size:"24"}),w(T);var O=k(T,2),P=b(O);{var L=B=>{var V=Kp(),Q=b(V,!0);w(V),lt(()=>dt(Q,i().exifInfo.city)),I(B,V)};K(P,B=>{i().exifInfo?.city&&B(L)})}var E=k(P,2);{var _=B=>{var V=Zp(),Q=b(V),tt=b(Q,!0);w(Q),w(V),lt(()=>dt(tt,i().exifInfo.state)),I(B,V)};K(E,B=>{i().exifInfo?.state&&B(_)})}var j=k(E,2);{var X=B=>{var V=Jp(),Q=b(V),tt=b(Q,!0);w(Q),w(V),lt(()=>dt(tt,i().exifInfo.country)),I(B,V)};K(j,B=>{i().exifInfo?.country&&B(X)})}w(O),w(x);var G=k(x,2);{var R=B=>{var V=Qp(),Q=b(V);De(Q,{get icon(){return Ys},size:"20"}),w(V),I(B,V)};K(G,B=>{t.isOwner&&B(R)})}w(p),lt(B=>{v=fr(p,1,"flex w-full text-start justify-between place-items-start gap-4 py-4",null,v,{"hover:text-primary":t.isOwner}),Nt(p,"title",B)},[()=>t.isOwner?e()("edit_location"):""]),I(m,p)},d=m=>{var p=ev();p.__click=()=>U(n,!0);var v=b(p),x=b(v),T=b(x);De(T,{get icon(){return oa},size:"24"}),w(x);var A=k(x,2),O=b(A,!0);w(A),w(v);var P=k(v,2),L=b(P);De(L,{get icon(){return Ys},size:"20"}),w(P),w(p),lt((E,_)=>{Nt(p,"title",E),dt(O,_)},[()=>e()("add_location"),()=>e()("add_a_location")]),I(m,p)};K(c,m=>{i().exifInfo?.country?m(u):!i().exifInfo?.city&&t.isOwner&&m(d,1)})}var g=k(c,2);{var f=m=>{ad(m,{children:(p,v)=>{od(p,{get asset(){return i()},onClose:o})},$$slots:{default:!0}})};K(g,m=>{h(n)&&m(f)})}I(a,l),Dt(),s()}Zr(["click"]);var iv=q('<label data-testid="star"><span class="sr-only"> </span> <!></label> <input type="radio" name="stars" class="sr-only"/>',1),nv=q('<button type="button" class="cursor-pointer text-xs text-primary"> </button>'),ov=q('<fieldset class="text-primary w-fit cursor-default"><legend class="sr-only"> </legend> <div class="flex flex-row" data-testid="star-container"></div></fieldset> <!>',1);function av(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It(),i=[];let n=Tt(t,"count",3,5),o=Tt(t,"readOnly",3,!1),l=y(()=>t.rating),c=st(0),u=st(0),d;const g="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z",f=hd(),m=j=>{o()||j!==t.rating&&t.onRating(j)},p=j=>{o()||U(c,j,!0)},v=()=>{p(0),U(u,0)},x=j=>{clearTimeout(d),d=setTimeout(()=>{m(j)},300)};var T=ov(),A=Ct(T),O=b(A),P=b(O,!0);w(O);var L=k(O,2);pr(L,21,()=>({length:n()}),dl,(j,X,G)=>{const R=y(()=>G+1),B=y(()=>h(c)>=h(R)||h(c)===0&&h(l)>=h(R)),V=y(()=>`${f}-${h(R)}`);var Q=iv(),tt=Ct(Q);tt.__mouseover=()=>p(h(R)),Nt(tt,"tabindex",-1);let z;var $=b(tt),J=b($,!0);w($);var rt=k($,2);{let nt=y(()=>h(B)?"currentcolor":"transparent"),ut=y(()=>h(B)?"currentcolor":"#c1cce8");De(rt,{icon:g,size:"1.5em",strokeWidth:1,get color(){return h(nt)},get strokeColor(){return h(ut)},"aria-hidden":!0})}w(tt);var it=k(tt,2);vl(it),it.__change=()=>x(h(R));var ht;lt(nt=>{Nt(tt,"for",h(V)),z=fr(tt,1,"",null,z,{"cursor-pointer":!o(),"ring-2":h(u)===h(R)}),dt(J,nt),Nt(it,"id",h(V)),it.disabled=o(),ht!==(ht=h(R))&&(it.value=(it.__value=h(R))??"")},[()=>e()("rating_count",{values:{count:h(R)}})]),Be("focus",it,()=>{U(u,h(R))}),ld(i,[],it,()=>(h(R),h(l)),nt=>U(l,nt)),I(j,Q)}),w(L),w(A),Ue(A,(j,X)=>ud?.(j,X),()=>({onFocusOut:v})),Ue(A,(j,X)=>Ps?.(j,X),()=>[{shortcut:{key:"ArrowLeft"},preventDefault:!1,onShortcut:j=>j.stopPropagation()},{shortcut:{key:"ArrowRight"},preventDefault:!1,onShortcut:j=>j.stopPropagation()}]);var E=k(A,2);{var _=j=>{var X=nv();X.__click=()=>{U(l,0),m(h(l))};var G=b(X,!0);w(X),lt(R=>dt(G,R),[()=>e()("rating_clear")]),I(j,X)};K(E,j=>{h(l)>0&&!o()&&j(_)})}lt(j=>dt(P,j),[()=>e()("rating")]),Be("mouseleave",A,()=>p(0)),I(a,T),Dt(),s()}Zr(["mouseover","change","click"]);var lv=q('<section class="px-4 pt-2"><!></section>');function cv(a,t){At(t,!0);const e=()=>at(zt,"$t",s),r=()=>at(Po,"$preferences",s),[s,i]=It();let n=y(()=>t.asset.exifInfo?.rating||0);const o=async d=>{try{await ki({id:t.asset.id,updateAssetDto:{rating:d}})}catch(g){ce(g,e()("errors.cant_apply_changes"))}};var l=Ce(),c=Ct(l);{var u=d=>{var g=lv(),f=b(g);{let m=y(()=>!t.isOwner);av(f,{get rating(){return h(n)},get readOnly(){return h(m)},onRating:p=>Sr(o(p))})}w(g),I(d,g)};K(c,d=>{!$s.isSharedLink&&r()?.ratings.enabled&&d(u)})}I(a,l),Dt(),i()}var hv=q("<!> <!>",1),uv=q('<section class="px-4 mt-4"><div class="flex h-10 w-full items-center justify-between text-sm"><!></div> <section class="flex flex-wrap pt-2 gap-1" data-testid="detail-panel-tags"><!> <!></section></section>'),dv=q("<!> <!>",1);function gv(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It();let i=Tt(t,"asset",15),n=y(()=>i().tags||[]);const o=async p=>{await gu({tagIds:[p],assetIds:[i().id],showNotification:!1})&&i(await _i({id:i().id}))},l=async p=>{p.includes(i().id)&&i(await _i({id:i().id}))},c=y(()=>Mo(e(),i())),u=y(()=>h(c).Tag);var d=dv(),g=Ct(d);Lo(g,{onAssetsTag:l});var f=k(g,2);{var m=p=>{var v=uv(),x=b(v),T=b(x);Rs(T,{color:"muted",children:(L,E)=>{Ne();var _=pe();lt(j=>dt(_,j),[()=>e()("tags")]),I(L,_)},$$slots:{default:!0}}),w(x);var A=k(x,2),O=b(A);pr(O,17,()=>h(n),L=>L.id,(L,E)=>{fd(L,{size:"small",class:"items-center px-0",shape:"round",children:(_,j)=>{var X=hv(),G=Ct(X);{let B=y(()=>$e.tags({path:h(E).value}));md(G,{get href(){return h(B)},class:"text-light no-underline rounded-full hover:bg-primary-400 px-2",children:(V,Q)=>{Ne();var tt=pe();lt(()=>dt(tt,h(E).value)),I(V,tt)},$$slots:{default:!0}})}var R=k(G,2);{let B=y(()=>e()("remove_tag"));Jt(R,{get"aria-label"(){return h(B)},get icon(){return Ti},onclick:()=>o(h(E).id),size:"tiny",class:"hover:bg-primary-400",shape:"round"})}I(_,X)},$$slots:{default:!0}})});var P=k(O,2);gd(P,{get action(){return h(u)}}),w(A),w(v),I(p,v)};K(f,p=>{t.isOwner&&!$s.isSharedLink&&p(m)})}I(a,d),Dt(),s()}var fv=q('<div class="w-full"><!></div>'),mv=q("<!> <!> <!>",1);function pv(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It();let i=Tt(t,"initialDate",19,()=>di.now()),n=Tt(t,"timezoneInput",3,!0),o=st(ue(i().toFormat("yyyy-MM-dd'T'HH:mm:ss.SSS")));const l=y(()=>Gu(h(o)));let c=ue(ma(i(),t.initialTimeZone,h(l))),u=y(()=>ma(i(),t.initialTimeZone,h(l),c));const d=async()=>{if(!h(g).isValid||!h(u)){t.onClose(!1);return}const f=Uu(h(o),h(u));try{await ki({id:t.asset.id,updateAssetDto:{dateTimeOriginal:f}}),t.onClose(!0)}catch(m){ce(m,e()("errors.unable_to_change_date")),t.onClose(!1)}},g=y(()=>di.fromISO(h(o),{zone:h(u)?.value,setZone:!0}));{let f=y(()=>e()("edit_date_and_time")),m=y(()=>e()("confirm")),p=y(()=>!h(g).isValid||!h(u));Io(a,{get title(){return h(f)},get icon(){return Th},onClose:()=>t.onClose(!1),onSubmit:d,get submitText(){return h(m)},get disabled(){return h(p)},size:"small",children:(v,x)=>{var T=mv(),A=Ct(T);cd(A,{for:"datetime",class:"block mb-1",children:(E,_)=>{Ne();var j=pe();lt(X=>dt(j,X),[()=>e()("date_and_time")]),I(E,j)},$$slots:{default:!0}});var O=k(A,2);pd(O,{class:"immich-form-input w-full mb-2",id:"datetime",type:"datetime-local",get value(){return h(o)},set value(E){U(o,E,!0)}});var P=k(O,2);{var L=E=>{var _=fv(),j=b(_);{let X=y(()=>e()("timezone")),G=y(()=>e()("search_timezone"));dd(j,{get label(){return h(X)},get options(){return h(l)},get placeholder(){return h(G)},get selectedOption(){return h(u)},set selectedOption(R){U(u,R)}})}w(_),I(E,_)};K(P,E=>{n()&&E(L)})}I(v,T)},$$slots:{default:!0}})}Dt(),s()}var vv=q('<div class="flex place-content-center place-items-center"><!></div>'),_v=q('<div class="flex items-center gap-2"><!> <p class="flex text-lg text-immich-fg dark:text-immich-dark-fg"> </p></div> <div class="flex justify-end gap-2"><!> <!></div>',1),yv=q("<div><!></div>"),xv=q('<!> <div class="w-full flex"><!> <!></div> <!>',1),wv=q('<div class="flex w-full justify-center"><!></div>'),bv=q('<div class="w-fit"><button type="button" class="w-22.5"><div class="relative"><!></div> <p class="mt-1 truncate font-medium"> </p></button></div>'),Sv=q('<div class="immich-scrollbar mt-4 flex flex-wrap gap-2 overflow-y-auto"></div>'),Cv=q('<section class="absolute top-0 h-full w-90 overflow-x-hidden p-2 dark:text-immich-dark-fg bg-light"><div class="flex place-items-center justify-between gap-2"><!></div> <div class="px-4 py-4 text-sm"><h2 class="mb-8 mt-4"> </h2> <!></div></section>');function Tv(a,t){At(t,!0);const e=()=>at(zt,"$t",s),r=()=>at(El,"$getPersonNameWithHiddenValue",s),[s,i]=It();let n=st(ue([])),o=st(!1);async function l(){const G=setTimeout(()=>U(o,!0),mn);try{const{people:R}=await Al({withHidden:!0,closestAssetId:t.editedFace.id});U(n,R,!0)}catch(R){ce(R,e()("errors.cant_get_faces"))}finally{clearTimeout(G)}U(o,!1)}let c=st(!1),u=st(!1),d=st(ue([])),g=st(!1),f=st(""),m=y(()=>h(f)?h(d):h(n).filter(G=>!G.isHidden));tr(()=>{Sr(l())});const p=async()=>{const G=setTimeout(()=>U(c,!0),mn),R=await Bc(t.editedFace,t.assetId,t.assetType,Rt.imgRef);t.onCreatePerson(R),clearTimeout(G),U(c,!1),t.onCreatePerson(R)};var v=Cv(),x=b(v),T=b(x);{var A=G=>{var R=_v(),B=Ct(R),V=b(B);{let ht=y(()=>e()("back"));Jt(V,{color:"secondary",variant:"ghost",shape:"round",get icon(){return go},get"aria-label"(){return h(ht)},get onclick(){return t.onClose}})}var Q=k(V,2),tt=b(Q,!0);w(Q),w(B);var z=k(B,2),$=b(z);{let ht=y(()=>e()("search_for_existing_person"));Jt($,{color:"secondary",variant:"ghost",shape:"round",get icon(){return kh},get"aria-label"(){return h(ht)},onclick:()=>{U(g,!0)}})}var J=k($,2);{var rt=ht=>{{let nt=y(()=>e()("create_new_person"));Jt(ht,{color:"secondary",variant:"ghost",shape:"round",get icon(){return _l},get"aria-label"(){return h(nt)},onclick:p})}},it=ht=>{var nt=vv(),ut=b(nt);gr(ut,{}),w(nt),I(ht,nt)};K(J,ht=>{h(c)?ht(it,!1):ht(rt)})}w(z),lt(ht=>dt(tt,ht),[()=>e()("select_face")]),I(G,R)},O=G=>{var R=xv(),B=Ct(R);{let J=y(()=>e()("back"));Jt(B,{color:"secondary",variant:"ghost",shape:"round",get icon(){return go},get"aria-label"(){return h(J)},get onclick(){return t.onClose}})}var V=k(B,2),Q=b(V);_d(Q,{type:"input",get searchName(){return h(f)},set searchName(J){U(f,J,!0)},get showLoadingSpinner(){return h(u)},set showLoadingSpinner(J){U(u,J,!0)},get searchedPeopleLocal(){return h(d)},set searchedPeopleLocal(J){U(d,J,!0)}});var tt=k(Q,2);{var z=J=>{var rt=yv(),it=b(rt);gr(it,{}),w(rt),I(J,rt)};K(tt,J=>{h(u)&&J(z)})}w(V);var $=k(V,2);{let J=y(()=>e()("cancel_search"));Jt($,{color:"secondary",variant:"ghost",shape:"round",get icon(){return Ti},get"aria-label"(){return h(J)},onclick:()=>U(g,!1)})}I(G,R)};K(T,G=>{h(g)?G(O,!1):G(A)})}w(x);var P=k(x,2),L=b(P),E=b(L,!0);w(L);var _=k(L,2);{var j=G=>{var R=wv(),B=b(R);gr(B,{}),w(R),I(G,R)},X=G=>{var R=Sv();pr(R,21,()=>h(m),B=>B.id,(B,V)=>{var Q=Ce(),tt=Ct(Q);{var z=$=>{var J=bv(),rt=b(J);rt.__click=()=>t.onReassign(h(V));var it=b(rt),ht=b(it);{let D=y(()=>vi(h(V))),W=y(()=>r()(h(V).name,h(V).isHidden)),H=y(()=>r()(h(V).name,h(V).isHidden));as(ht,{curve:!0,shadow:!0,get url(){return h(D)},get altText(){return h(W)},get title(){return h(H)},widthStyle:"90px",heightStyle:"90px",get hidden(){return h(V).isHidden}})}w(it);var nt=k(it,2),ut=b(nt,!0);w(nt),w(rt),w(J),lt(D=>{Nt(nt,"title",D),dt(ut,h(V).name)},[()=>r()(h(V).name,h(V).isHidden)]),I($,J)};K(tt,$=>{(!t.editedFace.person||h(V).id!==t.editedFace.person.id)&&$(z)})}I(B,Q)}),w(R),I(G,R)};K(_,G=>{h(o)?G(j):G(X,!1)})}w(P),w(v),lt(G=>dt(E,G),[()=>e()("all_people")]),Qe(3,v,()=>Ts,()=>({x:360,duration:100,easing:Pl})),I(a,v),Dt(),i()}Zr(["click"]);var kv=q('<button type="button" class="justify-self-end rounded-lg p-2 hover:bg-immich-dark-primary hover:dark:bg-immich-dark-primary/50"> </button>'),Ov=q('<div class="flex w-full justify-center"><!></div>'),Av=q("<span> </span>"),Dv=q('<p class="relative mt-1 truncate font-medium"><!></p>'),Ev=q('<div class="flex place-content-center place-items-center rounded-full bg-[#d3d3d3] p-1 transition-all absolute start-1/2 top-1/2 translate-x-[-50%] translate-y-[-50%] transform"><!></div>'),Pv=q('<div class="absolute -end-[3px] top-8 h-5 w-5 rounded-full"><!></div>'),Mv=q('<div class="relative h-29 w-24"><div role="button" class="absolute start-0 top-0 h-22.5 w-22.5 cursor-default"><div class="relative"><!></div> <!> <div class="absolute -end-[3px] -top-[3px] h-5 w-5 rounded-full"><!></div> <div class="absolute end-8 -top-[3px] h-5 w-5 rounded-full"><!></div> <!></div></div>'),Iv=q('<!> <section class="absolute top-0 h-full w-90 overflow-x-hidden p-2 dark:text-immich-dark-fg bg-light"><div class="flex place-items-center justify-between gap-2"><div class="flex items-center gap-2"><!> <p class="flex text-lg text-immich-fg dark:text-immich-dark-fg"> </p></div> <!></div> <div class="px-4 py-4 text-sm"><div class="mt-4 flex flex-wrap gap-2"><!></div></div></section> <!>',1);function Lv(a,t){At(t,!0);const e=()=>at(zt,"$t",s),r=()=>at(El,"$getPersonNameWithHiddenValue",s),[s,i]=It();let n=[],o=[],l=st(ue([])),c=ue({}),u=ue({}),d=st(void 0),g=st(!1),f=st(!1),m=st(!1),p,v;const x="90px";async function T(){const M=setTimeout(()=>U(f,!0),mn);try{U(l,await Bu({id:t.assetId}),!0)}catch(Z){ce(Z,e()("errors.cant_get_faces"))}finally{clearTimeout(M)}U(f,!1)}const A=({id:M})=>{o.push(M),O(o,n)&&p&&v&&Object.keys(u).length===n.length&&(clearTimeout(p),clearTimeout(v),t.onRefresh())};tr(()=>{Sr(T())});const O=(M,Z)=>Z.every(ft=>M.includes(ft)),P=M=>{c[M]&&delete c[M],u[M]&&delete u[M]},L=async()=>{p=setTimeout(()=>U(g,!0),mn);const M=Object.keys(u).length+Object.keys(c).length;if(M>0)try{for(const Z of h(l)){const ft=c[Z.id]?.id;if(ft)await fa({id:ft,faceDto:{id:Z.id}});else if(u[Z.id]){const Lt=await Ru({personCreateDto:{}});n.push(Lt.id),await fa({id:Lt.id,faceDto:{id:Z.id}})}}er.success(e()("people_edits_count",{values:{count:M}}))}catch(Z){ce(Z,e()("errors.cant_apply_changes"))}U(g,!1),n.length===0?(clearTimeout(p),t.onRefresh()):v=setTimeout(t.onRefresh,15e3)},E=M=>{M&&h(d)&&(u[h(d).id]=M),U(m,!1)},_=M=>{M&&h(d)&&(c[h(d).id]=M),U(m,!1)},j=M=>{U(d,M,!0),U(m,!0)},X=async M=>{try{if(!M.person||!await Dr.showDialog({prompt:e()("confirm_delete_face",{values:{name:M.person.name}})}))return;await zu({id:M.id,assetFaceDeleteDto:{force:!1}}),Fo.emit("PersonAssetDelete",{id:M.person.id,assetId:t.assetId}),U(l,h(l).filter(ft=>ft.id!==M.id),!0),await _n.setAssetId(t.assetId)}catch(Z){ce(Z,e()("error_delete_face"))}};var G=Iv(),R=Ct(G);Lo(R,{onPersonThumbnailReady:A});var B=k(R,2),V=b(B),Q=b(V),tt=b(Q);{let M=y(()=>e()("back"));Jt(tt,{shape:"round",color:"secondary",variant:"ghost",get icon(){return go},get"aria-label"(){return h(M)},get onclick(){return t.onClose}})}var z=k(tt,2),$=b(z,!0);w(z),w(Q);var J=k(Q,2);{var rt=M=>{var Z=kv();Z.__click=()=>L();var ft=b(Z,!0);w(Z),lt(Lt=>dt(ft,Lt),[()=>e()("done")]),I(M,Z)},it=M=>{gr(M,{})};K(J,M=>{h(g)?M(it,!1):M(rt)})}w(V);var ht=k(V,2),nt=b(ht),ut=b(nt);{var D=M=>{var Z=Ov(),ft=b(Z);gr(ft,{}),w(Z),I(M,Z)},W=M=>{var Z=Ce(),ft=Ct(Z);pr(ft,19,()=>h(l),Lt=>Lt.id,(Lt,vt,Pt)=>{const Ht=y(()=>h(vt).person?h(vt).person?.name:e()("face_unassigned"));var ke=Mv(),Vt=b(ke);Vt.__mouseover=()=>Zt(Or,[h(l)[h(Pt)]]);var fe=b(Vt),Ft=b(fe);{var me=jt=>{{let Yt=y(()=>e()("new_person")),et=y(()=>e()("new_person"));as(jt,{curve:!0,shadow:!0,get url(){return u[h(vt).id]},get altText(){return h(Yt)},get title(){return h(et)},widthStyle:x,heightStyle:x})}},vr=jt=>{{let Yt=y(()=>vi(c[h(vt).id])),et=y(()=>r()(c[h(vt).id].name,c[h(vt).id]?.isHidden));as(jt,{curve:!0,shadow:!0,get url(){return h(Yt)},get altText(){return c[h(vt).id].name},get title(){return h(et)},widthStyle:x,heightStyle:x,get hidden(){return c[h(vt).id].isHidden}})}},Pr=jt=>{{let Yt=y(()=>vi(h(vt).person)),et=y(()=>r()(h(vt).person.name,h(vt).person.isHidden));as(jt,{curve:!0,shadow:!0,get url(){return h(Yt)},get altText(){return h(vt).person.name},get title(){return h(et)},widthStyle:x,heightStyle:x,get hidden(){return h(vt).person.isHidden}})}},ts=jt=>{var Yt=Ce(),et=Ct(Yt);yi(et,()=>Bc(h(vt),t.assetId,t.assetType,Rt.imgRef),ot=>{{let _t=y(()=>e()("face_unassigned")),bt=y(()=>e()("face_unassigned"));as(ot,{curve:!0,shadow:!0,url:"/src/lib/assets/no-thumbnail.png",get altText(){return h(_t)},get title(){return h(bt)},widthStyle:"90px",heightStyle:"90px"})}},(ot,_t)=>{{let bt=y(()=>h(_t)===null?"/src/lib/assets/no-thumbnail.png":h(_t)),St=y(()=>e()("face_unassigned")),kt=y(()=>e()("face_unassigned"));as(ot,{curve:!0,shadow:!0,get url(){return h(bt)},get altText(){return h(St)},get title(){return h(kt)},widthStyle:"90px",heightStyle:"90px"})}}),I(jt,Yt)};K(Ft,jt=>{u[h(vt).id]?jt(me):c[h(vt).id]?jt(vr,1):h(vt).person?jt(Pr,2):jt(ts,!1)})}w(fe);var _r=k(fe,2);{var es=jt=>{var Yt=Dv(),et=b(Yt);{var ot=bt=>{var St=pe();lt(()=>dt(St,c[h(vt).id]?.name)),I(bt,St)},_t=bt=>{var St=Av(),kt=b(St,!0);w(St),lt(Ot=>{fr(St,1,Ot),dt(kt,h(Ht))},[()=>yl(h(Ht)===e()("face_unassigned")?"dark:text-gray-500":"")]),I(bt,St)};K(et,bt=>{c[h(vt).id]?.id?bt(ot):bt(_t,!1)})}w(Yt),lt(()=>Nt(Yt,"title",h(Ht))),I(jt,Yt)};K(_r,jt=>{u[h(vt).id]||jt(es)})}var yr=k(_r,2),ae=b(yr);{var xr=jt=>{{let Yt=y(()=>e()("reset"));Jt(jt,{shape:"round",variant:"ghost",color:"primary",get icon(){return Oh},get"aria-label"(){return h(Yt)},size:"small",class:"absolute start-1/2 top-1/2 translate-x-[-50%] translate-y-[-50%] transform",onclick:()=>P(h(vt).id)})}},rs=jt=>{{let Yt=y(()=>e()("select_new_face"));Jt(jt,{shape:"round",color:"primary",get icon(){return Ys},get"aria-label"(){return h(Yt)},size:"small",class:"absolute start-1/2 top-1/2 translate-x-[-50%] translate-y-[-50%] transform",onclick:()=>j(h(vt))})}};K(ae,jt=>{u[h(vt).id]||c[h(vt).id]?jt(xr):jt(rs,!1)})}w(yr);var Mr=k(yr,2),Ir=b(Mr);{var Lr=jt=>{var Yt=Ev(),et=b(Yt);De(et,{color:"primary",get icon(){return Ah},"aria-hidden":!0,size:"24"}),w(Yt),I(jt,Yt)};K(Ir,jt=>{!u[h(vt).id]&&!c[h(vt).id]&&!h(vt).person&&jt(Lr)})}w(Mr);var ss=k(Mr,2);{var wr=jt=>{var Yt=Pv(),et=b(Yt);{let ot=y(()=>e()("delete_face"));Jt(et,{shape:"round",color:"danger",get icon(){return Dh},get"aria-label"(){return h(ot)},size:"small",class:"absolute start-1/2 top-1/2 translate-x-[-50%] translate-y-[-50%] transform",onclick:()=>X(h(vt))})}w(Yt),I(jt,Yt)};K(ss,jt=>{h(vt).person!=null&&jt(wr)})}w(Vt),w(ke),lt(()=>Nt(Vt,"tabindex",h(Pt))),Be("focus",Vt,()=>Zt(Or,[h(l)[h(Pt)]])),Be("mouseleave",Vt,()=>Zt(Or,[])),I(Lt,ke)}),I(M,Z)};K(ut,M=>{h(f)?M(D):M(W,!1)})}w(nt),w(ht),w(B);var H=k(B,2);{var Y=M=>{Tv(M,{get editedFace(){return h(d)},get assetId(){return t.assetId},get assetType(){return t.assetType},onClose:()=>U(m,!1),onCreatePerson:E,onReassign:_})};K(H,M=>{h(m)&&h(d)&&M(Y)})}lt(M=>dt($,M),[()=>e()("edit_faces")]),Qe(3,B,()=>Ts,()=>({x:360,duration:100,easing:Pl})),I(a,G),Dt(),i()}Zr(["click","mouseover"]);var Fv=q('<section class="px-4 py-4"><div role="alert"><div class="rounded-t bg-red-500 px-4 py-2 font-bold text-white"> </div> <div class="border border-t-0 border-red-400 bg-red-100 px-4 py-3 text-red-700"><p><!></p></div> <div class="rounded-b bg-red-500 px-4 py-2 text-white text-sm"><p> </p></div></div></section>'),jv=q('<p class="font-light"><!></p>'),Rv=q('<a class="w-22"><div class="relative"><!></div> <p class="mt-1 truncate font-medium"> </p> <!></a>'),Bv=q('<section class="px-4 pt-4 text-sm"><div class="flex h-10 w-full items-center justify-between"><!> <div class="flex gap-2 items-center"><!> <!> <!></div></div> <div class="mt-2 flex flex-wrap gap-2"></div></section>'),zv=q('<div class="flex h-10 w-full items-center justify-between text-sm"><!></div>'),Vv=q('<div class="p-1"><!></div>'),Wv=q('<button type="button"><div class="flex gap-4"><div><!></div> <div><p> </p> <div class="flex gap-2 text-sm"><p> </p></div></div></div> <!></button>'),Hv=q('<div class="flex justify-between place-items-start gap-4 py-4"><div class="flex gap-4"><div><!></div></div> <div class="p-1"><!></div></div>'),Yv=q('<p class="text-xs opacity-50 break-all pb-2 hover:text-primary"><a class="whitespace-pre-wrap"> </a></p>'),Xv=q("<p> </p>"),Nv=q("<!> <p> </p>",1),Uv=q("<p> </p>"),Gv=q('<div class="flex gap-2 text-sm"><!> <!></div>'),qv=q('<p><a class="hover:text-primary"> </a></p>'),$v=q("<p> </p>"),Kv=q("<p> </p>"),Zv=q('<div class="flex gap-4 py-4"><div><!></div> <div><!> <div class="flex gap-2 text-sm"><!> <!></div></div></div>'),Jv=q('<p><a class="hover:text-primary line-clamp-1"> </a></p>'),Qv=q("<p> </p>"),t_=q("<p> </p>"),e_=q('<div class="flex gap-4 py-4"><div><!></div> <div><!> <div class="flex gap-2 text-sm"><!> <!></div></div></div>'),r_=q('<div class="flex flex-col items-center gap-1"><p class="font-bold"> </p> <a target="_blank" class="font-medium text-primary underline focus:outline-none"> </a></div>'),s_=q('<div class="flex items-center justify-center h-full w-full"><!></div>'),i_=q('<div class="h-90"><!></div>'),n_=q('<section class="px-6 dark:text-immich-dark-fg mt-4"><!> <div class="flex gap-4 pt-4"><div><!></div> <div class="mb-auto mt-auto"><p> </p></div></div></section>'),o_=q('<a><div class="flex gap-4 pt-2 hover:cursor-pointer items-center"><div><img class="h-12.5 w-12.5 rounded object-cover" draggable="false"/></div> <div class="mb-auto mt-auto"><p class="dark:text-immich-dark-primary"> </p> <div class="flex flex-col gap-0 text-sm"><div><!></div></div></div></div></a>'),a_=q('<section class="px-6 py-6 dark:text-immich-dark-fg"><div class="pb-4"><!></div> <!></section>'),l_=q('<section class="relative px-2 pb-12 dark:bg-immich-dark-bg dark:text-immich-dark-fg"><!></section>'),c_=q('<section class="relative p-2"><div class="flex place-items-center gap-2"><!> <p class="text-lg text-immich-fg dark:text-immich-dark-fg"> </p></div> <!> <!> <!> <!> <div class="px-4 py-4"><!> <!> <div class="flex gap-4 py-4"><div><!></div> <div><p class="break-all flex place-items-center gap-2 whitespace-pre-wrap"> <!></p> <!> <!></div></div> <!> <!> <!></div></section> <!> <!> <!> <!> <!>',1);function h_(a,t){At(t,!0);const e=()=>at(Xs,"$user",n),r=()=>at(zt,"$t",n),s=()=>at(mu,"$locale",n),i=()=>at(Po,"$preferences",n),[n,o]=It();let l=Tt(t,"asset",7),c=Tt(t,"albums",19,()=>[]),u=Tt(t,"currentAlbum",3,null),d=st(!1),g=st(!1),f=y(()=>e()?.id===l().ownerId),m=y(()=>l().people||[]),p=y(()=>l().unassignedFaces||[]),v=st(!1),x=y(()=>l().exifInfo?.timeZone??void 0),T=y(()=>h(x)&&l().exifInfo?.dateTimeOriginal?wu(l().exifInfo.dateTimeOriginal,h(x)):bu(l().localDateTime)),A=y(()=>(()=>{const et=l().exifInfo?.latitude,ot=l().exifInfo?.longitude;if(et&&ot)return{lat:Number(et.toFixed(7)),lng:Number(ot.toFixed(7))}})()),O=st(void 0),P=y(()=>u()?.id?$e.viewAlbum(u()):$e.photos());Ee(()=>{h(O)||U(O,l().id,!0),l().id!==h(O)&&(U(g,!1),U(O,l().id,!0))});const L=(et,ot)=>{const _t=Math.round(ot*et/1e6);if(_t)return _t},E=async()=>{l(await _i({id:l().id})),U(g,!1)},_=et=>$e.folders({path:vd(et.originalPath)}),j=()=>U(d,!h(d)),X=async()=>{h(f)&&await Dr.show(pv,{asset:Pe(l()),initialDate:h(T),initialTimeZone:h(x)})};var G=c_(),R=Ct(G),B=b(R),V=b(B);{let et=y(()=>r()("close"));Jt(V,{get icon(){return Ti},get"aria-label"(){return h(et)},onclick:()=>Rt.closeDetailPanel(),shape:"round",color:"secondary",variant:"ghost"})}var Q=k(V,2),tt=b(Q,!0);w(Q),w(B);var z=k(B,2);{var $=et=>{var ot=Fv(),_t=b(ot),bt=b(_t),St=b(bt,!0);w(bt);var kt=k(bt,2),Ot=b(kt),Et=b(Ot);{var Xt=pt=>{var wt=pe();lt(Mt=>dt(wt,Mt),[()=>r()("admin.asset_offline_description")]),I(pt,wt)},qt=pt=>{var wt=pe();lt(Mt=>dt(wt,Mt),[()=>r()("asset_offline_description")]),I(pt,wt)};K(Et,pt=>{e()?.isAdmin?pt(Xt):pt(qt,!1)})}w(Ot),w(kt);var ne=k(kt,2),ee=b(ne),mt=b(ee,!0);w(ee),w(ne),w(_t),w(ot),lt(pt=>{dt(St,pt),dt(mt,l().originalPath)},[()=>r()("asset_offline")]),I(et,ot)};K(z,et=>{l().isOffline&&et($)})}var J=k(z,2);$p(J,{get asset(){return l()},get isOwner(){return h(f)}});var rt=k(J,2);cv(rt,{get asset(){return l()},get isOwner(){return h(f)}});var it=k(rt,2);{var ht=et=>{var ot=Bv(),_t=b(ot),bt=b(_t);Rs(bt,{size:"small",color:"muted",children:(mt,pt)=>{Ne();var wt=pe();lt(Mt=>dt(wt,Mt),[()=>r()("people")]),I(mt,wt)},$$slots:{default:!0}});var St=k(bt,2),kt=b(St);{var Ot=mt=>{{let pt=y(()=>r()("show_hidden_people")),wt=y(()=>h(v)?Lh:Fh);Jt(mt,{get"aria-label"(){return h(pt)},get icon(){return h(wt)},size:"medium",shape:"round",color:"secondary",variant:"ghost",onclick:()=>U(v,!h(v))})}},Et=y(()=>h(m).some(mt=>mt.isHidden));K(kt,mt=>{h(Et)&&mt(Ot)})}var Xt=k(kt,2);{let mt=y(()=>r()("tag_people"));Jt(Xt,{get"aria-label"(){return h(mt)},get icon(){return _l},size:"medium",shape:"round",color:"secondary",variant:"ghost",onclick:()=>ds.value=!ds.value})}var qt=k(Xt,2);{var ne=mt=>{{let pt=y(()=>r()("edit_people"));Jt(mt,{get"aria-label"(){return h(pt)},get icon(){return Ys},size:"medium",shape:"round",color:"secondary",variant:"ghost",onclick:()=>U(g,!0)})}};K(qt,mt=>{(h(m).length>0||h(p).length>0)&&mt(ne)})}w(St),w(_t);var ee=k(_t,2);pr(ee,23,()=>h(m),mt=>mt.id,(mt,pt,wt)=>{var Mt=Ce(),he=Ct(Mt);{var xt=te=>{var se=Rv();se.__mouseover=()=>Zt(Or,h(m)[h(wt)].faces);var N=b(se),ct=b(N);{let we=y(()=>vi(h(pt)));as(ct,{curve:!0,shadow:!0,get url(){return h(we)},get altText(){return h(pt).name},get title(){return h(pt).name},widthStyle:"90px",heightStyle:"90px",get hidden(){return h(pt).isHidden}})}w(N);var yt=k(N,2),Ut=b(yt,!0);w(yt);var Oe=k(yt,2);{var xe=we=>{const br=y(()=>di.fromISO(h(pt).birthDate)),ir=y(()=>Math.floor(di.fromISO(l().localDateTime).diff(h(br),"years").years)),Ae=y(()=>Math.floor(di.fromISO(l().localDateTime).diff(h(br),"months").months));var Fr=Ce(),jr=Ct(Fr);{var ps=Rr=>{var Is=jv(),Un=b(Is);{var Wc=nr=>{var is=pe();lt(ii=>dt(is,ii),[()=>r()("age_months",{values:{months:h(Ae)}})]),I(nr,is)},Hc=nr=>{var is=pe();lt(ii=>dt(is,ii),[()=>r()("age_year_months",{values:{months:h(Ae)-12}})]),I(nr,is)},Yc=nr=>{var is=pe();lt(ii=>dt(is,ii),[()=>r()("age_years",{values:{years:h(ir)}})]),I(nr,is)};K(Un,nr=>{h(Ae)<=11?nr(Wc):h(Ae)>12&&h(Ae)<=23?nr(Hc,1):nr(Yc,!1)})}w(Is),lt(nr=>Nt(Is,"title",nr),[()=>h(br).toLocaleString({month:"long",day:"numeric",year:"numeric"},{locale:s()})]),I(Rr,Is)};K(jr,Rr=>{h(ir)>=0&&Rr(ps)})}I(we,Fr)};K(Oe,we=>{h(pt).birthDate&&we(xe)})}w(se),lt(we=>{Nt(se,"href",we),Nt(yt,"title",h(pt).name),dt(Ut,h(pt).name)},[()=>$e.viewPerson(h(pt),{previousRoute:h(P)})]),Be("focus",se,()=>Zt(Or,h(m)[h(wt)].faces)),Be("blur",se,()=>Zt(Or,[])),Be("mouseleave",se,()=>Zt(Or,[])),I(te,se)};K(he,te=>{(h(v)||!h(pt).isHidden)&&te(xt)})}I(mt,Mt)}),w(ee),w(ot),I(et,ot)};K(it,et=>{!$s.isSharedLink&&h(f)&&et(ht)})}var nt=k(it,2),ut=b(nt);{var D=et=>{var ot=zv(),_t=b(ot);Rs(_t,{size:"small",color:"muted",children:(bt,St)=>{Ne();var kt=pe();lt(Ot=>dt(kt,Ot),[()=>r()("details")]),I(bt,kt)},$$slots:{default:!0}}),w(ot),I(et,ot)},W=et=>{Rs(et,{size:"small",color:"muted",children:(ot,_t)=>{Ne();var bt=pe();lt(St=>dt(bt,St),[()=>r()("no_exif_info_available")]),I(ot,bt)},$$slots:{default:!0}})};K(ut,et=>{l().exifInfo?et(D):et(W,!1)})}var H=k(ut,2);{var Y=et=>{var ot=Wv();let _t;ot.__click=X;var bt=b(ot),St=b(bt),kt=b(St);De(kt,{get icon(){return aa},size:"24"}),w(St);var Ot=k(St,2),Et=b(Ot),Xt=b(Et,!0);w(Et);var qt=k(Et,2),ne=b(qt),ee=b(ne,!0);w(ne),w(qt),w(Ot),w(bt);var mt=k(bt,2);{var pt=wt=>{var Mt=Vv(),he=b(Mt);De(he,{get icon(){return Ys},size:"20"}),w(Mt),I(wt,Mt)};K(mt,wt=>{h(f)&&wt(pt)})}w(ot),lt((wt,Mt,he)=>{_t=fr(ot,1,"flex w-full text-start justify-between place-items-start gap-4 py-4",null,_t,{"hover:text-primary":h(f)}),Nt(ot,"title",wt),dt(Xt,Mt),dt(ee,he)},[()=>h(f)?r()("edit_date"):"",()=>h(T).toLocaleString({month:"short",day:"numeric",year:"numeric"},{locale:s()}),()=>h(T).toLocaleString({weekday:"short",hour:"numeric",minute:"2-digit",second:"2-digit",timeZoneName:h(x)?"longOffset":void 0},{locale:s()})]),I(et,ot)},M=et=>{var ot=Hv(),_t=b(ot),bt=b(_t),St=b(bt);De(St,{get icon(){return aa},size:"24"}),w(bt),w(_t);var kt=k(_t,2),Ot=b(kt);De(Ot,{get icon(){return Ys},size:"20"}),w(kt),w(ot),I(et,ot)};K(H,et=>{h(T)?et(Y):!h(T)&&h(f)&&et(M,1)})}var Z=k(H,2),ft=b(Z),Lt=b(ft);De(Lt,{get icon(){return ml},size:"24"}),w(ft);var vt=k(ft,2),Pt=b(vt),Ht=b(Pt),ke=k(Ht);{var Vt=et=>{{let ot=y(()=>r()("show_file_location"));Jt(et,{get icon(){return Eh},get"aria-label"(){return h(ot)},size:"small",shape:"round",color:"secondary",variant:"ghost",onclick:j})}};K(ke,et=>{h(f)&&et(Vt)})}w(Pt);var fe=k(Pt,2);{var Ft=et=>{var ot=Yv(),_t=b(ot),bt=b(_t,!0);w(_t),w(ot),lt((St,kt)=>{Nt(_t,"href",St),Nt(_t,"title",kt),dt(bt,l().originalPath)},[()=>_(l()),()=>r()("go_to_folder")]),Qe(3,ot,()=>Ph,()=>({duration:250})),I(et,ot)};K(fe,et=>{h(d)&&et(Ft)})}var me=k(fe,2);{var vr=et=>{var ot=Gv(),_t=b(ot);{var bt=Ot=>{const Et=y(()=>{const{width:wt,height:Mt}=Tl(l().exifInfo);return{width:wt,height:Mt}});var Xt=Nv(),qt=Ct(Xt);{var ne=wt=>{var Mt=Xv(),he=b(Mt);w(Mt),lt(xt=>dt(he,`${xt??""} MP`),[()=>L(l().exifInfo.exifImageHeight,l().exifInfo.exifImageWidth)]),I(wt,Mt)},ee=y(()=>L(l().exifInfo.exifImageHeight,l().exifInfo.exifImageWidth));K(qt,wt=>{h(ee)&&wt(ne)})}var mt=k(qt,2),pt=b(mt);w(mt),lt(()=>dt(pt,`${h(Et).width??""} x ${h(Et).height??""}`)),I(Ot,Xt)};K(_t,Ot=>{l().exifInfo?.exifImageHeight&&l().exifInfo?.exifImageWidth&&Ot(bt)})}var St=k(_t,2);{var kt=Ot=>{var Et=Uv(),Xt=b(Et,!0);w(Et),lt(qt=>dt(Xt,qt),[()=>pu(l().exifInfo.fileSizeInByte,s())]),I(Ot,Et)};K(St,Ot=>{l().exifInfo?.fileSizeInByte&&Ot(kt)})}w(ot),I(et,ot)};K(me,et=>{(l().exifInfo?.exifImageHeight&&l().exifInfo?.exifImageWidth||l().exifInfo?.fileSizeInByte)&&et(vr)})}w(vt),w(Z);var Pr=k(Z,2);{var ts=et=>{var ot=Zv(),_t=b(ot),bt=b(_t);De(bt,{get icon(){return Mh},size:"24"}),w(_t);var St=k(_t,2),kt=b(St);{var Ot=mt=>{var pt=qv(),wt=b(pt),Mt=b(wt);w(wt),w(pt),lt((he,xt)=>{Nt(wt,"href",he),Nt(wt,"title",`${xt??""} ${(l().exifInfo.make||"")??""} ${(l().exifInfo.model||"")??""}`),dt(Mt,`${(l().exifInfo.make||"")??""}
                ${(l().exifInfo.model||"")??""}`)},[()=>$e.search({make:l().exifInfo?.make??void 0,model:l().exifInfo?.model??void 0}),()=>r()("search_for")]),I(mt,pt)};K(kt,mt=>{(l().exifInfo?.make||l().exifInfo?.model)&&mt(Ot)})}var Et=k(kt,2),Xt=b(Et);{var qt=mt=>{var pt=$v(),wt=b(pt,!0);w(pt),lt(()=>dt(wt,`${l().exifInfo.exposureTime} s`)),I(mt,pt)};K(Xt,mt=>{l().exifInfo.exposureTime&&mt(qt)})}var ne=k(Xt,2);{var ee=mt=>{var pt=Kv(),wt=b(pt,!0);w(pt),lt(()=>dt(wt,`ISO ${l().exifInfo.iso}`)),I(mt,pt)};K(ne,mt=>{l().exifInfo.iso&&mt(ee)})}w(Et),w(St),w(ot),I(et,ot)};K(Pr,et=>{(l().exifInfo?.make||l().exifInfo?.model||l().exifInfo?.exposureTime||l().exifInfo?.iso)&&et(ts)})}var _r=k(Pr,2);{var es=et=>{var ot=e_(),_t=b(ot),bt=b(_t);De(bt,{get icon(){return Ih},size:"24"}),w(_t);var St=k(_t,2),kt=b(St);{var Ot=mt=>{var pt=Jv(),wt=b(pt),Mt=b(wt,!0);w(wt),w(pt),lt((he,xt)=>{Nt(wt,"href",he),Nt(wt,"title",`${xt??""} ${l().exifInfo.lensModel??""}`),dt(Mt,l().exifInfo.lensModel)},[()=>$e.search({lensModel:l().exifInfo.lensModel}),()=>r()("search_for")]),I(mt,pt)};K(kt,mt=>{l().exifInfo?.lensModel&&mt(Ot)})}var Et=k(kt,2),Xt=b(Et);{var qt=mt=>{var pt=Qv(),wt=b(pt);w(pt),lt(Mt=>dt(wt,`/${Mt??""}`),[()=>l().exifInfo.fNumber.toLocaleString(s())]),I(mt,pt)};K(Xt,mt=>{l().exifInfo?.fNumber&&mt(qt)})}var ne=k(Xt,2);{var ee=mt=>{var pt=t_(),wt=b(pt,!0);w(pt),lt(Mt=>dt(wt,Mt),[()=>`${l().exifInfo.focalLength.toLocaleString(s())} mm`]),I(mt,pt)};K(ne,mt=>{l().exifInfo.focalLength&&mt(ee)})}w(Et),w(St),w(ot),I(et,ot)};K(_r,et=>{(l().exifInfo?.lensModel||l().exifInfo?.fNumber||l().exifInfo?.focalLength)&&et(es)})}var yr=k(_r,2);sv(yr,{get isOwner(){return h(f)},get asset(){return l()}}),w(nt),w(R);var ae=k(R,2);{var xr=et=>{var ot=i_(),_t=b(ot);yi(_t,()=>zs(()=>import("./DBZgVNgs.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48])),bt=>{var St=Ce(),kt=Ct(St);yi(kt,()=>fu(Qh),null,Ot=>{var Et=s_(),Xt=b(Et);gr(Xt,{}),w(Et),I(Ot,Et)}),I(bt,St)},(bt,St)=>{var kt=y(()=>{var{default:qt}=h(St);return{Map:qt}}),Ot=y(()=>h(kt).Map),Et=Ce(),Xt=Ct(Et);{const qt=(mt,pt)=>{let wt=()=>pt?.().marker;const Mt=y(()=>{const{lat:ct,lon:yt}=wt();return{lat:ct,lon:yt}});var he=r_(),xt=b(he),te=b(xt);w(xt);var se=k(xt,2),N=b(se,!0);w(se),w(he),lt((ct,yt,Ut)=>{dt(te,`${ct??""}, ${yt??""}`),Nt(se,"href",`https://www.openstreetmap.org/?mlat=${h(Mt).lat??""}&mlon=${h(Mt).lon??""}&zoom=13#map=15/${h(Mt).lat??""}/${h(Mt).lon??""}`),dt(N,Ut)},[()=>h(Mt).lat.toPrecision(6),()=>h(Mt).lon.toPrecision(6),()=>r()("open_in_openstreetmap")]),I(mt,he)};let ne=y(()=>[{lat:h(A).lat,lon:h(A).lng,id:l().id,city:l().exifInfo?.city??null,state:l().exifInfo?.state??null,country:l().exifInfo?.country??null}]),ee=y(()=>!h(g));Mn(Xt,()=>h(Ot),(mt,pt)=>{pt(mt,{get mapMarkers(){return h(ne)},get center(){return h(A)},showSettings:!1,zoom:12.5,simplified:!0,useLocationPin:!0,get showSimpleControls(){return h(ee)},onOpenInMapView:()=>fn($e.map({...h(A),zoom:12.5})),popup:qt,$$slots:{popup:!0}})})}I(bt,Et)}),w(ot),I(et,ot)};K(ae,et=>{h(A)&&Eo.value.map&&et(xr)})}var rs=k(ae,2);{var Mr=et=>{var ot=n_(),_t=b(ot);Rs(_t,{size:"small",color:"muted",children:(qt,ne)=>{Ne();var ee=pe();lt(mt=>dt(ee,mt),[()=>r()("shared_by")]),I(qt,ee)},$$slots:{default:!0}});var bt=k(_t,2),St=b(bt),kt=b(St);Jh(kt,{get user(){return l().owner},size:"md"}),w(St);var Ot=k(St,2),Et=b(Ot),Xt=b(Et,!0);w(Et),w(Ot),w(bt),w(ot),lt(()=>dt(Xt,l().owner.name)),I(et,ot)};K(rs,et=>{u()&&u().albumUsers.length>0&&l().owner&&et(Mr)})}var Ir=k(rs,2);{var Lr=et=>{var ot=a_(),_t=b(ot),bt=b(_t);Rs(bt,{size:"small",color:"muted",children:(kt,Ot)=>{Ne();var Et=pe();lt(Xt=>dt(Et,Xt),[()=>r()("appears_in")]),I(kt,Et)},$$slots:{default:!0}}),w(_t);var St=k(_t,2);pr(St,17,c,kt=>kt.id,(kt,Ot)=>{var Et=o_(),Xt=b(Et),qt=b(Xt),ne=b(qt);w(qt);var ee=k(qt,2),mt=b(ee),pt=b(mt,!0);w(mt);var wt=k(mt,2),Mt=b(wt),he=b(Mt);eu(he,{get album(){return h(Ot)}}),w(Mt),w(wt),w(ee),w(Xt),w(Et),lt((xt,te)=>{Nt(Et,"href",xt),Nt(ne,"alt",h(Ot).albumName),Nt(ne,"src",te),dt(pt,h(Ot).albumName)},[()=>$e.viewAlbum(h(Ot)),()=>h(Ot).albumThumbnailAssetId&&ks({id:h(Ot).albumThumbnailAssetId,size:hs.Preview})]),I(kt,Et)}),w(ot),I(et,ot)};K(Ir,et=>{c().length>0&&et(Lr)})}var ss=k(Ir,2);{var wr=et=>{var ot=l_(),_t=b(ot);gv(_t,{get asset(){return l()},get isOwner(){return h(f)}}),w(ot),I(et,ot)};K(ss,et=>{i()?.tags?.enabled&&et(wr)})}var jt=k(ss,2);{var Yt=et=>{Lv(et,{get assetId(){return l().id},get assetType(){return l().type},onClose:()=>U(g,!1),onRefresh:E})};K(jt,et=>{h(g)&&et(Yt)})}lt(et=>{dt(tt,et),dt(Ht,`${l().originalFileName??""} `)},[()=>r()("info")]),I(a,G),Dt(),o()}Zr(["mouseover","click"]);var u_=q('<!> <p class="text-lg text-immich-fg dark:text-immich-dark-fg capitalize"> </p>',1),d_=q("<!> <!>",1),g_=q('<section class="relative flex flex-col h-full p-2 dark:bg-immich-dark-bg dark:text-immich-dark-fg dark pt-3"><!> <section><!></section> <div class="flex-1"></div> <section class="p-4"><!></section></section>');function f_(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It();tr(()=>vu.on("on_asset_update",p=>{p.id===o().id&&o(p)})),tr(async()=>{const p=await Vu({id:o().id});await qe.activateTool(ra.Transform,o(),p)}),qs(()=>{qe.cleanup()});async function i(){await qe.applyEdits()&&t.onClose()}async function n(){await qe.closeConfirm()&&t.onClose()}let o=Tt(t,"asset",15);var l=g_();Ue(ze,(p,v)=>In?.(p,v),()=>({shortcut:{key:"Escape"},onShortcut:t.onClose}));var c=b(l);pn(c,{class:"justify-between me-4",children:(p,v)=>{var x=d_(),T=Ct(x);pn(T,{children:(O,P)=>{var L=u_(),E=Ct(L);{let X=y(()=>e()("close"));Jt(E,{shape:"round",variant:"ghost",color:"secondary",get icon(){return Ti},get"aria-label"(){return h(X)},onclick:n})}var _=k(E,2),j=b(_,!0);w(_),lt(X=>dt(j,X),[()=>e()("editor")]),I(O,L)},$$slots:{default:!0}});var A=k(T,2);gn(A,{shape:"round",size:"small",onclick:i,get loading(){return qe.isApplyingEdits},children:(O,P)=>{Ne();var L=pe();lt(E=>dt(L,E),[()=>e()("save")]),I(O,L)},$$slots:{default:!0}}),I(p,x)},$$slots:{default:!0}});var u=k(c,2),d=b(u);{var g=p=>{var v=Ce(),x=Ct(v);Mn(x,()=>qe.selectedTool.component,(T,A)=>{A(T,{})}),I(p,v)};K(d,p=>{qe.selectedTool&&p(g)})}w(u);var f=k(u,4),m=b(f);{let p=y(()=>!qe.canReset);gn(m,{variant:"outline",onclick:()=>qe.resetAllChanges(),get disabled(){return h(p)},class:"self-start",shape:"round",size:"small",children:(v,x)=>{Ne();var T=pe();lt(A=>dt(T,A),[()=>e()("editor_reset_all_changes")]),I(v,T)},$$slots:{default:!0}})}w(f),w(l),I(a,l),Dt(),s()}var m_=q('<div class="canvas-container svelte-5ud7ea"><button aria-label="Crop area" type="button"><img draggable="false" class="svelte-5ud7ea"/> <div><div class="grid svelte-5ud7ea"></div> <div class="corner top-left svelte-5ud7ea"></div> <div class="corner top-right svelte-5ud7ea"></div> <div class="corner bottom-left svelte-5ud7ea"></div> <div class="corner bottom-right svelte-5ud7ea"></div></div> <div></div></button></div>');function p_(a,t){At(t,!0);const e=()=>at(Ol,"$getAltText",r),[r,s]=It();let i=st(null),n=y(()=>ks({id:t.asset.id,cacheKey:t.asset.thumbhash,edited:!1,size:hs.Preview})),o=y(()=>{const f=[];return Qt.mirrorHorizontal&&f.push("scaleX(-1)"),Qt.mirrorVertical&&f.push("scaleY(-1)"),f.join(" ")});Ee(()=>{if(!h(i))return;const f=new ResizeObserver(()=>{Qt.resizeCanvas()});return f.observe(h(i)),()=>{f.disconnect()}});var l=m_(),c=b(l);c.__mousedown=f=>Qt.handleMouseDown(f),c.__mouseup=()=>Qt.handleMouseUp();var u=b(c),d=k(u,2);Je(d,f=>Qt.cropFrame=f,()=>Qt?.cropFrame);var g=k(d,2);Je(g,f=>Qt.overlayEl=f,()=>Qt?.overlayEl),w(c),Je(c,f=>Qt.cropAreaEl=f,()=>Qt?.cropAreaEl),w(l),Je(l,f=>U(i,f),()=>h(i)),lt(f=>{fr(c,1,`crop-area ${Qt.orientationChanged?"changedOriention":""}`,"svelte-5ud7ea"),us(c,`rotate:${Qt.imageRotation}deg`),Nt(u,"src",h(n)),Nt(u,"alt",f),us(u,h(o)?`transform: ${h(o)}`:""),fr(d,1,`${Qt.isInteracting?"resizing":""} crop-frame`,"svelte-5ud7ea"),fr(g,1,`${Qt.isInteracting?"light":""} overlay`,"svelte-5ud7ea")},[()=>e()(Pe(t.asset))]),I(a,l),Dt(),s()}Zr(["mousedown","mouseup"]);var v_=q('<div class="flex h-full select-none place-content-center place-items-center"><!></div>');function __(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It(),i=async l=>{const c=await Wu({...$s.params,id:l,size:hs.Preview});return URL.createObjectURL(c)};var n=v_(),o=b(n);yi(o,()=>Promise.all([i(t.asset.id),zs(()=>import("./BppaSL2M.js"),__vite__mapDeps([49,1,6,4,5,7,19,10,50,3,39,40,11,12,41,15,23,17,2,8,28,29,9,13,22,42,51,21,52,24,25,26,27,53,54,30,55,56,34,32,33,36,37,57,31,58,16,59,60,61,62,63]))]),l=>{gr(l,{})},(l,c)=>{var u=y(()=>{var[p,{default:v}]=h(c);return{data:p,PhotoSphereViewer:v}}),d=y(()=>h(u).data),g=y(()=>h(u).PhotoSphereViewer),f=Ce(),m=Ct(f);{let p=y(()=>Do({asset:t.asset,forceOriginal:!0}));Mn(m,()=>h(g),(v,x)=>{x(v,{get panorama(){return h(d)},get originalPanorama(){return h(p)}})})}I(l,f)},l=>{var c=pe();lt(u=>dt(c,u),[()=>e()("errors.failed_to_load_asset")]),I(l,c)}),w(n),Qe(3,n,()=>Pn,()=>({duration:150})),I(a,n),Dt(),s()}function y_(a,t){At(t,!1);const e=()=>at(zt,"$t",r),[r,s]=It();xd();{let i=sa(()=>kr.showOverlay?e()("hide_text_recognition"):e()("show_text_recognition")),n=sa(()=>e()("text_recognition"));Jt(a,{get title(){return h(i)},get icon(){return jh},class:"dark {ocrStore.showOverlay ? 'bg-immich-primary text-white dark' : 'dark'}",color:"secondary",variant:"ghost",shape:"round",get"aria-label"(){return h(n)},onclick:()=>kr.toggleOcrBoundingBox()})}Dt(),s()}var x_=q('<span class="absolute start-0 h-[3px] bg-immich-primary shadow-2xl"></span>');function w_(a,t){At(t,!0);const e=()=>at(g,"$progress",r),[r,s]=It();let i=Tt(t,"autoplay",3,!1),n=Tt(t,"status",15),o=Tt(t,"hidden",3,!1),l=Tt(t,"duration",3,5),c=Tt(t,"onPlaying",3,()=>{}),u=Tt(t,"onPaused",3,()=>{});const d=async E=>{g=x(E),await f()};let g=x(l());Ee(()=>{Sr(d(l()))}),Ee(()=>{e()===1&&t.onDone()}),tr(async()=>{i()?(n(Hr.Playing),await f()):(n(Hr.Paused),await g.set(0))});const f=async()=>{n(Hr.Playing),c()(),await g.set(1)},m=async()=>{n(Hr.Paused),u()(),await g.set(e())},p=async()=>{await g.set(0),n()!==Hr.Paused&&await f()},v=async()=>{await g.set(0)};function x(E){return wd(0,{duration:(_,j)=>j?E*1e3*(j-_):0})}var T={play:f,pause:m,restart:p,resetProgress:v},A=Ce(),O=Ct(A);{var P=E=>{var _=x_();let j;lt(()=>j=us(_,"",j,{width:`${e()*100}%`})),I(E,_)};K(O,E=>{o()||E(P)})}I(a,A);var L=Dt(T);return s(),L}var b_=q('<div class="rounded-full bg-orange-100 px-2 text-[10px] text-orange-900"> </div>'),S_=q('<div class="flex place-items-center justify-between"><div><div class="flex h-6.5 place-items-center gap-1"><label class="font-medium text-sm"> </label> <!></div> <p class="text-sm dark:text-immich-dark-fg"> </p> <!></div> <div class="w-fit"><!></div></div>');function hl(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It();let i=Tt(t,"subtitle",3,""),n=Tt(t,"selectedOption",15),o=Tt(t,"isEdited",3,!1);var l=S_(),c=b(l),u=b(c),d=b(u),g=b(d,!0);w(d);var f=k(d,2);{var m=O=>{var P=b_(),L=b(P,!0);w(P),lt(E=>dt(L,E),[()=>e()("unsaved_change")]),Qe(3,P,()=>Ts,()=>({x:10,duration:200,easing:yd})),I(O,P)};K(f,O=>{o()&&O(m)})}w(u);var p=k(u,2),v=b(p,!0);w(p);var x=k(p,2);ul(x,()=>t.children??Ao),w(c);var T=k(c,2),A=b(T);bd(A,{get options(){return t.options},position:"bottom-right",hideTextOnSmallScreen:!1,render:O=>({title:O.title,icon:O.icon}),get onSelect(){return t.onToggle},get selectedOption(){return n()},set selectedOption(O){n(O)}}),w(T),w(l),lt(()=>{Nt(d,"for",t.title),dt(g,t.title),dt(v,i())}),I(a,l),Dt(),s()}var C_=q("<!> <!>",1),T_=q('<div class="flex flex-col gap-4"><!> <!> <!> <!> <!> <!> <!></div>');function k_(a,t){At(t,!0);const e=()=>at(g,"$slideshowDelay",u),r=()=>at(f,"$showProgressBar",u),s=()=>at(m,"$slideshowNavigation",u),i=()=>at(p,"$slideshowLook",u),n=()=>at(v,"$slideshowTransition",u),o=()=>at(x,"$slideshowAutoplay",u),l=()=>at(T,"$slideshowRepeat",u),c=()=>at(zt,"$t",u),[u,d]=It(),{slideshowDelay:g,showProgressBar:f,slideshowNavigation:m,slideshowLook:p,slideshowTransition:v,slideshowAutoplay:x,slideshowRepeat:T,slideshowState:A}=Ln;let O=st(ue(e())),P=st(ue(r())),L=st(ue(s())),E=st(ue(i())),_=st(ue(n())),j=st(ue(o())),X=st(ue(l()));const G={[Os.Shuffle]:{icon:zh,title:c()("shuffle")},[Os.AscendingOrder]:{icon:Bh,title:c()("backward")},[Os.DescendingOrder]:{icon:Rh,title:c()("forward")}},R={[nn.Contain]:{icon:Hh,title:c()("contain")},[nn.Cover]:{icon:Wh,title:c()("cover")},[nn.BlurredBackground]:{icon:Vh,title:c()("blurred_background")}},B=(Q,tt)=>{for(const[z,$]of Object.entries(tt))if($===Q)return z},V=()=>{Zt(g,h(O)),Zt(f,h(P)),Zt(m,h(L)),Zt(p,h(E)),Zt(v,h(_)),Zt(x,h(j)),Zt(T,h(X)),Zt(A,oe.PlaySlideshow),t.onClose()};{let Q=y(()=>c()("slideshow_settings"));Io(a,{size:"small",get title(){return h(Q)},get onClose(){return t.onClose},onSubmit:V,children:(tt,z)=>{var $=T_(),J=b($);{let W=y(()=>c()("direction")),H=y(()=>Object.values(G));hl(J,{get title(){return h(W)},get options(){return h(H)},get selectedOption(){return G[h(L)]},onToggle:Y=>{U(L,B(Y,G)||h(L),!0)}})}var rt=k(J,2);{let W=y(()=>c()("look")),H=y(()=>Object.values(R));hl(rt,{get title(){return h(W)},get options(){return h(H)},get selectedOption(){return R[h(E)]},onToggle:Y=>{U(E,B(Y,R)||h(E),!0)}})}var it=k(rt,2);{let W=y(()=>c()("autoplay_slideshow"));oi(it,{get label(){return h(W)},children:(H,Y)=>{Ei(H,{get checked(){return h(j)},set checked(M){U(j,M,!0)}})},$$slots:{default:!0}})}var ht=k(it,2);{let W=y(()=>c()("show_progress_bar"));oi(ht,{get label(){return h(W)},children:(H,Y)=>{Ei(H,{get checked(){return h(P)},set checked(M){U(P,M,!0)}})},$$slots:{default:!0}})}var nt=k(ht,2);{let W=y(()=>c()("show_slideshow_transition"));oi(nt,{get label(){return h(W)},children:(H,Y)=>{Ei(H,{get checked(){return h(_)},set checked(M){U(_,M,!0)}})},$$slots:{default:!0}})}var ut=k(nt,2);{let W=y(()=>c()("slideshow_repeat")),H=y(()=>c()("slideshow_repeat_description"));oi(ut,{get label(){return h(W)},get description(){return h(H)},children:(Y,M)=>{Ei(Y,{get checked(){return h(X)},set checked(Z){U(X,Z,!0)}})},$$slots:{default:!0}})}var D=k(ut,2);{let W=y(()=>c()("duration"));oi(D,{get label(){return h(W)},children:(H,Y)=>{var M=C_(),Z=Ct(M);Sd(Z,{min:1,get value(){return h(O)},set value(Lt){U(O,Lt,!0)}});var ft=k(Z,2);Cd(ft,{children:(Lt,vt)=>{Ne();var Pt=pe();lt(Ht=>dt(Pt,Ht),[()=>c()("admin.slideshow_duration_description")]),I(Lt,Pt)},$$slots:{default:!0}}),I(H,M)},$$slots:{default:!0}})}w($),I(tt,$)},$$slots:{default:!0}})}Dt(),d()}var O_=q('<div class="m-4 flex gap-2 dark" role="navigation"><!> <!> <!> <!> <!> <!></div>'),A_=q(" <!> <!>",1);function D_(a,t){At(t,!0);const e=()=>at(x,"$slideshowNavigation",o),r=()=>at(zt,"$t",o),s=()=>at(T,"$slideshowAutoplay",o),i=()=>at(v,"$showProgressBar",o),n=()=>at(p,"$slideshowDelay",o),[o,l]=It();let c=Tt(t,"onNext",3,()=>{}),u=Tt(t,"onPrevious",3,()=>{}),d=Tt(t,"onClose",3,()=>{}),g=Tt(t,"onSetToFullScreen",3,()=>{});const{restartProgress:f,stopProgress:m,slideshowDelay:p,showProgressBar:v,slideshowNavigation:x,slideshowAutoplay:T}=Ln;let A=st(void 0),O=st(void 0),P=st(!0),L,E=st(!1);const _=y(()=>t.assetType===cs.Video);let j,X;const G=H=>{document.body.style.cursor=H},R=()=>{clearTimeout(L),G("")},B=()=>{U(P,!0),R(),V()},V=()=>{L=setTimeout(()=>{h(E)||(U(P,!1),G("none"))},2500)};tr(()=>{V(),j=f.subscribe(H=>{H&&h(O)?.restart()}),X=m.subscribe(H=>{H&&(h(O)?.restart(),R())})}),qs(()=>{j&&j(),X&&X()});const Q=async()=>{if(await h(O)?.resetProgress(),e()===Os.AscendingOrder){u()();return}c()()},tt=async()=>{document.fullscreenElement&&await document.exitFullscreen(),await Dr.show(k_)};tr(()=>{function H(){const Y=document;!document.fullscreenElement&&!Y.webkitIsFullScreen&&d()()}return document.addEventListener("fullscreenchange",H),document.addEventListener("webkitfullscreenchange",H),()=>{document.removeEventListener("fullscreenchange",H),document.removeEventListener("webkitfullscreenchange",H)}});const{swipe:z,onswipe:$,onswipedown:J}=ea(()=>{},()=>({touchAction:"pan-x"}),{onswipedown:B},!0),rt=y(()=>{const H=[{shortcut:{key:"Escape"},onShortcut:d()},{shortcut:{key:"ArrowLeft"},onShortcut:u()},{shortcut:{key:"ArrowRight"},onShortcut:c()}];return h(_)||H.push({shortcut:{key:" "},onShortcut:()=>{h(A)===Hr.Paused?h(O)?.play():h(O)?.pause()},preventDefault:!0}),H});Ne();var it=A_();Be("mousemove",ze,B),Ue(ze,(H,Y)=>Ps?.(H,Y),()=>h(rt)),Yh(ze.body,()=>z),Be("swipe",ze.body,$),Be("swipedown",ze.body,J);var ht=Ct(it);ht.nodeValue=" ";var nt=k(ht);{var ut=H=>{var Y=O_(),M=b(Y);{let Vt=y(()=>r()("exit_slideshow"));Jt(M,{variant:"ghost",shape:"round",color:"secondary",get icon(){return Ti},get onclick(){return d()},get"aria-label"(){return h(Vt)}})}var Z=k(M,2);{var ft=Vt=>{{let fe=y(()=>h(A)===Hr.Paused?xl:wl),Ft=y(()=>h(A)===Hr.Paused?r()("play"):r()("pause"));Jt(Vt,{variant:"ghost",shape:"round",color:"secondary",get icon(){return h(fe)},onclick:()=>h(A)===Hr.Paused?h(O)?.play():h(O)?.pause(),get"aria-label"(){return h(Ft)}})}};K(Z,Vt=>{h(_)||Vt(ft)})}var Lt=k(Z,2);{let Vt=y(()=>r()("previous"));Jt(Lt,{variant:"ghost",shape:"round",color:"secondary",get icon(){return fl},get onclick(){return u()},get"aria-label"(){return h(Vt)}})}var vt=k(Lt,2);{let Vt=y(()=>r()("next"));Jt(vt,{variant:"ghost",shape:"round",color:"secondary",get icon(){return gl},get onclick(){return c()},get"aria-label"(){return h(Vt)}})}var Pt=k(vt,2);{let Vt=y(()=>r()("slideshow_settings"));Jt(Pt,{variant:"ghost",shape:"round",color:"secondary",get icon(){return Xh},onclick:tt,get"aria-label"(){return h(Vt)}})}var Ht=k(Pt,2);{var ke=Vt=>{{let fe=y(()=>r()("set_slideshow_to_fullscreen"));Jt(Vt,{variant:"ghost",shape:"round",color:"secondary",get icon(){return Nh},get onclick(){return g()},get"aria-label"(){return h(fe)}})}};K(Ht,Vt=>{t.isFullScreen||Vt(ke)})}w(Y),Be("mouseenter",Y,()=>U(E,!0)),Be("mouseleave",Y,()=>U(E,!1)),Qe(3,Y,()=>Ts,()=>({duration:150})),I(H,Y)};K(nt,H=>{h(P)&&H(ut)})}var D=k(nt,2);{var W=H=>{{let Y=y(()=>!i());Je(w_(H,{get autoplay(){return s()},get hidden(){return h(Y)},get duration(){return n()},onDone:Q,get status(){return h(A)},set status(M){U(A,M,!0)}}),M=>U(O,M,!0),()=>h(O))}};K(D,H=>{h(_)||H(W)})}I(a,it),Dt(),l()}var E_=q('<div class="p-3"><!></div>'),P_=q('<span class="flex items-center space-x-2 text-gray-200 text-2xl font-bold"><!> <span> </span></span> <img alt="poster" class="rounded-xl m-4"/> <div class="flex place-content-center place-items-center"><!> <input type="range" min="0" class="w-full h-4 bg-primary"/></div>',1);function M_(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It();let i=st(null);const n=async()=>{switch(be.castState){case vs.PLAYING:{be.pause();break}case vs.IDLE:{await o(t.assetFileUrl,!0);break}default:{be.play();break}}};Ee(()=>{t.assetFileUrl&&o(t.assetFileUrl)}),Ee(()=>{be.castState===vs.IDLE&&h(i)!==vs.PAUSED&&t.onVideoEnded(),U(i,be.castState,!0)});const o=async(O,P=!1)=>{if(!O||!be.isCasting)return;const L=new URL(O,globalThis.location.href);try{await be.loadMedia(L.href,P),t.onVideoStarted()}catch(E){ce(E,"Unable to cast");return}};function l(O){const P=Number.parseFloat(O.target.value);be.seekTo(P)}var c=P_(),u=Ct(c),d=b(u);De(d,{get icon(){return Uh},class:"text-primary",size:"36"});var g=k(d,2),f=b(g);w(g),w(u);var m=k(u,2),p=k(m,2),v=b(p);{var x=O=>{var P=E_(),L=b(P);gr(L,{}),w(P),I(O,P)},T=O=>{{let P=y(()=>be.castState==vs.PLAYING?wl:xl),L=y(()=>be.castState==vs.PLAYING?"Pause":"Play");Jt(O,{color:"primary",shape:"round",variant:"ghost",get icon(){return h(P)},onclick:()=>n(),get"aria-label"(){return h(L)}})}};K(v,O=>{be.castState==vs.BUFFERING?O(x):O(T,!1)})}var A=k(v,2);vl(A),A.__change=l,w(p),lt(O=>{dt(f,`${O??""} ${be.receiverName??""}`),Nt(m,"src",t.poster),Nt(A,"max",be.duration),Gh(A,be.currentTime??0)},[()=>e()("connected_to")]),I(a,c),Dt(),s()}Zr(["change"]);var I_=q('<div class="place-content-center h-full place-items-center"><!></div>'),L_=q('<div class="absolute flex place-content-center place-items-center"><!></div>'),F_=q("<video></video> <!> <!>",3),j_=q('<div class="flex h-full select-none place-content-center place-items-center"><!></div>');function R_(a,t){At(t,!0);const e=()=>at(yu,"$loopVideoPreference",n),r=()=>at(_u,"$autoPlayVideo",n),s=()=>at(ha,"$videoViewerMuted",n),i=()=>at(ua,"$videoViewerVolume",n),[n,o]=It();let l=Tt(t,"onPreviousAsset",3,()=>{}),c=Tt(t,"onNextAsset",3,()=>{}),u=Tt(t,"onVideoEnded",3,()=>{}),d=Tt(t,"onVideoStarted",3,()=>{}),g=Tt(t,"onClose",3,()=>{}),f=st(void 0),m=st(!0),p=y(()=>t.playOriginalVideo?ks({id:t.assetId,size:hs.Original,cacheKey:t.cacheKey}):kl({id:t.assetId,cacheKey:t.cacheKey})),v=st(!1),x=st(!1);tr(()=>{U(x,!0)}),Ee(()=>{h(p)&&h(f)?.load()}),qs(()=>{h(f)&&(h(f).src="")});const T=async X=>{try{!X.paused&&!h(v)&&(await X.play(),d()())}catch(G){if(G instanceof DOMException&&G.name==="NotAllowedError"){await A(X);return}}finally{U(m,!1)}},A=async X=>{if(!X.muted)try{X.muted=!0,await T(X)}catch{}},O=X=>{X.detail.direction==="left"&&c()(),X.detail.direction==="right"&&l()()};let P=st(0),L=st(0);Ee(()=>{ds.value&&h(f)?.pause()});var E=Ce(),_=Ct(E);{var j=X=>{var G=j_(),R=b(G);{var B=Q=>{var tt=I_(),z=b(tt);{let $=y(()=>ks({id:t.assetId,size:hs.Preview,cacheKey:t.cacheKey}));M_(z,{get poster(){return h($)},get onVideoStarted(){return d()},get onVideoEnded(){return u()},get assetFileUrl(){return h(p)}})}w(tt),I(Q,tt)},V=Q=>{var tt=F_(),z=Ct(tt),$=Y=>T(Y.currentTarget),J=Y=>Zt(ha,Y.currentTarget.muted),rt=()=>U(v,!0),it=()=>U(v,!1),ht=Y=>{Y.currentTarget.focus()},nt=()=>g()();pl(z,(Y,M)=>({loop:e()&&t.loopVideo,autoplay:r(),playsinline:!0,controls:!0,disablePictureInPicture:!0,class:"h-full object-contain",...Y,oncanplay:$,onended:u(),onvolumechange:J,onseeking:rt,onseeked:it,onplaying:ht,onclose:nt,muted:s(),poster:M,src:h(p)}),[()=>ea(O),()=>ks({id:t.assetId,size:hs.Preview,cacheKey:t.cacheKey})]),Je(z,Y=>U(f,Y),()=>h(f));var ut=k(z,2);{var D=Y=>{var M=L_(),Z=b(M);gr(Z,{}),w(M),I(Y,M)};K(ut,Y=>{h(m)&&Y(D)})}var W=k(ut,2);{var H=Y=>{Rc(Y,{get htmlElement(){return h(f)},get containerWidth(){return h(P)},get containerHeight(){return h(L)},get assetId(){return t.assetId}})};K(W,Y=>{ds.value&&Y(H)})}Td(z,i,Y=>Zt(ua,Y)),I(Q,tt)};K(R,Q=>{be.isCasting?Q(B):Q(V,!1)})}w(G),Qe(3,G,()=>Pn,()=>({duration:bl})),vn(G,"clientWidth",Q=>U(P,Q)),vn(G,"clientHeight",Q=>U(L,Q)),I(X,G)};K(_,X=>{h(x)&&X(j)})}I(a,E),Dt(),o()}var B_=q('<div class="flex h-full select-none place-content-center place-items-center"><!></div>');function z_(a,t){At(t,!0);const e=()=>at(zt,"$t",r),[r,s]=It(),i=Promise.all([zs(()=>import("./BppaSL2M.js"),__vite__mapDeps([49,1,6,4,5,7,19,10,50,3,39,40,11,12,41,15,23,17,2,8,28,29,9,13,22,42,51,21,52,24,25,26,27,53,54,30,55,56,34,32,33,36,37,57,31,58,16,59,60,61,62,63])).then(l=>l.default),zs(()=>import("./C2CyOes3.js"),__vite__mapDeps([64,62,65])).then(l=>l.EquirectangularVideoAdapter),zs(()=>import("./ClEInM3m.js"),__vite__mapDeps([66,62,65])).then(l=>l.VideoPlugin),zs(()=>Promise.resolve({}),__vite__mapDeps([67]))]);var n=B_(),o=b(n);yi(o,()=>i,l=>{gr(l,{})},(l,c)=>{var u=y(()=>{var[v,x,T]=h(c);return{PhotoSphereViewer:v,adapter:x,videoPlugin:T}}),d=y(()=>h(u).PhotoSphereViewer),g=y(()=>h(u).adapter),f=y(()=>h(u).videoPlugin),m=Ce(),p=Ct(m);{let v=y(()=>({source:kl({id:t.asset.id})})),x=y(()=>({source:Do({asset:t.asset,forceOriginal:!0})})),T=y(()=>[h(f)]);Mn(p,()=>h(d),(A,O)=>{O(A,{get panorama(){return h(v)},get originalPanorama(){return h(x)},get plugins(){return h(T)},get adapter(){return h(g)},navbar:!0})})}I(l,m)},l=>{var c=pe();lt(u=>dt(c,u),[()=>e()("errors.failed_to_load_asset")]),I(l,c)}),w(n),Qe(3,n,()=>Pn,()=>({duration:150})),I(a,n),Dt(),s()}function uo(a,t){At(t,!0);const e=y(()=>t.assetId??t.asset.id);var r=Ce(),s=Ct(r);{var i=o=>{z_(o,{get asset(){return t.asset}})},n=o=>{R_(o,{get loopVideo(){return t.loopVideo},get cacheKey(){return t.cacheKey},get assetId(){return h(e)},get playOriginalVideo(){return t.playOriginalVideo},get onPreviousAsset(){return t.onPreviousAsset},get onNextAsset(){return t.onNextAsset},get onVideoEnded(){return t.onVideoEnded},get onVideoStarted(){return t.onVideoStarted},get onClose(){return t.onClose}})};K(s,o=>{t.projectionType===Sl.EQUIRECTANGULAR?o(i):o(n,!1)})}I(a,r),Dt()}var V_=q('<div class="col-span-4 col-start-1 row-span-1 row-start-1 transition-transform"><!></div>'),W_=q('<div class="absolute w-full flex justify-center"><!></div>'),H_=q('<div class="my-auto col-span-1 col-start-1 row-span-full row-start-1 justify-self-start"><!></div>'),Y_=q('<div class="absolute bottom-0 end-0 mb-20 me-8"><!></div>'),X_=q('<div class="absolute bottom-0 end-0 mb-6 me-6"><!></div>'),N_=q('<div class="my-auto col-span-1 col-start-4 row-span-full row-start-1 justify-self-end"><!></div>'),U_=q('<div id="detail-panel" class="row-start-1 row-span-4 w-90 overflow-y-auto transition-all dark:border-l dark:border-s-immich-dark-gray bg-light" translate="yes"><!></div>'),G_=q('<div id="editor-panel" class="row-start-1 row-span-4 w-100 overflow-y-auto transition-all dark:border-l dark:border-s-immich-dark-gray" translate="yes"><!></div>'),q_=q('<div class="w-full flex place-items-center place-content-center"><div class="w-2 h-2 bg-white rounded-full flex mt-0.5"></div></div>'),$_=q("<div><!> <!></div>"),K_=q('<div id="stack-slideshow" class="absolute bottom-0 w-full col-span-4 col-start-1 pointer-events-none"><div class="relative flex flex-row no-wrap overflow-x-auto overflow-y-hidden horizontal-scrollbar svelte-skymrn"></div></div>'),Z_=q('<div id="activity-panel" class="row-start-1 row-span-5 w-90 md:w-115 overflow-y-auto transition-all dark:border-l dark:border-s-immich-dark-gray" translate="yes"><!></div>'),J_=q('<!> <!> <section id="immich-asset-viewer" class="fixed start-0 top-0 grid size-full grid-cols-4 grid-rows-[64px_1fr] overflow-hidden bg-black svelte-skymrn"><!> <!> <!> <div class="z-[-1] relative col-start-1 col-span-4 row-start-1 row-span-full"><!> <!> <!></div> <!> <!> <!> <!> <!></section>',1);function Q_(a,t){At(t,!0);const e=()=>at(xu,"$alwaysLoadOriginalVideo",c),r=()=>at(zt,"$t",c),s=()=>at(A,"$slideshowState",c),i=()=>at(T,"$slideshowNavigation",c),n=()=>at(P,"$slideshowRepeat",c),o=()=>at(O,"$slideshowTransition",c),l=()=>at(Xs,"$user",c),[c,u]=It();let d=Tt(t,"cursor",7),g=Tt(t,"showNavigation",3,!0),f=Tt(t,"withStacked",3,!1),m=Tt(t,"isShared",3,!1);const{setAssetId:p}=_n,{restartProgress:v,stopProgress:x,slideshowNavigation:T,slideshowState:A,slideshowTransition:O,slideshowRepeat:P}=Ln,L=60,E=65,_=y(()=>d().current),j=y(()=>d().nextAsset),X=y(()=>d().previousAsset);let G=st(ue([])),R=Cl(),B=st(void 0),V=st(void 0),Q=[],tt=st(null),z=st(ue(e())),$=st(void 0);const J=N=>{U(z,N,!0)},rt=async()=>{$s.isSharedLink||(h(_).stack&&U(tt,await Hu({id:h(_).stack.id}),!0),h(tt)?.assets.some(({id:N})=>N===h(_).id)||U(tt,null),ls(()=>{hi.preload(h(tt)?.assets[1])}))},it=async()=>{if(t.album&&t.album.isActivityEnabled)try{await Br.toggleLike()}catch(N){ce(N,r()("errors.unable_to_change_favorite"))}};tr(async()=>{Q.push(A.subscribe(N=>{N===oe.PlaySlideshow?(Y.reset(),Y.queue(Pe(h(_))),Sr(Z())):N===oe.StopSlideshow&&Sr(ft())}),T.subscribe(N=>{N===Os.Shuffle&&(Y.reset(),Y.queue(Pe(h(_))))})),R||await ht()}),qs(()=>{for(const N of Q)N();Br.reset(),Rt.closeEditor()});const ht=async()=>{if(!$s.isSharedLink)try{U(G,await Yu({assetId:h(_).id}),!0)}catch(N){console.error("Error getting album that asset belong to",N)}},nt=()=>{t.onClose?.(h(_))},ut=async()=>{if(qe.hasAppliedEdits){const N=await _i({id:h(_).id});t.onAssetChange?.(N),_n.setAsset(N)}Rt.closeEditor()},D=new Qu,W=(N,ct)=>{if(!N)if(s()===oe.PlaySlideshow)N=i()===Os.AscendingOrder?"previous":"next";else return;hi.cancel(h(_)),!D.isActive()&&D.invoke(async()=>{let yt=!1;if(s()===oe.PlaySlideshow&&i()===Os.Shuffle){if(yt=N==="previous"?Y.previous():Y.next(),!yt){const Ut=await t.onRandom?.();Ut&&(Y.queue(Ut),yt=!0)}}else yt=N==="previous"?await da(d().previousAsset):await da(d().nextAsset);s()===oe.PlaySlideshow&&(yt?Zt(v,!0):n()&&h($)?(await p(h($)),Zt(v,!0)):await ft())},r()("error_while_navigating"))};let H=st(void 0);const Y=new Up(N=>{Sr(p(N.id).then(()=>Zt(v,!0)))}),M=()=>{s()===oe.PlaySlideshow&&Zt(x,!0)},Z=async()=>{U($,h(_).id,!0);try{await h(H)?.requestFullscreen?.()}catch(N){ce(N,r()("errors.unable_to_enter_fullscreen")),Zt(A,oe.StopSlideshow)}},ft=async()=>{try{document.fullscreenElement&&(document.body.style.cursor="",await document.exitFullscreen())}catch(N){ce(N,r()("errors.unable_to_exit_fullscreen"))}finally{Zt(x,!0),Zt(A,oe.None)}},Lt=(N,ct)=>{U(B,N?ct:void 0,!0)},vt=N=>{t.preAction?.(N)},Pt=async N=>{switch(N.type){case Gt.ADD_TO_ALBUM:{await ht();break}case Gt.DELETE:case Gt.TRASH:{Fo.emit("AssetsDelete",[h(_).id]);break}case Gt.REMOVE_ASSET_FROM_STACK:{U(tt,N.stack,!0),h(tt)&&(d().current=h(tt).assets[0]);break}case Gt.STACK:case Gt.SET_STACK_PRIMARY_ASSET:{U(tt,N.stack,!0);break}case Gt.SET_PERSON_FEATURED_PHOTO:{const ct=await _i({id:h(_).id});d().current={...h(_),people:ct.people};break}case Gt.RATING:{d().current={...h(_),exifInfo:{...h(_).exifInfo,rating:N.rating}};break}case Gt.KEEP_THIS_DELETE_OTHERS:case Gt.UNSTACK:{nt();break}}t.onAction?.(N)};let Ht=y(()=>h(V)!==null);Ee(()=>{t.album&&!t.album.isActivityEnabled&&Br.commentCount===0&&Rt.closeActivityPanel()}),Ee(()=>{t.album&&m()&&h(_).id&&Sr(Br.init(t.album.id,h(_).id))});const ke=async()=>{await rt(),await ht(),kr.clear(),R||(h(B)&&await kr.getAssetOcr(h(B).id),await kr.getAssetOcr(h(_).id))};Ee(()=>{h(_),ls(()=>Sr(ke())),hi.preload(d().nextAsset),hi.preload(d().previousAsset)});const Vt=async({oldAssetId:N,newAssetId:ct})=>{N===h(_).id&&(await new Promise(yt=>setTimeout(yt,500)),await fn($e.viewAsset({id:ct})))},fe=N=>{h(_).id===N.id&&(d().current=N)},Ft=y(()=>h(B)?h(_).type===cs.Image?"StackPhotoViewer":"StackVideoViewer":h(_).type===cs.Video?"VideoViewer":Rt.isPlayingMotionPhoto&&h(_).livePhotoVideoId?"LiveVideoViewer":h(_).exifInfo?.projectionType===Sl.EQUIRECTANGULAR||h(_).originalPath&&h(_).originalPath.toLowerCase().endsWith(".insp")?"ImagePanaramaViewer":Rt.isShowEditor&&qe.selectedTool?.type===ra.Transform?"CropArea":"PhotoViewer"),me=y(()=>s()===oe.None&&m()&&(t.album&&t.album.isActivityEnabled||Br.commentCount>0)&&!Br.isLoading),vr=y(()=>s()===oe.None&&h(_).type===cs.Image&&h(_).exifInfo?.projectionType!=="EQUIRECTANGULAR"&&!Rt.isShowEditor&&kr.hasOcrData),Pr=y(()=>Mo(r(),h(_))),ts=y(()=>h(Pr).Tag);var _r=J_(),es=Ct(_r);{let N=y(()=>r()("assets")),ct=y(()=>[h(ts)]);Dl(es,{get name(){return h(N)},get actions(){return h(ct)}})}var yr=k(es,2);Lo(yr,{onAssetReplace:Vt,onAssetUpdate:fe});var ae=k(yr,2),xr=b(ae);{var rs=N=>{var ct=V_(),yt=b(ct);{let Ut=y(()=>t.onClose?()=>t.onClose(h(_)):void 0);Dp(yt,{get asset(){return h(_)},get album(){return t.album},get person(){return t.person},get stack(){return h(tt)},showSlideshow:!0,preAction:vt,onAction:Pt,get onUndoDelete(){return t.onUndoDelete},onPlaySlideshow:()=>Zt(A,oe.PlaySlideshow),get onClose(){return h(Ut)},get playOriginalVideo(){return h(z)},setPlayOriginalVideo:J})}w(ct),I(N,ct)};K(xr,N=>{s()===oe.None&&!Rt.isShowEditor&&N(rs)})}var Mr=k(xr,2);{var Ir=N=>{var ct=W_(),yt=b(ct);{let Ut=y(()=>h(B)?.type??h(_).type);D_(yt,{get isFullScreen(){return h(Ht)},get assetType(){return h(Ut)},onSetToFullScreen:()=>h(H)?.requestFullscreen?.(),onPrevious:()=>W("previous"),onNext:()=>W("next"),onClose:()=>Zt(A,oe.StopSlideshow)})}w(ct),I(N,ct)};K(Mr,N=>{s()!=oe.None&&N(Ir)})}var Lr=k(Mr,2);{var ss=N=>{var ct=H_(),yt=b(ct);Dd(yt,{onPreviousAsset:()=>W("previous")}),w(ct),I(N,ct)};K(Lr,N=>{s()===oe.None&&g()&&!Rt.isShowEditor&&h(X)&&N(ss)})}var wr=k(Lr,2),jt=b(wr);{var Yt=N=>{{let ct=y(()=>({...d(),current:h(B)}));Oo(N,{get cursor(){return h(ct)},onPreviousAsset:()=>W("previous"),onNextAsset:()=>W("next"),haveFadeTransition:!1,get sharedLink(){return R}})}},et=N=>{{let ct=y(()=>h(B).exifInfo?.projectionType);uo(N,{get asset(){return h(B)},get cacheKey(){return h(B).thumbhash},get projectionType(){return h(ct)},loopVideo:!0,onPreviousAsset:()=>W("previous"),onNextAsset:()=>W("next"),onClose:nt,onVideoEnded:()=>W(),onVideoStarted:M,get playOriginalVideo(){return h(z)}})}},ot=N=>{{let ct=y(()=>h(_).exifInfo?.projectionType),yt=y(()=>s()!==oe.PlaySlideshow);uo(N,{get asset(){return h(_)},get assetId(){return h(_).livePhotoVideoId},get cacheKey(){return h(_).thumbhash},get projectionType(){return h(ct)},get loopVideo(){return h(yt)},onPreviousAsset:()=>W("previous"),onNextAsset:()=>W("next"),onVideoEnded:()=>Rt.isPlayingMotionPhoto=!1,get playOriginalVideo(){return h(z)}})}},_t=N=>{__(N,{get asset(){return h(_)}})},bt=N=>{p_(N,{get asset(){return h(_)}})},St=N=>{{let ct=y(()=>s()!==oe.None&&o());Oo(N,{get cursor(){return d()},onPreviousAsset:()=>W("previous"),onNextAsset:()=>W("next"),get sharedLink(){return R},get haveFadeTransition(){return h(ct)}})}},kt=N=>{{let ct=y(()=>h(_).exifInfo?.projectionType),yt=y(()=>s()!==oe.PlaySlideshow);uo(N,{get asset(){return h(_)},get cacheKey(){return h(_).thumbhash},get projectionType(){return h(ct)},get loopVideo(){return h(yt)},onPreviousAsset:()=>W("previous"),onNextAsset:()=>W("next"),onClose:nt,onVideoEnded:()=>W(),onVideoStarted:M,get playOriginalVideo(){return h(z)}})}};K(jt,N=>{h(Ft)==="StackPhotoViewer"?N(Yt):h(Ft)==="StackVideoViewer"?N(et,1):h(Ft)==="LiveVideoViewer"?N(ot,2):h(Ft)==="ImagePanaramaViewer"?N(_t,3):h(Ft)==="CropArea"?N(bt,4):h(Ft)==="PhotoViewer"?N(St,5):h(Ft)==="VideoViewer"&&N(kt,6)})}var Ot=k(jt,2);{var Et=N=>{var ct=Y_(),yt=b(ct);{let Ut=y(()=>!t.album?.isActivityEnabled);rd(yt,{get disabled(){return h(Ut)},get isLiked(){return Br.isLiked},get numberOfComments(){return Br.commentCount},get numberOfLikes(){return Br.likeCount},onFavorite:it})}w(ct),I(N,ct)};K(Ot,N=>{h(me)&&N(Et)})}var Xt=k(Ot,2);{var qt=N=>{var ct=X_(),yt=b(ct);y_(yt,{}),w(ct),I(N,ct)};K(Xt,N=>{h(vr)&&N(qt)})}w(wr);var ne=k(wr,2);{var ee=N=>{var ct=N_(),yt=b(ct);Ad(yt,{onNextAsset:()=>W("next")}),w(ct),I(N,ct)};K(ne,N=>{s()===oe.None&&g()&&!Rt.isShowEditor&&h(j)&&N(ee)})}var mt=k(ne,2);{var pt=N=>{var ct=U_(),yt=b(ct);h_(yt,{get asset(){return h(_)},get currentAlbum(){return t.album},get albums(){return h(G)}}),w(ct),Qe(3,ct,()=>Ts,()=>({duration:150})),I(N,ct)};K(mt,N=>{h(_).hasMetadata&&s()===oe.None&&Rt.isShowDetailPanel&&!Rt.isShowEditor&&N(pt)})}var wt=k(mt,2);{var Mt=N=>{var ct=G_(),yt=b(ct);f_(yt,{get asset(){return h(_)},onClose:ut}),w(ct),Qe(3,ct,()=>Ts,()=>({duration:150})),I(N,ct)};K(wt,N=>{Rt.isShowEditor&&N(Mt)})}var he=k(wt,2);{var xt=N=>{const ct=y(()=>h(tt).assets);var yt=K_(),Ut=b(yt);pr(Ut,21,()=>h(ct),Oe=>Oe.id,(Oe,xe)=>{var we=$_();fr(we,1,yl(["inline-block px-1 relative transition-all pb-2 pointer-events-auto"]));let br;var ir=b(we);{let jr=y(()=>({"border-2 border-white":h(xe).id===h(_).id})),ps=y(()=>h(xe).id!==h(_).id),Rr=y(()=>Pe(h(xe))),Is=y(()=>h(xe).id===h(_).id?E:L);id(ir,{get imageClass(){return h(jr)},brokenAssetClass:"text-xs",get dimmed(){return h(ps)},get asset(){return h(Rr)},onClick:()=>{d().current=h(xe),U(B,void 0)},onMouseEvent:({isMouseOver:Un})=>Lt(Un,h(xe)),readonly:!0,get thumbnailSize(){return h(Is)},showStackedIcon:!1,disableLinkMouseOver:!0})}var Ae=k(ir,2);{var Fr=jr=>{var ps=q_();I(jr,ps)};K(Ae,jr=>{h(xe).id===h(_).id&&jr(Fr)})}w(we),lt(()=>br=us(we,"",br,{bottom:h(xe).id===h(_).id?"0":"-10px"})),I(Oe,we)}),w(Ut),w(yt),I(N,yt)};K(he,N=>{h(tt)&&f()&&!Rt.isShowEditor&&N(xt)})}var te=k(he,2);{var se=N=>{var ct=Z_(),yt=b(ct);{let Ut=y(()=>!t.album.isActivityEnabled);sd(yt,{get user(){return l()},get disabled(){return h(Ut)},get assetType(){return h(_).type},get albumOwnerId(){return t.album.ownerId},get albumId(){return t.album.id},get assetId(){return h(_).id}})}w(ct),Qe(3,ct,()=>Ts,()=>({duration:150})),I(N,ct)};K(te,N=>{m()&&t.album&&Rt.isShowActivityPanel&&l()&&N(se)})}w(ae),Ue(ae,N=>$h?.(N)),Je(ae,N=>U(H,N),()=>h(H)),kd("fullscreenElement","fullscreenchange",ze,N=>U(V,N,!0)),I(a,_r),Dt(),u()}const hy=Object.freeze(Object.defineProperty({__proto__:null,default:Q_},Symbol.toStringTag,{value:"Module"}));export{qm as A,hy as a,Or as b};
