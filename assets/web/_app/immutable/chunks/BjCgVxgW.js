import{a as S}from"./C2I_EQjW.js";import{U as R,as as k,h as _,i as M,g as P,j as A,d as w,W as x}from"./BOqQhZBJ.js";import{e as L}from"./ytu5q_IM.js";import{U as f}from"./DnqqNi3p.js";import{al as O,A as B,am as C,an as j,ao as E}from"./DeYUhNiz.js";import{u as U}from"./Cx5lmlld.js";import{h as q,O as N,V as v,R as F,B as Q}from"./Jagi0WJL.js";import{$ as W}from"./DdY9CyNE.js";import{h as $}from"./D4fmOnVC.js";function G(){const e=R([]),t=R({errors:0,duplicates:0,success:0,total:0}),{subscribe:n}=e,c=k(e,r=>r.length>0),u=k(e,r=>r.some(s=>s.state===f.ERROR||s.state===f.DUPLICATED)),o=k(e,r=>r.filter(s=>s.state===f.PENDING||s.state===f.STARTED).length),l=r=>{e.update(s=>s.find(i=>i.id===r.id)?s.map(i=>i.id===r.id?r:i):(t.update(i=>(i.total++,i)),s.push({...r,speed:0,state:f.PENDING,progress:0,eta:0}),s))},p=(r,s,g)=>{m(r,i=>{const b=i.startDate?s/((Date.now()-i.startDate)/1e3):0;return{...i,progress:Math.floor(s/g*100),speed:b,eta:Math.ceil((g-s)/b)}})},a=r=>{h(r,{state:f.STARTED,startDate:Date.now()})},m=(r,s)=>{e.update(g=>g.map(i=>i.id==r?s(i):i))},h=(r,s)=>{m(r,g=>({...g,...s}))};return{stats:t,remainingUploads:o,isDismissible:u,isUploading:c,track:r=>{t.update(s=>{switch(r){case"success":{s.success++;break}case"duplicate":{s.duplicates++;break}case"error":{s.errors++;break}}return s})},dismissErrors:()=>e.update(r=>r.filter(s=>s.state!==f.ERROR&&s.state!==f.DUPLICATED)),reset:()=>{e.set([]),t.set({errors:0,duplicates:0,success:0,total:0})},markStarted:a,addItem:l,updateItem:h,removeItem:r=>{e.update(s=>s.filter(g=>g.id!=r))},updateProgress:p,subscribe:n}}const d=G();class H{#t=_(M({image:[],sidecar:[],video:[]}));get mediaTypes(){return P(this.#t)}set mediaTypes(t){A(this.#t,t,!0)}constructor(){L.on({AppInit:()=>this.#e(),AuthLogout:()=>this.reset()})}reset(){d.reset()}async#e(){try{this.mediaTypes=await O()}catch{console.error("Failed to load supported media types")}}getExtensions(){return[...this.mediaTypes.image,...this.mediaTypes.video]}}const I=new H;class V{queue=[];running=0;_concurrency;constructor(t){this._concurrency=t?.concurrency||2}get concurrency(){return this._concurrency}set concurrency(t){if(t<1)return;this._concurrency=t;const n=t-this.running;if(n>0)for(let c=0;c<n;c++)this.tryRun()}addTask(t){return new Promise((n,c)=>{this.queue.push(async()=>{try{this.running++;const u=t();n(await u)}catch(u){c(u)}finally{this.taskFinished()}}),this.tryRun()})}taskFinished(){this.running--,this.tryRun()}tryRun(){if(this.running>=this.concurrency)return;const t=this.queue.shift();t&&q(t())}}const z=new V({concurrency:2}),J=async(e={})=>{const{multiple:t=!0,extensions:n}=e;return new Promise((c,u)=>{try{const o=document.createElement("input");o.type="file",o.multiple=t,n&&(o.accept=n.join(",")),o.addEventListener("change",l=>{const p=l.target;if(!p.files)return;const a=Array.from(p.files);c(a)},{passive:!0}),o.click()}catch(o){console.log("Error selecting file",o),u(o)}})},ut=async(e={})=>{const{albumId:t,multiple:n=!0}=e,c=I.getExtensions(),u=await J({multiple:n,extensions:c});return K({files:u,albumId:t})},K=async({files:e,albumId:t,isLockedAssets:n=!1})=>{const c=I.getExtensions(),u=[];for(const l of e){const p=l.name.toLowerCase();if(c.some(a=>p.endsWith(a))){const a=X(l);d.addItem({id:a,file:l,albumId:t}),u.push(z.addTask(()=>Y({assetFile:l,deviceAssetId:a,albumId:t,isLockedAssets:n})))}}return(await Promise.all(u)).filter(l=>!!l)};function X(e){return"web-"+e.name+"-"+e.lastModified}async function Y({assetFile:e,deviceAssetId:t,albumId:n,isLockedAssets:c=!1}){const u=new Date(e.lastModified).toISOString(),o=w(W),l=!!w(U);d.markStarted(t);try{const p=new FormData;for(const[m,h]of Object.entries({deviceAssetId:t,deviceId:"WEB",fileCreatedAt:u,fileModifiedAt:new Date(e.lastModified).toISOString(),isFavorite:"false",duration:"0:00:00.000000",assetData:new File([e],e.name)}))p.append(m,h);c&&p.append("visibility",B.Locked);let a;if(crypto?.subtle?.digest&&!S.isSharedLink){d.updateItem(t,{message:o("asset_hashing")}),await x();try{const m=await e.arrayBuffer(),h=await crypto.subtle.digest("SHA-1",m),y=Array.from(new Uint8Array(h)).map(T=>T.toString(16).padStart(2,"0")).join(""),{results:[D]}=await C({assetBulkUploadCheckDto:{assets:[{id:e.name,checksum:y}]}});D.action===j.Reject&&D.assetId&&(a={status:E.Duplicate,id:D.assetId,isTrashed:D.isTrashed})}catch(m){console.error(`Error calculating sha1 file=${e.name})`,m)}}if(!a){const m=N(S.params);d.updateItem(t,{message:o("asset_uploading")});const h=await v({url:F()+"/assets"+(m?`?${m}`:""),data:p,onUploadProgress:y=>d.updateProgress(t,y.loaded,y.total)});if(![200,201].includes(h.status))throw new Error(o("errors.unable_to_upload_file"));a=h.data}return a.status===E.Duplicate?d.track("duplicate"):d.track("success"),n&&(d.updateItem(t,{message:o("asset_adding_to_album")}),await Q(n,[a.id],!1),d.updateItem(t,{message:o("asset_added_to_album")})),d.updateItem(t,{state:a.status===E.Duplicate?f.DUPLICATED:f.DONE,assetId:a.id,isTrashed:a.isTrashed}),a.status!==E.Duplicate&&setTimeout(()=>{d.removeItem(t)},1e3),a.id}catch(p){if(l&&!w(U))return;const a=$(p,o("errors.unable_to_upload_file"));d.track("error"),d.updateItem(t,{state:f.ERROR,error:a});return}}export{J as a,z as b,K as f,ut as o,d as u};
