import"./DsnmJJEf.js";import{p as Be,c as a,g as e,u as b,s as g,r as i,t as C,a as Fe,h as p,i as qe,j as l,d as Le,aS as Q,P as rt,b as ot,f as Ce}from"./BOqQhZBJ.js";import{d as lt,s as U,e as nt}from"./BufZg4h2.js";import{f,a as h,c as vt}from"./CnteGC4G.js";import{i as L}from"./QS5y7wlf.js";import{a as fe,cj as dt,ck as Ee,cl as ct,u as ut,q as mt,I as Ie,x as gt,cm as ht,cn as ft,w as _t,co as yt,s as D,aa as bt,a1 as Se,af as Te}from"./LrV5ZTyj.js";import{s as Ke,a as _e,p as De}from"./B227BkWK.js";import{a as Ve}from"./Bc5ULZvy.js";import{l as Ge,h as Me,_ as pt,t as Oe}from"./Jagi0WJL.js";import{h as ye,e as wt,t as xt}from"./D4fmOnVC.js";import{b as he}from"./9i_j0jQI.js";import{B as ze}from"./Ydc33-3A.js";import{M as Pe}from"./ClWsMFS7.js";import{a as kt}from"./BNLYq5HQ.js";import{u as At,D as $}from"./Cx5lmlld.js";import{aV as jt,aW as I,aX as Lt,aY as Re,aZ as Ct,a_ as It}from"./DeYUhNiz.js";import{$ as Ne}from"./DdY9CyNE.js";import{R as He}from"./BeWG-__C.js";import{U as Ue}from"./Bp2HQ4kn.js";import{T as St}from"./BXaFREg4.js";import{a as Tt}from"./_U16pX41.js";var Dt=f('<div class="text-l"> </div>'),Mt=f('<div class="text-l"> </div>'),Ot=f('<div class="w-full flex p-4 items-center justify-center rounded-full gap-5 bg-subtle border bg-opacity-60"><button type="button"><div class="flex gap-2 items-center justify-center"><!> <!></div></button> <button type="button"><div class="flex gap-2 items-center justify-center"><!> <!></div></button></div>');function hi(O,t){Be(t,!0);const r=()=>_e(Ge,"$locale",v),[v,B]=Ke();var z=Ot(),k=a(z);k.__click=function(...m){t.onFavorite?.apply(this,m)};var S=a(k),V=a(S);{let m=b(()=>t.isLiked?Ee:ct),_=b(()=>t.isLiked?"text-primary":"text-fg");fe(V,{get icon(){return e(m)},size:"24",get class(){return e(_)}})}var T=g(V,2);{var X=m=>{var _=Dt(),F=a(_,!0);i(_),C(q=>U(F,q),[()=>t.numberOfLikes.toLocaleString(r())]),h(m,_)};L(T,m=>{t.numberOfLikes&&m(X)})}i(S),i(k);var P=g(k,2);P.__click=()=>Ve.toggleActivityPanel();var G=a(P),N=a(G);fe(N,{get icon(){return dt},class:"scale-x-[-1]",size:"24"});var ee=g(N,2);{var Y=m=>{var _=Mt(),F=a(_,!0);i(_),C(q=>U(F,q),[()=>t.numberOfComments.toLocaleString(r())]),h(m,_)};L(ee,m=>{t.numberOfComments&&m(Y)})}i(G),i(P),i(z),C(()=>{ut(k,1,mt(t.disabled?"cursor-not-allowed":"")),k.disabled=t.disabled}),h(O,z),Fe(),B()}lt(["click"]);class zt{#e=p();#i=p();#t=p(qe([]));#a=p(0);#r=p(0);#s=p(null);#o=new Map;#n=p(!1);get isLoading(){return e(this.#n)}set isLoading(t){l(this.#n,t,!0)}get assetId(){return e(this.#i)}get activities(){return e(this.#t)}get commentCount(){return e(this.#a)}get likeCount(){return e(this.#r)}get isLiked(){return e(this.#s)}#l(t,r){return`${t}:${r??""}`}async init(t,r){if(!(r&&r===e(this.#i))){l(this.#e,t,!0),l(this.#i,r,!0);try{await x.refreshActivities(t,r)}catch(v){ye(v,Le(Ne)("errors.unable_to_get_comments_number"))}}}#v(t,r){this.#o.delete(this.#l(t)),this.#o.delete(this.#l(t,r))}async addActivity(t){if(e(this.#e)===void 0)return;const r=await jt({activityCreateDto:t});return l(this.#t,[...e(this.#t),r],!0),r.type===I.Comment&&Q(this.#a),r.type===I.Like&&Q(this.#r),this.#v(e(this.#e),e(this.#i)),Me(this.refreshActivities(e(this.#e),e(this.#i))),r}async deleteActivity(t,r){e(this.#e)&&(t.type===I.Comment&&Q(this.#a,-1),t.type===I.Like&&Q(this.#r,-1),l(this.#t,r?e(this.#t).splice(r,1):e(this.#t).filter(({id:v})=>v!==t.id),!0),await Lt({id:t.id}),this.#v(e(this.#e),e(this.#i)),Me(this.refreshActivities(e(this.#e),e(this.#i))))}async toggleLike(){e(this.#e)&&(e(this.#s)?(await this.deleteActivity(e(this.#s)),l(this.#s,null)):l(this.#s,await this.addActivity({albumId:e(this.#e),assetId:e(this.#i),type:I.Like}),!0))}async refreshActivities(t,r){this.isLoading=!0;const v=this.#l(t,r);if(this.#o.has(v)){const S=this.#o.get(v);l(this.#t,S.activities,!0),l(this.#a,S.commentCount,!0),l(this.#r,S.likeCount,!0),l(this.#s,S.isLiked??null,!0),this.isLoading=!1;return}l(this.#t,await Re({albumId:t,assetId:r}),!0);const[B]=await Re({albumId:t,assetId:r,userId:Le(At).id,$type:I.Like,level:r?void 0:Ct.Album});l(this.#s,B??null,!0);const{comments:z,likes:k}=await It({albumId:t,assetId:r});l(this.#a,z,!0),l(this.#r,k,!0),this.#o.set(v,{activities:e(this.#t),commentCount:e(this.#a),likeCount:e(this.#r),isLiked:e(this.#s)}),this.isLoading=!1}reset(){l(this.#e,void 0),l(this.#i,void 0),l(this.#t,[],!0),l(this.#a,0),l(this.#r,0)}}const x=new zt,Pt=(O,t)=>!O||!t?!1:Math.abs(new Date(O).getTime()-new Date(t).getTime())/(1e3*60)>=10;var Rt=f('<a class="aspect-square w-19 h-19 svelte-1ohjg3g"><img class="rounded-lg w-19 h-19 object-cover svelte-1ohjg3g"/></a>'),Ht=f('<div class="me-4 svelte-1ohjg3g"><!></div>'),Ut=f('<div class="pt-1 px-2 text-right w-full text-sm text-gray-500 dark:text-gray-300 svelte-1ohjg3g"> </div>'),Bt=f('<div class="flex dark:bg-gray-800 bg-gray-200 py-3 ps-3 mt-3 rounded-lg gap-4 justify-start svelte-1ohjg3g"><div class="flex items-center svelte-1ohjg3g"><!></div> <div class="w-full leading-4 overflow-hidden self-center wrap-break-word text-sm svelte-1ohjg3g"> </div> <!> <!></div> <!>',1),Ft=f('<a class="aspect-square w-19 h-19 svelte-1ohjg3g"><img class="rounded-lg w-19 h-19 object-cover svelte-1ohjg3g"/></a>'),qt=f('<div class="me-4 svelte-1ohjg3g"><!></div>'),Et=f('<div class="pt-1 px-2 text-right w-full text-sm text-gray-500 dark:text-gray-300 svelte-1ohjg3g"> </div>'),Kt=f('<div class="relative svelte-1ohjg3g"><div class="flex py-3 ps-3 mt-3 gap-4 items-center text-sm svelte-1ohjg3g"><div class="text-primary svelte-1ohjg3g"><!></div> <div class="w-full svelte-1ohjg3g"> </div> <!> <!></div> <!></div>'),Vt=f('<div class="overflow-y-auto immich-scrollbar relative w-full px-2 svelte-1ohjg3g"></div>'),Gt=f('<div class="flex place-items-center pb-2 ms-0 svelte-1ohjg3g"><div class="flex w-full place-items-center svelte-1ohjg3g"><!></div></div>'),Nt=f('<div class="flex items-center w-fit ms-0 light svelte-1ohjg3g"><!></div>'),Wt=f('<div class="overflow-y-hidden relative h-full border-l border-subtle bg-subtle svelte-1ohjg3g"><div class="w-full h-full svelte-1ohjg3g"><div class="flex w-full h-fit dark:text-immich-dark-fg p-2 bg-subtle svelte-1ohjg3g"><div class="flex place-items-center gap-2 svelte-1ohjg3g"><!> <p class="text-lg text-immich-fg dark:text-immich-dark-fg svelte-1ohjg3g"> </p></div></div> <!></div> <div class="absolute w-full bottom-0 svelte-1ohjg3g"><div class="flex items-center justify-center p-2 svelte-1ohjg3g"><div class="flex p-2 gap-4 h-fit bg-gray-200 text-immich-dark-gray rounded-3xl w-full svelte-1ohjg3g"><div class="svelte-1ohjg3g"><!></div> <form class="flex w-full items-center max-h-56 gap-1 svelte-1ohjg3g"><!> <!></form></div></div></div></div>');function fi(O,t){Be(t,!0);const r=()=>_e(Ge,"$locale",B),v=()=>_e(Ne,"$t",B),[B,z]=Ke(),k=["year","month","week","day","hour","minute","second"],S=(s,c)=>{const u=$.fromISO(s,{locale:r()}),o=$.fromISO(c,{locale:r()});return u.hasSame(o,"hour")||u.toRelative()===o.toRelative()},V=s=>{const c=s.diffNow().shiftTo(...k),u=k.find(w=>c.get(w)!==0)||"second";return new Intl.RelativeTimeFormat(r(),{numeric:"auto"}).format(Math.trunc(c.as(u)),u)};let T=De(t,"assetId",3,void 0),X=De(t,"assetType",3,void 0),P=p(0),G=p(0),N=p(0),ee=b(()=>e(P)-e(G)),Y=p(qe(T())),m=p(""),_=p(!1);const F={year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1},q=async(s,c)=>{try{await x.deleteActivity(s,c);const u={[I.Comment]:v()("comment_deleted"),[I.Like]:v()("like_deleted")};xt.success(u[s.type])}catch(u){ye(u,v()("errors.unable_to_remove_reaction"))}},te=async()=>{if(!e(m))return;const s=setTimeout(()=>l(_,!0),kt);try{await x.addActivity({albumId:t.albumId,assetId:T(),type:I.Comment,comment:e(m)}),l(m,"")}catch(c){ye(c,v()("errors.unable_to_add_comment"))}finally{clearTimeout(s)}l(_,!1)};rt(()=>{T()&&e(Y)!=T()&&l(Y,T())});const We=async s=>{s.preventDefault(),await te()};var Z=Wt(),ie=a(Z),J=a(ie),be=a(J),pe=a(be);{let s=b(()=>v()("close"));Ie(pe,{shape:"round",variant:"ghost",color:"secondary",onclick:()=>Ve.closeActivityPanel(),get icon(){return gt},get"aria-label"(){return e(s)}})}var we=g(pe,2),Xe=a(we,!0);i(we),i(be),i(J);var Ye=g(J,2);{var Ze=s=>{var c=Vt();wt(c,23,()=>x.activities,u=>u.id,(u,o,w)=>{var je=vt(),tt=Ce(je);{var it=E=>{var K=Bt(),R=Ce(K),H=a(R),oe=a(H);Ue(oe,{get user(){return e(o).user},size:"sm"}),i(H);var M=g(H,2),le=a(M,!0);i(M);var W=g(M,2);{var ne=d=>{var n=Rt(),y=a(n);i(n),C((A,j)=>{D(n,"href",A),D(y,"src",j),D(y,"alt",`Profile picture of ${e(o).user.name??""}, who commented on this asset`)},[()=>He.viewAlbumAsset({albumId:t.albumId,assetId:e(o).assetId}),()=>Oe({id:e(o).assetId})]),h(d,n)};L(W,d=>{T()===void 0&&e(o).assetId&&d(ne)})}var ve=g(W,2);{var de=d=>{var n=Ht(),y=a(n);{let A=b(()=>v()("comment_options"));ze(y,{get icon(){return Te},get title(){return e(A)},align:"top-right",direction:"left",size:"small",children:(j,at)=>{{let ge=b(()=>v()("remove"));Pe(j,{activeColor:"bg-red-200",get icon(){return Se},get text(){return e(ge)},onClick:()=>q(e(o),e(w))})}},$$slots:{default:!0}})}i(n),h(d,n)};L(ve,d=>{(e(o).user.id===t.user.id||t.albumOwnerId===t.user.id)&&d(de)})}i(R);var ce=g(R,2);{var ue=d=>{var n=Ut(),y=a(n,!0);i(n),C((A,j)=>{D(n,"title",A),U(y,j)},[()=>new Date(e(o).createdAt).toLocaleDateString(void 0,F),()=>V($.fromISO(e(o).createdAt,{locale:r()}))]),h(d,n)},me=b(()=>e(w)!=x.activities.length-1&&!S(x.activities[e(w)].createdAt,x.activities[e(w)+1].createdAt)||e(w)===x.activities.length-1);L(ce,d=>{e(me)&&d(ue)})}C(()=>U(le,e(o).comment)),h(E,K)},st=E=>{var K=Kt(),R=a(K),H=a(R),oe=a(H);fe(oe,{get icon(){return Ee},size:"20"}),i(H);var M=g(H,2),le=a(M,!0);i(M);var W=g(M,2);{var ne=d=>{var n=Ft(),y=a(n);i(n),C((A,j)=>{D(n,"href",A),D(y,"src",j),D(y,"alt",`Profile picture of ${e(o).user.name??""}, who liked this asset`)},[()=>He.viewAlbumAsset({albumId:t.albumId,assetId:e(o).assetId}),()=>Oe({id:e(o).assetId})]),h(d,n)};L(W,d=>{T()===void 0&&e(o).assetId&&d(ne)})}var ve=g(W,2);{var de=d=>{var n=qt(),y=a(n);{let A=b(()=>v()("reaction_options"));ze(y,{get icon(){return Te},get title(){return e(A)},align:"top-right",direction:"left",size:"small",children:(j,at)=>{{let ge=b(()=>v()("remove"));Pe(j,{activeColor:"bg-red-200",get icon(){return Se},get text(){return e(ge)},onClick:()=>q(e(o),e(w))})}},$$slots:{default:!0}})}i(n),h(d,n)};L(ve,d=>{(e(o).user.id===t.user.id||t.albumOwnerId===t.user.id)&&d(de)})}i(R);var ce=g(R,2);{var ue=d=>{var n=Et(),y=a(n,!0);i(n),C((A,j)=>{D(n,"title",A),U(y,j)},[()=>new Date(e(o).createdAt).toLocaleDateString(navigator.language,F),()=>V($.fromISO(e(o).createdAt,{locale:r()}))]),h(d,n)},me=b(()=>e(w)!=x.activities.length-1&&Pt(x.activities[e(w)].createdAt,x.activities[e(w)+1].createdAt)||e(w)===x.activities.length-1);L(ce,d=>{e(me)&&d(ue)})}i(K),C(d=>{D(M,"title",`${e(o).user.name} (${e(o).user.email})`),U(le,d)},[()=>v()("user_liked",{values:{user:e(o).user.name,type:X()?pt(X()).toLowerCase():null}})]),h(E,K)};L(tt,E=>{e(o).type===I.Comment?E(it):e(o).type===I.Like&&E(st,1)})}h(u,je)}),i(c),C(()=>bt(c,`height: ${e(ee)??""}px;padding-bottom: ${e(N)??""}px`)),h(s,c)};L(Ye,s=>{e(P)&&s(Ze)})}i(ie);var xe=g(ie,2),se=a(xe),ke=a(se),ae=a(ke),Je=a(ae);Ue(Je,{get user(){return t.user},size:"md",noTitle:!0}),i(ae);var re=g(ae,2),Ae=a(re);{let s=b(()=>t.disabled?v()("comments_are_disabled"):v()("say_something")),c=b(()=>t.disabled?"cursor-not-allowed":"");St(Ae,{get disabled(){return t.disabled},rows:1,grow:!0,get placeholder(){return e(s)},[ft()]:u=>(ht(Tt,()=>({shortcut:{key:"Enter"},onShortcut:()=>te()}))||ot)(u),get class(){return`${e(c)??""} ring-0! w-full max-h-56 pe-2 items-center overflow-y-auto leading-4 outline-none resize-none bg-gray-200 dark:bg-gray-200`},get value(){return e(m)},set value(u){l(m,u,!0)}})}var Qe=g(Ae,2);{var $e=s=>{var c=Gt(),u=a(c),o=a(u);_t(o,{size:"large"}),i(u),i(c),h(s,c)},et=s=>{var c=Nt(),u=a(c);{let o=b(()=>v()("send_message"));Ie(u,{shape:"round",get"aria-label"(){return e(o)},variant:"ghost",get icon(){return yt},onclick:()=>te()})}i(c),h(s,c)};L(Qe,s=>{e(_)?s($e):e(m)&&s(et,1)})}i(re),i(ke),i(se),i(xe),i(Z),C(s=>U(Xe,s),[()=>v()("activity")]),he(J,"clientHeight",s=>l(G,s)),nt("submit",re,We),he(se,"clientHeight",s=>l(N,s)),he(Z,"offsetHeight",s=>l(P,s)),h(O,Z),Fe(),z()}export{hi as A,x as a,fi as b};
