import"./DsnmJJEf.js";import{a as wt,b as Et}from"./BufZg4h2.js";import{p as kt,f as bt,s as Mt,a as _t,g as Q,h as St,$ as xt,j as Ct}from"./BOqQhZBJ.js";import{f as Lt,a as Pt}from"./CnteGC4G.js";import{a as At}from"./4T_x9N89.js";import{p as J,c as Tt,s as Ot,a as Dt}from"./B227BkWK.js";import{b as zt,A as Rt}from"./BEfn6cqG.js";import{a as ee}from"./Bc5ULZvy.js";import{ab as jt}from"./Jagi0WJL.js";import{u as h,V as M,M as _e,D as Z,r as he,d as ce,e as l,a as $t,P as u,T as de,S as Bt,f as ve,c as P,Q as Nt,g as Vt,h as It,G as Ht,i as Ut,j as Wt,O as Ft,k as Yt,C as Gt,l as fe,m as Se,b as Xt,E as qt,n as Zt}from"./BQXmwHOz.js";import{s as Kt}from"./_U16pX41.js";var Qt=Object.defineProperty,Jt=(i,e)=>{for(var t in e)Qt(i,t,{get:e[t],enumerable:!0})},ei={};Jt(ei,{EnterMarkerEvent:()=>je,GotoMarkerDoneEvent:()=>se,HideMarkersEvent:()=>$,LeaveMarkerEvent:()=>De,MarkerVisibilityEvent:()=>Le,MarkersPluginEvent:()=>b,RenderMarkersListEvent:()=>tt,SelectMarkerEvent:()=>Ne,SelectMarkerListEvent:()=>He,SetMarkersEvent:()=>Ze,ShowMarkersEvent:()=>B,UnselectMarkerEvent:()=>Fe});var b=class extends de{},xe=class Ce extends b{constructor(e,t){super(Ce.type),this.marker=e,this.visible=t}};xe.type="marker-visibility";var Le=xe,Pe=class Ae extends b{constructor(e){super(Ae.type),this.marker=e}};Pe.type="goto-marker-done";var se=Pe,Te=class Oe extends b{constructor(e){super(Oe.type),this.marker=e}};Te.type="leave-marker";var De=Te,ze=class Re extends b{constructor(e){super(Re.type),this.marker=e}};ze.type="enter-marker";var je=ze,$e=class Be extends b{constructor(e,t,s){super(Be.type),this.marker=e,this.doubleClick=t,this.rightClick=s}};$e.type="select-marker";var Ne=$e,Ve=class Ie extends b{constructor(e){super(Ie.type),this.marker=e}};Ve.type="select-marker-list";var He=Ve,Ue=class We extends b{constructor(e){super(We.type),this.marker=e}};Ue.type="unselect-marker";var Fe=Ue,Ye=class Ge extends b{constructor(){super(Ge.type)}};Ye.type="hide-markers";var $=Ye,Xe=class qe extends b{constructor(e){super(qe.type),this.markers=e}};Xe.type="set-markers";var Ze=Xe,Ke=class Qe extends b{constructor(){super(Qe.type)}};Ke.type="show-markers";var B=Ke,Je=class et extends b{constructor(e){super(et.type),this.markers=e}};Je.type="render-markers-list";var tt=Je,ti=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="10 9 81 81"><path fill="currentColor" d="M50.5 90S22.9 51.9 22.9 36.6 35.2 9 50.5 9s27.6 12.4 27.6 27.6S50.5 90 50.5 90zm0-66.3c-6.1 0-11 4.9-11 11s4.9 11 11 11 11-4.9 11-11-4.9-11-11-11z"/><!--Created by Rohith M S from the Noun Project--></svg>
`,N=class extends ce{constructor(i){super(i,{className:"psv-markers-button",icon:ti,hoverScale:!0,collapsable:!0,tabbable:!0}),this.plugin=this.viewer.getPlugin("markers"),this.plugin&&(this.plugin.addEventListener(B.type,this),this.plugin.addEventListener($.type,this),this.toggleActive(!0))}destroy(){this.plugin&&(this.plugin.removeEventListener(B.type,this),this.plugin.removeEventListener($.type,this)),super.destroy()}isSupported(){return!!this.plugin}handleEvent(i){i instanceof B?this.toggleActive(!0):i instanceof $&&this.toggleActive(!1)}onClick(){this.plugin.toggleAllMarkers()}};N.id="markers";var it=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="9 9 81 81"><path fill="currentColor" d="M37.5 90S9.9 51.9 9.9 36.6 22.2 9 37.5 9s27.6 12.4 27.6 27.6S37.5 90 37.5 90zm0-66.3c-6.1 0-11 4.9-11 11s4.9 11 11 11 11-4.9 11-11-4.9-11-11-11zM86.7 55H70c-1.8 0-3.3-1.5-3.3-3.3s1.5-3.3 3.3-3.3h16.7c1.8 0 3.3 1.5 3.3 3.3S88.5 55 86.7 55zm0-25h-15a3.3 3.3 0 0 1-3.3-3.3c0-1.8 1.5-3.3 3.3-3.3h15c1.8 0 3.3 1.5 3.3 3.3 0 1.8-1.5 3.3-3.3 3.3zM56.5 73h30c1.8 0 3.3 1.5 3.3 3.3 0 1.8-1.5 3.3-3.3 3.3h-30a3.3 3.3 0 0 1-3.3-3.3 3.2 3.2 0 0 1 3.3-3.3z"/><!--Created by Rohith M S from the Noun Project--></svg>
`,X="http://www.w3.org/2000/svg",f="psvMarker",ii=h.dasherize(f),z="marker",A="markersList",ne={amount:2,duration:100,easing:"linear"},si=(i,e)=>`
<div class="psv-panel-menu psv-panel-menu--stripped">
    <h1 class="psv-panel-menu-title">${it} ${e}</h1>
    <ul class="psv-panel-menu-list">
    ${i.map(t=>`
        <li data-${ii}="${t.id}" class="psv-panel-menu-item" tabindex="0">
          ${t.type==="image"?`<span class="psv-panel-menu-item-icon"><img src="${t.definition}"/></span>`:""}
          <span class="psv-panel-menu-item-label">${t.getListContent()}</span>
        </li>
    `).join("")}
    </ul>
</div>
`,K=class extends ce{constructor(i){super(i,{className:" psv-markers-list-button",icon:it,hoverScale:!0,collapsable:!0,tabbable:!0}),this.plugin=this.viewer.getPlugin("markers"),this.plugin&&(this.viewer.addEventListener(l.ShowPanelEvent.type,this),this.viewer.addEventListener(l.HidePanelEvent.type,this))}destroy(){this.viewer.removeEventListener(l.ShowPanelEvent.type,this),this.viewer.removeEventListener(l.HidePanelEvent.type,this),super.destroy()}isSupported(){return!!this.plugin}handleEvent(i){i instanceof l.ShowPanelEvent?this.toggleActive(i.panelId===A):i instanceof l.HidePanelEvent&&this.toggleActive(!1)}onClick(){this.plugin.toggleMarkersList()}};K.id="markersList";var me=new M,ni=new Nt,ye=new M,ri=class extends Ft{constructor(i=document.createElement("div")){super(),this.isCSS3DObject=!0,this.element=i,this.element.style.position="absolute",this.element.style.pointerEvents="auto",this.element.style.userSelect="none",this.element.setAttribute("draggable",!1),this.addEventListener("removed",function(){this.traverse(function(e){e.element instanceof e.element.ownerDocument.defaultView.Element&&e.element.parentNode!==null&&e.element.remove()})})}copy(i,e){return super.copy(i,e),this.element=i.element.cloneNode(!0),this}},x=new _e,oi=new _e,ai=class{constructor(i={}){const e=this;let t,s,n,r;const d={camera:{style:""},objects:new WeakMap},p=i.element!==void 0?i.element:document.createElement("div");p.style.overflow="hidden",this.domElement=p;const g=document.createElement("div");g.style.transformOrigin="0 0",g.style.pointerEvents="none",p.appendChild(g);const v=document.createElement("div");v.style.transformStyle="preserve-3d",g.appendChild(v),this.getSize=function(){return{width:t,height:s}},this.render=function(c,o){const w=o.projectionMatrix.elements[5]*r;o.view&&o.view.enabled?(g.style.transform=`translate( ${-o.view.offsetX*(t/o.view.width)}px, ${-o.view.offsetY*(s/o.view.height)}px )`,g.style.transform+=`scale( ${o.view.fullWidth/o.view.width}, ${o.view.fullHeight/o.view.height} )`):g.style.transform="",c.matrixWorldAutoUpdate===!0&&c.updateMatrixWorld(),o.parent===null&&o.matrixWorldAutoUpdate===!0&&o.updateMatrixWorld();let O,m;o.isOrthographicCamera&&(O=-(o.right+o.left)/2,m=(o.top+o.bottom)/2);const y=o.view&&o.view.enabled?o.view.height/o.view.fullHeight:1,k=o.isOrthographicCamera?`scale( ${y} )scale(`+w+")translate("+a(O)+"px,"+a(m)+"px)"+E(o.matrixWorldInverse):`scale( ${y} )translateZ(`+w+"px)"+E(o.matrixWorldInverse),_=(o.isPerspectiveCamera?"perspective("+w+"px) ":"")+k+"translate("+n+"px,"+r+"px)";d.camera.style!==_&&(v.style.transform=_,d.camera.style=_),T(c,c,o)},this.setSize=function(c,o){t=c,s=o,n=t/2,r=s/2,p.style.width=c+"px",p.style.height=o+"px",g.style.width=c+"px",g.style.height=o+"px",v.style.width=c+"px",v.style.height=o+"px"};function a(c){return Math.abs(c)<1e-10?0:c}function E(c){const o=c.elements;return"matrix3d("+a(o[0])+","+a(-o[1])+","+a(o[2])+","+a(o[3])+","+a(o[4])+","+a(-o[5])+","+a(o[6])+","+a(o[7])+","+a(o[8])+","+a(-o[9])+","+a(o[10])+","+a(o[11])+","+a(o[12])+","+a(-o[13])+","+a(o[14])+","+a(o[15])+")"}function C(c){const o=c.elements;return"translate(-50%,-50%)"+("matrix3d("+a(o[0])+","+a(o[1])+","+a(o[2])+","+a(o[3])+","+a(-o[4])+","+a(-o[5])+","+a(-o[6])+","+a(-o[7])+","+a(o[8])+","+a(o[9])+","+a(o[10])+","+a(o[11])+","+a(o[12])+","+a(o[13])+","+a(o[14])+","+a(o[15])+")")}function H(c){c.isCSS3DObject&&(c.element.style.display="none");for(let o=0,w=c.children.length;o<w;o++)H(c.children[o])}function T(c,o,w,O){if(c.visible===!1){H(c);return}if(c.isCSS3DObject){const m=c.layers.test(w.layers)===!0,y=c.element;if(y.style.display=m===!0?"":"none",m===!0){c.onBeforeRender(e,o,w);let k;c.isCSS3DSprite?(x.copy(w.matrixWorldInverse),x.transpose(),c.rotation2D!==0&&x.multiply(oi.makeRotationZ(c.rotation2D)),c.matrixWorld.decompose(me,ni,ye),x.setPosition(me),x.scale(ye),x.elements[3]=0,x.elements[7]=0,x.elements[11]=0,x.elements[15]=1,k=C(x)):k=C(c.matrixWorld);const L=d.objects.get(c);if(L===void 0||L.style!==k){y.style.transform=k;const _={style:k};d.objects.set(c,_)}y.parentNode!==v&&v.appendChild(y),c.onAfterRender(e,o,w)}}for(let m=0,y=c.children.length;m<y;m++)T(c.children[m],o,w)}}},li=class{constructor(i){this.viewer=i,this.element=document.createElement("div"),this.element.className="psv-markers-css3d-container",this.renderer=new ai({element:this.element}),this.scene=new Bt,this.intersectionObserver=new IntersectionObserver(e=>{e.forEach(t=>{const s=t.target[f];s.config.visible&&(s.viewportIntersection=t.isIntersecting)})},{root:this.element}),i.addEventListener(l.ReadyEvent.type,this,{once:!0}),i.addEventListener(l.SizeUpdatedEvent.type,this),i.addEventListener(l.RenderEvent.type,this)}handleEvent(i){switch(i.type){case l.ReadyEvent.type:case l.SizeUpdatedEvent.type:this.updateSize();break;case l.RenderEvent.type:this.render();break}}destroy(){this.viewer.removeEventListener(l.ReadyEvent.type,this),this.viewer.removeEventListener(l.SizeUpdatedEvent.type,this),this.viewer.removeEventListener(l.RenderEvent.type,this),this.intersectionObserver.disconnect()}updateSize(){const i=this.viewer.getSize();this.renderer.setSize(i.width,i.height)}render(){this.renderer.render(this.scene,this.viewer.renderer.camera)}addObject(i){this.scene.add(i.threeElement),this.intersectionObserver.observe(i.domElement)}removeObject(i){this.scene.remove(i.threeElement),this.intersectionObserver.unobserve(i.domElement)}},G=(i=>(i.image="image",i.html="html",i.element="element",i.imageLayer="imageLayer",i.videoLayer="videoLayer",i.elementLayer="elementLayer",i.polygon="polygon",i.polygonPixels="polygonPixels",i.polyline="polyline",i.polylinePixels="polylinePixels",i.square="square",i.rect="rect",i.circle="circle",i.ellipse="ellipse",i.path="path",i))(G||{});function re(i,e=!1){const t=[];if(Object.keys(G).forEach(s=>{i[s]&&t.push(s)}),t.length===0&&!e)throw new u(`missing marker content, either ${Object.keys(G).join(", ")}`);if(t.length>1)throw new u(`multiple marker content, either ${Object.keys(G).join(", ")}`);return t[0]}var st=class{constructor(i,e,t){if(this.viewer=i,this.plugin=e,this.state={anchor:null,visible:!1,staticTooltip:!1,position:null,position2D:null,positions3D:null,size:null},!t.id)throw new u("missing marker id");this.type=re(t),this.createElement(),this.update(t)}get id(){return this.config.id}get data(){return this.config.data}get domElement(){return null}get threeElement(){return null}get video(){return null}destroy(){delete this.viewer,delete this.plugin,delete this.element,this.hideTooltip()}is3d(){return!1}isNormal(){return!1}isPoly(){return!1}isSvg(){return!1}isCss3d(){return!1}update(i){const e=re(i,!0);if(e!==void 0&&e!==this.type)throw new u(`cannot change marker ${i.id} type`);if(this.config=h.deepmerge(this.config,i),typeof this.config.tooltip=="string"&&(this.config.tooltip={content:this.config.tooltip}),this.config.tooltip&&!this.config.tooltip.trigger&&(this.config.tooltip.trigger="hover"),h.isNil(this.config.visible)&&(this.config.visible=!0),h.isNil(this.config.zIndex)&&(this.config.zIndex=1),h.isNil(this.config.opacity)&&(this.config.opacity=1),this.config.rotation){const t=this.config.rotation;typeof t=="object"?this.config.rotation={yaw:t.yaw?h.parseAngle(t.yaw,!0,!1):0,pitch:t.pitch?h.parseAngle(t.pitch,!0,!1):0,roll:t.roll?h.parseAngle(t.roll,!0,!1):0}:this.config.rotation={yaw:0,pitch:0,roll:h.parseAngle(t,!0,!1)}}else this.config.rotation={yaw:0,pitch:0,roll:0};this.state.anchor=h.parsePoint(this.config.anchor)}getListContent(){return this.config.listContent?this.config.listContent:this.config.tooltip?.content?this.config.tooltip.content:this.config.html?this.config.html:this.id}showTooltip(i,e,t=!1){if(this.state.visible&&this.config.tooltip?.content&&this.state.position2D){const s={...this.config.tooltip,style:{pointerEvents:this.state.staticTooltip?"auto":"none"},data:this,top:0,left:0};if(this.isPoly()||this.is3d()||this.isCss3d())if(i||e){const n=h.getPosition(this.viewer.container);s.top=e-n.y+10,s.left=i-n.x,s.box={width:20,height:20}}else s.top=this.state.position2D.y,s.left=this.state.position2D.x;else{const n=this.viewer.dataHelper.vector3ToViewerCoords(this.state.positions3D[0]);let r=this.state.size.width,d=this.state.size.height;this.config.hoverScale&&!this.state.staticTooltip&&(r*=this.config.hoverScale.amount,d*=this.config.hoverScale.amount),s.top=n.y-d*this.state.anchor.y+d/2,s.left=n.x-r*this.state.anchor.x+r/2,s.box={width:r,height:d}}this.tooltip?t?this.tooltip.update(this.config.tooltip.content,s):this.tooltip.move(s):this.tooltip=this.viewer.createTooltip(s)}}hideTooltip(){this.tooltip&&(this.tooltip.hide(),this.tooltip=null)}},pe=class extends st{get domElement(){return this.element}constructor(i,e,t){super(i,e,t)}afterCreateElement(){this.element[f]=this}destroy(){delete this.element[f],super.destroy()}update(i){super.update(i);const e=this.domElement;e.id=`psv-marker-${this.config.id}`,e.setAttribute("class","psv-marker"),this.state.visible&&e.classList.add("psv-marker--visible"),this.config.tooltip&&e.classList.add("psv-marker--has-tooltip"),this.config.content&&e.classList.add("psv-marker--has-content"),this.config.className&&h.addClasses(e,this.config.className),e.style.opacity=`${this.config.opacity}`,e.style.zIndex=`${30+this.config.zIndex}`,this.config.style&&Object.assign(e.style,this.config.style)}},q=class extends pe{constructor(i,e,t){super(i,e,t)}afterCreateElement(){super.afterCreateElement(),this.domElement.addEventListener("transitionend",()=>{this.domElement.style.transition=""})}render({viewerPosition:i,zoomLevel:e,hoveringMarker:t}){this.__updateSize();const s=this.viewer.dataHelper.vector3ToViewerCoords(this.state.positions3D[0]);return s.x-=this.state.size.width*this.state.anchor.x,s.y-=this.state.size.height*this.state.anchor.y,this.state.positions3D[0].dot(this.viewer.state.direction)>0&&s.x+this.state.size.width>=0&&s.x-this.state.size.width<=this.viewer.state.size.width&&s.y+this.state.size.height>=0&&s.y-this.state.size.height<=this.viewer.state.size.height?(this.domElement.style.translate=`${s.x}px ${s.y}px 0px`,this.applyScale({zoomLevel:e,viewerPosition:i,mouseover:this===t}),s):null}update(i){if(super.update(i),!h.isExtendedPosition(this.config.position))throw new u(`missing marker ${this.id} position`);try{this.state.position=this.viewer.dataHelper.cleanPosition(this.config.position)}catch(t){throw new u(`invalid marker ${this.id} position`,t)}this.state.positions3D=[this.viewer.dataHelper.sphericalCoordsToVector3(this.state.position)];const e=this.domElement;e.classList.add("psv-marker--normal"),this.config.scale&&Array.isArray(this.config.scale)&&(this.config.scale={zoom:this.config.scale}),typeof this.config.hoverScale=="boolean"?this.config.hoverScale=this.config.hoverScale?this.plugin.config.defaultHoverScale||ne:null:typeof this.config.hoverScale=="number"?this.config.hoverScale={amount:this.config.hoverScale}:this.config.hoverScale||(this.config.hoverScale=this.plugin.config.defaultHoverScale),this.config.hoverScale&&(this.config.hoverScale={...this.plugin.config.defaultHoverScale,...this.config.hoverScale}),e.style.rotate=this.config.rotation.roll!==0?ve.radToDeg(this.config.rotation.roll)+"deg":null,e.style.transformOrigin=`${this.state.anchor.x*100}% ${this.state.anchor.y*100}%`}__updateSize(){if(!this.needsUpdateSize)return;const i=this.domElement,e=!this.state.visible||!this.state.size;if(e&&i.classList.add("psv-marker--transparent"),this.isSvg()){const t=i.firstElementChild.getBoundingClientRect();this.state.size={width:t.width,height:t.height}}else this.state.size={width:i.offsetWidth,height:i.offsetHeight};e&&i.classList.remove("psv-marker--transparent"),this.isSvg()&&(i.style.width=this.state.size.width+"px",i.style.height=this.state.size.height+"px"),this.type!=="element"&&(this.needsUpdateSize=!1)}applyScale({zoomLevel:i,viewerPosition:e,mouseover:t}){t!==null&&this.config.hoverScale&&(this.domElement.style.transition=`scale ${this.config.hoverScale.duration}ms ${this.config.hoverScale.easing}`);let s=1;if(typeof this.config.scale=="function")s=this.config.scale(i,e);else if(this.config.scale){if(Array.isArray(this.config.scale.zoom)){const[n,r]=this.config.scale.zoom;s*=n+(r-n)*P.EASINGS.inQuad(i/100)}if(Array.isArray(this.config.scale.yaw)){const[n,r]=this.config.scale.yaw,d=ve.degToRad(this.viewer.state.hFov)/2,p=Math.abs(h.getShortestArc(this.state.position.yaw,e.yaw));s*=r+(n-r)*P.EASINGS.outQuad(Math.max(0,(d-p)/d))}}t&&this.config.hoverScale&&(s*=this.config.hoverScale.amount),this.domElement.style.scale=`${s}`}},hi=`// https://www.8thwall.com/playground/chromakey-threejs

uniform sampler2D map;
uniform float alpha;
uniform bool keying;
uniform vec3 color;
uniform float similarity;
uniform float smoothness;
uniform float spill;

varying vec2 vUv;

vec2 RGBtoUV(vec3 rgb) {
    return vec2(
        rgb.r * -0.169 + rgb.g * -0.331 + rgb.b *  0.5    + 0.5,
        rgb.r *  0.5   + rgb.g * -0.419 + rgb.b * -0.081  + 0.5
    );
}

void main(void) {
    gl_FragColor = texture2D(map, vUv);

    if (keying) {
        float chromaDist = distance(RGBtoUV(gl_FragColor.rgb), RGBtoUV(color));

        float baseMask = chromaDist - similarity;
        float fullMask = pow(clamp(baseMask / smoothness, 0., 1.), 1.5);
        gl_FragColor.a *= fullMask * alpha;

        float spillVal = pow(clamp(baseMask / spill, 0., 1.), 1.5);
        float desat = clamp(gl_FragColor.r * 0.2126 + gl_FragColor.g * 0.7152 + gl_FragColor.b * 0.0722, 0., 1.);
        gl_FragColor.rgb = mix(vec3(desat, desat, desat), gl_FragColor.rgb, spillVal);
    } else {
        gl_FragColor.a *= alpha;
    }
}
`,ci=`varying vec2 vUv;
uniform vec2 repeat;
uniform vec2 offset;

void main() {
    vUv = uv * repeat + offset;
    gl_Position = projectionMatrix *  modelViewMatrix * vec4( position, 1.0 );
}
`,di=class extends Yt{get map(){return this.uniforms.map.value}set map(i){this.uniforms.map.value=i}set alpha(i){this.uniforms.alpha.value=i}get offset(){return this.uniforms.offset.value}get repeat(){return this.uniforms.repeat.value}set chromaKey(i){this.uniforms.keying.value=i?.enabled===!0,i?.enabled&&(typeof i.color=="object"&&"r"in i.color?this.uniforms.color.value.set(i.color.r/255,i.color.g/255,i.color.b/255):this.uniforms.color.value.set(i.color??65280),this.uniforms.similarity.value=i.similarity??.2,this.uniforms.smoothness.value=i.smoothness??.2)}constructor(i){super({transparent:!0,depthTest:!1,depthWrite:!1,uniforms:{map:{value:i?.map},repeat:{value:new fe(1,1)},offset:{value:new fe(0,0)},alpha:{value:i?.alpha??1},keying:{value:!1},color:{value:new Gt(65280)},similarity:{value:.2},smoothness:{value:.2},spill:{value:.1}},vertexShader:ci,fragmentShader:hi}),this.chromaKey=i?.chromaKey}};function pi({src:i,withCredentials:e,muted:t,autoplay:s}){const n=document.createElement("video");return n.crossOrigin=e?"use-credentials":"anonymous",n.loop=!0,n.playsInline=!0,n.autoplay=s,n.muted=t,n.preload="metadata",i instanceof MediaStream?n.srcObject=i:n.src=i,n}function gi(i,e,t){const[s,n]=i,[r,d]=e,p=h.greatArcDistance(i,e),g=Math.sin((1-t)*p)/Math.sin(p),v=Math.sin(t*p)/Math.sin(p),a=g*Math.cos(n)*Math.cos(s)+v*Math.cos(d)*Math.cos(r),E=g*Math.cos(n)*Math.sin(s)+v*Math.cos(d)*Math.sin(r),C=g*Math.sin(n)+v*Math.sin(d);return[Math.atan2(E,a),Math.atan2(C,Math.sqrt(a*a+E*E))]}function ui(i){const e=[i[0]];let t=0;for(let s=1;s<i.length;s++){const n=i[s-1][0]-i[s][0];n>Math.PI?t+=1:n<-Math.PI&&(t-=1),e.push([i[s][0]+t*2*Math.PI,i[s][1]])}return e}function nt(i){return i.reduce((e,t)=>e.add(t),new M).normalize()}function vi(i){const e=ui(i);let t=0;const s=[];for(let r=0;r<e.length-1;r++){const d=h.greatArcDistance(e[r],e[r+1])*P.SPHERE_RADIUS;s.push(d),t+=d}let n=0;for(let r=0;r<e.length-1;r++){if(n+s[r]>t/2){const d=(t/2-n)/s[r];return gi(e[r],e[r+1],d)}n+=s[r]}return e[Math.round(e.length/2)]}var Y=new M,we=new M,te=new M,Ee=new M,ke=new M,be=new M;function fi(i,e,t){Y.copy(t).normalize(),we.crossVectors(i,e).normalize(),te.crossVectors(we,i).normalize(),Ee.copy(i).multiplyScalar(-Y.dot(te)),ke.copy(te).multiplyScalar(Y.dot(i));const s=new M().addVectors(Ee,ke).normalize();return be.crossVectors(s,Y),s.applyAxisAngle(be,.01).multiplyScalar(P.SPHERE_RADIUS)}var mi=class extends st{get threeElement(){return this.element}get threeMesh(){return this.threeElement.children[0]}get video(){return this.type==="videoLayer"?this.threeMesh.material.map.image:null}constructor(i,e,t){super(i,e,t)}is3d(){return!0}createElement(){const i=new di({alpha:0}),e=new Vt(1,1),t=new It(e,i);t.userData={[f]:this},Object.defineProperty(t,"visible",{enumerable:!0,get:function(){return this.userData[f].config.visible},set:function(s){this.userData[f].config.visible=s}}),this.element=new Ht().add(t),this.type==="videoLayer"&&this.viewer.needsContinuousUpdate(!0)}destroy(){delete this.threeMesh.userData[f],this.type==="videoLayer"&&(this.video.pause(),this.viewer.needsContinuousUpdate(!1)),super.destroy()}render(){return this.viewer.renderer.isObjectVisible(this.threeMesh)?this.viewer.dataHelper.sphericalCoordsToViewerCoords(this.state.position):null}update(i){super.update(i);const e=this.threeMesh,t=e.parent,s=e.material;if(h.isExtendedPosition(this.config.position)){try{this.state.position=this.viewer.dataHelper.cleanPosition(this.config.position)}catch(r){throw new u(`invalid marker ${this.id} position`,r)}if(!this.config.size)throw new u(`missing marker ${this.id} size`);this.state.size=this.config.size,e.scale.set(this.config.size.width/100,this.config.size.height/100,1),e.position.set(e.scale.x*(.5-this.state.anchor.x),e.scale.y*(this.state.anchor.y-.5),0),e.rotation.set(0,0,0),this.viewer.dataHelper.sphericalCoordsToVector3(this.state.position,t.position),t.lookAt(0,t.position.y,0),e.rotateY(-this.config.rotation.yaw),e.rotateX(-this.config.rotation.pitch),e.rotateZ(-this.config.rotation.roll);const n=e.geometry.getAttribute("position");this.state.positions3D=[0,1,3,2].map(r=>{const d=new M;return d.fromBufferAttribute(n,r),e.localToWorld(d)})}else{if(this.config.position?.length!==4)throw new u(`missing marker ${this.id} position`);let n;try{n=this.config.position.map(g=>this.viewer.dataHelper.cleanPosition(g))}catch(g){throw new u(`invalid marker ${this.id} position`,g)}const r=n.map(g=>this.viewer.dataHelper.sphericalCoordsToVector3(g)),d=nt(r);this.state.position=this.viewer.dataHelper.vector3ToSphericalCoords(d),this.state.positions3D=r;const p=e.geometry.getAttribute("position");[r[0],r[1],r[3],r[2]].forEach((g,v)=>{p.setX(v,g.x),p.setY(v,g.y),p.setZ(v,g.z)}),p.needsUpdate=!0,this.__setTextureWrap(s)}switch(this.type){case"videoLayer":if(this.definition!==this.config.videoLayer){s.map?.dispose();const n=pi({src:this.config.videoLayer,withCredentials:this.viewer.config.withCredentials(this.config.videoLayer),muted:!0,autoplay:this.config.autoplay??!0}),r=new Wt(n);s.map=r,s.alpha=0,n.addEventListener("loadedmetadata",()=>{this.viewer&&(s.alpha=this.config.opacity,h.isExtendedPosition(this.config.position)||(e.material.userData[f]={width:n.videoWidth,height:n.videoHeight},this.__setTextureWrap(s)))},{once:!0}),n.autoplay&&n.play(),this.definition=this.config.videoLayer}else s.alpha=this.config.opacity;break;case"imageLayer":if(this.definition!==this.config.imageLayer){s.map?.dispose();const n=new Ut;s.map=n,s.alpha=0,this.viewer.textureLoader.loadImage(this.config.imageLayer).then(r=>{this.viewer&&(h.isExtendedPosition(this.config.position)||(e.material.userData[f]={width:r.width,height:r.height},this.__setTextureWrap(s)),n.image=r,n.anisotropy=4,n.needsUpdate=!0,s.alpha=this.config.opacity,this.viewer.needsUpdate())}),this.definition=this.config.imageLayer}else s.alpha=this.config.opacity;break}s.chromaKey=this.config.chromaKey,e.renderOrder=1e3+this.config.zIndex,e.geometry.boundingBox=null}__setTextureWrap(i){const e=i.userData[f];if(!e||!e.height||!e.width){i.repeat.set(1,1),i.offset.set(0,0);return}const t=this.config.position.map(E=>this.viewer.dataHelper.cleanPosition(E)),s=h.greatArcDistance([t[0].yaw,t[0].pitch],[t[1].yaw,t[1].pitch]),n=h.greatArcDistance([t[3].yaw,t[3].pitch],[t[2].yaw,t[2].pitch]),r=h.greatArcDistance([t[1].yaw,t[1].pitch],[t[2].yaw,t[2].pitch]),d=h.greatArcDistance([t[0].yaw,t[0].pitch],[t[3].yaw,t[3].pitch]),p=(s+n)/(r+d),g=e.width/e.height;let v=0,a=0;p<g?v=g-p:a=1/g-1/p,i.repeat.set(1-v,1-a),i.offset.set(v/2,a/2)}},yi=class extends pe{constructor(i,e,t){super(i,e,t),this.viewportIntersection=!1}get threeElement(){return this.object}isCss3d(){return!0}createElement(){this.element=document.createElement("div"),this.object=new ri(this.element),this.object.userData={[f]:this},Object.defineProperty(this.object,"visible",{enumerable:!0,get:function(){return this.userData[f].config.visible},set:function(i){this.userData[f].config.visible=i}}),this.afterCreateElement()}destroy(){delete this.object.userData[f],delete this.object,super.destroy()}render({viewerPosition:i,zoomLevel:e}){const t=this.domElement;if(this.state.size={width:t.offsetWidth,height:t.offsetHeight},this.state.positions3D[0].dot(this.viewer.state.direction)>0&&this.viewportIntersection){const n=this.viewer.dataHelper.sphericalCoordsToViewerCoords(this.state.position);return this.config.elementLayer.updateMarker?.({marker:this,position:n,viewerPosition:i,zoomLevel:e,viewerSize:this.viewer.state.size}),n}else return null}update(i){if(super.update(i),!h.isExtendedPosition(this.config.position))throw new u(`missing marker ${this.id} position`);try{this.state.position=this.viewer.dataHelper.cleanPosition(this.config.position)}catch(s){throw new u(`invalid marker ${this.id} position`,s)}this.state.positions3D=[this.viewer.dataHelper.sphericalCoordsToVector3(this.state.position)];const e=this.threeElement,t=this.domElement;t.classList.add("psv-marker--css3d"),t.childNodes.forEach(s=>s.remove()),t.appendChild(this.config.elementLayer),this.config.elementLayer.style.display="block",e.position.copy(this.state.positions3D[0]).multiplyScalar(100),e.lookAt(0,this.state.positions3D[0].y*100,0),e.rotateY(-this.config.rotation.yaw),e.rotateX(-this.config.rotation.pitch),e.rotateZ(-this.config.rotation.roll)}},wi=class extends q{constructor(i,e,t){super(i,e,t)}isNormal(){return!0}createElement(){this.element=document.createElement("div"),this.afterCreateElement()}render(i){const e=super.render(i);return e&&this.type==="element"&&this.config.element.updateMarker?.({marker:this,position:e,viewerPosition:i.viewerPosition,zoomLevel:i.zoomLevel,viewerSize:this.viewer.state.size}),e}update(i){super.update(i);const e=this.domElement;if(this.config.image&&!this.config.size)throw new u(`missing marker ${this.id} size`);switch(this.config.size?(this.needsUpdateSize=!1,this.state.size=this.config.size,e.style.width=this.config.size.width+"px",e.style.height=this.config.size.height+"px"):this.needsUpdateSize=!0,this.type){case"image":this.definition=this.config.image,e.style.backgroundImage=`url("${this.config.image}")`;break;case"html":this.definition=this.config.html,e.innerHTML=this.config.html;break;case"element":this.definition!==this.config.element&&(this.definition=this.config.element,e.childNodes.forEach(t=>t.remove()),e.appendChild(this.config.element),this.config.element.style.display="block");break}}},Ei=class extends pe{constructor(i,e,t){super(i,e,t)}createElement(){this.element=document.createElementNS(X,"path"),this.element[f]=this}isPoly(){return!0}get isPixels(){return this.type==="polygonPixels"||this.type==="polylinePixels"}get isPolygon(){return this.type==="polygon"||this.type==="polygonPixels"}get isPolyline(){return this.type==="polyline"||this.type==="polylinePixels"}get coords(){return this.definition}render(){const i=this.__getAllPolyPositions();if(i[0].length>(this.isPolygon?2:1)){const t=this.viewer.dataHelper.sphericalCoordsToViewerCoords(this.state.position),s=i.filter(n=>n.length>0).map(n=>{let r="M";return r+=n.map(d=>`${d.x-t.x},${d.y-t.y}`).join("L"),this.isPolygon&&(r+="Z"),r}).join(" ");return this.domElement.setAttributeNS(null,"d",s),this.domElement.setAttributeNS(null,"transform",`translate(${t.x} ${t.y})`),t}else return null}update(i){super.update(i);const e=this.domElement;e.classList.add("psv-marker--poly"),this.config.svgStyle?(Object.entries(this.config.svgStyle).forEach(([t,s])=>{e.setAttributeNS(null,h.dasherize(t),s)}),this.isPolyline&&!this.config.svgStyle.fill&&e.setAttributeNS(null,"fill","none")):this.isPolygon?e.setAttributeNS(null,"fill","rgba(0,0,0,0.5)"):this.isPolyline&&(e.setAttributeNS(null,"fill","none"),e.setAttributeNS(null,"stroke","rgb(0,0,0)"));try{let t=this.config[this.type];if(!Array.isArray(t[0])&&typeof t[0]!="object")for(let s=0;s<t.length;s++)t.splice(s,2,[t[s],t[s+1]]);if(!Array.isArray(t[0][0])&&typeof t[0][0]!="object"&&(t=[t]),this.isPolyline&&t.length>1)throw new u("polylines cannot have holes");this.isPixels?this.definition=t.map(s=>s.map(n=>{let r;return h.isExtendedPosition(n)?r=this.viewer.dataHelper.cleanPosition(n):r=this.viewer.dataHelper.textureCoordsToSphericalCoords({textureX:n[0],textureY:n[1]}),[r.yaw,r.pitch]})):this.definition=t.map(s=>s.map(n=>{let r;return h.isExtendedPosition(n)?r=this.viewer.dataHelper.cleanPosition(n):r=this.viewer.dataHelper.cleanPosition({yaw:n[0],pitch:n[1]}),[r.yaw,r.pitch]}))}catch(t){throw new u(`invalid marker ${this.id} position`,t)}if(this.positions3D=this.coords.map(t=>t.map(s=>this.viewer.dataHelper.sphericalCoordsToVector3({yaw:s[0],pitch:s[1]}))),this.isPolygon){const t=nt(this.positions3D[0]);this.state.position=this.viewer.dataHelper.vector3ToSphericalCoords(t)}else{const t=vi(this.coords[0]);this.state.position={yaw:t[0],pitch:t[1]}}this.state.positions3D=this.positions3D[0]}__getAllPolyPositions(){return this.positions3D.map(i=>this.__getPolyPositions(i))}__getPolyPositions(i){const e=i.length,t=i.map(n=>({vector:n,visible:n.dot(this.viewer.state.direction)>0})),s=[];return t.forEach((n,r)=>{n.visible||[r===0?t[e-1]:t[r-1],r===e-1?t[0]:t[r+1]].forEach(p=>{p.visible&&s.push({visible:p.vector,invisible:n.vector,index:r})})}),s.reverse().forEach(n=>{t.splice(n.index,0,{vector:fi(n.visible,n.invisible,this.viewer.state.direction),visible:!0})}),t.filter(n=>n.visible).map(n=>this.viewer.dataHelper.vector3ToViewerCoords(n.vector))}},ki=class extends q{get svgElement(){return this.domElement.firstElementChild}constructor(i,e,t){super(i,e,t)}isSvg(){return!0}createElement(){const i=this.type==="square"?"rect":this.type,e=document.createElementNS(X,i);this.element=document.createElementNS(X,"svg"),this.element.appendChild(e),this.afterCreateElement()}update(i){super.update(i);const e=this.svgElement;switch(this.needsUpdateSize=!0,this.type){case"square":this.definition={x:0,y:0,width:this.config.square,height:this.config.square};break;case"rect":Array.isArray(this.config.rect)?this.definition={x:0,y:0,width:this.config.rect[0],height:this.config.rect[1]}:this.definition={x:0,y:0,width:this.config.rect.width,height:this.config.rect.height};break;case"circle":this.definition={cx:this.config.circle,cy:this.config.circle,r:this.config.circle};break;case"ellipse":Array.isArray(this.config.ellipse)?this.definition={cx:this.config.ellipse[0],cy:this.config.ellipse[1],rx:this.config.ellipse[0],ry:this.config.ellipse[1]}:this.definition={cx:this.config.ellipse.rx,cy:this.config.ellipse.ry,rx:this.config.ellipse.rx,ry:this.config.ellipse.ry};break;case"path":this.definition={d:this.config.path};break}Object.entries(this.definition).forEach(([t,s])=>{e.setAttributeNS(null,t,s)}),this.config.svgStyle?Object.entries(this.config.svgStyle).forEach(([t,s])=>{e.setAttributeNS(null,h.dasherize(t),s)}):e.setAttributeNS(null,"fill","rgba(0,0,0,0.5)")}},bi=h.getConfigParser({clickEventOnMarker:!1,gotoMarkerSpeed:"8rpm",markers:null,defaultHoverScale:null},{defaultHoverScale(i){return i?(i===!0&&(i=ne),typeof i=="number"&&(i={amount:i}),{...ne,...i}):null}});function Mi(i){switch(re(i,!1)){case"image":case"html":case"element":return wi;case"imageLayer":case"videoLayer":return mi;case"elementLayer":return yi;case"polygon":case"polyline":case"polygonPixels":case"polylinePixels":return Ei;case"square":case"rect":case"circle":case"ellipse":case"path":return ki;default:throw new u("invalid marker type")}}var V=class rt extends $t{constructor(e,t){super(e,t),this.markers={},this.state={allVisible:!0,showAllTooltips:!1,currentMarker:null,hoveringMarker:null,needsReRender:!1,lastClientX:null,lastClientY:null},this.container=document.createElement("div"),this.container.className="psv-markers",this.viewer.container.appendChild(this.container),this.container.addEventListener("contextmenu",s=>s.preventDefault()),this.svgContainer=document.createElementNS(X,"svg"),this.svgContainer.setAttribute("class","psv-markers-svg-container"),this.container.appendChild(this.svgContainer),this.css3DContainer=new li(e),this.container.appendChild(this.css3DContainer.element),this.container.addEventListener("mouseenter",this,!0),this.container.addEventListener("mouseleave",this,!0),this.container.addEventListener("mousemove",this,!0)}static withConfig(e){return[rt,e]}init(){super.init(),h.checkStylesheet(this.viewer.container,"markers-plugin"),this.viewer.addEventListener(l.ClickEvent.type,this),this.viewer.addEventListener(l.DoubleClickEvent.type,this),this.viewer.addEventListener(l.RenderEvent.type,this),this.viewer.addEventListener(l.ConfigChangedEvent.type,this),this.viewer.addEventListener(l.ObjectEnterEvent.type,this),this.viewer.addEventListener(l.ObjectHoverEvent.type,this),this.viewer.addEventListener(l.ObjectLeaveEvent.type,this),this.viewer.addEventListener(l.ReadyEvent.type,this,{once:!0})}destroy(){this.clearMarkers(!1),this.viewer.unobserveObjects(f),this.viewer.removeEventListener(l.ClickEvent.type,this),this.viewer.removeEventListener(l.DoubleClickEvent.type,this),this.viewer.removeEventListener(l.RenderEvent.type,this),this.viewer.removeEventListener(l.ObjectEnterEvent.type,this),this.viewer.removeEventListener(l.ObjectHoverEvent.type,this),this.viewer.removeEventListener(l.ObjectLeaveEvent.type,this),this.viewer.removeEventListener(l.ReadyEvent.type,this),this.css3DContainer.destroy(),this.viewer.container.removeChild(this.container),super.destroy()}handleEvent(e){switch(e.type){case l.ReadyEvent.type:this.config.markers&&(this.setMarkers(this.config.markers),delete this.config.markers);break;case l.RenderEvent.type:this.renderMarkers();break;case l.ClickEvent.type:this.__onClick(e,!1);break;case l.DoubleClickEvent.type:this.__onClick(e,!0);break;case l.ObjectEnterEvent.type:case l.ObjectLeaveEvent.type:case l.ObjectHoverEvent.type:if(e.userDataKey===f){const t=e.originalEvent,s=e.object.userData[f];switch(e.type){case l.ObjectEnterEvent.type:s.config.style?.cursor?this.viewer.setCursor(s.config.style.cursor):(s.config.tooltip||s.config.content)&&this.viewer.setCursor("pointer"),this.__onEnterMarker(t,s);break;case l.ObjectLeaveEvent.type:this.viewer.setCursor(null),this.__onLeaveMarker(s);break;case l.ObjectHoverEvent.type:this.__onHoverMarker(t,s);break}}break;case"mouseenter":{const t=this.__getTargetMarker(h.getEventTarget(e));this.__onEnterMarker(e,t);break}case"mouseleave":{const t=this.__getTargetMarker(h.getEventTarget(e));this.__onLeaveMarker(t);break}case"mousemove":{const t=this.__getTargetMarker(h.getEventTarget(e),!0);this.__onHoverMarker(e,t);break}}}toggleAllMarkers(){this.state.allVisible?this.hideAllMarkers():this.showAllMarkers()}showAllMarkers(){this.state.allVisible=!0,Object.values(this.markers).forEach(e=>{e.config.visible=!0}),this.renderMarkers(),this.dispatchEvent(new B)}hideAllMarkers(){this.state.allVisible=!1,Object.values(this.markers).forEach(e=>{e.config.visible=!1}),this.renderMarkers(),this.dispatchEvent(new $)}toggleAllTooltips(){this.state.showAllTooltips?this.hideAllTooltips():this.showAllTooltips()}showAllTooltips(){this.state.showAllTooltips=!0,Object.values(this.markers).forEach(e=>{e.state.staticTooltip=!0,e.showTooltip()})}hideAllTooltips(){this.state.showAllTooltips=!1,Object.values(this.markers).forEach(e=>{e.state.staticTooltip=!1,e.hideTooltip()})}getNbMarkers(){return Object.keys(this.markers).length}getMarkers(){return Object.values(this.markers)}addMarker(e,t=!0){if(this.markers[e.id])throw new u(`marker "${e.id}" already exists`);const s=new(Mi(e))(this.viewer,this,e);s.isPoly()?this.svgContainer.appendChild(s.domElement):s.isCss3d()?this.css3DContainer.addObject(s):s.is3d()?this.viewer.renderer.addObject(s.threeElement):this.container.appendChild(s.domElement),this.markers[s.id]=s,this.state.showAllTooltips&&(s.state.staticTooltip=!0),t&&this.__afterChangeMarkers()}getMarker(e){const t=typeof e=="object"?e.id:e;if(!this.markers[t])throw new u(`cannot find marker "${t}"`);return this.markers[t]}getCurrentMarker(){return this.state.currentMarker}updateMarker(e,t=!0){const s=this.getMarker(e.id);s.update(e),t&&(this.__afterChangeMarkers(),(s===this.state.hoveringMarker&&s.config.tooltip?.trigger==="hover"||s.state.staticTooltip)&&s.showTooltip(this.state.lastClientX,this.state.lastClientY,!0))}removeMarker(e,t=!0){const s=this.getMarker(e);s.isPoly()?this.svgContainer.removeChild(s.domElement):s.isCss3d()?this.css3DContainer.removeObject(s):s.is3d()?this.viewer.renderer.removeObject(s.threeElement):this.container.removeChild(s.domElement),this.state.hoveringMarker===s&&(this.state.hoveringMarker=null),this.state.currentMarker===s&&(this.state.currentMarker=null),s.destroy(),delete this.markers[s.id],t&&this.__afterChangeMarkers()}removeMarkers(e,t=!0){e.forEach(s=>this.removeMarker(s,!1)),t&&this.__afterChangeMarkers()}setMarkers(e,t=!0){this.clearMarkers(!1),e?.forEach(s=>{this.addMarker(s,!1)}),t&&this.__afterChangeMarkers()}clearMarkers(e=!0){Object.keys(this.markers).forEach(t=>{this.removeMarker(t,!1)}),e&&this.__afterChangeMarkers()}gotoMarker(e,t=this.config.gotoMarkerSpeed){const s=this.getMarker(e);return t?this.viewer.animate({...s.state.position,zoom:s.config.zoomLvl,speed:t}).then(()=>{this.dispatchEvent(new se(s))}):(this.viewer.rotate(s.state.position),h.isNil(s.config.zoomLvl)||this.viewer.zoom(s.config.zoomLvl),this.dispatchEvent(new se(s)),Promise.resolve())}hideMarker(e){this.toggleMarker(e,!1)}showMarker(e){this.toggleMarker(e,!0)}showMarkerTooltip(e){const t=this.getMarker(e);t.state.staticTooltip=!0,t.showTooltip()}hideMarkerTooltip(e){const t=this.getMarker(e);t.state.staticTooltip=!1,t.hideTooltip()}toggleMarker(e,t){const s=this.getMarker(e);s.config.visible=h.isNil(t)?!s.config.visible:t,this.renderMarkers()}showMarkerPanel(e){const t=this.getMarker(e);t.config.content?this.viewer.panel.show({id:z,content:t.config.content}):this.hideMarkerPanel()}hideMarkerPanel(){this.viewer.panel.hide(z)}toggleMarkersList(){this.viewer.panel.isVisible(A)?this.hideMarkersList():this.showMarkersList()}showMarkersList(){let e=[];Object.values(this.markers).forEach(s=>{s.config.visible&&!s.config.hideList&&e.push(s)});const t=new tt(e);this.dispatchEvent(t),e=t.markers,this.viewer.panel.show({id:A,content:si(e,this.viewer.config.lang[N.id]),noMargin:!0,clickHandler:s=>{const n=h.getClosest(s,".psv-panel-menu-item"),r=n?n.dataset[f]:void 0;if(r){const d=this.getMarker(r);this.dispatchEvent(new He(d)),this.gotoMarker(d.id),this.hideMarkersList()}}})}hideMarkersList(){this.viewer.panel.hide(A)}renderMarkers(){if(this.state.needsReRender){this.state.needsReRender=!1;return}const e=this.viewer.getZoomLevel(),t=this.viewer.getPosition(),s=this.state.hoveringMarker;Object.values(this.markers).forEach(n=>{let r=n.config.visible,d=!1,p=null;r&&(p=n.render({viewerPosition:t,zoomLevel:e,hoveringMarker:s}),r=!!p),d=n.state.visible!==r,n.state.visible=r,n.state.position2D=p,n.domElement&&h.toggleClass(n.domElement,"psv-marker--visible",r),r?n.state.staticTooltip?n.showTooltip():n!==this.state.hoveringMarker&&n.hideTooltip():n.hideTooltip(),d&&(this.dispatchEvent(new Le(n,r)),(n.is3d()||n.isCss3d())&&(this.state.needsReRender=!0))}),this.state.needsReRender&&this.viewer.needsUpdate()}__getTargetMarker(e,t=!1){if(e instanceof Node){const s=t?h.getClosest(e,".psv-marker"):e;return s?s[f]:void 0}else return Array.isArray(e)?e.map(s=>s.userData[f]).filter(s=>!!s).sort((s,n)=>n.config.zIndex-s.config.zIndex)[0]:null}__onEnterMarker(e,t){t&&(this.state.hoveringMarker=t,this.state.lastClientX=e.clientX,this.state.lastClientY=e.clientY,this.dispatchEvent(new je(t)),t instanceof q&&t.applyScale({zoomLevel:this.viewer.getZoomLevel(),viewerPosition:this.viewer.getPosition(),mouseover:!0}),!t.state.staticTooltip&&t.config.tooltip?.trigger==="hover"&&t.showTooltip(e.clientX,e.clientY))}__onLeaveMarker(e){e&&(this.dispatchEvent(new De(e)),e instanceof q&&e.applyScale({zoomLevel:this.viewer.getZoomLevel(),viewerPosition:this.viewer.getPosition(),mouseover:!1}),this.state.hoveringMarker=null,!e.state.staticTooltip&&e.config.tooltip?.trigger==="hover"?e.hideTooltip():e.state.staticTooltip&&e.showTooltip())}__onHoverMarker(e,t){t&&(this.state.lastClientX=e.clientX,this.state.lastClientY=e.clientY,(t.isPoly()||t.is3d()||t.isCss3d())&&t.config.tooltip?.trigger==="hover"&&t.showTooltip(e.clientX,e.clientY))}__onClick(e,t){const s=this.__getTargetMarker(e.data.objects),r=this.__getTargetMarker(e.data.target,!0)||s;this.state.currentMarker&&this.state.currentMarker!==r&&(this.dispatchEvent(new Fe(this.state.currentMarker)),this.viewer.panel.hide(z),!this.state.showAllTooltips&&this.state.currentMarker.config.tooltip?.trigger==="click"&&this.hideMarkerTooltip(this.state.currentMarker.id),this.state.currentMarker=null),r&&(this.state.currentMarker=r,this.dispatchEvent(new Ne(r,t,e.data.rightclick)),this.config.clickEventOnMarker?e.data.marker=r:e.stopImmediatePropagation(),this.markers[r.id]&&!e.data.rightclick&&(r.config.tooltip?.trigger==="click"?r.tooltip?this.hideMarkerTooltip(r.id):this.showMarkerTooltip(r.id):this.showMarkerPanel(r.id)))}__afterChangeMarkers(){this.__refreshUi(),this.__checkObjectsObserver(),this.viewer.needsUpdate(),this.dispatchEvent(new Ze(this.getMarkers()))}__refreshUi(){const e=Object.values(this.markers).filter(t=>!t.config.hideList).length;e===0?(this.viewer.panel.hide(z),this.viewer.panel.hide(A)):this.viewer.panel.isVisible(A)?this.showMarkersList():this.viewer.panel.isVisible(z)&&(this.state.currentMarker?this.showMarkerPanel(this.state.currentMarker.id):this.viewer.panel.hide()),this.viewer.navbar.getButton(N.id,!1)?.toggle(e>0),this.viewer.navbar.getButton(K.id,!1)?.toggle(e>0)}__checkObjectsObserver(){Object.values(this.markers).some(t=>t.is3d())?this.viewer.observeObjects(f):this.viewer.unobserveObjects(f)}};V.id="markers";V.VERSION="5.14.1";V.configParser=bi;V.readonlyOptions=["markers"];var ie=V;Z.lang[N.id]="Markers";Z.lang[K.id]="Markers list";he(N,"caption:left");he(K,"caption:left");var _i=Object.defineProperty,Si=(i,e)=>{for(var t in e)_i(i,t,{get:e[t],enumerable:!0})},xi={};Si(xi,{ResolutionChangedEvent:()=>lt});var ot=class at extends de{constructor(e){super(at.type),this.resolutionId=e}};ot.type="resolution-changed";var lt=ot,Ci=h.getConfigParser({resolutions:null,defaultResolution:null,showBadge:!0}),ge=class R extends Se{constructor(e,t){super(e),this.resolutions=[],this.resolutionsById={},this.state={resolution:null},this.config=Ci(t),this.config.defaultResolution&&this.viewer.config.panorama&&h.logWarn("ResolutionPlugin, a defaultResolution was provided but a panorama is already configured on the viewer, the defaultResolution will be ignored.")}static withConfig(e){return[R,e]}init(){if(super.init(),this.settings=this.viewer.getPlugin("settings"),!this.settings)throw new u("Resolution plugin requires the Settings plugin");this.settings.addSetting({id:R.id,type:"options",label:R.id,current:()=>this.state.resolution,options:()=>this.resolutions,apply:e=>this.__setResolutionIfExists(e),badge:this.config.showBadge?()=>this.state.resolution:null}),this.viewer.addEventListener(l.PanoramaLoadedEvent.type,this),this.config.resolutions&&(this.setResolutions(this.config.resolutions,this.viewer.config.panorama?null:this.config.defaultResolution),delete this.config.resolutions,delete this.config.defaultResolution)}destroy(){this.viewer.removeEventListener(l.PanoramaLoadedEvent.type,this),this.settings.removeSetting(R.id),super.destroy()}handleEvent(e){e instanceof l.PanoramaLoadedEvent&&this.__refreshResolution()}setResolutions(e,t){this.resolutions=e,this.resolutionsById={},e.forEach(s=>{if(!s.id)throw new u("Missing resolution id");if(!s.label)throw new u("Missing resolution label");if(!s.panorama)throw new u("Missing resolution panorama");this.resolutionsById[s.id]=s}),t||this.viewer.config.panorama&&this.resolutions.find(n=>h.deepEqual(this.viewer.config.panorama,n.panorama))||(t=e[0].id),t&&this.setResolution(t),this.__refreshResolution()}setResolution(e){if(!this.resolutionsById[e])throw new u(`Resolution "${e}" unknown`);return this.__setResolutionIfExists(e)}__setResolutionIfExists(e){return this.resolutionsById[e]?this.viewer.setPanorama(this.resolutionsById[e].panorama,{transition:!1,showLoader:!1,panoData:this.resolutionsById[e].panoData}):Promise.resolve()}getResolution(){return this.state.resolution}__refreshResolution(){const e=this.resolutions.find(t=>h.deepEqual(this.viewer.config.panorama,t.panorama));this.state.resolution!==e?.id&&(this.state.resolution=e?.id,this.settings?.updateButton(),this.dispatchEvent(new lt(this.state.resolution)))}};ge.id="resolution";ge.VERSION="5.14.1";var oe=ge;Z.lang[oe.id]="Quality";var Li=Object.defineProperty,Pi=(i,e)=>{for(var t in e)Li(i,t,{get:e[t],enumerable:!0})},Ai={};Pi(Ai,{SettingChangedEvent:()=>j});var ht=class ct extends de{constructor(e,t){super(ct.type),this.settingId=e,this.settingValue=t}};ht.type="setting-changed";var j=ht,Ti=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path fill="currentColor" d="M98.4 43.7c-.8-.5-7-4.3-9.6-5.4l-3-7.5c.9-2.5 2.6-9.4 3-10.6a3.3 3.3 0 00-1-3.1L83 12.2a3.3 3.3 0 00-3-.9c-1 .2-8 2-10.7 3l-7.5-3.1c-1-2.4-4.8-8.6-5.4-9.6A3.3 3.3 0 0053.4 0h-6.8a3.4 3.4 0 00-2.9 1.6c-.5.8-4.2 7-5.4 9.6l-7.5 3-10.6-3a3.3 3.3 0 00-3.1 1L12.2 17a3.3 3.3 0 00-.9 3c.2 1 2 8 3 10.7l-3.1 7.5c-2.4 1-8.6 4.8-9.6 5.4A3.3 3.3 0 000 46.6v6.8a3.4 3.4 0 001.6 2.9c.8.5 7 4.2 9.6 5.4l3 7.5-3 10.6a3.3 3.3 0 001 3.1l4.8 4.9a3.3 3.3 0 003.1.9c1-.2 8-2 10.7-3l7.5 3c1 2.5 4.7 8.6 5.4 9.7a3.3 3.3 0 002.9 1.6h6.8a3.4 3.4 0 002.9-1.6c.5-.8 4.2-7 5.4-9.6l7.5-3c2.5.9 9.4 2.6 10.6 3a3.3 3.3 0 003.1-1l4.9-4.8a3.3 3.3 0 00.9-3.1c-.2-1-2-8-3-10.7l3-7.5c2.5-1 8.6-4.7 9.7-5.4a3.3 3.3 0 001.6-2.9v-6.8a3.3 3.3 0 00-1.6-2.9zM50 71.7A21.8 21.8 0 1171.8 50 21.8 21.8 0 0150 71.8z"/><!-- Created by i cons from the Noun Project --></svg>
`,I=class extends ce{constructor(i){super(i,{className:"psv-settings-button",icon:Ti,hoverScale:!0,collapsable:!1,tabbable:!0}),this.plugin=this.viewer.getPlugin("settings"),this.badge=document.createElement("div"),this.badge.className="psv-settings-badge",this.badge.style.display="none",this.container.appendChild(this.badge)}isSupported(){return!!this.plugin}onClick(){this.plugin.toggleSettings()}setBadge(i){this.badge.innerText=i,this.badge.style.display=i?"":"none"}};I.id="settings";var Oi=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 90 90"><polygon fill="currentColor" points="0,48 10,35 36,57 78,10 90,21 37,79 "/><!-- Created by Zahroe from the Noun Project --></svg>
`,dt=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path fill="currentColor" d="M86.2 50.7l-44 44-9.9-9.9 34.1-34.1-34.7-34.8L41.6 6z"/><!-- Created by Renee Ramsey-Passmore from the Noun Project--></svg>
`,Di=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 100" width="2.4em" height="1.2em"><path fill="currentColor" transform="scale(1.88) translate(0, -25)" d="M72 73.2H44A26.4 26.4 0 0044 30h28a21.6 21.6 0 010 43.2M7.2 51.6a21.6 21.6 0 1143.2 0 21.6 21.6 0 01-43.2 0M72 25.2H28.8a26.4 26.4 0 000 52.8H72a26.4 26.4 0 000-52.8"/><!-- Created by Nikita from the Noun Project --></svg>
`,zi=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 100" width="2.4em" height="1.2em"><path fill="currentColor" transform="scale(1.88) translate(0, -25)" d="M72 73.2A21.6 21.6 0 1172 30a21.6 21.6 0 010 43.2M2.4 51.6A26.4 26.4 0 0028.8 78H72a26.4 26.4 0 000-52.8H28.8A26.4 26.4 0 002.4 51.6"/><!-- Created by Nikita from the Noun Project --></svg>
`,pt="psvSettings",gt="settingId",ut="optionId",vt="__back",ft="__enter",ae=h.dasherize(gt),le=h.dasherize(ut),Ri={options:(i,e)=>{const t=i.current(),s=i.options().find(n=>n.id===t);return`
<span class="psv-settings-item-label">${e[i.label]??i.label}</span>
<span class="psv-settings-item-value">${s?.label??t}</span>
<span class="psv-settings-item-icon">${dt}</span>
`},toggle:(i,e)=>`
<span class="psv-settings-item-label">${e[i.label]??i.label}</span>
<span class="psv-settings-item-value">${i.active()?zi:Di}</span>
`},ji=(i,e)=>`
<ul class="psv-settings-list">
${i.map(t=>`
    <li class="psv-settings-item" tabindex="0"
        data-${ae}="${t.id}" data-${le}="${ft}">
        ${Ri[t.type](t,e)}
    </li>
`).join("")}
</ul>
`,$i=(i,e)=>{const t=i.current();return`
<ul class="psv-settings-list">
    <li class="psv-settings-item psv-settings-item--header" tabindex="0"
        data-${ae}="${i.id}" data-${le}="${vt}">
        <span class="psv-settings-item-icon">${dt}</span>
        <span class="psv-settings-item-label">${e[i.label]??i.label}</span>
    </li>
${i.options().map(s=>`
    <li class="psv-settings-item" tabindex="0"
        data-${ae}="${i.id}" data-${le}="${s.id}">
        <span class="psv-settings-item-icon">${s.id===t?Oi:""}</span>
        <span class="psv-settings-item-value">${e[s.label]??s.label}</span>
    </li>
`).join("")}
</ul>
`},Bi=class extends Xt{constructor(i,e){super(e,{className:`psv-settings ${P.CAPTURE_EVENTS_CLASS}`}),this.plugin=i,this.container.addEventListener("click",this),this.container.addEventListener("transitionend",this),this.container.addEventListener("keydown",this),this.hide()}handleEvent(i){switch(i.type){case"click":this.__click(i);break;case"transitionend":i.target===this.container&&(this.isVisible()?this.__focusFirstOption():this.container.innerHTML="");break;case"keydown":if(this.isVisible())switch(i.key){case P.KEY_CODES.Escape:this.plugin.hideSettings();break;case P.KEY_CODES.Enter:this.__click(i);break}break}}show(i){if(this.__showSettings(!1),this.container.classList.add("psv-settings--open"),this.container.style.right="",this.container.style.left="",i){const e=this.viewer.container.getBoundingClientRect(),t=i.left-e.left,s=e.right-i.right,n=i.width,r=this.container.offsetWidth;r>=t+n?this.container.style.left="0px":r>=s+n?this.container.style.right="0px":t+r<e.width?this.container.style.left=`${t}px`:this.container.style.right=`${s}px`}else this.container.style.right="0px";this.state.visible=!0}hide(){this.container.classList.remove("psv-settings--open"),this.state.visible=!1,h.hasParent(document.activeElement,this.container)&&this.viewer.navbar.focusButton(I.id)}__click(i){const e=h.getMatchingTarget(i,".psv-settings-item");if(!e)return;const t=e.dataset[gt],s=e.dataset[ut],n=this.plugin.settings.find(r=>r.id===t);switch(s){case vt:this.__showSettings(!0);break;case ft:switch(n.type){case"toggle":this.plugin.toggleSettingValue(n),this.__showSettings(!0);break;case"options":this.__showOptions(n);break}break;default:n.type==="options"&&(this.hide(),this.plugin.applySettingOption(n,s));break}}__showSettings(i){this.container.innerHTML=ji(this.plugin.settings,this.viewer.config.lang),i&&this.__focusFirstOption()}__showOptions(i){this.container.innerHTML=$i(i,this.viewer.config.lang),this.__focusFirstOption()}__focusFirstOption(){this.container.querySelector("[tabindex]")?.focus()}};function Me(){return JSON.parse(localStorage.getItem(pt))||{}}function Ni(i){localStorage.setItem(pt,JSON.stringify(i))}var Vi=h.getConfigParser({persist:!1,storage:{set(i,e){const t=Me();t[i]=e,Ni(t)},get(i){return Me()[i]}}}),ue=class mt extends Se{constructor(e,t){super(e),this.settings=[],this.config=Vi(t),this.component=new Bi(this,this.viewer)}static withConfig(e){return[mt,e]}init(){super.init(),h.checkStylesheet(this.viewer.container,"settings-plugin"),this.viewer.addEventListener(l.ClickEvent.type,this),this.viewer.addEventListener(l.ShowPanelEvent.type,this),setTimeout(()=>this.updateButton())}destroy(){this.viewer.removeEventListener(l.ClickEvent.type,this),this.viewer.removeEventListener(l.ShowPanelEvent.type,this),this.component.destroy(),this.settings.length=0,super.destroy()}handleEvent(e){(e instanceof l.ClickEvent||e instanceof l.ShowPanelEvent)&&this.component.isVisible()&&this.hideSettings()}addSetting(e){if(!e.id)throw new u("Missing setting id");if(!e.type)throw new u("Missing setting type");if(this.settings.some(t=>t.id===e.id))throw new u(`Setting "${e.id}" already exists`);e.badge&&this.settings.some(t=>t.badge)&&h.logWarn("More than one setting with a badge are declared, the result is unpredictable."),this.settings.push(e),this.component.isVisible()&&this.showSettings(),this.updateButton(),this.config.persist&&Promise.resolve(this.config.storage.get(e.id)).then(t=>{switch(e.type){case"toggle":{const s=e;!h.isNil(t)&&t!==s.active()&&(s.toggle(),this.dispatchEvent(new j(s.id,s.active())));break}case"options":{const s=e;!h.isNil(t)&&t!==s.current()&&(s.apply(t),this.dispatchEvent(new j(s.id,s.current())));break}}this.updateButton()})}removeSetting(e){const t=this.settings.findIndex(s=>s.id===e);t!==-1&&(this.settings.splice(t,1),this.component.isVisible()&&this.component.show(),this.updateButton())}toggleSettings(){this.component.isVisible()?this.hideSettings():this.showSettings()}hideSettings(){this.__getButton()?.toggleActive(!1),this.component.hide()}showSettings(){const e=this.__getButton();this.component.show(e?.container.getBoundingClientRect()),e?.toggleActive(!0)}updateButton(){const e=this.__getButton();if(this.settings.length){const t=this.settings.find(s=>s.badge)?.badge();e?.show(),e?.setBadge(t)}else e?.hide()}toggleSettingValue(e){const t=!e.active();e.toggle(),this.dispatchEvent(new j(e.id,t)),this.config.persist&&this.config.storage.set(e.id,t),this.updateButton()}applySettingOption(e,t){e.apply(t),this.dispatchEvent(new j(e.id,t)),this.config.persist&&this.config.storage.set(e.id,t),this.updateButton()}__getButton(){return this.viewer.navbar.getButton(I.id,!1)}};ue.id="settings";ue.VERSION="5.14.1";var Ii=ue;Z.lang[I.id]="Settings";he(I,"fullscreen:left");var Hi=Lt('<!> <div class="h-full w-full mb-0"></div>',1);function es(i,e){kt(e,!0);const t=()=>Dt(jt,"$alwaysLoadOriginalFile",s),[s,n]=Ot(),r={fill:"rgba(0, 0, 0, 0)",stroke:"#ffffff",strokeWidth:"3px",strokeLinejoin:"round"};let d=J(e,"adapter",3,qt),p=J(e,"plugins",19,()=>[]),g=J(e,"navbar",3,!1),v=St(void 0),a,E,C=[];const H=zt.subscribe(m=>{if(m===C||(C=m,E&&(E.cancel(),E=void 0),!a||!a.state.textureData||!a.getPlugin(ie)))return;const y=a.getPlugin(ie),k=a.state.textureData.panoData.croppedWidth;y.clearMarkers();for(const[L,_]of m.entries()){const{boundingBoxX1:U,boundingBoxY1:W,boundingBoxX2:F,boundingBoxY2:D}=_,S=k/_.imageWidth;y.addMarker({id:`face_${L}`,polygonPixels:[[U*S,W*S],[F*S,W*S],[F*S,D*S],[U*S,D*S]],svgStyle:r})}if(m.length===1){const{boundingBoxX1:L,boundingBoxY1:_,boundingBoxX2:U,boundingBoxY2:W,imageWidth:F}=m[0],D=k/F,S=(L+U)*D/2,yt=(_+W)*D/2;E=a.animate({textureX:S,textureY:yt,zoom:Math.min(a.getZoomLevel(),75),speed:500})}}),T=()=>{a?.animate({zoom:ee.zoom>1?50:83.3,speed:250})};let c=!1;wt(()=>{if(!Q(v))return;a=new Zt({adapter:d(),plugins:[ie,Ii,[oe,{defaultResolution:t()&&e.originalPanorama?"original":"default",resolutions:[{id:"default",label:"Default",panorama:e.panorama},...e.originalPanorama?[{id:"original",label:"Original",panorama:e.originalPanorama}]:[]]}],...p()],container:Q(v),touchmoveTwoFingers:!1,mousewheelCtrlKey:!1,navbar:g(),minFov:15,maxFov:90,zoomSpeed:.5,fisheye:!1});const m=a.getPlugin(oe),y=({zoomLevel:k})=>{ee.zoom=k/50,Math.round(k)>=75&&!c&&(m.setResolution("original"),c=!0)};return e.originalPanorama&&!t()&&a.addEventListener(l.ZoomUpdatedEvent.type,y,{passive:!0}),()=>a.removeEventListener(l.ZoomUpdatedEvent.type,y)}),Et(()=>{a&&a.destroy(),H(),ee.zoom=1});var o=Hi();At(xt,(m,y)=>Kt?.(m,y),()=>[{shortcut:{key:"z"},onShortcut:T,preventDefault:!0}]);var w=bt(o);Rt(w,{onZoom:T});var O=Mt(w,2);Tt(O,m=>Ct(v,m),()=>Q(v)),Pt(i,o),_t(),n()}export{es as default};
