import{d as c,h as U,g as u,j as h,u as f}from"./BOqQhZBJ.js";import{s as P,g as n}from"./C4XZXykC.js";import{p as l}from"./DbKlvrsB.js";import{e as g}from"./ytu5q_IM.js";import{R as p}from"./BeWG-__C.js";import{f as $,ai as k,aj as I,ak as L}from"./DeYUhNiz.js";const b=()=>{const s=P;return{page:{subscribe:s.page.subscribe},navigating:{subscribe:s.navigating.subscribe},updated:s.updated}},o={subscribe(s){return b().page.subscribe(s)}},z={subscribe(s){return b().navigating.subscribe(s)}},m=s=>JSON.stringify(s);class A{constructor(e){this.fetcher=e}#s=new Map;async getOrFetch(e,t){const a=m(e),r=this.#s.get(a);if(r)return r;const i=await this.fetcher(e);return i&&t&&this.#s.set(a,i),i}clearKey(e){const t=m(e);this.#s.delete(t)}clear(){this.#s.clear()}}class O{#s=new A($);#e=new A(k);constructor(){g.on({AssetEditsApplied:e=>{this.invalidateAsset(e)},AssetUpdate:e=>{this.invalidateAsset(e.id)}})}async getAsset({id:e,key:t,slug:a},r=!0){return this.#s.getOrFetch({id:e,key:t,slug:a},r)}async getAssetOcr(e){return this.#e.getOrFetch({id:e},!0)}invalidateAsset(e){const{key:t,slug:a}=d.params;this.#s.clearKey({id:e,key:t,slug:a}),this.#e.clearKey({id:e})}clearAssetCache(){this.#s.clear()}clearOcrCache(){this.#e.clear()}invalidate(){this.clearAssetCache(),this.clearOcrCache()}}const C=new O,_=s=>new URL(s,globalThis.location.href).origin!==globalThis.location.origin,y=s=>!!s?.startsWith("/(user)/photos/[[assetId=id]]"),W=s=>!!s?.startsWith("/(user)/share/[key]")||!!s?.startsWith("/(user)/s/[slug]"),B=s=>!!s?.startsWith("/(user)/albums/[albumId=id]"),D=s=>!!s?.startsWith("/(user)/people/[personId]"),H=s=>!!s?.startsWith("/(user)/locked"),X=s=>!!(s?.route?.id?.endsWith("/[[assetId=id]]")&&"assetId"in(s?.params||{}));function Y({assetId:s,slug:e,key:t}){return s?C.getAsset({id:s,slug:e,key:t},!1):void 0}function v(){const s=c(o);return y(s.route.id)?p.photos()+s.url.search:s.url.pathname.replace(/(\/photos.*)$/,"")+s.url.search}function R(s){const e=c(o),t=new URLSearchParams(e.url.search);t.delete("at");const r=t.toString()==""?"":"?"+t.toString();return y(e.route.id)?`${p.viewAsset({id:s})}${r}`:`${e.url.pathname.replace(/\/photos\/[^/]+$/,"")}/photos/${s}${r}`}function F(s,e){const t=c(o),a=new URL(s,t.url),{at:r}=e||{at:null};if(!r)return a.pathname;const i=new URLSearchParams(t.url.search);return r&&i.set("at",r),a.pathname+"?"+i.toString()}function w(){const e=c(o).url;return e.pathname+e.search+e.hash}function M(s){return s.targetRoute==="current"&&"assetId"in s}function T(s){return s.targetRoute==="current"&&"assetId"in s&&"assetGridRouteSearchParams"in s}async function G(s,e){const{assetId:t}=s,a=t?R(t):v(),r=w();(a!==r||e?.forceNavigate)&&await n(a,e)}async function K(s,e){const{assetId:t,assetGridRouteSearchParams:a}=s,r=t?R(t):v(),i=F(r,a),S=w();(i!==S||e?.forceNavigate)&&await n(i,e)}function Z(s,e){if(T(s))return K(s,e);if(M(s))return G(s,e);throw`Invalid navigation: ${JSON.stringify(s)}`}const q=async(s,e)=>{e.searchParams.has(s)&&(e.searchParams.delete(s),await n(e,{keepFocus:!0}))},ss=async(s,e)=>{const t=globalThis.location.href,a=new URL(t);a.searchParams.set(s,e),await n(a,{keepFocus:!0})};class j{#s=U(!1);get isPurchased(){return u(this.#s)}set isPurchased(e){h(this.#s,e,!0)}#e=f(()=>W(l.route?.id));get isSharedLink(){return u(this.#e)}set isSharedLink(e){h(this.#e,e)}#t=f(()=>this.isSharedLink?{key:l.params.key,slug:l.params.slug}:{});get params(){return u(this.#t)}set params(e){h(this.#t,e)}constructor(){g.on({AuthUserLoaded:e=>this.onAuthUserLoaded(e)})}async onAuthUserLoaded(e){if(e.license?.activatedAt){d.isPurchased=!0;return}(await I().catch(()=>{}))?.licensed&&(d.isPurchased=!0)}async logout(){let e;try{const t=await L();t.redirectUri&&(e=t.redirectUri)}catch(t){console.log("Error logging out:",t)}e=e??p.login();try{e.startsWith("/")?await n(e):globalThis.location.href=e}finally{this.isPurchased=!1,g.emit("AuthLogout")}}}const d=new j;export{d as a,Z as b,B as c,W as d,H as e,q as f,Y as g,R as h,D as i,_ as j,C as k,X as l,z as n,o as p,ss as s};
